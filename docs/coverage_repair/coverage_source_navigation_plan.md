# Coverage Source Navigation Enhancement Plan

## Overview

This plan outlines the enhancements needed to improve navigation in the HTML coverage reports generated by the Firmo coverage module. The goal is to make it easier for users to navigate through source files, especially in large codebases, and to quickly find areas of interest in the coverage reports.

## Current Limitations

The current HTML coverage reports have the following navigation limitations:

1. Limited file navigation - no quick way to jump between files
2. No search functionality within the coverage report
3. No bookmarking or highlighting of interesting areas
4. Limited keyboard navigation support
5. No code folding for better overview of large files
6. Difficult to navigate through large files with many lines
7. No quick way to jump to specific line numbers
8. No ability to filter files by coverage percentage
9. No way to track visited files or lines

## Implementation Tasks

### 1. File Navigation Panel

Create a persistent, collapsible file navigation panel that:

```lua
-- Add file navigation panel to HTML template
local function add_file_navigation_panel(files)
  local panel_html = [[
  <div class="file-nav-panel" id="fileNavPanel">
    <div class="panel-header">
      <h3>Files</h3>
      <button class="toggle-button" onclick="toggleFileNav()">⟩</button>
    </div>
    <div class="panel-search">
      <input type="text" id="fileSearchInput" placeholder="Search files..." onkeyup="filterFiles()">
      <div class="filter-options">
        <select id="coverageFilter" onchange="filterFilesByCoverage()">
          <option value="all">All Files</option>
          <option value="high">High Coverage (>80%)</option>
          <option value="medium">Medium Coverage (50-80%)</option>
          <option value="low">Low Coverage (<50%)</option>
        </select>
      </div>
    </div>
    <div class="file-list" id="fileNavList">
  ]]
  
  -- Add file entries
  for file_path, file_data in pairs(files) do
    local file_coverage = file_data.coverage_percent or 0
    local coverage_class = get_coverage_class(file_coverage)
    
    panel_html = panel_html .. string.format([[
      <div class="file-entry %s" data-coverage="%0.1f" data-path="%s">
        <span class="file-path">%s</span>
        <span class="file-coverage">%0.1f%%</span>
      </div>
    ]], coverage_class, file_coverage, escape_html(file_path), escape_html(file_path), file_coverage)
  end
  
  panel_html = panel_html .. [[
    </div>
  </div>
  ]]
  
  return panel_html
end
```

### 2. In-File Navigation Enhancements

Add navigation aids within each file:

```lua
-- Add line number navigation and overview bar
local function enhance_file_navigation(file_path, file_data)
  -- Create a file overview bar that shows a minimap of coverage
  local overview_html = [[
  <div class="file-overview-bar" id="overviewBar-]] .. escape_file_id(file_path) .. [[">
  ]]
  
  -- Generate coverage points for every 10 lines
  for i = 1, file_data.line_count, 10 do
    local coverage_points = calculate_coverage_points(file_data, i, math.min(i+9, file_data.line_count))
    overview_html = overview_html .. string.format([[
      <div class="overview-segment" style="height: %dpx; background-color: %s" 
           data-line="%d" onclick="scrollToLine('%s', %d)"></div>
    ]], 5, coverage_points.color, i, escape_file_id(file_path), i)
  end
  
  overview_html = overview_html .. [[
  </div>
  
  <div class="line-number-nav">
    <input type="number" id="gotoLine-]] .. escape_file_id(file_path) .. [[" 
           placeholder="Line #" min="1" max="]] .. file_data.line_count .. [[">
    <button onclick="gotoLine(']] .. escape_file_id(file_path) .. [[')">Go</button>
  </div>
  ]]
  
  return overview_html
end
```

### 3. Code Folding Functionality

Implement code folding to allow users to collapse and expand sections of code:

```lua
-- Add code folding functionality
local function add_code_folding(html)
  -- Enhance the block-start lines with folding controls
  html = html:gsub('<div class="line block%-start([^"]*)"', 
    '<div class="line block-start%1 foldable" onclick="toggleFold(this)"')
  
  -- Add JavaScript for folding
  local js = [[
  function toggleFold(element) {
    // Get the block ID
    const blockId = element.getAttribute('data-block-id');
    if (!blockId) return;
    
    // Find all lines in this block
    const blockLines = document.querySelectorAll(`[data-inside-block-id="${blockId}"], [data-block-id="${blockId}"].block-end`);
    
    // Toggle folded state
    const isFolded = element.classList.toggle('folded');
    
    // Hide or show block lines
    blockLines.forEach(line => {
      line.style.display = isFolded ? 'none' : '';
    });
    
    // Update fold indicator
    element.querySelector('.fold-indicator').textContent = isFolded ? '⊕' : '⊖';
  }
  ]]
  
  return html, js
end
```

### 4. Keyboard Navigation Support

Add keyboard shortcuts for common navigation actions:

```lua
-- Add keyboard navigation support
local function add_keyboard_navigation()
  local js = [[
  document.addEventListener('keydown', function(e) {
    // Navigation shortcuts
    if (e.ctrlKey && e.key === 'f') {
      // Ctrl+F: Focus file search
      e.preventDefault();
      document.getElementById('fileSearchInput').focus();
    } else if (e.ctrlKey && e.key === 'g') {
      // Ctrl+G: Focus line number input
      e.preventDefault();
      const activeFile = document.querySelector('.file-container.active');
      if (activeFile) {
        const fileId = activeFile.id;
        document.getElementById(`gotoLine-${fileId}`).focus();
      }
    } else if (e.key === 'Escape') {
      // Escape: Clear search or close panels
      if (document.activeElement === document.getElementById('fileSearchInput')) {
        document.getElementById('fileSearchInput').value = '';
        filterFiles();
      }
    } else if (e.ctrlKey && e.key === 'ArrowLeft') {
      // Ctrl+Left: Toggle file navigation panel
      e.preventDefault();
      toggleFileNav();
    } else if (e.ctrlKey && e.key === 'ArrowUp') {
      // Ctrl+Up: Go to previous file
      e.preventDefault();
      navigateToPreviousFile();
    } else if (e.ctrlKey && e.key === 'ArrowDown') {
      // Ctrl+Down: Go to next file
      e.preventDefault();
      navigateToNextFile();
    }
  });
  ]]
  
  return js
end
```

### 5. Bookmark and Highlighting System

Implement a bookmark system to mark and quickly navigate to points of interest:

```lua
-- Add bookmark and highlighting functionality
local function add_bookmark_system()
  local js = [[
  // Bookmarking system
  let bookmarks = [];
  
  function toggleBookmark(lineElement) {
    const lineId = lineElement.id;
    const fileId = lineElement.closest('.file-container').id;
    const lineNum = lineElement.querySelector('.line-number').textContent;
    
    const bookmarkIndex = bookmarks.findIndex(b => b.lineId === lineId);
    
    if (bookmarkIndex >= 0) {
      // Remove bookmark
      bookmarks.splice(bookmarkIndex, 1);
      lineElement.classList.remove('bookmarked');
    } else {
      // Add bookmark
      bookmarks.push({
        lineId: lineId,
        fileId: fileId,
        lineNum: lineNum,
        text: lineElement.textContent.trim().substring(0, 50)
      });
      lineElement.classList.add('bookmarked');
    }
    
    updateBookmarksList();
  }
  
  function updateBookmarksList() {
    const container = document.getElementById('bookmarksContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (bookmarks.length === 0) {
      container.innerHTML = '<p>No bookmarks added yet</p>';
      return;
    }
    
    const list = document.createElement('ul');
    bookmarks.forEach(bookmark => {
      const item = document.createElement('li');
      item.innerHTML = `
        <span>${bookmark.fileId}: Line ${bookmark.lineNum}</span>
        <span class="bookmark-preview">${bookmark.text}</span>
        <button onclick="scrollToBookmark('${bookmark.lineId}')">Go</button>
        <button onclick="removeBookmark('${bookmark.lineId}')">✕</button>
      `;
      list.appendChild(item);
    });
    
    container.appendChild(list);
  }
  
  function scrollToBookmark(lineId) {
    const lineElement = document.getElementById(lineId);
    if (lineElement) {
      // Show the file if it's hidden
      const fileContainer = lineElement.closest('.file-container');
      document.querySelectorAll('.file-container').forEach(container => {
        container.classList.toggle('active', container === fileContainer);
      });
      
      // Scroll to the line
      lineElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // Highlight temporarily
      lineElement.classList.add('highlight-flash');
      setTimeout(() => {
        lineElement.classList.remove('highlight-flash');
      }, 2000);
    }
  }
  ]]
  
  return js
end
```

### 6. Search in Current File

Add functionality to search within the current file:

```lua
-- Add in-file search functionality
local function add_file_search()
  local html = [[
  <div class="file-search-panel">
    <input type="text" id="inFileSearchInput" placeholder="Search in file...">
    <button id="prevMatchBtn">⬆</button>
    <button id="nextMatchBtn">⬇</button>
    <span id="searchStats"></span>
    <button id="closeSearchBtn">✕</button>
  </div>
  ]]
  
  local js = [[
  // In-file search
  let currentMatches = [];
  let currentMatchIndex = -1;
  
  function initFileSearch() {
    const searchInput = document.getElementById('inFileSearchInput');
    const prevBtn = document.getElementById('prevMatchBtn');
    const nextBtn = document.getElementById('nextMatchBtn');
    const closeBtn = document.getElementById('closeSearchBtn');
    
    searchInput.addEventListener('input', function() {
      performFileSearch();
    });
    
    prevBtn.addEventListener('click', function() {
      navigateToMatch(-1);
    });
    
    nextBtn.addEventListener('click', function() {
      navigateToMatch(1);
    });
    
    closeBtn.addEventListener('click', function() {
      document.querySelector('.file-search-panel').classList.remove('active');
      clearFileSearch();
    });
    
    // Ctrl+F shortcut
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'f' && document.querySelector('.file-container.active')) {
        e.preventDefault();
        document.querySelector('.file-search-panel').classList.add('active');
        document.getElementById('inFileSearchInput').focus();
      }
    });
  }
  
  function performFileSearch() {
    clearFileSearch();
    
    const searchTerm = document.getElementById('inFileSearchInput').value.toLowerCase();
    if (!searchTerm) return;
    
    const activeFile = document.querySelector('.file-container.active');
    if (!activeFile) return;
    
    const lines = activeFile.querySelectorAll('.line');
    lines.forEach(line => {
      const text = line.textContent.toLowerCase();
      if (text.includes(searchTerm)) {
        line.classList.add('search-match');
        currentMatches.push(line);
      }
    });
    
    updateSearchStats();
    
    if (currentMatches.length > 0) {
      navigateToMatch(1); // Go to first match
    }
  }
  
  function clearFileSearch() {
    document.querySelectorAll('.search-match').forEach(el => {
      el.classList.remove('search-match', 'current-match');
    });
    
    currentMatches = [];
    currentMatchIndex = -1;
    updateSearchStats();
  }
  
  function navigateToMatch(direction) {
    if (currentMatches.length === 0) return;
    
    // Remove current highlight
    if (currentMatchIndex >= 0) {
      currentMatches[currentMatchIndex].classList.remove('current-match');
    }
    
    // Update index with wrapping
    currentMatchIndex += direction;
    if (currentMatchIndex >= currentMatches.length) currentMatchIndex = 0;
    if (currentMatchIndex < 0) currentMatchIndex = currentMatches.length - 1;
    
    // Highlight new current match
    const match = currentMatches[currentMatchIndex];
    match.classList.add('current-match');
    match.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    updateSearchStats();
  }
  
  function updateSearchStats() {
    const stats = document.getElementById('searchStats');
    if (currentMatches.length === 0) {
      stats.textContent = 'No matches';
    } else {
      stats.textContent = `${currentMatchIndex + 1} of ${currentMatches.length}`;
    }
  }
  ]]
  
  return html, js
end
```

### 7. Visited Lines Tracking

Implement a system to track which lines and files have been visited:

```lua
-- Add visited tracking functionality
local function add_visited_tracking()
  local js = [[
  // Track visited lines and files
  const visitedLines = new Set();
  const visitedFiles = new Set();
  
  function markLineVisited(lineElement) {
    if (!lineElement) return;
    
    const lineId = lineElement.id;
    if (visitedLines.has(lineId)) return;
    
    visitedLines.add(lineId);
    lineElement.classList.add('visited');
    
    // Update file visited status
    const fileContainer = lineElement.closest('.file-container');
    if (fileContainer) {
      const fileId = fileContainer.id;
      visitedFiles.add(fileId);
      
      // Update file list
      const fileEntry = document.querySelector(`.file-entry[data-path="${fileId}"]`);
      if (fileEntry) {
        fileEntry.classList.add('visited');
      }
    }
    
    // Track visited percentage
    updateVisitedPercentage();
  }
  
  function updateVisitedPercentage() {
    const allLines = document.querySelectorAll('.line:not(.non-executable)');
    const visitedPercentage = (visitedLines.size / allLines.length) * 100;
    
    document.getElementById('visitedPercentage').textContent = 
      `Visited: ${visitedLines.size}/${allLines.length} (${visitedPercentage.toFixed(1)}%)`;
  }
  
  // Track mouse and keyboard interactions
  document.addEventListener('DOMContentLoaded', function() {
    // Track line hover
    document.querySelectorAll('.line').forEach(line => {
      line.addEventListener('mouseenter', function() {
        markLineVisited(this);
      });
    });
    
    // Initialize visited counter
    const statusBar = document.createElement('div');
    statusBar.className = 'status-bar';
    statusBar.innerHTML = '<span id="visitedPercentage">Visited: 0/0 (0.0%)</span>';
    document.body.appendChild(statusBar);
    
    updateVisitedPercentage();
  });
  ]]
  
  return js
end
```

### 8. Responsive Design Improvements

Enhance the responsive design for better viewing on different devices:

```lua
-- Add responsive design improvements
local function add_responsive_styles()
  local css = [[
  /* Responsive layout */
  @media (max-width: 768px) {
    .container {
      padding: 10px;
    }
    
    .file-nav-panel {
      position: fixed;
      left: -250px;
      transition: left 0.3s ease;
      width: 250px;
      z-index: 1000;
    }
    
    .file-nav-panel.active {
      left: 0;
    }
    
    .file-overview-bar {
      width: 10px;
    }
    
    .line-number {
      min-width: 30px;
    }
    
    .file-search-panel {
      width: 100%;
      left: 0;
    }
  }
  
  /* Dark mode adjustments for navigation */
  [data-theme="dark"] .file-nav-panel {
    background-color: #1e1e1e;
    border-color: #333;
  }
  
  [data-theme="dark"] .file-search-panel {
    background-color: #2d2d2d;
  }
  
  [data-theme="dark"] .line.visited {
    border-left: 3px solid #5465ff;
  }
  
  [data-theme="dark"] .line.bookmarked {
    border-left: 3px solid #ff7b00;
  }
  
  [data-theme="dark"] .line.highlight-flash {
    animation: darkFlash 2s;
  }
  
  @keyframes darkFlash {
    0% { background-color: #2d5e80; }
    100% { background-color: inherit; }
  }
  ]]
  
  return css
end
```

### 9. Integration with Format_Coverage

Update the main format_coverage function to include all these navigation enhancements:

```lua
function M.format_coverage(coverage_data)
  -- Existing implementation...
  
  -- Add file navigation panel
  html = html:gsub('<div class="container">', function()
    return '<div class="container">' .. add_file_navigation_panel(coverage_data.files)
  end)
  
  -- Add in-file search panel
  local file_search_html, file_search_js = add_file_search()
  html = html:gsub('</body>', function()
    return file_search_html .. '</body>'
  end)
  
  -- Add file overview bars to each file
  for file_path, file_data in pairs(coverage_data.files) do
    local file_id = escape_file_id(file_path)
    local overview_html = enhance_file_navigation(file_path, file_data)
    
    html = html:gsub('<div class="file%-container" id="' .. file_id .. '">', function()
      return '<div class="file-container" id="' .. file_id .. '">' .. overview_html
    end)
  end
  
  -- Add code folding
  local folded_html, folding_js = add_code_folding(html)
  html = folded_html
  
  -- Add navigation JavaScript
  local keyboard_js = add_keyboard_navigation()
  local bookmark_js = add_bookmark_system()
  local visited_js = add_visited_tracking()
  
  -- Add responsive styles
  local responsive_css = add_responsive_styles()
  
  -- Inject all JavaScript
  html = html:gsub('</head>', function()
    return '<style>' .. responsive_css .. '</style></head>'
  end)
  
  html = html:gsub('</body>', function()
    return '<script>' .. 
           folding_js .. 
           keyboard_js .. 
           bookmark_js .. 
           visited_js .. 
           file_search_js ..
           '</script></body>'
  end)
  
  return html
end
```

## CSS Classes and Styling

Add these CSS classes to support the new functionality:

```css
/* Navigation CSS classes */
.file-nav-panel {
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  width: 300px;
  background-color: #f5f5f5;
  border-right: 1px solid #ddd;
  overflow-y: auto;
  z-index: 100;
  transition: left 0.3s ease;
}

.file-nav-panel.collapsed {
  left: -290px;
}

.file-overview-bar {
  position: fixed;
  right: 5px;
  top: 100px;
  bottom: 100px;
  width: 15px;
  background-color: #eee;
  border-radius: 10px;
  overflow: hidden;
}

.overview-segment {
  width: 100%;
  cursor: pointer;
}

.overview-segment:hover {
  filter: brightness(1.1);
}

.line-number-nav {
  position: fixed;
  right: 25px;
  top: 60px;
  display: flex;
  align-items: center;
}

.line.foldable {
  cursor: pointer;
}

.line.foldable:hover {
  background-color: rgba(0, 0, 0, 0.05);
}

.line.foldable.folded {
  border-bottom: 1px dashed #999;
}

.line.bookmarked {
  border-left: 3px solid #ff6b00;
}

.line.visited {
  border-left: 3px solid #4a6bff;
}

.line.highlight-flash {
  animation: flash 2s;
}

@keyframes flash {
  0% { background-color: #d7e9ff; }
  100% { background-color: inherit; }
}

.file-search-panel {
  position: fixed;
  top: 10px;
  right: 10px;
  background-color: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 10px;
  display: none;
  z-index: 100;
}

.file-search-panel.active {
  display: flex;
  align-items: center;
}

.line.search-match {
  background-color: rgba(255, 250, 205, 0.5);
}

.line.current-match {
  background-color: rgba(255, 229, 153, 0.8);
}

.status-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #f5f5f5;
  border-top: 1px solid #ddd;
  padding: 5px 10px;
  display: flex;
  justify-content: space-between;
}
```

## Testing Plan

1. Create test cases for different navigation features:
   - File navigation panel functionality
   - Line number navigation
   - Code folding
   - Keyboard shortcuts
   - Bookmarking and highlighting
   - In-file search
   - Visited tracking

2. Test with different types of source files:
   - Large files with many lines
   - Files with complex nesting
   - Files with varied coverage patterns
   - Multiple files in the same report

3. Test responsive behavior with different screen sizes:
   - Desktop
   - Tablet
   - Mobile

4. Verify browser compatibility:
   - Chrome/Chromium
   - Firefox
   - Safari

## Implementation Strategy

1. First, implement the file navigation panel and in-file navigation
2. Then, add code folding and keyboard navigation
3. Add the bookmark and search functionality
4. Implement the visited tracking system
5. Finally, enhance the responsive design and perform UI refinements

The implementation should follow the project's existing coding standards and maintain compatibility with all other features of the HTML formatter.