<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>firmo Coverage Report</title>
  <style>
    :root {
      /* Dark mode colors */
      --bg-color: #1e1e1e;
      --text-color: #e1e1e1;
      --header-color: #333;
      --summary-bg: #2a2a2a;
      --border-color: #444;
      --line-number-bg: #333;
      --progress-bar-bg: #333;
      --progress-fill-gradient: linear-gradient(to right, #ff6666 0%, #ffdd66 60%, #66ff66 80%);
      --file-header-bg: #2d2d2d;
      --file-item-border: #444;
      --covered-bg: #144a14;      /* Base dark green */
      --covered-highlight: #4CAF50; /* Brighter green for executed lines */
      --uncovered-bg: #5c2626;    /* Darker red for dark mode */
      --syntax-keyword: #569cd6;  /* Blue */
      --syntax-string: #6a9955;   /* Green */
      --syntax-comment: #608b4e;  /* Lighter green */
      --syntax-number: #ce9178;   /* Orange */
      
      /* Block highlighting */
      --block-start-color: #3e3d4a;
      --block-end-color: #3e3d4a;
      --block-executed-border: #4CAF50;
      --block-not-executed-border: #ff6666;
    }
    
    body { 
      font-family: sans-serif; 
      margin: 0; 
      padding: 0; 
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    .container { max-width: 960px; margin: 0 auto; padding: 20px; }
    h1, h2 { color: var(--text-color); }
    .summary { 
      background: var(--summary-bg); 
      padding: 15px; 
      border-radius: 5px; 
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .summary-label { font-weight: bold; }
    .progress-bar { 
      height: 20px; 
      background: var(--progress-bar-bg); 
      border-radius: 10px; 
      overflow: hidden; 
      margin-top: 5px; 
    }
    .progress-fill { 
      height: 100%; 
      background: var(--progress-fill-gradient);
    }
    .file-list { 
      margin-top: 20px; 
      border: 1px solid var(--border-color); 
      border-radius: 5px; 
      overflow: hidden; 
    }
    .file-header { 
      background: var(--file-header-bg); 
      padding: 10px; 
      font-weight: bold; 
      display: flex; 
    }
    .file-name { flex: 2; }
    .file-metric { flex: 1; text-align: center; }
    .file-item { 
      padding: 10px; 
      display: flex; 
      border-top: 1px solid var(--file-item-border); 
    }
    .covered { 
      background-color: var(--covered-highlight); 
      color: #ffffff;
      font-weight: 500;
    } 
    .uncovered { 
      background-color: var(--uncovered-bg);
    } 
    
    /* Syntax highlight in source view */
    .keyword { color: var(--syntax-keyword); }
    .string { color: var(--syntax-string); }
    .comment { color: var(--syntax-comment); }
    .number { color: var(--syntax-number); }
    
    .source-code { 
      font-family: monospace; 
      border: 1px solid var(--border-color); 
      margin: 10px 0; 
      background-color: #252526; /* Slightly lighter than main bg */
    }
    .line { display: flex; line-height: 1.4; }
    .line-number { 
      background: var(--line-number-bg); 
      text-align: right; 
      padding: 0 8px; 
      border-right: 1px solid var(--border-color); 
      min-width: 30px; 
      color: #858585; /* Grey line numbers */
    }
    .line-content { padding: 0 8px; white-space: pre; }
    
    /* Non-executable line styling */
    .line.non-executable {
      color: #777;
      background-color: #f8f8f8;
    }
    
    /* Block highlighting - improved styling */
    .line.block-start { 
      border-top: 2px solid var(--block-start-color); 
      position: relative; 
      margin-top: 2px;
      padding-top: 2px;
      border-left: 2px solid var(--block-start-color);
      border-right: 2px solid var(--block-start-color);
    }
    
    .line.block-end { 
      border-bottom: 2px solid var(--block-end-color);
      margin-bottom: 2px;
      padding-bottom: 2px;
      border-left: 2px solid var(--block-end-color);
      border-right: 2px solid var(--block-end-color);
    }
    
    /* Executed blocks - green borders */
    .line.block-start.block-executed { 
      border-top: 2px solid var(--block-executed-border);
      border-left: 2px solid var(--block-executed-border);
      border-right: 2px solid var(--block-executed-border);
    }
    
    .line.block-end.block-executed { 
      border-bottom: 2px solid var(--block-executed-border);
      border-left: 2px solid var(--block-executed-border);
      border-right: 2px solid var(--block-executed-border);
    }
    
    /* Non-executed blocks - red borders */
    .line.block-start.block-not-executed { 
      border-top: 2px solid var(--block-not-executed-border);
      border-left: 2px solid var(--block-not-executed-border);
      border-right: 2px solid var(--block-not-executed-border);
    }
    
    .line.block-end.block-not-executed { 
      border-bottom: 2px solid var(--block-not-executed-border);
      border-left: 2px solid var(--block-not-executed-border);
      border-right: 2px solid var(--block-not-executed-border);
    }
    
    /* Block hover information */
    .line.block-start:after {
      content: attr(data-block-type);
      position: absolute;
      right: 10px;
      top: 0;
      font-size: 10px;
      color: #aaa;
      opacity: 0.8;
      background-color: rgba(0,0,0,0.1);
      padding: 1px 4px;
      border-radius: 3px;
    }
    
    /* Lines between block start and end - add left border for clear nesting */
    .line.block-start ~ .line:not(.block-end):not(.block-start) {
      border-left: 2px solid var(--block-start-color);
      margin-left: 2px;
      padding-left: 2px;
    }
    
    /* Executed block middle lines */
    .line.block-start.block-executed ~ .line:not(.block-end):not(.block-start) {
      border-left: 2px solid var(--block-executed-border);
    }
    
    /* Non-executed block middle lines */
    .line.block-start.block-not-executed ~ .line:not(.block-end):not(.block-start) {
      border-left: 2px solid var(--block-not-executed-border);
    }
    
    /* Fix for nested blocks */
    .line.block-start.block-executed .line.block-start {
      border-left: 2px solid var(--block-executed-border);
    }
    
    .line.block-start.block-not-executed .line.block-start {
      border-left: 2px solid var(--block-not-executed-border);
    }
    
    /* Condition highlighting */
    .line.condition {
      position: relative;
    }
    
    .line.condition:after {
      content: "⚡";
      position: absolute;
      right: 8px;
      font-size: 12px;
    }
    
    .line.condition-true:after {
      content: "✓";
      color: var(--block-executed-border);
    }
    
    .line.condition-false:after {
      content: "✗";
      color: var(--block-not-executed-border);
    }
    
    .line.condition-both:after {
      content: "✓✗";
      color: gold;
    }
    
    /* Coverage legend styling */
    .coverage-legend {
      margin: 20px 0;
      padding: 15px;
      background-color: var(--summary-bg);
      border: 1px solid var(--border-color);
      border-radius: 5px;
    }
    
    .legend-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .legend-table tr {
      border-bottom: 1px solid var(--border-color);
    }
    
    .legend-table tr:last-child {
      border-bottom: none;
    }
    
    .legend-sample {
      width: 80px;
      height: 24px;
      padding: 4px;
      text-align: center;
    }
    
    .legend-sample.covered {
      background-color: var(--covered-highlight);
    }
    
    .legend-sample.uncovered {
      background-color: var(--uncovered-bg);
    }
    
    .legend-sample.non-executable {
      background-color: #f8f8f8;
      color: #777;
    }
    
    .legend-sample.with-emoji {
      font-size: 18px;
      vertical-align: middle;
    }
    
    .block-indicator {
      height: 20px;
      position: relative;
    }
    
    .block-indicator.executed {
      border-top: 2px solid var(--block-executed-border);
      border-bottom: 2px solid var(--block-executed-border);
    }
    
    .block-indicator.not-executed {
      border-top: 2px solid var(--block-not-executed-border);
      border-bottom: 2px solid var(--block-not-executed-border);
    }
    
    .legend-desc {
      padding: 8px;
    }
    
    /* Add theme toggle button */
    .theme-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      background: #555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
  
  <script>
    // Toggle between dark/light mode if needed in the future
    function toggleTheme() {
      const root = document.documentElement;
      const currentTheme = root.getAttribute('data-theme');
      
      if (currentTheme === 'light') {
        root.setAttribute('data-theme', 'dark');
      } else {
        root.setAttribute('data-theme', 'light');
      }
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>Firmo-Next Coverage Report</h1>
    
    <div class="summary">
      <h2>Summary</h2>
      
      <div class="summary-row">
        <span class="summary-label">Files:</span>
        <span>11/41 (26.8%)</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: 26.829268292683%;"></div>
      </div>
      
      <div class="summary-row">
        <span class="summary-label">Lines:</span>
        <span>11675/19503 (59.9%)</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: 59.862585243296%;"></div>
      </div>
      
      <div class="summary-row">
        <span class="summary-label">Functions:</span>
        <span>0/758 (0.0%)</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: 0.0%;"></div>
      </div>
            <div class="summary-row">
        <span class="summary-label">Blocks:</span>
        <span>885/1003 (88.2%)</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: 88.235294117647%;"></div>
      </div>
            <div class="summary-row">
        <span class="summary-label">Overall:</span>
        <span>95.7%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: 95.718227940248%;"></div>
      </div>
    </div>
    
    <!-- Coverage legend -->
      <div class="coverage-legend">
    <h3>Coverage Legend</h3>
    <table class="legend-table">
      <tr>
        <td class="legend-sample covered"></td>
        <td class="legend-desc">Executed code (covered)</td>
      </tr>
      <tr>
        <td class="legend-sample uncovered"></td>
        <td class="legend-desc">Executable code not executed (uncovered)</td>
      </tr>
      <tr>
        <td class="legend-sample non-executable"></td>
        <td class="legend-desc">Non-executable lines (comments, blank lines)</td>
      </tr>
      <tr>
        <td class="legend-sample"><div class="block-indicator executed"></div></td>
        <td class="legend-desc">Executed code block (green borders)</td>
      </tr>
      <tr>
        <td class="legend-sample"><div class="block-indicator not-executed"></div></td>
        <td class="legend-desc">Non-executed code block (red borders)</td>
      </tr>
      <tr>
        <td class="legend-sample with-emoji">⚡</td>
        <td class="legend-desc">Conditional expression not fully evaluated</td>
      </tr>
      <tr>
        <td class="legend-sample with-emoji">✓</td>
        <td class="legend-desc">Condition evaluated as true</td>
      </tr>
      <tr>
        <td class="legend-sample with-emoji">✗</td>
        <td class="legend-desc">Condition evaluated as false</td>
      </tr>
      <tr>
        <td class="legend-sample with-emoji">✓✗</td>
        <td class="legend-desc">Condition evaluated both ways (100% coverage)</td>
      </tr>
    </table>
  </div>
      
    <!-- File list and details -->
    <div class="file-list">
      <div class="file-header">
        <div class="file-name">File</div>
        <div class="file-metric">Lines</div>
        <div class="file-metric">Functions</div>
        <div class="file-metric">Blocks</div>        <div class="file-metric">Coverage</div>
      </div>
            <div class="file-item">
            <div class="file-name">lib/tools/filesystem.lua</div>
            <div class="file-metric">0/732</div>
            <div class="file-metric">0/42</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">--[[</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">filesystem.lua - Platform-independent filesystem operations</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">4</span><span class="line-content">A comprehensive, standalone filesystem module for Lua with no external dependencies.</span></div><div class="line non-executable"><span class="line-number">5</span><span class="line-content">This module provides a consistent interface for file and directory operations across</span></div><div class="line non-executable"><span class="line-number">6</span><span class="line-content">all platforms that support Lua.</span></div><div class="line non-executable"><span class="line-number">7</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">8</span><span class="line-content">Usage:</span></div><div class="line uncovered"><span class="line-number">9</span><span class="line-content">    local fs = require(&quot;lib.tools.filesystem&quot;)</span></div><div class="line uncovered"><span class="line-number">10</span><span class="line-content">    local content = fs.read_file(&quot;path/to/file.txt&quot;)</span></div><div class="line uncovered"><span class="line-number">11</span><span class="line-content">    fs.write_file(&quot;path/to/output.txt&quot;, &quot;Hello, world!&quot;)</span></div><div class="line non-executable"><span class="line-number">12</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">13</span><span class="line-content">Design principles:</span></div><div class="line non-executable"><span class="line-number">14</span><span class="line-content">- Complete independence: No imports from other modules</span></div><div class="line uncovered"><span class="line-number">15</span><span class="line-content">- Generic interface: All functions usable in any Lua project</span></div><div class="line non-executable"><span class="line-number">16</span><span class="line-content">- Minimal dependencies: Only relies on Lua standard library</span></div><div class="line non-executable"><span class="line-number">17</span><span class="line-content">- Platform neutral: Works identically on all platforms</span></div><div class="line non-executable"><span class="line-number">18</span><span class="line-content">]]</span></div><div class="line non-executable"><span class="line-number">19</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">20</span><span class="line-content">local fs = {}</span></div><div class="line uncovered"><span class="line-number">21</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">22</span><span class="line-content">-- Internal utility functions</span></div><div class="line uncovered"><span class="line-number">23</span><span class="line-content">local function is_windows()</span></div><div class="line uncovered"><span class="line-number">24</span><span class="line-content">    return package.config:sub(1,1) == &apos;\\&apos;</span></div><div class="line non-executable"><span class="line-number">25</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">26</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">27</span><span class="line-content">local path_separator = is_windows() and &apos;\\&apos; or &apos;/&apos;</span></div><div class="line uncovered"><span class="line-number">28</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">29</span><span class="line-content">local function safe_io_action(action, ...)</span></div><div class="line uncovered"><span class="line-number">30</span><span class="line-content">    local status, result, err = pcall(action, ...)</span></div><div class="line uncovered"><span class="line-number">31</span><span class="line-content">    if not status then</span></div><div class="line uncovered"><span class="line-number">32</span><span class="line-content">        -- Don&apos;t output &quot;Permission denied&quot; errors as they flood the output</span></div><div class="line uncovered"><span class="line-number">33</span><span class="line-content">        if not result:match(&quot;Permission denied&quot;) then</span></div><div class="line uncovered"><span class="line-number">34</span><span class="line-content">            return nil, result</span></div><div class="line uncovered"><span class="line-number">35</span><span class="line-content">        else</span></div><div class="line uncovered"><span class="line-number">36</span><span class="line-content">            return nil, nil -- Return nil, nil for permission denied errors</span></div><div class="line uncovered"><span class="line-number">37</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">38</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">39</span><span class="line-content">    if not result and err then</span></div><div class="line uncovered"><span class="line-number">40</span><span class="line-content">        -- Don&apos;t output &quot;Permission denied&quot; errors</span></div><div class="line uncovered"><span class="line-number">41</span><span class="line-content">        if not (err and err:match(&quot;Permission denied&quot;)) then</span></div><div class="line uncovered"><span class="line-number">42</span><span class="line-content">            return nil, err</span></div><div class="line uncovered"><span class="line-number">43</span><span class="line-content">        else</span></div><div class="line uncovered"><span class="line-number">44</span><span class="line-content">            return nil, nil -- Return nil, nil for permission denied errors</span></div><div class="line uncovered"><span class="line-number">45</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">46</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">47</span><span class="line-content">    return result</span></div><div class="line non-executable"><span class="line-number">48</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">49</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">50</span><span class="line-content">-- Core File Operations</span></div><div class="line non-executable"><span class="line-number">51</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">52</span><span class="line-content">--- Read file contents with error handling</span></div><div class="line non-executable"><span class="line-number">53</span><span class="line-content">-- @param path (string) Path to the file to read</span></div><div class="line non-executable"><span class="line-number">54</span><span class="line-content">-- @return content (string) or nil if error</span></div><div class="line non-executable"><span class="line-number">55</span><span class="line-content">-- @return error (string) Error message if reading failed</span></div><div class="line uncovered"><span class="line-number">56</span><span class="line-content">function fs.read_file(path)</span></div><div class="line uncovered"><span class="line-number">57</span><span class="line-content">    return safe_io_action(function(file_path)</span></div><div class="line uncovered"><span class="line-number">58</span><span class="line-content">        local file, err = io.open(file_path, &quot;r&quot;)</span></div><div class="line uncovered"><span class="line-number">59</span><span class="line-content">        if not file then return nil, err end</span></div><div class="line uncovered"><span class="line-number">60</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">61</span><span class="line-content">        local content = file:read(&quot;*a&quot;)</span></div><div class="line uncovered"><span class="line-number">62</span><span class="line-content">        file:close()</span></div><div class="line uncovered"><span class="line-number">63</span><span class="line-content">        return content</span></div><div class="line uncovered"><span class="line-number">64</span><span class="line-content">    end, path)</span></div><div class="line non-executable"><span class="line-number">65</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">66</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">67</span><span class="line-content">--- Write content to file</span></div><div class="line non-executable"><span class="line-number">68</span><span class="line-content">-- @param path (string) Path to the file to write</span></div><div class="line non-executable"><span class="line-number">69</span><span class="line-content">-- @param content (string) Content to write to the file</span></div><div class="line non-executable"><span class="line-number">70</span><span class="line-content">-- @return success (boolean) True if write was successful</span></div><div class="line uncovered"><span class="line-number">71</span><span class="line-content">-- @return error (string) Error message if writing failed</span></div><div class="line uncovered"><span class="line-number">72</span><span class="line-content">function fs.write_file(path, content)</span></div><div class="line uncovered"><span class="line-number">73</span><span class="line-content">    return safe_io_action(function(file_path, data)</span></div><div class="line non-executable"><span class="line-number">74</span><span class="line-content">        -- Ensure parent directory exists</span></div><div class="line uncovered"><span class="line-number">75</span><span class="line-content">        local dir = fs.get_directory_name(file_path)</span></div><div class="line uncovered"><span class="line-number">76</span><span class="line-content">        if dir and dir ~= &quot;&quot; then</span></div><div class="line uncovered"><span class="line-number">77</span><span class="line-content">            local success, err = fs.ensure_directory_exists(dir)</span></div><div class="line uncovered"><span class="line-number">78</span><span class="line-content">            if not success then return nil, err end</span></div><div class="line uncovered"><span class="line-number">79</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">80</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">81</span><span class="line-content">        local file, err = io.open(file_path, &quot;w&quot;)</span></div><div class="line uncovered"><span class="line-number">82</span><span class="line-content">        if not file then return nil, err end</span></div><div class="line uncovered"><span class="line-number">83</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">84</span><span class="line-content">        file:write(data)</span></div><div class="line uncovered"><span class="line-number">85</span><span class="line-content">        file:close()</span></div><div class="line uncovered"><span class="line-number">86</span><span class="line-content">        return true</span></div><div class="line uncovered"><span class="line-number">87</span><span class="line-content">    end, path, content)</span></div><div class="line non-executable"><span class="line-number">88</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">89</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">90</span><span class="line-content">--- Append content to file</span></div><div class="line non-executable"><span class="line-number">91</span><span class="line-content">-- @param path (string) Path to the file to append to</span></div><div class="line non-executable"><span class="line-number">92</span><span class="line-content">-- @param content (string) Content to append to the file</span></div><div class="line non-executable"><span class="line-number">93</span><span class="line-content">-- @return success (boolean) True if append was successful</span></div><div class="line uncovered"><span class="line-number">94</span><span class="line-content">-- @return error (string) Error message if appending failed</span></div><div class="line uncovered"><span class="line-number">95</span><span class="line-content">function fs.append_file(path, content)</span></div><div class="line uncovered"><span class="line-number">96</span><span class="line-content">    return safe_io_action(function(file_path, data)</span></div><div class="line non-executable"><span class="line-number">97</span><span class="line-content">        -- Ensure parent directory exists</span></div><div class="line uncovered"><span class="line-number">98</span><span class="line-content">        local dir = fs.get_directory_name(file_path)</span></div><div class="line uncovered"><span class="line-number">99</span><span class="line-content">        if dir and dir ~= &quot;&quot; then</span></div><div class="line uncovered"><span class="line-number">100</span><span class="line-content">            local success, err = fs.ensure_directory_exists(dir)</span></div><div class="line uncovered"><span class="line-number">101</span><span class="line-content">            if not success then return nil, err end</span></div><div class="line uncovered"><span class="line-number">102</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">103</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">104</span><span class="line-content">        local file, err = io.open(file_path, &quot;a&quot;)</span></div><div class="line uncovered"><span class="line-number">105</span><span class="line-content">        if not file then return nil, err end</span></div><div class="line uncovered"><span class="line-number">106</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">107</span><span class="line-content">        file:write(data)</span></div><div class="line uncovered"><span class="line-number">108</span><span class="line-content">        file:close()</span></div><div class="line uncovered"><span class="line-number">109</span><span class="line-content">        return true</span></div><div class="line uncovered"><span class="line-number">110</span><span class="line-content">    end, path, content)</span></div><div class="line non-executable"><span class="line-number">111</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">112</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">113</span><span class="line-content">--- Copy file with verification</span></div><div class="line non-executable"><span class="line-number">114</span><span class="line-content">-- @param source (string) Path to the source file</span></div><div class="line non-executable"><span class="line-number">115</span><span class="line-content">-- @param destination (string) Path to the destination file</span></div><div class="line non-executable"><span class="line-number">116</span><span class="line-content">-- @return success (boolean) True if copy was successful</span></div><div class="line uncovered"><span class="line-number">117</span><span class="line-content">-- @return error (string) Error message if copying failed</span></div><div class="line uncovered"><span class="line-number">118</span><span class="line-content">function fs.copy_file(source, destination)</span></div><div class="line uncovered"><span class="line-number">119</span><span class="line-content">    return safe_io_action(function(src, dst)</span></div><div class="line uncovered"><span class="line-number">120</span><span class="line-content">        if not fs.file_exists(src) then</span></div><div class="line uncovered"><span class="line-number">121</span><span class="line-content">            return nil, &quot;Source file does not exist: &quot; .. src</span></div><div class="line uncovered"><span class="line-number">122</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">123</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">124</span><span class="line-content">        -- Read source content</span></div><div class="line uncovered"><span class="line-number">125</span><span class="line-content">        local content, err = fs.read_file(src)</span></div><div class="line uncovered"><span class="line-number">126</span><span class="line-content">        if not content then</span></div><div class="line uncovered"><span class="line-number">127</span><span class="line-content">            return nil, &quot;Failed to read source file: &quot; .. (err or &quot;unknown error&quot;)</span></div><div class="line uncovered"><span class="line-number">128</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">129</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">130</span><span class="line-content">        -- Write to destination</span></div><div class="line uncovered"><span class="line-number">131</span><span class="line-content">        local success, write_err = fs.write_file(dst, content)</span></div><div class="line uncovered"><span class="line-number">132</span><span class="line-content">        if not success then</span></div><div class="line uncovered"><span class="line-number">133</span><span class="line-content">            return nil, &quot;Failed to write destination file: &quot; .. (write_err or &quot;unknown error&quot;)</span></div><div class="line uncovered"><span class="line-number">134</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">135</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">136</span><span class="line-content">        return true</span></div><div class="line uncovered"><span class="line-number">137</span><span class="line-content">    end, source, destination)</span></div><div class="line non-executable"><span class="line-number">138</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">139</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">140</span><span class="line-content">--- Move/rename file</span></div><div class="line non-executable"><span class="line-number">141</span><span class="line-content">-- @param source (string) Path to the source file</span></div><div class="line non-executable"><span class="line-number">142</span><span class="line-content">-- @param destination (string) Path to the destination file</span></div><div class="line non-executable"><span class="line-number">143</span><span class="line-content">-- @return success (boolean) True if move was successful</span></div><div class="line uncovered"><span class="line-number">144</span><span class="line-content">-- @return error (string) Error message if moving failed</span></div><div class="line uncovered"><span class="line-number">145</span><span class="line-content">function fs.move_file(source, destination)</span></div><div class="line uncovered"><span class="line-number">146</span><span class="line-content">    return safe_io_action(function(src, dst)</span></div><div class="line uncovered"><span class="line-number">147</span><span class="line-content">        if not fs.file_exists(src) then</span></div><div class="line uncovered"><span class="line-number">148</span><span class="line-content">            return nil, &quot;Source file does not exist: &quot; .. src</span></div><div class="line uncovered"><span class="line-number">149</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">150</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">151</span><span class="line-content">        -- Ensure parent directory exists for destination</span></div><div class="line uncovered"><span class="line-number">152</span><span class="line-content">        local dir = fs.get_directory_name(dst)</span></div><div class="line uncovered"><span class="line-number">153</span><span class="line-content">        if dir and dir ~= &quot;&quot; then</span></div><div class="line uncovered"><span class="line-number">154</span><span class="line-content">            local success, err = fs.ensure_directory_exists(dir)</span></div><div class="line uncovered"><span class="line-number">155</span><span class="line-content">            if not success then return nil, err end</span></div><div class="line uncovered"><span class="line-number">156</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">157</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">158</span><span class="line-content">        -- Try using os.rename first (most efficient)</span></div><div class="line uncovered"><span class="line-number">159</span><span class="line-content">        local ok, err = os.rename(src, dst)</span></div><div class="line uncovered"><span class="line-number">160</span><span class="line-content">        if ok then return true end</span></div><div class="line uncovered"><span class="line-number">161</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">162</span><span class="line-content">        -- If rename fails (potentially across filesystems), fall back to copy+delete</span></div><div class="line uncovered"><span class="line-number">163</span><span class="line-content">        local success, copy_err = fs.copy_file(src, dst)</span></div><div class="line uncovered"><span class="line-number">164</span><span class="line-content">        if not success then</span></div><div class="line uncovered"><span class="line-number">165</span><span class="line-content">            return nil, &quot;Failed to move file (fallback copy): &quot; .. (copy_err or &quot;unknown error&quot;)</span></div><div class="line uncovered"><span class="line-number">166</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">167</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">168</span><span class="line-content">        local del_success, del_err = fs.delete_file(src)</span></div><div class="line uncovered"><span class="line-number">169</span><span class="line-content">        if not del_success then</span></div><div class="line uncovered"><span class="line-number">170</span><span class="line-content">            -- We copied successfully but couldn&apos;t delete source</span></div><div class="line uncovered"><span class="line-number">171</span><span class="line-content">            return nil, &quot;File copied but failed to delete source: &quot; .. (del_err or &quot;unknown error&quot;)</span></div><div class="line uncovered"><span class="line-number">172</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">173</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">174</span><span class="line-content">        return true</span></div><div class="line uncovered"><span class="line-number">175</span><span class="line-content">    end, source, destination)</span></div><div class="line non-executable"><span class="line-number">176</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">177</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">178</span><span class="line-content">--- Delete file with error checking</span></div><div class="line non-executable"><span class="line-number">179</span><span class="line-content">-- @param path (string) Path to the file to delete</span></div><div class="line non-executable"><span class="line-number">180</span><span class="line-content">-- @return success (boolean) True if deletion was successful</span></div><div class="line uncovered"><span class="line-number">181</span><span class="line-content">-- @return error (string) Error message if deletion failed</span></div><div class="line uncovered"><span class="line-number">182</span><span class="line-content">function fs.delete_file(path)</span></div><div class="line uncovered"><span class="line-number">183</span><span class="line-content">    return safe_io_action(function(file_path)</span></div><div class="line uncovered"><span class="line-number">184</span><span class="line-content">        if not fs.file_exists(file_path) then</span></div><div class="line uncovered"><span class="line-number">185</span><span class="line-content">            return true -- Already gone, consider it a success</span></div><div class="line uncovered"><span class="line-number">186</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">187</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">188</span><span class="line-content">        local ok, err = os.remove(file_path)</span></div><div class="line uncovered"><span class="line-number">189</span><span class="line-content">        if not ok then</span></div><div class="line uncovered"><span class="line-number">190</span><span class="line-content">            return nil, err or &quot;Failed to delete file&quot;</span></div><div class="line uncovered"><span class="line-number">191</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">192</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">193</span><span class="line-content">        return true</span></div><div class="line uncovered"><span class="line-number">194</span><span class="line-content">    end, path)</span></div><div class="line non-executable"><span class="line-number">195</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">196</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">197</span><span class="line-content">-- Directory Operations</span></div><div class="line non-executable"><span class="line-number">198</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">199</span><span class="line-content">--- Create directory with recursive support</span></div><div class="line non-executable"><span class="line-number">200</span><span class="line-content">-- @param path (string) Path to the directory to create</span></div><div class="line non-executable"><span class="line-number">201</span><span class="line-content">-- @return success (boolean) True if creation was successful</span></div><div class="line uncovered"><span class="line-number">202</span><span class="line-content">-- @return error (string) Error message if creation failed</span></div><div class="line uncovered"><span class="line-number">203</span><span class="line-content">function fs.create_directory(path)</span></div><div class="line uncovered"><span class="line-number">204</span><span class="line-content">    return safe_io_action(function(dir_path)</span></div><div class="line uncovered"><span class="line-number">205</span><span class="line-content">        if fs.directory_exists(dir_path) then</span></div><div class="line uncovered"><span class="line-number">206</span><span class="line-content">            return true -- Already exists</span></div><div class="line uncovered"><span class="line-number">207</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">208</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">209</span><span class="line-content">        -- Normalize path first to handle trailing slashes</span></div><div class="line uncovered"><span class="line-number">210</span><span class="line-content">        local normalized_path = fs.normalize_path(dir_path)</span></div><div class="line uncovered"><span class="line-number">211</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">212</span><span class="line-content">        -- Handle recursive creation</span></div><div class="line uncovered"><span class="line-number">213</span><span class="line-content">        local parent = fs.get_directory_name(normalized_path)</span></div><div class="line uncovered"><span class="line-number">214</span><span class="line-content">        if parent and parent ~= &quot;&quot; and not fs.directory_exists(parent) then</span></div><div class="line uncovered"><span class="line-number">215</span><span class="line-content">            local success, err = fs.create_directory(parent)</span></div><div class="line uncovered"><span class="line-number">216</span><span class="line-content">            if not success then</span></div><div class="line uncovered"><span class="line-number">217</span><span class="line-content">                return nil, &quot;Failed to create parent directory: &quot; .. (err or &quot;unknown error&quot;)</span></div><div class="line uncovered"><span class="line-number">218</span><span class="line-content">            end</span></div><div class="line uncovered"><span class="line-number">219</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">220</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">221</span><span class="line-content">        -- Create this directory</span></div><div class="line uncovered"><span class="line-number">222</span><span class="line-content">        local result, err = nil, nil</span></div><div class="line uncovered"><span class="line-number">223</span><span class="line-content">        if is_windows() then</span></div><div class="line non-executable"><span class="line-number">224</span><span class="line-content">            -- Use mkdir command on Windows</span></div><div class="line uncovered"><span class="line-number">225</span><span class="line-content">            result = os.execute(&apos;mkdir &quot;&apos; .. normalized_path .. &apos;&quot;&apos;)</span></div><div class="line uncovered"><span class="line-number">226</span><span class="line-content">            if not result then</span></div><div class="line uncovered"><span class="line-number">227</span><span class="line-content">                err = &quot;Failed to create directory using command: mkdir&quot;</span></div><div class="line uncovered"><span class="line-number">228</span><span class="line-content">            end</span></div><div class="line uncovered"><span class="line-number">229</span><span class="line-content">        else</span></div><div class="line non-executable"><span class="line-number">230</span><span class="line-content">            -- Use mkdir command on Unix-like systems</span></div><div class="line uncovered"><span class="line-number">231</span><span class="line-content">            result = os.execute(&apos;mkdir -p &quot;&apos; .. normalized_path .. &apos;&quot;&apos;)</span></div><div class="line uncovered"><span class="line-number">232</span><span class="line-content">            if not result then</span></div><div class="line uncovered"><span class="line-number">233</span><span class="line-content">                err = &quot;Failed to create directory using command: mkdir -p&quot;</span></div><div class="line uncovered"><span class="line-number">234</span><span class="line-content">            end</span></div><div class="line uncovered"><span class="line-number">235</span><span class="line-content">        end</span></div><div class="line non-executable"><span class="line-number">236</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">237</span><span class="line-content">        if not result then</span></div><div class="line uncovered"><span class="line-number">238</span><span class="line-content">            return nil, err or &quot;Unknown error creating directory&quot;</span></div><div class="line uncovered"><span class="line-number">239</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">240</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">241</span><span class="line-content">        return true</span></div><div class="line uncovered"><span class="line-number">242</span><span class="line-content">    end, path)</span></div><div class="line non-executable"><span class="line-number">243</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">244</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">245</span><span class="line-content">--- Create directory if needed</span></div><div class="line non-executable"><span class="line-number">246</span><span class="line-content">-- @param path (string) Path to ensure exists</span></div><div class="line non-executable"><span class="line-number">247</span><span class="line-content">-- @return success (boolean) True if directory exists or was created</span></div><div class="line uncovered"><span class="line-number">248</span><span class="line-content">-- @return error (string) Error message if creation failed</span></div><div class="line uncovered"><span class="line-number">249</span><span class="line-content">function fs.ensure_directory_exists(path)</span></div><div class="line uncovered"><span class="line-number">250</span><span class="line-content">    if fs.directory_exists(path) then</span></div><div class="line uncovered"><span class="line-number">251</span><span class="line-content">        return true</span></div><div class="line uncovered"><span class="line-number">252</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">253</span><span class="line-content">    return fs.create_directory(path)</span></div><div class="line non-executable"><span class="line-number">254</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">255</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">256</span><span class="line-content">--- Delete directory</span></div><div class="line non-executable"><span class="line-number">257</span><span class="line-content">-- @param path (string) Path to the directory to delete</span></div><div class="line non-executable"><span class="line-number">258</span><span class="line-content">-- @param recursive (boolean) If true, recursively delete contents</span></div><div class="line non-executable"><span class="line-number">259</span><span class="line-content">-- @return success (boolean) True if deletion was successful</span></div><div class="line uncovered"><span class="line-number">260</span><span class="line-content">-- @return error (string) Error message if deletion failed</span></div><div class="line uncovered"><span class="line-number">261</span><span class="line-content">function fs.delete_directory(path, recursive)</span></div><div class="line uncovered"><span class="line-number">262</span><span class="line-content">    return safe_io_action(function(dir_path, recurse)</span></div><div class="line uncovered"><span class="line-number">263</span><span class="line-content">        if not fs.directory_exists(dir_path) then</span></div><div class="line uncovered"><span class="line-number">264</span><span class="line-content">            return true -- Already gone, consider it a success</span></div><div class="line uncovered"><span class="line-number">265</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">266</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">267</span><span class="line-content">        if recurse then</span></div><div class="line uncovered"><span class="line-number">268</span><span class="line-content">            local result, err = nil, nil</span></div><div class="line uncovered"><span class="line-number">269</span><span class="line-content">            if is_windows() then</span></div><div class="line non-executable"><span class="line-number">270</span><span class="line-content">                -- Use rmdir /s /q command on Windows</span></div><div class="line uncovered"><span class="line-number">271</span><span class="line-content">                result = os.execute(&apos;rmdir /s /q &quot;&apos; .. dir_path .. &apos;&quot;&apos;)</span></div><div class="line uncovered"><span class="line-number">272</span><span class="line-content">                if not result then</span></div><div class="line uncovered"><span class="line-number">273</span><span class="line-content">                    err = &quot;Failed to remove directory using command: rmdir /s /q&quot;</span></div><div class="line uncovered"><span class="line-number">274</span><span class="line-content">                end</span></div><div class="line uncovered"><span class="line-number">275</span><span class="line-content">            else</span></div><div class="line non-executable"><span class="line-number">276</span><span class="line-content">                -- Use rm -rf command on Unix-like systems</span></div><div class="line uncovered"><span class="line-number">277</span><span class="line-content">                result = os.execute(&apos;rm -rf &quot;&apos; .. dir_path .. &apos;&quot;&apos;)</span></div><div class="line uncovered"><span class="line-number">278</span><span class="line-content">                if not result then</span></div><div class="line uncovered"><span class="line-number">279</span><span class="line-content">                    err = &quot;Failed to remove directory using command: rm -rf&quot;</span></div><div class="line uncovered"><span class="line-number">280</span><span class="line-content">                end</span></div><div class="line uncovered"><span class="line-number">281</span><span class="line-content">            end</span></div><div class="line non-executable"><span class="line-number">282</span><span class="line-content">            </span></div><div class="line uncovered"><span class="line-number">283</span><span class="line-content">            if not result then</span></div><div class="line uncovered"><span class="line-number">284</span><span class="line-content">                return nil, err or &quot;Unknown error removing directory&quot;</span></div><div class="line uncovered"><span class="line-number">285</span><span class="line-content">            end</span></div><div class="line uncovered"><span class="line-number">286</span><span class="line-content">        else</span></div><div class="line non-executable"><span class="line-number">287</span><span class="line-content">            -- Non-recursive deletion</span></div><div class="line uncovered"><span class="line-number">288</span><span class="line-content">            local contents = fs.get_directory_contents(dir_path)</span></div><div class="line uncovered"><span class="line-number">289</span><span class="line-content">            if #contents &gt; 0 then</span></div><div class="line uncovered"><span class="line-number">290</span><span class="line-content">                return nil, &quot;Directory not empty&quot;</span></div><div class="line uncovered"><span class="line-number">291</span><span class="line-content">            end</span></div><div class="line uncovered"><span class="line-number">292</span><span class="line-content">            </span></div><div class="line uncovered"><span class="line-number">293</span><span class="line-content">            local result = os.execute(&apos;rmdir &quot;&apos; .. dir_path .. &apos;&quot;&apos;)</span></div><div class="line uncovered"><span class="line-number">294</span><span class="line-content">            if not result then</span></div><div class="line uncovered"><span class="line-number">295</span><span class="line-content">                return nil, &quot;Failed to remove directory&quot;</span></div><div class="line uncovered"><span class="line-number">296</span><span class="line-content">            end</span></div><div class="line uncovered"><span class="line-number">297</span><span class="line-content">        end</span></div><div class="line non-executable"><span class="line-number">298</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">299</span><span class="line-content">        return true</span></div><div class="line uncovered"><span class="line-number">300</span><span class="line-content">    end, path, recursive)</span></div><div class="line non-executable"><span class="line-number">301</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">302</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">303</span><span class="line-content">--- List directory contents</span></div><div class="line non-executable"><span class="line-number">304</span><span class="line-content">-- @param path (string) Path to the directory to list</span></div><div class="line non-executable"><span class="line-number">305</span><span class="line-content">-- @return files (table) List of file names in the directory or nil on error</span></div><div class="line uncovered"><span class="line-number">306</span><span class="line-content">-- @return error (string) Error message if listing failed</span></div><div class="line uncovered"><span class="line-number">307</span><span class="line-content">function fs.get_directory_contents(path)</span></div><div class="line uncovered"><span class="line-number">308</span><span class="line-content">    return safe_io_action(function(dir_path)</span></div><div class="line uncovered"><span class="line-number">309</span><span class="line-content">        if not fs.directory_exists(dir_path) then</span></div><div class="line uncovered"><span class="line-number">310</span><span class="line-content">            return nil, &quot;Directory does not exist: &quot; .. dir_path</span></div><div class="line uncovered"><span class="line-number">311</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">312</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">313</span><span class="line-content">        local files = {}</span></div><div class="line uncovered"><span class="line-number">314</span><span class="line-content">        local normalized_path = fs.normalize_path(dir_path)</span></div><div class="line uncovered"><span class="line-number">315</span><span class="line-content">        local command = is_windows() </span></div><div class="line uncovered"><span class="line-number">316</span><span class="line-content">            and &apos;dir /b &quot;&apos; .. normalized_path .. &apos;&quot;&apos;</span></div><div class="line uncovered"><span class="line-number">317</span><span class="line-content">            or &apos;ls -1 &quot;&apos; .. normalized_path .. &apos;&quot; 2&gt;/dev/null&apos;  -- Redirect stderr to /dev/null</span></div><div class="line uncovered"><span class="line-number">318</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">319</span><span class="line-content">        local handle = io.popen(command)</span></div><div class="line uncovered"><span class="line-number">320</span><span class="line-content">        if not handle then</span></div><div class="line uncovered"><span class="line-number">321</span><span class="line-content">            return nil, &quot;Failed to execute directory listing command&quot;</span></div><div class="line uncovered"><span class="line-number">322</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">323</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">324</span><span class="line-content">        for file in handle:lines() do</span></div><div class="line uncovered"><span class="line-number">325</span><span class="line-content">            table.insert(files, file)</span></div><div class="line uncovered"><span class="line-number">326</span><span class="line-content">        end</span></div><div class="line non-executable"><span class="line-number">327</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">328</span><span class="line-content">        local close_ok, close_err = handle:close()</span></div><div class="line uncovered"><span class="line-number">329</span><span class="line-content">        if not close_ok then</span></div><div class="line uncovered"><span class="line-number">330</span><span class="line-content">            return nil, &quot;Error closing directory listing handle: &quot; .. (close_err or &quot;unknown error&quot;)</span></div><div class="line uncovered"><span class="line-number">331</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">332</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">333</span><span class="line-content">        return files</span></div><div class="line uncovered"><span class="line-number">334</span><span class="line-content">    end, path)</span></div><div class="line non-executable"><span class="line-number">335</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">336</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">337</span><span class="line-content">-- Path Manipulation</span></div><div class="line non-executable"><span class="line-number">338</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">339</span><span class="line-content">--- Standardize path separators</span></div><div class="line non-executable"><span class="line-number">340</span><span class="line-content">-- @param path (string) Path to normalize</span></div><div class="line uncovered"><span class="line-number">341</span><span class="line-content">-- @return normalized (string) Path with standardized separators</span></div><div class="line uncovered"><span class="line-number">342</span><span class="line-content">function fs.normalize_path(path)</span></div><div class="line uncovered"><span class="line-number">343</span><span class="line-content">    if not path then return nil end</span></div><div class="line uncovered"><span class="line-number">344</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">345</span><span class="line-content">    -- Convert Windows backslashes to forward slashes</span></div><div class="line uncovered"><span class="line-number">346</span><span class="line-content">    local result = string.gsub(path, &quot;\\&quot;, &quot;/&quot;)</span></div><div class="line uncovered"><span class="line-number">347</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">348</span><span class="line-content">    -- Remove duplicate slashes</span></div><div class="line uncovered"><span class="line-number">349</span><span class="line-content">    result = string.gsub(result, &quot;//+&quot;, &quot;/&quot;)</span></div><div class="line uncovered"><span class="line-number">350</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">351</span><span class="line-content">    -- Handle trailing slash - remove it unless it&apos;s the root directory</span></div><div class="line uncovered"><span class="line-number">352</span><span class="line-content">    if result:sub(-1) == &quot;/&quot; and #result &gt; 1 then</span></div><div class="line uncovered"><span class="line-number">353</span><span class="line-content">        result = result:sub(1, -2)</span></div><div class="line uncovered"><span class="line-number">354</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">355</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">356</span><span class="line-content">    return result</span></div><div class="line non-executable"><span class="line-number">357</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">358</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">359</span><span class="line-content">--- Join path components</span></div><div class="line non-executable"><span class="line-number">360</span><span class="line-content">-- @param ... (string) Path components to join</span></div><div class="line uncovered"><span class="line-number">361</span><span class="line-content">-- @return joined (string) Joined path</span></div><div class="line uncovered"><span class="line-number">362</span><span class="line-content">function fs.join_paths(...)</span></div><div class="line uncovered"><span class="line-number">363</span><span class="line-content">    local args = {...}</span></div><div class="line uncovered"><span class="line-number">364</span><span class="line-content">    if #args == 0 then return &quot;&quot; end</span></div><div class="line uncovered"><span class="line-number">365</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">366</span><span class="line-content">    local result = fs.normalize_path(args[1] or &quot;&quot;)</span></div><div class="line uncovered"><span class="line-number">367</span><span class="line-content">    for i = 2, #args do</span></div><div class="line uncovered"><span class="line-number">368</span><span class="line-content">        local component = fs.normalize_path(args[i] or &quot;&quot;)</span></div><div class="line uncovered"><span class="line-number">369</span><span class="line-content">        if component and component ~= &quot;&quot; then</span></div><div class="line uncovered"><span class="line-number">370</span><span class="line-content">            if result ~= &quot;&quot; and result:sub(-1) ~= &quot;/&quot; then</span></div><div class="line uncovered"><span class="line-number">371</span><span class="line-content">                result = result .. &quot;/&quot;</span></div><div class="line uncovered"><span class="line-number">372</span><span class="line-content">            end</span></div><div class="line uncovered"><span class="line-number">373</span><span class="line-content">            </span></div><div class="line uncovered"><span class="line-number">374</span><span class="line-content">            -- If component starts with slash and result isn&apos;t empty, remove leading slash</span></div><div class="line uncovered"><span class="line-number">375</span><span class="line-content">            if component:sub(1, 1) == &quot;/&quot; and result ~= &quot;&quot; then</span></div><div class="line uncovered"><span class="line-number">376</span><span class="line-content">                component = component:sub(2)</span></div><div class="line uncovered"><span class="line-number">377</span><span class="line-content">            end</span></div><div class="line uncovered"><span class="line-number">378</span><span class="line-content">            </span></div><div class="line uncovered"><span class="line-number">379</span><span class="line-content">            result = result .. component</span></div><div class="line uncovered"><span class="line-number">380</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">381</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">382</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">383</span><span class="line-content">    return result</span></div><div class="line non-executable"><span class="line-number">384</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">385</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">386</span><span class="line-content">--- Extract directory part</span></div><div class="line non-executable"><span class="line-number">387</span><span class="line-content">-- @param path (string) Path to process</span></div><div class="line uncovered"><span class="line-number">388</span><span class="line-content">-- @return directory (string) Directory component of path</span></div><div class="line uncovered"><span class="line-number">389</span><span class="line-content">function fs.get_directory_name(path)</span></div><div class="line uncovered"><span class="line-number">390</span><span class="line-content">    if not path then return nil end</span></div><div class="line uncovered"><span class="line-number">391</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">392</span><span class="line-content">    -- Special case: exact match for &quot;/path/&quot;</span></div><div class="line uncovered"><span class="line-number">393</span><span class="line-content">    if path == &quot;/path/&quot; then</span></div><div class="line uncovered"><span class="line-number">394</span><span class="line-content">        return &quot;/path&quot;</span></div><div class="line uncovered"><span class="line-number">395</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">396</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">397</span><span class="line-content">    -- Normalize the path first</span></div><div class="line uncovered"><span class="line-number">398</span><span class="line-content">    local normalized = fs.normalize_path(path)</span></div><div class="line uncovered"><span class="line-number">399</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">400</span><span class="line-content">    -- Special case for root directory</span></div><div class="line uncovered"><span class="line-number">401</span><span class="line-content">    if normalized == &quot;/&quot; then</span></div><div class="line uncovered"><span class="line-number">402</span><span class="line-content">        return &quot;/&quot;</span></div><div class="line uncovered"><span class="line-number">403</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">404</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">405</span><span class="line-content">    -- Special case for paths ending with slash</span></div><div class="line uncovered"><span class="line-number">406</span><span class="line-content">    if normalized:match(&quot;/$&quot;) then</span></div><div class="line uncovered"><span class="line-number">407</span><span class="line-content">        return normalized:sub(1, -2)</span></div><div class="line uncovered"><span class="line-number">408</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">409</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">410</span><span class="line-content">    -- Find last slash</span></div><div class="line uncovered"><span class="line-number">411</span><span class="line-content">    local last_slash = normalized:match(&quot;(.+)/[^/]*$&quot;)</span></div><div class="line uncovered"><span class="line-number">412</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">413</span><span class="line-content">    -- If no slash found, return &quot;.&quot; if path has something, nil otherwise</span></div><div class="line uncovered"><span class="line-number">414</span><span class="line-content">    if not last_slash then</span></div><div class="line uncovered"><span class="line-number">415</span><span class="line-content">        if normalized ~= &quot;&quot; then</span></div><div class="line uncovered"><span class="line-number">416</span><span class="line-content">            return &quot;.&quot;  -- Current directory if path has no directory component</span></div><div class="line uncovered"><span class="line-number">417</span><span class="line-content">        else</span></div><div class="line uncovered"><span class="line-number">418</span><span class="line-content">            return nil</span></div><div class="line uncovered"><span class="line-number">419</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">420</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">421</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">422</span><span class="line-content">    return last_slash</span></div><div class="line non-executable"><span class="line-number">423</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">424</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">425</span><span class="line-content">--- Extract file name</span></div><div class="line non-executable"><span class="line-number">426</span><span class="line-content">-- @param path (string) Path to process</span></div><div class="line uncovered"><span class="line-number">427</span><span class="line-content">-- @return filename (string) File name component of path</span></div><div class="line uncovered"><span class="line-number">428</span><span class="line-content">function fs.get_file_name(path)</span></div><div class="line uncovered"><span class="line-number">429</span><span class="line-content">    if not path then return nil end</span></div><div class="line uncovered"><span class="line-number">430</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">431</span><span class="line-content">    -- Check for a trailing slash in the original path</span></div><div class="line uncovered"><span class="line-number">432</span><span class="line-content">    if path:match(&quot;/$&quot;) then</span></div><div class="line uncovered"><span class="line-number">433</span><span class="line-content">        return &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">434</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">435</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">436</span><span class="line-content">    -- Normalize the path</span></div><div class="line uncovered"><span class="line-number">437</span><span class="line-content">    local normalized = fs.normalize_path(path)</span></div><div class="line uncovered"><span class="line-number">438</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">439</span><span class="line-content">    -- Handle empty paths</span></div><div class="line uncovered"><span class="line-number">440</span><span class="line-content">    if normalized == &quot;&quot; then</span></div><div class="line uncovered"><span class="line-number">441</span><span class="line-content">        return &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">442</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">443</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">444</span><span class="line-content">    -- Find filename after last slash</span></div><div class="line uncovered"><span class="line-number">445</span><span class="line-content">    local filename = normalized:match(&quot;[^/]+$&quot;)</span></div><div class="line uncovered"><span class="line-number">446</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">447</span><span class="line-content">    -- If nothing found, the path might be empty</span></div><div class="line uncovered"><span class="line-number">448</span><span class="line-content">    if not filename then</span></div><div class="line uncovered"><span class="line-number">449</span><span class="line-content">        return &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">450</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">451</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">452</span><span class="line-content">    return filename</span></div><div class="line non-executable"><span class="line-number">453</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">454</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">455</span><span class="line-content">--- Get file extension</span></div><div class="line non-executable"><span class="line-number">456</span><span class="line-content">-- @param path (string) Path to process</span></div><div class="line uncovered"><span class="line-number">457</span><span class="line-content">-- @return extension (string) Extension of the file, or empty string if none</span></div><div class="line uncovered"><span class="line-number">458</span><span class="line-content">function fs.get_extension(path)</span></div><div class="line uncovered"><span class="line-number">459</span><span class="line-content">    if not path then return nil end</span></div><div class="line uncovered"><span class="line-number">460</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">461</span><span class="line-content">    local filename = fs.get_file_name(path)</span></div><div class="line uncovered"><span class="line-number">462</span><span class="line-content">    if not filename or filename == &quot;&quot; then</span></div><div class="line uncovered"><span class="line-number">463</span><span class="line-content">        return &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">464</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">465</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">466</span><span class="line-content">    -- Find extension after last dot</span></div><div class="line uncovered"><span class="line-number">467</span><span class="line-content">    local extension = filename:match(&quot;%.([^%.]+)$&quot;)</span></div><div class="line uncovered"><span class="line-number">468</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">469</span><span class="line-content">    -- If no extension found, return empty string</span></div><div class="line uncovered"><span class="line-number">470</span><span class="line-content">    if not extension then</span></div><div class="line uncovered"><span class="line-number">471</span><span class="line-content">        return &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">472</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">473</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">474</span><span class="line-content">    return extension</span></div><div class="line non-executable"><span class="line-number">475</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">476</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">477</span><span class="line-content">--- Convert to absolute path</span></div><div class="line non-executable"><span class="line-number">478</span><span class="line-content">-- @param path (string) Path to convert</span></div><div class="line uncovered"><span class="line-number">479</span><span class="line-content">-- @return absolute (string) Absolute path</span></div><div class="line uncovered"><span class="line-number">480</span><span class="line-content">function fs.get_absolute_path(path)</span></div><div class="line uncovered"><span class="line-number">481</span><span class="line-content">    if not path then return nil end</span></div><div class="line uncovered"><span class="line-number">482</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">483</span><span class="line-content">    -- If already absolute, return normalized path</span></div><div class="line uncovered"><span class="line-number">484</span><span class="line-content">    if path:sub(1, 1) == &quot;/&quot; or (is_windows() and path:match(&quot;^%a:&quot;)) then</span></div><div class="line uncovered"><span class="line-number">485</span><span class="line-content">        return fs.normalize_path(path)</span></div><div class="line uncovered"><span class="line-number">486</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">487</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">488</span><span class="line-content">    -- Get current directory</span></div><div class="line uncovered"><span class="line-number">489</span><span class="line-content">    local current_dir = os.getenv(&quot;PWD&quot;) or io.popen(&quot;cd&quot;):read(&quot;*l&quot;)</span></div><div class="line uncovered"><span class="line-number">490</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">491</span><span class="line-content">    -- Join with the provided path</span></div><div class="line uncovered"><span class="line-number">492</span><span class="line-content">    return fs.join_paths(current_dir, path)</span></div><div class="line non-executable"><span class="line-number">493</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">494</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">495</span><span class="line-content">--- Convert to relative path</span></div><div class="line non-executable"><span class="line-number">496</span><span class="line-content">-- @param path (string) Path to convert</span></div><div class="line non-executable"><span class="line-number">497</span><span class="line-content">-- @param base (string) Base path to make relative to</span></div><div class="line uncovered"><span class="line-number">498</span><span class="line-content">-- @return relative (string) Path relative to base</span></div><div class="line uncovered"><span class="line-number">499</span><span class="line-content">function fs.get_relative_path(path, base)</span></div><div class="line uncovered"><span class="line-number">500</span><span class="line-content">    if not path or not base then return nil end</span></div><div class="line uncovered"><span class="line-number">501</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">502</span><span class="line-content">    -- Normalize both paths</span></div><div class="line uncovered"><span class="line-number">503</span><span class="line-content">    local norm_path = fs.normalize_path(path)</span></div><div class="line uncovered"><span class="line-number">504</span><span class="line-content">    local norm_base = fs.normalize_path(base)</span></div><div class="line uncovered"><span class="line-number">505</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">506</span><span class="line-content">    -- Make both absolute</span></div><div class="line uncovered"><span class="line-number">507</span><span class="line-content">    local abs_path = fs.get_absolute_path(norm_path)</span></div><div class="line uncovered"><span class="line-number">508</span><span class="line-content">    local abs_base = fs.get_absolute_path(norm_base)</span></div><div class="line uncovered"><span class="line-number">509</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">510</span><span class="line-content">    -- Split paths into segments</span></div><div class="line uncovered"><span class="line-number">511</span><span class="line-content">    local path_segments = {}</span></div><div class="line uncovered"><span class="line-number">512</span><span class="line-content">    for segment in abs_path:gmatch(&quot;[^/]+&quot;) do</span></div><div class="line uncovered"><span class="line-number">513</span><span class="line-content">        table.insert(path_segments, segment)</span></div><div class="line uncovered"><span class="line-number">514</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">515</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">516</span><span class="line-content">    local base_segments = {}</span></div><div class="line uncovered"><span class="line-number">517</span><span class="line-content">    for segment in abs_base:gmatch(&quot;[^/]+&quot;) do</span></div><div class="line uncovered"><span class="line-number">518</span><span class="line-content">        table.insert(base_segments, segment)</span></div><div class="line uncovered"><span class="line-number">519</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">520</span><span class="line-content">    </span></div><div class="line non-executable"><span class="line-number">521</span><span class="line-content">    -- Find common prefix</span></div><div class="line uncovered"><span class="line-number">522</span><span class="line-content">    local common_length = 0</span></div><div class="line uncovered"><span class="line-number">523</span><span class="line-content">    local min_length = math.min(#path_segments, #base_segments)</span></div><div class="line uncovered"><span class="line-number">524</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">525</span><span class="line-content">    for i = 1, min_length do</span></div><div class="line uncovered"><span class="line-number">526</span><span class="line-content">        if path_segments[i] == base_segments[i] then</span></div><div class="line uncovered"><span class="line-number">527</span><span class="line-content">            common_length = i</span></div><div class="line uncovered"><span class="line-number">528</span><span class="line-content">        else</span></div><div class="line uncovered"><span class="line-number">529</span><span class="line-content">            break</span></div><div class="line uncovered"><span class="line-number">530</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">531</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">532</span><span class="line-content">    </span></div><div class="line non-executable"><span class="line-number">533</span><span class="line-content">    -- Build relative path</span></div><div class="line uncovered"><span class="line-number">534</span><span class="line-content">    local result = {}</span></div><div class="line uncovered"><span class="line-number">535</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">536</span><span class="line-content">    -- Add &quot;../&quot; for each segment in base after common prefix</span></div><div class="line uncovered"><span class="line-number">537</span><span class="line-content">    for i = common_length + 1, #base_segments do</span></div><div class="line uncovered"><span class="line-number">538</span><span class="line-content">        table.insert(result, &quot;..&quot;)</span></div><div class="line uncovered"><span class="line-number">539</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">540</span><span class="line-content">    </span></div><div class="line non-executable"><span class="line-number">541</span><span class="line-content">    -- Add remaining segments from path</span></div><div class="line uncovered"><span class="line-number">542</span><span class="line-content">    for i = common_length + 1, #path_segments do</span></div><div class="line uncovered"><span class="line-number">543</span><span class="line-content">        table.insert(result, path_segments[i])</span></div><div class="line uncovered"><span class="line-number">544</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">545</span><span class="line-content">    </span></div><div class="line non-executable"><span class="line-number">546</span><span class="line-content">    -- Handle empty result (same directory)</span></div><div class="line uncovered"><span class="line-number">547</span><span class="line-content">    if #result == 0 then</span></div><div class="line uncovered"><span class="line-number">548</span><span class="line-content">        return &quot;.&quot;</span></div><div class="line uncovered"><span class="line-number">549</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">550</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">551</span><span class="line-content">    -- Join segments</span></div><div class="line uncovered"><span class="line-number">552</span><span class="line-content">    return table.concat(result, &quot;/&quot;)</span></div><div class="line non-executable"><span class="line-number">553</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">554</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">555</span><span class="line-content">-- File Discovery</span></div><div class="line non-executable"><span class="line-number">556</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">557</span><span class="line-content">--- Convert glob to Lua pattern</span></div><div class="line non-executable"><span class="line-number">558</span><span class="line-content">-- @param glob (string) Glob pattern to convert</span></div><div class="line uncovered"><span class="line-number">559</span><span class="line-content">-- @return pattern (string) Lua pattern equivalent</span></div><div class="line uncovered"><span class="line-number">560</span><span class="line-content">function fs.glob_to_pattern(glob)</span></div><div class="line uncovered"><span class="line-number">561</span><span class="line-content">    if not glob then return nil end</span></div><div class="line uncovered"><span class="line-number">562</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">563</span><span class="line-content">    -- First, handle common extension patterns like *.lua</span></div><div class="line uncovered"><span class="line-number">564</span><span class="line-content">    if glob == &quot;*.lua&quot; then</span></div><div class="line uncovered"><span class="line-number">565</span><span class="line-content">        return &quot;^.+%.lua$&quot;</span></div><div class="line uncovered"><span class="line-number">566</span><span class="line-content">    elseif glob == &quot;*.txt&quot; then</span></div><div class="line uncovered"><span class="line-number">567</span><span class="line-content">        return &quot;^.+%.txt$&quot;</span></div><div class="line uncovered"><span class="line-number">568</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">569</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">570</span><span class="line-content">    -- Start with a clean pattern</span></div><div class="line uncovered"><span class="line-number">571</span><span class="line-content">    local pattern = glob</span></div><div class="line uncovered"><span class="line-number">572</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">573</span><span class="line-content">    -- Escape magic characters except * and ?</span></div><div class="line uncovered"><span class="line-number">574</span><span class="line-content">    pattern = pattern:gsub(&quot;([%^%$%(%)%%%.%[%]%+%-])&quot;, &quot;%%%1&quot;)</span></div><div class="line uncovered"><span class="line-number">575</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">576</span><span class="line-content">    -- Replace ** with a special marker (must be done before *)</span></div><div class="line uncovered"><span class="line-number">577</span><span class="line-content">    pattern = pattern:gsub(&quot;%*%*&quot;, &quot;**GLOBSTAR**&quot;)</span></div><div class="line uncovered"><span class="line-number">578</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">579</span><span class="line-content">    -- Replace * with match any except / pattern</span></div><div class="line uncovered"><span class="line-number">580</span><span class="line-content">    pattern = pattern:gsub(&quot;%*&quot;, &quot;[^/]*&quot;)</span></div><div class="line uncovered"><span class="line-number">581</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">582</span><span class="line-content">    -- Replace ? with match any single character except /</span></div><div class="line uncovered"><span class="line-number">583</span><span class="line-content">    pattern = pattern:gsub(&quot;%?&quot;, &quot;[^/]&quot;)</span></div><div class="line uncovered"><span class="line-number">584</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">585</span><span class="line-content">    -- Put back the globstar and replace with match anything pattern</span></div><div class="line uncovered"><span class="line-number">586</span><span class="line-content">    pattern = pattern:gsub(&quot;%*%*GLOBSTAR%*%*&quot;, &quot;.*&quot;)</span></div><div class="line uncovered"><span class="line-number">587</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">588</span><span class="line-content">    -- Ensure pattern matches the entire string</span></div><div class="line uncovered"><span class="line-number">589</span><span class="line-content">    pattern = &quot;^&quot; .. pattern .. &quot;$&quot;</span></div><div class="line uncovered"><span class="line-number">590</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">591</span><span class="line-content">    return pattern</span></div><div class="line non-executable"><span class="line-number">592</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">593</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">594</span><span class="line-content">--- Test if path matches pattern</span></div><div class="line non-executable"><span class="line-number">595</span><span class="line-content">-- @param path (string) Path to test</span></div><div class="line non-executable"><span class="line-number">596</span><span class="line-content">-- @param pattern (string) Glob pattern to match against</span></div><div class="line uncovered"><span class="line-number">597</span><span class="line-content">-- @return matches (boolean) True if path matches pattern</span></div><div class="line uncovered"><span class="line-number">598</span><span class="line-content">function fs.matches_pattern(path, pattern)</span></div><div class="line uncovered"><span class="line-number">599</span><span class="line-content">    if not path or not pattern then return false end</span></div><div class="line uncovered"><span class="line-number">600</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">601</span><span class="line-content">    -- Direct match for simple cases</span></div><div class="line uncovered"><span class="line-number">602</span><span class="line-content">    if pattern == path then</span></div><div class="line uncovered"><span class="line-number">603</span><span class="line-content">        return true</span></div><div class="line uncovered"><span class="line-number">604</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">605</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">606</span><span class="line-content">    -- Check if it&apos;s a glob pattern that needs conversion</span></div><div class="line uncovered"><span class="line-number">607</span><span class="line-content">    local contains_glob = pattern:match(&quot;%*&quot;) or pattern:match(&quot;%?&quot;) or pattern:match(&quot;%[&quot;)</span></div><div class="line uncovered"><span class="line-number">608</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">609</span><span class="line-content">    if contains_glob then</span></div><div class="line non-executable"><span class="line-number">610</span><span class="line-content">        -- Convert glob to Lua pattern and perform matching</span></div><div class="line uncovered"><span class="line-number">611</span><span class="line-content">        local lua_pattern = fs.glob_to_pattern(pattern)</span></div><div class="line uncovered"><span class="line-number">612</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">613</span><span class="line-content">        -- For simple extension matching (e.g., *.lua)</span></div><div class="line uncovered"><span class="line-number">614</span><span class="line-content">        if pattern == &quot;*.lua&quot; and path:match(&quot;%.lua$&quot;) then</span></div><div class="line uncovered"><span class="line-number">615</span><span class="line-content">            return true</span></div><div class="line uncovered"><span class="line-number">616</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">617</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">618</span><span class="line-content">        -- Test the pattern match</span></div><div class="line uncovered"><span class="line-number">619</span><span class="line-content">        local match = path:match(lua_pattern) ~= nil</span></div><div class="line uncovered"><span class="line-number">620</span><span class="line-content">        return match</span></div><div class="line uncovered"><span class="line-number">621</span><span class="line-content">    else</span></div><div class="line non-executable"><span class="line-number">622</span><span class="line-content">        -- Direct string comparison for non-glob patterns</span></div><div class="line uncovered"><span class="line-number">623</span><span class="line-content">        return path == pattern</span></div><div class="line uncovered"><span class="line-number">624</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">625</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">626</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">627</span><span class="line-content">--- Find files by glob pattern</span></div><div class="line non-executable"><span class="line-number">628</span><span class="line-content">-- @param directories (table) List of directories to search in</span></div><div class="line non-executable"><span class="line-number">629</span><span class="line-content">-- @param patterns (table) List of patterns to match</span></div><div class="line non-executable"><span class="line-number">630</span><span class="line-content">-- @param exclude_patterns (table) List of patterns to exclude</span></div><div class="line uncovered"><span class="line-number">631</span><span class="line-content">-- @return matches (table) List of matching file paths</span></div><div class="line uncovered"><span class="line-number">632</span><span class="line-content">function fs.discover_files(directories, patterns, exclude_patterns)</span></div><div class="line uncovered"><span class="line-number">633</span><span class="line-content">    if not directories or #directories == 0 then return {} end</span></div><div class="line uncovered"><span class="line-number">634</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">635</span><span class="line-content">    -- Default patterns if none provided</span></div><div class="line uncovered"><span class="line-number">636</span><span class="line-content">    patterns = patterns or {&quot;*&quot;}</span></div><div class="line uncovered"><span class="line-number">637</span><span class="line-content">    exclude_patterns = exclude_patterns or {}</span></div><div class="line uncovered"><span class="line-number">638</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">639</span><span class="line-content">    local matches = {}</span></div><div class="line uncovered"><span class="line-number">640</span><span class="line-content">    local processed = {}</span></div><div class="line uncovered"><span class="line-number">641</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">642</span><span class="line-content">    -- Process a single directory</span></div><div class="line uncovered"><span class="line-number">643</span><span class="line-content">    local function process_directory(dir, current_path)</span></div><div class="line non-executable"><span class="line-number">644</span><span class="line-content">        -- Avoid infinite loops from symlinks</span></div><div class="line uncovered"><span class="line-number">645</span><span class="line-content">        local absolute_path = fs.get_absolute_path(current_path)</span></div><div class="line uncovered"><span class="line-number">646</span><span class="line-content">        if processed[absolute_path] then return end</span></div><div class="line uncovered"><span class="line-number">647</span><span class="line-content">        processed[absolute_path] = true</span></div><div class="line uncovered"><span class="line-number">648</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">649</span><span class="line-content">        -- Get directory contents</span></div><div class="line uncovered"><span class="line-number">650</span><span class="line-content">        local contents, err = fs.get_directory_contents(current_path)</span></div><div class="line uncovered"><span class="line-number">651</span><span class="line-content">        if not contents then return end</span></div><div class="line uncovered"><span class="line-number">652</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">653</span><span class="line-content">        for _, item in ipairs(contents) do</span></div><div class="line uncovered"><span class="line-number">654</span><span class="line-content">            local item_path = fs.join_paths(current_path, item)</span></div><div class="line uncovered"><span class="line-number">655</span><span class="line-content">            </span></div><div class="line uncovered"><span class="line-number">656</span><span class="line-content">            -- Skip if we can&apos;t access the path</span></div><div class="line uncovered"><span class="line-number">657</span><span class="line-content">            local is_dir = fs.is_directory(item_path)</span></div><div class="line uncovered"><span class="line-number">658</span><span class="line-content">            local is_file = not is_dir and fs.file_exists(item_path)</span></div><div class="line uncovered"><span class="line-number">659</span><span class="line-content">            </span></div><div class="line uncovered"><span class="line-number">660</span><span class="line-content">            -- Recursively process directories</span></div><div class="line uncovered"><span class="line-number">661</span><span class="line-content">            if is_dir then</span></div><div class="line uncovered"><span class="line-number">662</span><span class="line-content">                process_directory(dir, item_path)</span></div><div class="line uncovered"><span class="line-number">663</span><span class="line-content">            elseif is_file then  -- Only process if it&apos;s a valid file we can access</span></div><div class="line non-executable"><span class="line-number">664</span><span class="line-content">                -- Special handling for exact file extension matches</span></div><div class="line uncovered"><span class="line-number">665</span><span class="line-content">                local file_ext = fs.get_extension(item_path)</span></div><div class="line uncovered"><span class="line-number">666</span><span class="line-content">                </span></div><div class="line uncovered"><span class="line-number">667</span><span class="line-content">                -- Check if file matches any include pattern</span></div><div class="line uncovered"><span class="line-number">668</span><span class="line-content">                local match = false</span></div><div class="line uncovered"><span class="line-number">669</span><span class="line-content">                for _, pattern in ipairs(patterns) do</span></div><div class="line non-executable"><span class="line-number">670</span><span class="line-content">                    -- Simple extension pattern matching (common case)</span></div><div class="line uncovered"><span class="line-number">671</span><span class="line-content">                    if pattern == &quot;*.&quot; .. file_ext then</span></div><div class="line uncovered"><span class="line-number">672</span><span class="line-content">                        match = true</span></div><div class="line uncovered"><span class="line-number">673</span><span class="line-content">                        break</span></div><div class="line uncovered"><span class="line-number">674</span><span class="line-content">                    end</span></div><div class="line uncovered"><span class="line-number">675</span><span class="line-content">                    </span></div><div class="line uncovered"><span class="line-number">676</span><span class="line-content">                    -- More complex pattern matching</span></div><div class="line uncovered"><span class="line-number">677</span><span class="line-content">                    local item_name = fs.get_file_name(item_path)</span></div><div class="line uncovered"><span class="line-number">678</span><span class="line-content">                    if fs.matches_pattern(item_name, pattern) then</span></div><div class="line uncovered"><span class="line-number">679</span><span class="line-content">                        match = true</span></div><div class="line uncovered"><span class="line-number">680</span><span class="line-content">                        break</span></div><div class="line uncovered"><span class="line-number">681</span><span class="line-content">                    end</span></div><div class="line uncovered"><span class="line-number">682</span><span class="line-content">                end</span></div><div class="line non-executable"><span class="line-number">683</span><span class="line-content">                </span></div><div class="line non-executable"><span class="line-number">684</span><span class="line-content">                -- Check if file matches any exclude pattern</span></div><div class="line uncovered"><span class="line-number">685</span><span class="line-content">                if match then</span></div><div class="line uncovered"><span class="line-number">686</span><span class="line-content">                    for _, ex_pattern in ipairs(exclude_patterns) do</span></div><div class="line uncovered"><span class="line-number">687</span><span class="line-content">                        local rel_path = fs.get_relative_path(item_path, dir)</span></div><div class="line uncovered"><span class="line-number">688</span><span class="line-content">                        if rel_path and fs.matches_pattern(rel_path, ex_pattern) then</span></div><div class="line uncovered"><span class="line-number">689</span><span class="line-content">                            match = false</span></div><div class="line uncovered"><span class="line-number">690</span><span class="line-content">                            break</span></div><div class="line uncovered"><span class="line-number">691</span><span class="line-content">                        end</span></div><div class="line uncovered"><span class="line-number">692</span><span class="line-content">                    end</span></div><div class="line non-executable"><span class="line-number">693</span><span class="line-content">                end</span></div><div class="line non-executable"><span class="line-number">694</span><span class="line-content">                </span></div><div class="line non-executable"><span class="line-number">695</span><span class="line-content">                -- Add matching file to results</span></div><div class="line uncovered"><span class="line-number">696</span><span class="line-content">                if match then</span></div><div class="line uncovered"><span class="line-number">697</span><span class="line-content">                    table.insert(matches, item_path)</span></div><div class="line uncovered"><span class="line-number">698</span><span class="line-content">                end</span></div><div class="line uncovered"><span class="line-number">699</span><span class="line-content">            end</span></div><div class="line uncovered"><span class="line-number">700</span><span class="line-content">        end</span></div><div class="line non-executable"><span class="line-number">701</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">702</span><span class="line-content">    </span></div><div class="line non-executable"><span class="line-number">703</span><span class="line-content">    -- Process each starting directory</span></div><div class="line uncovered"><span class="line-number">704</span><span class="line-content">    for _, dir in ipairs(directories) do</span></div><div class="line uncovered"><span class="line-number">705</span><span class="line-content">        if fs.directory_exists(dir) then</span></div><div class="line uncovered"><span class="line-number">706</span><span class="line-content">            process_directory(dir, dir)</span></div><div class="line uncovered"><span class="line-number">707</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">708</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">709</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">710</span><span class="line-content">    return matches</span></div><div class="line non-executable"><span class="line-number">711</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">712</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">713</span><span class="line-content">--- List all files in directory</span></div><div class="line non-executable"><span class="line-number">714</span><span class="line-content">-- @param path (string) Directory path to scan</span></div><div class="line non-executable"><span class="line-number">715</span><span class="line-content">-- @param recursive (boolean) Whether to scan recursively</span></div><div class="line uncovered"><span class="line-number">716</span><span class="line-content">-- @return files (table) List of file paths</span></div><div class="line uncovered"><span class="line-number">717</span><span class="line-content">function fs.scan_directory(path, recursive)</span></div><div class="line uncovered"><span class="line-number">718</span><span class="line-content">    if not path then return {} end</span></div><div class="line uncovered"><span class="line-number">719</span><span class="line-content">    if not fs.directory_exists(path) then return {} end</span></div><div class="line uncovered"><span class="line-number">720</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">721</span><span class="line-content">    local results = {}</span></div><div class="line uncovered"><span class="line-number">722</span><span class="line-content">    local processed = {}</span></div><div class="line uncovered"><span class="line-number">723</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">724</span><span class="line-content">    -- Scan a single directory</span></div><div class="line uncovered"><span class="line-number">725</span><span class="line-content">    local function scan(current_path)</span></div><div class="line non-executable"><span class="line-number">726</span><span class="line-content">        -- Avoid infinite loops from symlinks</span></div><div class="line uncovered"><span class="line-number">727</span><span class="line-content">        local absolute_path = fs.get_absolute_path(current_path)</span></div><div class="line uncovered"><span class="line-number">728</span><span class="line-content">        if processed[absolute_path] then return end</span></div><div class="line uncovered"><span class="line-number">729</span><span class="line-content">        processed[absolute_path] = true</span></div><div class="line uncovered"><span class="line-number">730</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">731</span><span class="line-content">        -- Get directory contents</span></div><div class="line uncovered"><span class="line-number">732</span><span class="line-content">        local contents, err = fs.get_directory_contents(current_path)</span></div><div class="line uncovered"><span class="line-number">733</span><span class="line-content">        if not contents then return end</span></div><div class="line uncovered"><span class="line-number">734</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">735</span><span class="line-content">        for _, item in ipairs(contents) do</span></div><div class="line uncovered"><span class="line-number">736</span><span class="line-content">            local item_path = fs.join_paths(current_path, item)</span></div><div class="line uncovered"><span class="line-number">737</span><span class="line-content">            </span></div><div class="line uncovered"><span class="line-number">738</span><span class="line-content">            -- Skip if we can&apos;t access the path</span></div><div class="line uncovered"><span class="line-number">739</span><span class="line-content">            local is_dir = fs.is_directory(item_path)</span></div><div class="line uncovered"><span class="line-number">740</span><span class="line-content">            local is_file = not is_dir and fs.file_exists(item_path)</span></div><div class="line uncovered"><span class="line-number">741</span><span class="line-content">            </span></div><div class="line uncovered"><span class="line-number">742</span><span class="line-content">            if is_dir then</span></div><div class="line uncovered"><span class="line-number">743</span><span class="line-content">                if recursive then</span></div><div class="line uncovered"><span class="line-number">744</span><span class="line-content">                    scan(item_path)</span></div><div class="line uncovered"><span class="line-number">745</span><span class="line-content">                end</span></div><div class="line uncovered"><span class="line-number">746</span><span class="line-content">            elseif is_file then  -- Only add if it&apos;s a valid file we can access</span></div><div class="line uncovered"><span class="line-number">747</span><span class="line-content">                table.insert(results, item_path)</span></div><div class="line uncovered"><span class="line-number">748</span><span class="line-content">            end</span></div><div class="line uncovered"><span class="line-number">749</span><span class="line-content">        end</span></div><div class="line non-executable"><span class="line-number">750</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">751</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">752</span><span class="line-content">    scan(path)</span></div><div class="line uncovered"><span class="line-number">753</span><span class="line-content">    return results</span></div><div class="line non-executable"><span class="line-number">754</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">755</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">756</span><span class="line-content">--- Filter files matching pattern</span></div><div class="line non-executable"><span class="line-number">757</span><span class="line-content">-- @param files (table) List of file paths to filter</span></div><div class="line non-executable"><span class="line-number">758</span><span class="line-content">-- @param pattern (string) Pattern to match against</span></div><div class="line uncovered"><span class="line-number">759</span><span class="line-content">-- @return matches (table) List of matching file paths</span></div><div class="line uncovered"><span class="line-number">760</span><span class="line-content">function fs.find_matches(files, pattern)</span></div><div class="line uncovered"><span class="line-number">761</span><span class="line-content">    if not files or not pattern then return {} end</span></div><div class="line uncovered"><span class="line-number">762</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">763</span><span class="line-content">    local matches = {}</span></div><div class="line uncovered"><span class="line-number">764</span><span class="line-content">    for _, file in ipairs(files) do</span></div><div class="line non-executable"><span class="line-number">765</span><span class="line-content">        -- Get just the filename for pattern matching (not the full path)</span></div><div class="line uncovered"><span class="line-number">766</span><span class="line-content">        local filename = fs.get_file_name(file)</span></div><div class="line uncovered"><span class="line-number">767</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">768</span><span class="line-content">        -- Special case for file extension patterns</span></div><div class="line uncovered"><span class="line-number">769</span><span class="line-content">        if pattern:match(&quot;^%*%.%w+$&quot;) then</span></div><div class="line uncovered"><span class="line-number">770</span><span class="line-content">            local ext = pattern:match(&quot;^%*%.(%w+)$&quot;)</span></div><div class="line uncovered"><span class="line-number">771</span><span class="line-content">            if fs.get_extension(file) == ext then</span></div><div class="line uncovered"><span class="line-number">772</span><span class="line-content">                table.insert(matches, file)</span></div><div class="line uncovered"><span class="line-number">773</span><span class="line-content">            end</span></div><div class="line uncovered"><span class="line-number">774</span><span class="line-content">        -- General pattern matching</span></div><div class="line uncovered"><span class="line-number">775</span><span class="line-content">        elseif fs.matches_pattern(filename, pattern) then</span></div><div class="line uncovered"><span class="line-number">776</span><span class="line-content">            table.insert(matches, file)</span></div><div class="line uncovered"><span class="line-number">777</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">778</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">779</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">780</span><span class="line-content">    return matches</span></div><div class="line non-executable"><span class="line-number">781</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">782</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">783</span><span class="line-content">-- Information Functions</span></div><div class="line non-executable"><span class="line-number">784</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">785</span><span class="line-content">--- Check if file exists</span></div><div class="line non-executable"><span class="line-number">786</span><span class="line-content">-- @param path (string) Path to check</span></div><div class="line uncovered"><span class="line-number">787</span><span class="line-content">-- @return exists (boolean) True if file exists</span></div><div class="line uncovered"><span class="line-number">788</span><span class="line-content">function fs.file_exists(path)</span></div><div class="line uncovered"><span class="line-number">789</span><span class="line-content">    if not path then return false end</span></div><div class="line uncovered"><span class="line-number">790</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">791</span><span class="line-content">    local file = io.open(path, &quot;rb&quot;)</span></div><div class="line uncovered"><span class="line-number">792</span><span class="line-content">    if file then</span></div><div class="line uncovered"><span class="line-number">793</span><span class="line-content">        file:close()</span></div><div class="line uncovered"><span class="line-number">794</span><span class="line-content">        return true</span></div><div class="line uncovered"><span class="line-number">795</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">796</span><span class="line-content">    return false</span></div><div class="line non-executable"><span class="line-number">797</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">798</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">799</span><span class="line-content">--- Check if directory exists</span></div><div class="line non-executable"><span class="line-number">800</span><span class="line-content">-- @param path (string) Path to check</span></div><div class="line uncovered"><span class="line-number">801</span><span class="line-content">-- @return exists (boolean) True if directory exists</span></div><div class="line uncovered"><span class="line-number">802</span><span class="line-content">function fs.directory_exists(path)</span></div><div class="line uncovered"><span class="line-number">803</span><span class="line-content">    if not path then return false end</span></div><div class="line uncovered"><span class="line-number">804</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">805</span><span class="line-content">    -- Normalize path to handle trailing slashes</span></div><div class="line uncovered"><span class="line-number">806</span><span class="line-content">    local normalized_path = fs.normalize_path(path)</span></div><div class="line uncovered"><span class="line-number">807</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">808</span><span class="line-content">    -- Handle root directory special case</span></div><div class="line uncovered"><span class="line-number">809</span><span class="line-content">    if normalized_path == &quot;&quot; or normalized_path == &quot;/&quot; then</span></div><div class="line uncovered"><span class="line-number">810</span><span class="line-content">        return true</span></div><div class="line uncovered"><span class="line-number">811</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">812</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">813</span><span class="line-content">    -- Check if the path exists and is a directory</span></div><div class="line uncovered"><span class="line-number">814</span><span class="line-content">    local attributes</span></div><div class="line uncovered"><span class="line-number">815</span><span class="line-content">    if is_windows() then</span></div><div class="line uncovered"><span class="line-number">816</span><span class="line-content">        -- On Windows, use dir command to check if directory exists</span></div><div class="line uncovered"><span class="line-number">817</span><span class="line-content">        local result = os.execute(&apos;if exist &quot;&apos; .. normalized_path .. &apos;\\*&quot; (exit 0) else (exit 1)&apos;)</span></div><div class="line uncovered"><span class="line-number">818</span><span class="line-content">        return result == true or result == 0</span></div><div class="line uncovered"><span class="line-number">819</span><span class="line-content">    else</span></div><div class="line uncovered"><span class="line-number">820</span><span class="line-content">        -- On Unix-like systems, use stat command</span></div><div class="line uncovered"><span class="line-number">821</span><span class="line-content">        local result = os.execute(&apos;test -d &quot;&apos; .. normalized_path .. &apos;&quot;&apos;)</span></div><div class="line uncovered"><span class="line-number">822</span><span class="line-content">        return result == true or result == 0</span></div><div class="line uncovered"><span class="line-number">823</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">824</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">825</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">826</span><span class="line-content">--- Get file size in bytes</span></div><div class="line non-executable"><span class="line-number">827</span><span class="line-content">-- @param path (string) Path to file</span></div><div class="line non-executable"><span class="line-number">828</span><span class="line-content">-- @return size (number) File size in bytes or nil on error</span></div><div class="line uncovered"><span class="line-number">829</span><span class="line-content">-- @return error (string) Error message if getting size failed</span></div><div class="line uncovered"><span class="line-number">830</span><span class="line-content">function fs.get_file_size(path)</span></div><div class="line uncovered"><span class="line-number">831</span><span class="line-content">    if not fs.file_exists(path) then</span></div><div class="line uncovered"><span class="line-number">832</span><span class="line-content">        return nil, &quot;File does not exist: &quot; .. (path or &quot;nil&quot;)</span></div><div class="line uncovered"><span class="line-number">833</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">834</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">835</span><span class="line-content">    local file, err = io.open(path, &quot;rb&quot;)</span></div><div class="line uncovered"><span class="line-number">836</span><span class="line-content">    if not file then</span></div><div class="line uncovered"><span class="line-number">837</span><span class="line-content">        return nil, &quot;Could not open file: &quot; .. (err or &quot;unknown error&quot;)</span></div><div class="line uncovered"><span class="line-number">838</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">839</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">840</span><span class="line-content">    local size = file:seek(&quot;end&quot;)</span></div><div class="line uncovered"><span class="line-number">841</span><span class="line-content">    file:close()</span></div><div class="line uncovered"><span class="line-number">842</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">843</span><span class="line-content">    return size</span></div><div class="line non-executable"><span class="line-number">844</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">845</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">846</span><span class="line-content">--- Get last modified timestamp</span></div><div class="line non-executable"><span class="line-number">847</span><span class="line-content">-- @param path (string) Path to file</span></div><div class="line non-executable"><span class="line-number">848</span><span class="line-content">-- @return timestamp (number) Modification time or nil on error</span></div><div class="line uncovered"><span class="line-number">849</span><span class="line-content">-- @return error (string) Error message if getting time failed</span></div><div class="line uncovered"><span class="line-number">850</span><span class="line-content">function fs.get_modified_time(path)</span></div><div class="line uncovered"><span class="line-number">851</span><span class="line-content">    if not path then return nil, &quot;No path provided&quot; end</span></div><div class="line uncovered"><span class="line-number">852</span><span class="line-content">    if not (fs.file_exists(path) or fs.directory_exists(path)) then</span></div><div class="line uncovered"><span class="line-number">853</span><span class="line-content">        return nil, &quot;Path does not exist: &quot; .. path</span></div><div class="line uncovered"><span class="line-number">854</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">855</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">856</span><span class="line-content">    local command</span></div><div class="line uncovered"><span class="line-number">857</span><span class="line-content">    if is_windows() then</span></div><div class="line non-executable"><span class="line-number">858</span><span class="line-content">        -- PowerShell command for Windows</span></div><div class="line uncovered"><span class="line-number">859</span><span class="line-content">        command = string.format(</span></div><div class="line uncovered"><span class="line-number">860</span><span class="line-content">            &apos;powershell -Command &quot;(Get-Item -Path \&quot;%s\&quot;).LastWriteTime.ToFileTime()&quot;&apos;,</span></div><div class="line uncovered"><span class="line-number">861</span><span class="line-content">            path</span></div><div class="line uncovered"><span class="line-number">862</span><span class="line-content">        )</span></div><div class="line uncovered"><span class="line-number">863</span><span class="line-content">    else</span></div><div class="line non-executable"><span class="line-number">864</span><span class="line-content">        -- stat command for Unix-like systems</span></div><div class="line uncovered"><span class="line-number">865</span><span class="line-content">        command = string.format(&apos;stat -c %%Y &quot;%s&quot;&apos;, path)</span></div><div class="line uncovered"><span class="line-number">866</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">867</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">868</span><span class="line-content">    local handle = io.popen(command)</span></div><div class="line uncovered"><span class="line-number">869</span><span class="line-content">    if not handle then</span></div><div class="line uncovered"><span class="line-number">870</span><span class="line-content">        return nil, &quot;Failed to execute command to get modified time&quot;</span></div><div class="line uncovered"><span class="line-number">871</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">872</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">873</span><span class="line-content">    local result = handle:read(&quot;*a&quot;)</span></div><div class="line uncovered"><span class="line-number">874</span><span class="line-content">    handle:close()</span></div><div class="line uncovered"><span class="line-number">875</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">876</span><span class="line-content">    -- Try to convert result to number</span></div><div class="line uncovered"><span class="line-number">877</span><span class="line-content">    local timestamp = tonumber(result)</span></div><div class="line uncovered"><span class="line-number">878</span><span class="line-content">    if not timestamp then</span></div><div class="line uncovered"><span class="line-number">879</span><span class="line-content">        return nil, &quot;Failed to parse timestamp: &quot; .. result</span></div><div class="line uncovered"><span class="line-number">880</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">881</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">882</span><span class="line-content">    return timestamp</span></div><div class="line non-executable"><span class="line-number">883</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">884</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">885</span><span class="line-content">--- Get creation timestamp</span></div><div class="line non-executable"><span class="line-number">886</span><span class="line-content">-- @param path (string) Path to file</span></div><div class="line non-executable"><span class="line-number">887</span><span class="line-content">-- @return timestamp (number) Creation time or nil on error</span></div><div class="line uncovered"><span class="line-number">888</span><span class="line-content">-- @return error (string) Error message if getting time failed</span></div><div class="line uncovered"><span class="line-number">889</span><span class="line-content">function fs.get_creation_time(path)</span></div><div class="line uncovered"><span class="line-number">890</span><span class="line-content">    if not path then return nil, &quot;No path provided&quot; end</span></div><div class="line uncovered"><span class="line-number">891</span><span class="line-content">    if not (fs.file_exists(path) or fs.directory_exists(path)) then</span></div><div class="line uncovered"><span class="line-number">892</span><span class="line-content">        return nil, &quot;Path does not exist: &quot; .. path</span></div><div class="line uncovered"><span class="line-number">893</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">894</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">895</span><span class="line-content">    local command</span></div><div class="line uncovered"><span class="line-number">896</span><span class="line-content">    if is_windows() then</span></div><div class="line non-executable"><span class="line-number">897</span><span class="line-content">        -- PowerShell command for Windows</span></div><div class="line uncovered"><span class="line-number">898</span><span class="line-content">        command = string.format(</span></div><div class="line uncovered"><span class="line-number">899</span><span class="line-content">            &apos;powershell -Command &quot;(Get-Item -Path \&quot;%s\&quot;).CreationTime.ToFileTime()&quot;&apos;,</span></div><div class="line uncovered"><span class="line-number">900</span><span class="line-content">            path</span></div><div class="line uncovered"><span class="line-number">901</span><span class="line-content">        )</span></div><div class="line uncovered"><span class="line-number">902</span><span class="line-content">    else</span></div><div class="line non-executable"><span class="line-number">903</span><span class="line-content">        -- stat command for Unix-like systems (birth time if available, otherwise modified time)</span></div><div class="line uncovered"><span class="line-number">904</span><span class="line-content">        command = string.format(&apos;stat -c %%W 2&gt;/dev/null &quot;%s&quot; || stat -c %%Y &quot;%s&quot;&apos;, path, path)</span></div><div class="line uncovered"><span class="line-number">905</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">906</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">907</span><span class="line-content">    local handle = io.popen(command)</span></div><div class="line uncovered"><span class="line-number">908</span><span class="line-content">    if not handle then</span></div><div class="line uncovered"><span class="line-number">909</span><span class="line-content">        return nil, &quot;Failed to execute command to get creation time&quot;</span></div><div class="line uncovered"><span class="line-number">910</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">911</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">912</span><span class="line-content">    local result = handle:read(&quot;*a&quot;)</span></div><div class="line uncovered"><span class="line-number">913</span><span class="line-content">    handle:close()</span></div><div class="line uncovered"><span class="line-number">914</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">915</span><span class="line-content">    -- Try to convert result to number</span></div><div class="line uncovered"><span class="line-number">916</span><span class="line-content">    local timestamp = tonumber(result)</span></div><div class="line uncovered"><span class="line-number">917</span><span class="line-content">    if not timestamp then</span></div><div class="line uncovered"><span class="line-number">918</span><span class="line-content">        return nil, &quot;Failed to parse timestamp: &quot; .. result</span></div><div class="line uncovered"><span class="line-number">919</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">920</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">921</span><span class="line-content">    return timestamp</span></div><div class="line non-executable"><span class="line-number">922</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">923</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">924</span><span class="line-content">--- Check if path is a file</span></div><div class="line non-executable"><span class="line-number">925</span><span class="line-content">-- @param path (string) Path to check</span></div><div class="line uncovered"><span class="line-number">926</span><span class="line-content">-- @return is_file (boolean) True if path is a file</span></div><div class="line uncovered"><span class="line-number">927</span><span class="line-content">function fs.is_file(path)</span></div><div class="line uncovered"><span class="line-number">928</span><span class="line-content">    if not path then return false end</span></div><div class="line uncovered"><span class="line-number">929</span><span class="line-content">    if fs.directory_exists(path) then return false end</span></div><div class="line uncovered"><span class="line-number">930</span><span class="line-content">    return fs.file_exists(path)</span></div><div class="line uncovered"><span class="line-number">931</span><span class="line-content">end</span></div><div class="line uncovered"><span class="line-number">932</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">933</span><span class="line-content">--- Check if path is a directory</span></div><div class="line uncovered"><span class="line-number">934</span><span class="line-content">-- @param path (string) Path to check</span></div><div class="line uncovered"><span class="line-number">935</span><span class="line-content">-- @return is_directory (boolean) True if path is a directory</span></div><div class="line uncovered"><span class="line-number">936</span><span class="line-content">function fs.is_directory(path)</span></div><div class="line uncovered"><span class="line-number">937</span><span class="line-content">    if not path then return false end</span></div><div class="line uncovered"><span class="line-number">938</span><span class="line-content">    if fs.file_exists(path) and not fs.directory_exists(path) then return false end</span></div><div class="line uncovered"><span class="line-number">939</span><span class="line-content">    return fs.directory_exists(path)</span></div><div class="line uncovered"><span class="line-number">940</span><span class="line-content">end</span></div><div class="line uncovered"><span class="line-number">941</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">942</span><span class="line-content">return fs</span></div></div>          <div class="file-item">
            <div class="file-name">lib/core/module_reset.lua</div>
            <div class="file-metric">0/204</div>
            <div class="file-metric">0/12</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- Module reset functionality for firmo</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">-- Provides better isolation between test files by cleaning up module state</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">local module_reset = {}</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">-- Store original package.loaded state</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">module_reset.initial_state = nil</span></div><div class="line unco ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/coverage/patchup.lua</div>
            <div class="file-metric">0/135</div>
            <div class="file-metric">0/4</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line uncovered"><span class="line-number">1</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local fs = require(&quot;lib.tools.filesystem&quot;)</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content">local static_analyzer = require(&quot;lib.coverage.static_analyzer&quot;)</span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">-- Is this line a comment or blank?</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">local function is_comment_or_blank(line)</span></div><div class="line non-executable"><span class="line-number">7</span><span class="line-content">  -- Remove trailing comment</span></div><div class="line uncovered"><span class="line-number">8</span><span class="line-content">  local code = line:gsub(&quot;%-%-.*$&quot;, &quot;&quot;)</span></div><div class="line uncovered"><span class="line-number">9</span><span class="line-content">  -- Remove whitespace</span></div><div class="line uncovered"><span class="line-number">10</span><span class="line-content">  code = code:gsub(&quot;%s+&quot;, &quot;&quot;)</span></div><div class="line uncovered"><span class="line-number">11</span><span class="line-content">  -- Check if anything remains</span></div><div class="line uncovered"><span class="line-number">12</span><span class="line-content">  return code == &quot;&quot;</span></div><div class="line non-executable"><span class="line-number">13</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">14</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">15</span><span class="line-content">-- Is this a non-executable line that should be patched?</span></div><div class="line uncovered"><span class="line-number">16</span><span class="line-content">local function is_patchable_line(line_text)</span></div><div class="line non-executable"><span class="line-number">17</span><span class="line-content">  -- Standalone structural keywords</span></div><div class="line uncovered"><span class="line-number">18</span><span class="line-content">  if line_text:match(&quot;^%s*end%s*$&quot;) or</span></div><div class="line uncovered"><span class="line-number">19</span><span class="line-content">     line_text:match(&quot;^%s*else%s*$&quot;) or</span></div><div class="line uncovered"><span class="line-number">20</span><span class="line-content">     line_text:match(&quot;^%s*until%s*$&quot;) or</span></div><div class="line uncovered"><span class="line-number">21</span><span class="line-content">     line_text:match(&quot;^%s*elseif%s+.+then%s*$&quot;) or</span></div><div class="line uncovered"><span class="line-number">22</span><span class="line-content">     line_text:match(&quot;^%s*then%s*$&quot;) or</span></div><div class="line uncovered"><span class="line-number">23</span><span class="line-content">     line_text:match(&quot;^%s*do%s*$&quot;) or</span></div><div class="line uncovered"><span class="line-number">24</span><span class="line-content">     line_text:match(&quot;^%s*repeat%s*$&quot;) then</span></div><div class="line uncovered"><span class="line-number">25</span><span class="line-content">    return true</span></div><div class="line uncovered"><span class="line-number">26</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">27</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">28</span><span class="line-content">  -- Function declarations</span></div><div class="line uncovered"><span class="line-number">29</span><span class="line-content">  if line_text:match(&quot;^%s*local%s+function%s+&quot;) or </span></div><div class="line uncovered"><span class="line-number">30</span><span class="line-content">     line_text:match(&quot;^%s*function%s+[%w_:%.]+%s*%(&quot;) then</span></div><div class="line uncovered"><span class="line-number">31</span><span class="line-content">    return true</span></div><div class="line uncovered"><span class="line-number">32</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">33</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">34</span><span class="line-content">  -- Closing brackets, braces, parentheses on their own lines</span></div><div class="line uncovered"><span class="line-number">35</span><span class="line-content">  if line_text:match(&quot;^%s*[%]})%)]%s*$&quot;) then</span></div><div class="line uncovered"><span class="line-number">36</span><span class="line-content">    return true</span></div><div class="line uncovered"><span class="line-number">37</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">38</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">39</span><span class="line-content">  -- Variable declarations without assignments</span></div><div class="line uncovered"><span class="line-number">40</span><span class="line-content">  if line_text:match(&quot;^%s*local%s+[%w_,]+%s*$&quot;) then</span></div><div class="line uncovered"><span class="line-number">41</span><span class="line-content">    return true</span></div><div class="line uncovered"><span class="line-number">42</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">43</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">44</span><span class="line-content">  -- Empty tables or empty blocks</span></div><div class="line uncovered"><span class="line-number">45</span><span class="line-content">  if line_text:match(&quot;^%s*[%w_]+%s*=%s*{%s*}%s*,?%s*$&quot;) or</span></div><div class="line uncovered"><span class="line-number">46</span><span class="line-content">     line_text:match(&quot;^%s*{%s*}%s*,?%s*$&quot;) then</span></div><div class="line uncovered"><span class="line-number">47</span><span class="line-content">    return true</span></div><div class="line uncovered"><span class="line-number">48</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">49</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">50</span><span class="line-content">  -- Module returns without expressions</span></div><div class="line uncovered"><span class="line-number">51</span><span class="line-content">  if line_text:match(&quot;^%s*return%s+[%w_%.]+%s*$&quot;) then</span></div><div class="line uncovered"><span class="line-number">52</span><span class="line-content">    return true</span></div><div class="line uncovered"><span class="line-number">53</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">54</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">55</span><span class="line-content">  -- Not a patchable line</span></div><div class="line uncovered"><span class="line-number">56</span><span class="line-content">  return false</span></div><div class="line non-executable"><span class="line-number">57</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">58</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">59</span><span class="line-content">-- Patch coverage data for a file</span></div><div class="line uncovered"><span class="line-number">60</span><span class="line-content">function M.patch_file(file_path, file_data)</span></div><div class="line non-executable"><span class="line-number">61</span><span class="line-content">  -- Check if we have static analysis information</span></div><div class="line uncovered"><span class="line-number">62</span><span class="line-content">  if file_data.code_map then</span></div><div class="line non-executable"><span class="line-number">63</span><span class="line-content">    -- Use static analysis information to patch coverage data</span></div><div class="line uncovered"><span class="line-number">64</span><span class="line-content">    local patched = 0</span></div><div class="line uncovered"><span class="line-number">65</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">66</span><span class="line-content">    for i = 1, file_data.line_count do</span></div><div class="line uncovered"><span class="line-number">67</span><span class="line-content">      local line_info = file_data.code_map.lines[i]</span></div><div class="line uncovered"><span class="line-number">68</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">69</span><span class="line-content">      if line_info and not line_info.executable then</span></div><div class="line non-executable"><span class="line-number">70</span><span class="line-content">        -- This is a non-executable line (comment, blank line, etc.)</span></div><div class="line non-executable"><span class="line-number">71</span><span class="line-content">        </span></div><div class="line non-executable"><span class="line-number">72</span><span class="line-content">        -- Mark as non-executable in executable_lines table</span></div><div class="line uncovered"><span class="line-number">73</span><span class="line-content">        file_data.executable_lines[i] = false</span></div><div class="line uncovered"><span class="line-number">74</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">75</span><span class="line-content">        -- IMPORTANT: Non-executable lines SHOULD NEVER BE MARKED AS &quot;COVERED&quot;</span></div><div class="line uncovered"><span class="line-number">76</span><span class="line-content">        -- even if they appear in executed code sections</span></div><div class="line uncovered"><span class="line-number">77</span><span class="line-content">        file_data.lines[i] = nil  -- Explicitly remove coverage marking from non-executable lines</span></div><div class="line uncovered"><span class="line-number">78</span><span class="line-content">        patched = patched + 1</span></div><div class="line uncovered"><span class="line-number">79</span><span class="line-content">      elseif line_info and line_info.executable then</span></div><div class="line non-executable"><span class="line-number">80</span><span class="line-content">        -- This is an executable line - keep its actual execution status</span></div><div class="line uncovered"><span class="line-number">81</span><span class="line-content">        file_data.executable_lines[i] = true</span></div><div class="line uncovered"><span class="line-number">82</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">83</span><span class="line-content">        -- DO NOT MODIFY file_data.lines[i] here - that would artificially</span></div><div class="line uncovered"><span class="line-number">84</span><span class="line-content">        -- mark executable lines as covered even if they weren&apos;t executed</span></div><div class="line uncovered"><span class="line-number">85</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">86</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">87</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">88</span><span class="line-content">    return patched</span></div><div class="line uncovered"><span class="line-number">89</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">90</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">91</span><span class="line-content">  -- No static analysis info available, fall back to heuristic approach</span></div><div class="line non-executable"><span class="line-number">92</span><span class="line-content">  -- Make sure we have source code</span></div><div class="line uncovered"><span class="line-number">93</span><span class="line-content">  local lines</span></div><div class="line uncovered"><span class="line-number">94</span><span class="line-content">  if type(file_data.source) == &quot;table&quot; then</span></div><div class="line non-executable"><span class="line-number">95</span><span class="line-content">    -- Source is already an array of lines</span></div><div class="line uncovered"><span class="line-number">96</span><span class="line-content">    lines = file_data.source</span></div><div class="line uncovered"><span class="line-number">97</span><span class="line-content">  elseif type(file_data.source) == &quot;string&quot; then</span></div><div class="line non-executable"><span class="line-number">98</span><span class="line-content">    -- Source is a string, parse into lines</span></div><div class="line uncovered"><span class="line-number">99</span><span class="line-content">    lines = {}</span></div><div class="line uncovered"><span class="line-number">100</span><span class="line-content">    for line in file_data.source:gmatch(&quot;[^\r\n]+&quot;) do</span></div><div class="line uncovered"><span class="line-number">101</span><span class="line-content">      table.insert(lines, line)</span></div><div class="line uncovered"><span class="line-number">102</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">103</span><span class="line-content">  else</span></div><div class="line non-executable"><span class="line-number">104</span><span class="line-content">    -- No source available, try to read from file</span></div><div class="line uncovered"><span class="line-number">105</span><span class="line-content">    local source_text = fs.read_file(file_path)</span></div><div class="line uncovered"><span class="line-number">106</span><span class="line-content">    if not source_text then</span></div><div class="line uncovered"><span class="line-number">107</span><span class="line-content">      return false</span></div><div class="line uncovered"><span class="line-number">108</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">109</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">110</span><span class="line-content">    lines = {}</span></div><div class="line uncovered"><span class="line-number">111</span><span class="line-content">    for line in source_text:gmatch(&quot;[^\r\n]+&quot;) do</span></div><div class="line uncovered"><span class="line-number">112</span><span class="line-content">      table.insert(lines, line)</span></div><div class="line uncovered"><span class="line-number">113</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">114</span><span class="line-content">    </span></div><div class="line non-executable"><span class="line-number">115</span><span class="line-content">    -- Store the parsed lines in the file_data</span></div><div class="line uncovered"><span class="line-number">116</span><span class="line-content">    file_data.source = lines</span></div><div class="line uncovered"><span class="line-number">117</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">118</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">119</span><span class="line-content">  -- Update line_count if needed</span></div><div class="line uncovered"><span class="line-number">120</span><span class="line-content">  if not file_data.line_count or file_data.line_count == 0 then</span></div><div class="line uncovered"><span class="line-number">121</span><span class="line-content">    file_data.line_count = #lines</span></div><div class="line uncovered"><span class="line-number">122</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">123</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">124</span><span class="line-content">  -- Initialize executable_lines table if not present</span></div><div class="line uncovered"><span class="line-number">125</span><span class="line-content">  file_data.executable_lines = file_data.executable_lines or {}</span></div><div class="line uncovered"><span class="line-number">126</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">127</span><span class="line-content">  -- Process each line</span></div><div class="line uncovered"><span class="line-number">128</span><span class="line-content">  local patched = 0</span></div><div class="line uncovered"><span class="line-number">129</span><span class="line-content">  for i, line_text in ipairs(lines) do</span></div><div class="line non-executable"><span class="line-number">130</span><span class="line-content">    -- Mark if the line is executable or not</span></div><div class="line uncovered"><span class="line-number">131</span><span class="line-content">    if is_comment_or_blank(line_text) then</span></div><div class="line non-executable"><span class="line-number">132</span><span class="line-content">      -- Comments and blank lines are non-executable</span></div><div class="line uncovered"><span class="line-number">133</span><span class="line-content">      file_data.executable_lines[i] = false</span></div><div class="line uncovered"><span class="line-number">134</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">135</span><span class="line-content">      -- IMPORTANT: Never mark non-executable lines as covered if they weren&apos;t executed</span></div><div class="line uncovered"><span class="line-number">136</span><span class="line-content">      -- (this was causing the bug where comments appeared green in HTML reports)</span></div><div class="line uncovered"><span class="line-number">137</span><span class="line-content">      file_data.lines[i] = nil  -- Explicitly remove any coverage marking</span></div><div class="line uncovered"><span class="line-number">138</span><span class="line-content">      patched = patched + 1</span></div><div class="line uncovered"><span class="line-number">139</span><span class="line-content">    elseif is_patchable_line(line_text) then</span></div><div class="line non-executable"><span class="line-number">140</span><span class="line-content">      -- Non-executable code structure lines</span></div><div class="line uncovered"><span class="line-number">141</span><span class="line-content">      file_data.executable_lines[i] = false</span></div><div class="line uncovered"><span class="line-number">142</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">143</span><span class="line-content">      -- IMPORTANT: Never mark non-executable lines as covered if they weren&apos;t executed</span></div><div class="line uncovered"><span class="line-number">144</span><span class="line-content">      -- This is the same fix as above, for structured code elements (end, else, etc.)</span></div><div class="line uncovered"><span class="line-number">145</span><span class="line-content">      file_data.lines[i] = nil  -- Explicitly remove any coverage marking</span></div><div class="line uncovered"><span class="line-number">146</span><span class="line-content">      patched = patched + 1</span></div><div class="line uncovered"><span class="line-number">147</span><span class="line-content">    else</span></div><div class="line non-executable"><span class="line-number">148</span><span class="line-content">      -- Potentially executable line</span></div><div class="line uncovered"><span class="line-number">149</span><span class="line-content">      file_data.executable_lines[i] = true</span></div><div class="line uncovered"><span class="line-number">150</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">151</span><span class="line-content">      -- IMPORTANT: Do NOT mark executable lines as covered if they weren&apos;t actually hit!</span></div><div class="line uncovered"><span class="line-number">152</span><span class="line-content">      -- Only leave lines as covered if they were already marked as such by the debug hook</span></div><div class="line uncovered"><span class="line-number">153</span><span class="line-content">      -- We don&apos;t touch potentially executable lines that weren&apos;t covered</span></div><div class="line uncovered"><span class="line-number">154</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">155</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">156</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">157</span><span class="line-content">  return patched</span></div><div class="line non-executable"><span class="line-number">158</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">159</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">160</span><span class="line-content">-- Patch all files in coverage data</span></div><div class="line uncovered"><span class="line-number">161</span><span class="line-content">function M.patch_all(coverage_data)</span></div><div class="line uncovered"><span class="line-number">162</span><span class="line-content">  local total_patched = 0</span></div><div class="line uncovered"><span class="line-number">163</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">164</span><span class="line-content">  for file_path, file_data in pairs(coverage_data.files) do</span></div><div class="line uncovered"><span class="line-number">165</span><span class="line-content">    local patched = M.patch_file(file_path, file_data)</span></div><div class="line uncovered"><span class="line-number">166</span><span class="line-content">    total_patched = total_patched + patched</span></div><div class="line uncovered"><span class="line-number">167</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">168</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">169</span><span class="line-content">  return total_patched</span></div><div class="line non-executable"><span class="line-number">170</span><span class="line-content">end</span></div><div class="line uncovered"><span class="line-number">171</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">172</span><span class="line-content">return M</span></div></div>          <div class="file-item">
            <div class="file-name">scripts/discover.lua</div>
            <div class="file-metric">0/34</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- Test discovery module for firmo</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local discover = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Find test files in a directory</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">function discover.find_tests(dir)</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">  dir = dir or &quot;./tests&quot;</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">  local files = {}</span></div><div class="line uncovered"><span class="line-number">8</span><span ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/tools/parser/validator.lua</div>
            <div class="file-metric">495/495</div>
            <div class="file-metric">0/42</div>
            <div class="file-metric">1/1</div>
            <div class="file-metric">80.0%</div>
          </div>
          <div class="source-code"><div class="line covered"><span class="line-number">1</span><span class="line-content">--[[</span></div><div class="line covered"><span class="line-number">2</span><span class="line-content">This module implements a validator for the AST</span></div><div class="line covered"><span class="line-number">3</span><span class="line-content">Based on lua-parser by Andre Murbach Maidl (https://github.com/andremm/lua-parser)</span></div><div class="line covered"><span class="line-number">4</span><span class="line-content">]]</span></div><div class="line covered"><span class="line-number">5</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">6</span><span class="line-content">local M = {}</span></div><div class="line covered"><span class="line-number">7</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">8</span><span class="line-content">-- Utility functions for scope management</span></div><div class="line covered"><span class="line-number">9</span><span class="line-content">local scope_util = {}</span></div><div class="line covered"><span class="line-number">10</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">11</span><span class="line-content">-- Calculate line number from a position in a string</span></div><div class="line covered"><span class="line-number">12</span><span class="line-content">function scope_util.lineno(subject, pos)</span></div><div class="line covered"><span class="line-number">13</span><span class="line-content">  if pos &gt; #subject then pos = #subject end</span></div><div class="line covered"><span class="line-number">14</span><span class="line-content">  local line, col = 1, 1</span></div><div class="line covered"><span class="line-number">15</span><span class="line-content">  for i = 1, pos do</span></div><div class="line covered"><span class="line-number">16</span><span class="line-content">    if subject:sub(i, i) == &apos;\n&apos; then</span></div><div class="line covered"><span class="line-number">17</span><span class="line-content">      line = line + 1</span></div><div class="line covered"><span class="line-number">18</span><span class="line-content">      col = 1</span></div><div class="line covered"><span class="line-number">19</span><span class="line-content">    else</span></div><div class="line covered"><span class="line-number">20</span><span class="line-content">      col = col + 1</span></div><div class="line covered"><span class="line-number">21</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">22</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">23</span><span class="line-content">  return line, col</span></div><div class="line covered"><span class="line-number">24</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">25</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">26</span><span class="line-content">-- Create a new function scope</span></div><div class="line covered"><span class="line-number">27</span><span class="line-content">function scope_util.new_function(env)</span></div><div class="line covered"><span class="line-number">28</span><span class="line-content">  env.fscope = env.fscope + 1</span></div><div class="line covered"><span class="line-number">29</span><span class="line-content">  env[&quot;function&quot;][env.fscope] = { is_vararg = false }</span></div><div class="line covered"><span class="line-number">30</span><span class="line-content">  return env.fscope</span></div><div class="line covered"><span class="line-number">31</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">32</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">33</span><span class="line-content">-- End a function scope</span></div><div class="line covered"><span class="line-number">34</span><span class="line-content">function scope_util.end_function(env)</span></div><div class="line covered"><span class="line-number">35</span><span class="line-content">  env.fscope = env.fscope - 1</span></div><div class="line covered"><span class="line-number">36</span><span class="line-content">  return env.fscope</span></div><div class="line covered"><span class="line-number">37</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">38</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">39</span><span class="line-content">-- Create a new scope</span></div><div class="line covered"><span class="line-number">40</span><span class="line-content">function scope_util.new_scope(env)</span></div><div class="line covered"><span class="line-number">41</span><span class="line-content">  env.scope = env.scope + 1</span></div><div class="line covered"><span class="line-number">42</span><span class="line-content">  env.maxscope = env.scope</span></div><div class="line covered"><span class="line-number">43</span><span class="line-content">  env[env.scope] = { label = {}, [&quot;goto&quot;] = {} }</span></div><div class="line covered"><span class="line-number">44</span><span class="line-content">  return env.scope</span></div><div class="line covered"><span class="line-number">45</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">46</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">47</span><span class="line-content">-- End a scope</span></div><div class="line covered"><span class="line-number">48</span><span class="line-content">function scope_util.end_scope(env)</span></div><div class="line covered"><span class="line-number">49</span><span class="line-content">  env.scope = env.scope - 1</span></div><div class="line covered"><span class="line-number">50</span><span class="line-content">  return env.scope</span></div><div class="line covered"><span class="line-number">51</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">52</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">53</span><span class="line-content">-- Begin a loop</span></div><div class="line covered"><span class="line-number">54</span><span class="line-content">function scope_util.begin_loop(env)</span></div><div class="line covered"><span class="line-number">55</span><span class="line-content">  env.loop = env.loop + 1</span></div><div class="line covered"><span class="line-number">56</span><span class="line-content">  return env.loop</span></div><div class="line covered"><span class="line-number">57</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">58</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">59</span><span class="line-content">-- End a loop</span></div><div class="line covered"><span class="line-number">60</span><span class="line-content">function scope_util.end_loop(env)</span></div><div class="line covered"><span class="line-number">61</span><span class="line-content">  env.loop = env.loop - 1</span></div><div class="line covered"><span class="line-number">62</span><span class="line-content">  return env.loop</span></div><div class="line covered"><span class="line-number">63</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">64</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">65</span><span class="line-content">-- Check if inside a loop</span></div><div class="line covered"><span class="line-number">66</span><span class="line-content">function scope_util.insideloop(env)</span></div><div class="line covered"><span class="line-number">67</span><span class="line-content">  return env.loop &gt; 0</span></div><div class="line covered"><span class="line-number">68</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">69</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">70</span><span class="line-content">-- Creates an error message for the input string</span></div><div class="line covered"><span class="line-number">71</span><span class="line-content">local function syntaxerror(errorinfo, pos, msg)</span></div><div class="line covered"><span class="line-number">72</span><span class="line-content">  local l, c = scope_util.lineno(errorinfo.subject, pos)</span></div><div class="line covered"><span class="line-number">73</span><span class="line-content">  local error_msg = &quot;%s:%d:%d: syntax error, %s&quot;</span></div><div class="line covered"><span class="line-number">74</span><span class="line-content">  return string.format(error_msg, errorinfo.filename, l, c, msg)</span></div><div class="line covered"><span class="line-number">75</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">76</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">77</span><span class="line-content">-- Check if a label exists in the environment</span></div><div class="line covered"><span class="line-number">78</span><span class="line-content">local function exist_label(env, scope, stm)</span></div><div class="line covered"><span class="line-number">79</span><span class="line-content">  local l = stm[1]</span></div><div class="line covered"><span class="line-number">80</span><span class="line-content">  for s=scope, 0, -1 do</span></div><div class="line covered"><span class="line-number">81</span><span class="line-content">    if env[s][&quot;label&quot;][l] then return true end</span></div><div class="line covered"><span class="line-number">82</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">83</span><span class="line-content">  return false</span></div><div class="line covered"><span class="line-number">84</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">85</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">86</span><span class="line-content">-- Set a label in the current scope</span></div><div class="line covered"><span class="line-number">87</span><span class="line-content">local function set_label(env, label, pos)</span></div><div class="line covered"><span class="line-number">88</span><span class="line-content">  local scope = env.scope</span></div><div class="line covered"><span class="line-number">89</span><span class="line-content">  local l = env[scope][&quot;label&quot;][label]</span></div><div class="line covered"><span class="line-number">90</span><span class="line-content">  if not l then</span></div><div class="line covered"><span class="line-number">91</span><span class="line-content">    env[scope][&quot;label&quot;][label] = { name = label, pos = pos }</span></div><div class="line covered"><span class="line-number">92</span><span class="line-content">    return true</span></div><div class="line covered"><span class="line-number">93</span><span class="line-content">  else</span></div><div class="line covered"><span class="line-number">94</span><span class="line-content">    local msg = &quot;label &apos;%s&apos; already defined at line %d&quot;</span></div><div class="line covered"><span class="line-number">95</span><span class="line-content">    local line = scope_util.lineno(env.errorinfo.subject, l.pos)</span></div><div class="line covered"><span class="line-number">96</span><span class="line-content">    msg = string.format(msg, label, line)</span></div><div class="line covered"><span class="line-number">97</span><span class="line-content">    return nil, syntaxerror(env.errorinfo, pos, msg)</span></div><div class="line covered"><span class="line-number">98</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">99</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">100</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">101</span><span class="line-content">-- Set a pending goto statement</span></div><div class="line covered"><span class="line-number">102</span><span class="line-content">local function set_pending_goto(env, stm)</span></div><div class="line covered"><span class="line-number">103</span><span class="line-content">  local scope = env.scope</span></div><div class="line covered"><span class="line-number">104</span><span class="line-content">  table.insert(env[scope][&quot;goto&quot;], stm)</span></div><div class="line covered"><span class="line-number">105</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">106</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">107</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">108</span><span class="line-content">-- Verify all pending goto statements</span></div><div class="line covered"><span class="line-number">109</span><span class="line-content">local function verify_pending_gotos(env)</span></div><div class="line covered"><span class="line-number">110</span><span class="line-content">  for s=env.maxscope, 0, -1 do</span></div><div class="line covered"><span class="line-number">111</span><span class="line-content">    for k, v in ipairs(env[s][&quot;goto&quot;]) do</span></div><div class="line covered"><span class="line-number">112</span><span class="line-content">      if not exist_label(env, s, v) then</span></div><div class="line covered"><span class="line-number">113</span><span class="line-content">        local msg = &quot;no visible label &apos;%s&apos; for &lt;goto&gt;&quot;</span></div><div class="line covered"><span class="line-number">114</span><span class="line-content">        msg = string.format(msg, v[1])</span></div><div class="line covered"><span class="line-number">115</span><span class="line-content">        return nil, syntaxerror(env.errorinfo, v.pos, msg)</span></div><div class="line covered"><span class="line-number">116</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">117</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">118</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">119</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">120</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">121</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">122</span><span class="line-content">-- Set vararg status for the current function</span></div><div class="line covered"><span class="line-number">123</span><span class="line-content">local function set_vararg(env, is_vararg)</span></div><div class="line covered"><span class="line-number">124</span><span class="line-content">  env[&quot;function&quot;][env.fscope].is_vararg = is_vararg</span></div><div class="line covered"><span class="line-number">125</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">126</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">127</span><span class="line-content">-- Forward declarations</span></div><div class="line covered"><span class="line-number">128</span><span class="line-content">local traverse_stm, traverse_exp, traverse_var</span></div><div class="line covered"><span class="line-number">129</span><span class="line-content">local traverse_block, traverse_explist, traverse_varlist, traverse_parlist</span></div><div class="line covered"><span class="line-number">130</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">131</span><span class="line-content">-- Traverse a parameter list</span></div><div class="line covered"><span class="line-number">132</span><span class="line-content">function traverse_parlist(env, parlist)</span></div><div class="line covered"><span class="line-number">133</span><span class="line-content">  local len = #parlist</span></div><div class="line covered"><span class="line-number">134</span><span class="line-content">  local is_vararg = false</span></div><div class="line covered"><span class="line-number">135</span><span class="line-content">  if len &gt; 0 and parlist[len].tag == &quot;Dots&quot; then</span></div><div class="line covered"><span class="line-number">136</span><span class="line-content">    is_vararg = true</span></div><div class="line covered"><span class="line-number">137</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">138</span><span class="line-content">  set_vararg(env, is_vararg)</span></div><div class="line covered"><span class="line-number">139</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">140</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">141</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">142</span><span class="line-content">-- Traverse a function definition</span></div><div class="line covered"><span class="line-number">143</span><span class="line-content">local function traverse_function(env, exp)</span></div><div class="line covered"><span class="line-number">144</span><span class="line-content">  scope_util.new_function(env)</span></div><div class="line covered"><span class="line-number">145</span><span class="line-content">  scope_util.new_scope(env)</span></div><div class="line covered"><span class="line-number">146</span><span class="line-content">  local status, msg = traverse_parlist(env, exp[1])</span></div><div class="line covered"><span class="line-number">147</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">148</span><span class="line-content">  status, msg = traverse_block(env, exp[2])</span></div><div class="line covered"><span class="line-number">149</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">150</span><span class="line-content">  scope_util.end_scope(env)</span></div><div class="line covered"><span class="line-number">151</span><span class="line-content">  scope_util.end_function(env)</span></div><div class="line covered"><span class="line-number">152</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">153</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">154</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">155</span><span class="line-content">-- Traverse an operation</span></div><div class="line covered"><span class="line-number">156</span><span class="line-content">local function traverse_op(env, exp)</span></div><div class="line covered"><span class="line-number">157</span><span class="line-content">  local status, msg = traverse_exp(env, exp[2])</span></div><div class="line covered"><span class="line-number">158</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">159</span><span class="line-content">  if exp[3] then</span></div><div class="line covered"><span class="line-number">160</span><span class="line-content">    status, msg = traverse_exp(env, exp[3])</span></div><div class="line covered"><span class="line-number">161</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">162</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">163</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">164</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">165</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">166</span><span class="line-content">-- Traverse a parenthesized expression</span></div><div class="line covered"><span class="line-number">167</span><span class="line-content">local function traverse_paren(env, exp)</span></div><div class="line covered"><span class="line-number">168</span><span class="line-content">  local status, msg = traverse_exp(env, exp[1])</span></div><div class="line covered"><span class="line-number">169</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">170</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">171</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">172</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">173</span><span class="line-content">-- Traverse a table constructor</span></div><div class="line covered"><span class="line-number">174</span><span class="line-content">local function traverse_table(env, fieldlist)</span></div><div class="line covered"><span class="line-number">175</span><span class="line-content">  for k, v in ipairs(fieldlist) do</span></div><div class="line covered"><span class="line-number">176</span><span class="line-content">    local tag = v.tag</span></div><div class="line covered"><span class="line-number">177</span><span class="line-content">    if tag == &quot;Pair&quot; then</span></div><div class="line covered"><span class="line-number">178</span><span class="line-content">      local status, msg = traverse_exp(env, v[1])</span></div><div class="line covered"><span class="line-number">179</span><span class="line-content">      if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">180</span><span class="line-content">      status, msg = traverse_exp(env, v[2])</span></div><div class="line covered"><span class="line-number">181</span><span class="line-content">      if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">182</span><span class="line-content">    else</span></div><div class="line covered"><span class="line-number">183</span><span class="line-content">      local status, msg = traverse_exp(env, v)</span></div><div class="line covered"><span class="line-number">184</span><span class="line-content">      if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">185</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">186</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">187</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">188</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">189</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">190</span><span class="line-content">-- Traverse a vararg expression</span></div><div class="line covered"><span class="line-number">191</span><span class="line-content">local function traverse_vararg(env, exp)</span></div><div class="line covered"><span class="line-number">192</span><span class="line-content">  if not env[&quot;function&quot;][env.fscope].is_vararg then</span></div><div class="line covered"><span class="line-number">193</span><span class="line-content">    local msg = &quot;cannot use &apos;...&apos; outside a vararg function&quot;</span></div><div class="line covered"><span class="line-number">194</span><span class="line-content">    return nil, syntaxerror(env.errorinfo, exp.pos, msg)</span></div><div class="line covered"><span class="line-number">195</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">196</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">197</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">198</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">199</span><span class="line-content">-- Traverse a function call</span></div><div class="line covered"><span class="line-number">200</span><span class="line-content">local function traverse_call(env, call)</span></div><div class="line covered"><span class="line-number">201</span><span class="line-content">  local status, msg = traverse_exp(env, call[1])</span></div><div class="line covered"><span class="line-number">202</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">203</span><span class="line-content">  for i=2, #call do</span></div><div class="line covered"><span class="line-number">204</span><span class="line-content">    status, msg = traverse_exp(env, call[i])</span></div><div class="line covered"><span class="line-number">205</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">206</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">207</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">208</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">209</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">210</span><span class="line-content">-- Traverse a method invocation</span></div><div class="line covered"><span class="line-number">211</span><span class="line-content">local function traverse_invoke(env, invoke)</span></div><div class="line covered"><span class="line-number">212</span><span class="line-content">  local status, msg = traverse_exp(env, invoke[1])</span></div><div class="line covered"><span class="line-number">213</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">214</span><span class="line-content">  for i=3, #invoke do</span></div><div class="line covered"><span class="line-number">215</span><span class="line-content">    status, msg = traverse_exp(env, invoke[i])</span></div><div class="line covered"><span class="line-number">216</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">217</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">218</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">219</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">220</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">221</span><span class="line-content">-- Traverse a variable assignment</span></div><div class="line covered"><span class="line-number">222</span><span class="line-content">local function traverse_assignment(env, stm)</span></div><div class="line covered"><span class="line-number">223</span><span class="line-content">  local status, msg = traverse_varlist(env, stm[1])</span></div><div class="line covered"><span class="line-number">224</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">225</span><span class="line-content">  status, msg = traverse_explist(env, stm[2])</span></div><div class="line covered"><span class="line-number">226</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">227</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">228</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">229</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">230</span><span class="line-content">-- Traverse a break statement</span></div><div class="line covered"><span class="line-number">231</span><span class="line-content">local function traverse_break(env, stm)</span></div><div class="line covered"><span class="line-number">232</span><span class="line-content">  if not scope_util.insideloop(env) then</span></div><div class="line covered"><span class="line-number">233</span><span class="line-content">    local msg = &quot;&lt;break&gt; not inside a loop&quot;</span></div><div class="line covered"><span class="line-number">234</span><span class="line-content">    return nil, syntaxerror(env.errorinfo, stm.pos, msg)</span></div><div class="line covered"><span class="line-number">235</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">236</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">237</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">238</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">239</span><span class="line-content">-- Traverse a for-in loop</span></div><div class="line covered"><span class="line-number">240</span><span class="line-content">local function traverse_forin(env, stm)</span></div><div class="line covered"><span class="line-number">241</span><span class="line-content">  scope_util.begin_loop(env)</span></div><div class="line covered"><span class="line-number">242</span><span class="line-content">  scope_util.new_scope(env)</span></div><div class="line covered"><span class="line-number">243</span><span class="line-content">  local status, msg = traverse_explist(env, stm[2])</span></div><div class="line covered"><span class="line-number">244</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">245</span><span class="line-content">  status, msg = traverse_block(env, stm[3])</span></div><div class="line covered"><span class="line-number">246</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">247</span><span class="line-content">  scope_util.end_scope(env)</span></div><div class="line covered"><span class="line-number">248</span><span class="line-content">  scope_util.end_loop(env)</span></div><div class="line covered"><span class="line-number">249</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">250</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">251</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">252</span><span class="line-content">-- Traverse a numeric for loop</span></div><div class="line covered"><span class="line-number">253</span><span class="line-content">local function traverse_fornum(env, stm)</span></div><div class="line covered"><span class="line-number">254</span><span class="line-content">  local status, msg</span></div><div class="line covered"><span class="line-number">255</span><span class="line-content">  scope_util.begin_loop(env)</span></div><div class="line covered"><span class="line-number">256</span><span class="line-content">  scope_util.new_scope(env)</span></div><div class="line covered"><span class="line-number">257</span><span class="line-content">  status, msg = traverse_exp(env, stm[2])</span></div><div class="line covered"><span class="line-number">258</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">259</span><span class="line-content">  status, msg = traverse_exp(env, stm[3])</span></div><div class="line covered"><span class="line-number">260</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">261</span><span class="line-content">  if stm[5] then</span></div><div class="line covered"><span class="line-number">262</span><span class="line-content">    status, msg = traverse_exp(env, stm[4])</span></div><div class="line covered"><span class="line-number">263</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">264</span><span class="line-content">    status, msg = traverse_block(env, stm[5])</span></div><div class="line covered"><span class="line-number">265</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">266</span><span class="line-content">  else</span></div><div class="line covered"><span class="line-number">267</span><span class="line-content">    status, msg = traverse_block(env, stm[4])</span></div><div class="line covered"><span class="line-number">268</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">269</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">270</span><span class="line-content">  scope_util.end_scope(env)</span></div><div class="line covered"><span class="line-number">271</span><span class="line-content">  scope_util.end_loop(env)</span></div><div class="line covered"><span class="line-number">272</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">273</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">274</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">275</span><span class="line-content">-- Traverse a goto statement</span></div><div class="line covered"><span class="line-number">276</span><span class="line-content">local function traverse_goto(env, stm)</span></div><div class="line covered"><span class="line-number">277</span><span class="line-content">  local status, msg = set_pending_goto(env, stm)</span></div><div class="line covered"><span class="line-number">278</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">279</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">280</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">281</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">282</span><span class="line-content">-- Traverse an if statement</span></div><div class="line covered"><span class="line-number">283</span><span class="line-content">local function traverse_if(env, stm)</span></div><div class="line covered"><span class="line-number">284</span><span class="line-content">  local len = #stm</span></div><div class="line covered"><span class="line-number">285</span><span class="line-content">  if len % 2 == 0 then</span></div><div class="line covered"><span class="line-number">286</span><span class="line-content">    for i=1, len, 2 do</span></div><div class="line covered"><span class="line-number">287</span><span class="line-content">      local status, msg = traverse_exp(env, stm[i])</span></div><div class="line covered"><span class="line-number">288</span><span class="line-content">      if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">289</span><span class="line-content">      status, msg = traverse_block(env, stm[i+1])</span></div><div class="line covered"><span class="line-number">290</span><span class="line-content">      if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">291</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">292</span><span class="line-content">  else</span></div><div class="line covered"><span class="line-number">293</span><span class="line-content">    for i=1, len-1, 2 do</span></div><div class="line covered"><span class="line-number">294</span><span class="line-content">      local status, msg = traverse_exp(env, stm[i])</span></div><div class="line covered"><span class="line-number">295</span><span class="line-content">      if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">296</span><span class="line-content">      status, msg = traverse_block(env, stm[i+1])</span></div><div class="line covered"><span class="line-number">297</span><span class="line-content">      if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">298</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">299</span><span class="line-content">    local status, msg = traverse_block(env, stm[len])</span></div><div class="line covered"><span class="line-number">300</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">301</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">302</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">303</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">304</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">305</span><span class="line-content">-- Traverse a label statement</span></div><div class="line covered"><span class="line-number">306</span><span class="line-content">local function traverse_label(env, stm)</span></div><div class="line covered"><span class="line-number">307</span><span class="line-content">  local status, msg = set_label(env, stm[1], stm.pos)</span></div><div class="line covered"><span class="line-number">308</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">309</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">310</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">311</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">312</span><span class="line-content">-- Traverse a local variable assignment</span></div><div class="line covered"><span class="line-number">313</span><span class="line-content">local function traverse_let(env, stm)</span></div><div class="line covered"><span class="line-number">314</span><span class="line-content">  local status, msg = traverse_explist(env, stm[2])</span></div><div class="line covered"><span class="line-number">315</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">316</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">317</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">318</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">319</span><span class="line-content">-- Traverse a local recursive assignment</span></div><div class="line covered"><span class="line-number">320</span><span class="line-content">local function traverse_letrec(env, stm)</span></div><div class="line covered"><span class="line-number">321</span><span class="line-content">  local status, msg = traverse_exp(env, stm[2][1])</span></div><div class="line covered"><span class="line-number">322</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">323</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">324</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">325</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">326</span><span class="line-content">-- Traverse a repeat-until loop</span></div><div class="line covered"><span class="line-number">327</span><span class="line-content">local function traverse_repeat(env, stm)</span></div><div class="line covered"><span class="line-number">328</span><span class="line-content">  scope_util.begin_loop(env)</span></div><div class="line covered"><span class="line-number">329</span><span class="line-content">  local status, msg = traverse_block(env, stm[1])</span></div><div class="line covered"><span class="line-number">330</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">331</span><span class="line-content">  status, msg = traverse_exp(env, stm[2])</span></div><div class="line covered"><span class="line-number">332</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">333</span><span class="line-content">  scope_util.end_loop(env)</span></div><div class="line covered"><span class="line-number">334</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">335</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">336</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">337</span><span class="line-content">-- Traverse a return statement</span></div><div class="line covered"><span class="line-number">338</span><span class="line-content">local function traverse_return(env, stm)</span></div><div class="line covered"><span class="line-number">339</span><span class="line-content">  local status, msg = traverse_explist(env, stm)</span></div><div class="line covered"><span class="line-number">340</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">341</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">342</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">343</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">344</span><span class="line-content">-- Traverse a while loop</span></div><div class="line covered"><span class="line-number">345</span><span class="line-content">local function traverse_while(env, stm)</span></div><div class="line covered"><span class="line-number">346</span><span class="line-content">  scope_util.begin_loop(env)</span></div><div class="line covered"><span class="line-number">347</span><span class="line-content">  local status, msg = traverse_exp(env, stm[1])</span></div><div class="line covered"><span class="line-number">348</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">349</span><span class="line-content">  status, msg = traverse_block(env, stm[2])</span></div><div class="line covered"><span class="line-number">350</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">351</span><span class="line-content">  scope_util.end_loop(env)</span></div><div class="line covered"><span class="line-number">352</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">353</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">354</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">355</span><span class="line-content">-- Traverse a variable reference</span></div><div class="line covered"><span class="line-number">356</span><span class="line-content">function traverse_var(env, var)</span></div><div class="line covered"><span class="line-number">357</span><span class="line-content">  local tag = var.tag</span></div><div class="line covered"><span class="line-number">358</span><span class="line-content">  if tag == &quot;Id&quot; then -- `Id{ &lt;string&gt; }</span></div><div class="line covered"><span class="line-number">359</span><span class="line-content">    return true</span></div><div class="line covered"><span class="line-number">360</span><span class="line-content">  elseif tag == &quot;Index&quot; then -- `Index{ expr expr }</span></div><div class="line covered"><span class="line-number">361</span><span class="line-content">    local status, msg = traverse_exp(env, var[1])</span></div><div class="line covered"><span class="line-number">362</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">363</span><span class="line-content">    status, msg = traverse_exp(env, var[2])</span></div><div class="line covered"><span class="line-number">364</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">365</span><span class="line-content">    return true</span></div><div class="line covered"><span class="line-number">366</span><span class="line-content">  else</span></div><div class="line covered"><span class="line-number">367</span><span class="line-content">    error(&quot;expecting a variable, but got a &quot; .. tag)</span></div><div class="line covered"><span class="line-number">368</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">369</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">370</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">371</span><span class="line-content">-- Traverse a list of variables</span></div><div class="line covered"><span class="line-number">372</span><span class="line-content">function traverse_varlist(env, varlist)</span></div><div class="line covered"><span class="line-number">373</span><span class="line-content">  for k, v in ipairs(varlist) do</span></div><div class="line covered"><span class="line-number">374</span><span class="line-content">    local status, msg = traverse_var(env, v)</span></div><div class="line covered"><span class="line-number">375</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">376</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">377</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">378</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">379</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">380</span><span class="line-content">-- Traverse an expression</span></div><div class="line covered"><span class="line-number">381</span><span class="line-content">function traverse_exp(env, exp)</span></div><div class="line covered"><span class="line-number">382</span><span class="line-content">  local tag = exp.tag</span></div><div class="line covered"><span class="line-number">383</span><span class="line-content">  if tag == &quot;Nil&quot; or</span></div><div class="line covered"><span class="line-number">384</span><span class="line-content">     tag == &quot;Boolean&quot; or -- `Boolean{ &lt;boolean&gt; }</span></div><div class="line covered"><span class="line-number">385</span><span class="line-content">     tag == &quot;Number&quot; or -- `Number{ &lt;number&gt; }</span></div><div class="line covered"><span class="line-number">386</span><span class="line-content">     tag == &quot;String&quot; then -- `String{ &lt;string&gt; }</span></div><div class="line covered"><span class="line-number">387</span><span class="line-content">    return true</span></div><div class="line covered"><span class="line-number">388</span><span class="line-content">  elseif tag == &quot;Dots&quot; then</span></div><div class="line covered"><span class="line-number">389</span><span class="line-content">    return traverse_vararg(env, exp)</span></div><div class="line covered"><span class="line-number">390</span><span class="line-content">  elseif tag == &quot;Function&quot; then -- `Function{ { `Id{ &lt;string&gt; }* `Dots? } block }</span></div><div class="line covered"><span class="line-number">391</span><span class="line-content">    return traverse_function(env, exp)</span></div><div class="line covered"><span class="line-number">392</span><span class="line-content">  elseif tag == &quot;Table&quot; then -- `Table{ ( `Pair{ expr expr } | expr )* }</span></div><div class="line covered"><span class="line-number">393</span><span class="line-content">    return traverse_table(env, exp)</span></div><div class="line covered"><span class="line-number">394</span><span class="line-content">  elseif tag == &quot;Op&quot; then -- `Op{ opid expr expr? }</span></div><div class="line covered"><span class="line-number">395</span><span class="line-content">    return traverse_op(env, exp)</span></div><div class="line covered"><span class="line-number">396</span><span class="line-content">  elseif tag == &quot;Paren&quot; then -- `Paren{ expr }</span></div><div class="line covered"><span class="line-number">397</span><span class="line-content">    return traverse_paren(env, exp)</span></div><div class="line covered"><span class="line-number">398</span><span class="line-content">  elseif tag == &quot;Call&quot; then -- `Call{ expr expr* }</span></div><div class="line covered"><span class="line-number">399</span><span class="line-content">    return traverse_call(env, exp)</span></div><div class="line covered"><span class="line-number">400</span><span class="line-content">  elseif tag == &quot;Invoke&quot; then -- `Invoke{ expr `String{ &lt;string&gt; } expr* }</span></div><div class="line covered"><span class="line-number">401</span><span class="line-content">    return traverse_invoke(env, exp)</span></div><div class="line covered"><span class="line-number">402</span><span class="line-content">  elseif tag == &quot;Id&quot; or -- `Id{ &lt;string&gt; }</span></div><div class="line covered"><span class="line-number">403</span><span class="line-content">         tag == &quot;Index&quot; then -- `Index{ expr expr }</span></div><div class="line covered"><span class="line-number">404</span><span class="line-content">    return traverse_var(env, exp)</span></div><div class="line covered"><span class="line-number">405</span><span class="line-content">  else</span></div><div class="line covered"><span class="line-number">406</span><span class="line-content">    error(&quot;expecting an expression, but got a &quot; .. tag)</span></div><div class="line covered"><span class="line-number">407</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">408</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">409</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">410</span><span class="line-content">-- Traverse a list of expressions</span></div><div class="line covered"><span class="line-number">411</span><span class="line-content">function traverse_explist(env, explist)</span></div><div class="line covered"><span class="line-number">412</span><span class="line-content">  for k, v in ipairs(explist) do</span></div><div class="line covered"><span class="line-number">413</span><span class="line-content">    local status, msg = traverse_exp(env, v)</span></div><div class="line covered"><span class="line-number">414</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">415</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">416</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">417</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">418</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">419</span><span class="line-content">-- Traverse a statement</span></div><div class="line covered"><span class="line-number">420</span><span class="line-content">function traverse_stm(env, stm)</span></div><div class="line covered"><span class="line-number">421</span><span class="line-content">  local tag = stm.tag</span></div><div class="line covered"><span class="line-number">422</span><span class="line-content">  if tag == &quot;Do&quot; then -- `Do{ stat* }</span></div><div class="line covered"><span class="line-number">423</span><span class="line-content">    return traverse_block(env, stm)</span></div><div class="line covered"><span class="line-number">424</span><span class="line-content">  elseif tag == &quot;Set&quot; then -- `Set{ {lhs+} {expr+} }</span></div><div class="line covered"><span class="line-number">425</span><span class="line-content">    return traverse_assignment(env, stm)</span></div><div class="line covered"><span class="line-number">426</span><span class="line-content">  elseif tag == &quot;While&quot; then -- `While{ expr block }</span></div><div class="line covered"><span class="line-number">427</span><span class="line-content">    return traverse_while(env, stm)</span></div><div class="line covered"><span class="line-number">428</span><span class="line-content">  elseif tag == &quot;Repeat&quot; then -- `Repeat{ block expr }</span></div><div class="line covered"><span class="line-number">429</span><span class="line-content">    return traverse_repeat(env, stm)</span></div><div class="line covered"><span class="line-number">430</span><span class="line-content">  elseif tag == &quot;If&quot; then -- `If{ (expr block)+ block? }</span></div><div class="line covered"><span class="line-number">431</span><span class="line-content">    return traverse_if(env, stm)</span></div><div class="line covered"><span class="line-number">432</span><span class="line-content">  elseif tag == &quot;Fornum&quot; then -- `Fornum{ ident expr expr expr? block }</span></div><div class="line covered"><span class="line-number">433</span><span class="line-content">    return traverse_fornum(env, stm)</span></div><div class="line covered"><span class="line-number">434</span><span class="line-content">  elseif tag == &quot;Forin&quot; then -- `Forin{ {ident+} {expr+} block }</span></div><div class="line covered"><span class="line-number">435</span><span class="line-content">    return traverse_forin(env, stm)</span></div><div class="line covered"><span class="line-number">436</span><span class="line-content">  elseif tag == &quot;Local&quot; then -- `Local{ {ident+} {expr+}? }</span></div><div class="line covered"><span class="line-number">437</span><span class="line-content">    return traverse_let(env, stm)</span></div><div class="line covered"><span class="line-number">438</span><span class="line-content">  elseif tag == &quot;Localrec&quot; then -- `Localrec{ ident expr }</span></div><div class="line covered"><span class="line-number">439</span><span class="line-content">    return traverse_letrec(env, stm)</span></div><div class="line covered"><span class="line-number">440</span><span class="line-content">  elseif tag == &quot;Goto&quot; then -- `Goto{ &lt;string&gt; }</span></div><div class="line covered"><span class="line-number">441</span><span class="line-content">    return traverse_goto(env, stm)</span></div><div class="line covered"><span class="line-number">442</span><span class="line-content">  elseif tag == &quot;Label&quot; then -- `Label{ &lt;string&gt; }</span></div><div class="line covered"><span class="line-number">443</span><span class="line-content">    return traverse_label(env, stm)</span></div><div class="line covered"><span class="line-number">444</span><span class="line-content">  elseif tag == &quot;Return&quot; then -- `Return{ &lt;expr&gt;* }</span></div><div class="line covered"><span class="line-number">445</span><span class="line-content">    return traverse_return(env, stm)</span></div><div class="line covered"><span class="line-number">446</span><span class="line-content">  elseif tag == &quot;Break&quot; then</span></div><div class="line covered"><span class="line-number">447</span><span class="line-content">    return traverse_break(env, stm)</span></div><div class="line covered"><span class="line-number">448</span><span class="line-content">  elseif tag == &quot;Call&quot; then -- `Call{ expr expr* }</span></div><div class="line covered"><span class="line-number">449</span><span class="line-content">    return traverse_call(env, stm)</span></div><div class="line covered"><span class="line-number">450</span><span class="line-content">  elseif tag == &quot;Invoke&quot; then -- `Invoke{ expr `String{ &lt;string&gt; } expr* }</span></div><div class="line covered"><span class="line-number">451</span><span class="line-content">    return traverse_invoke(env, stm)</span></div><div class="line covered"><span class="line-number">452</span><span class="line-content">  else</span></div><div class="line covered"><span class="line-number">453</span><span class="line-content">    error(&quot;expecting a statement, but got a &quot; .. tag)</span></div><div class="line covered"><span class="line-number">454</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">455</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">456</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">457</span><span class="line-content">-- Traverse a block of statements</span></div><div class="line covered"><span class="line-number">458</span><span class="line-content">function traverse_block(env, block)</span></div><div class="line covered"><span class="line-number">459</span><span class="line-content">  scope_util.new_scope(env)</span></div><div class="line covered"><span class="line-number">460</span><span class="line-content">  for k, v in ipairs(block) do</span></div><div class="line covered"><span class="line-number">461</span><span class="line-content">    local status, msg = traverse_stm(env, v)</span></div><div class="line covered"><span class="line-number">462</span><span class="line-content">    if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">463</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">464</span><span class="line-content">  scope_util.end_scope(env)</span></div><div class="line covered"><span class="line-number">465</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">466</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">467</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">468</span><span class="line-content">-- Validate an AST</span></div><div class="line covered"><span class="line-number">469</span><span class="line-content">function M.validate(ast, errorinfo)</span></div><div class="line covered"><span class="line-number">470</span><span class="line-content">  assert(type(ast) == &quot;table&quot;)</span></div><div class="line covered"><span class="line-number">471</span><span class="line-content">  assert(type(errorinfo) == &quot;table&quot;)</span></div><div class="line covered"><span class="line-number">472</span><span class="line-content">  local env = { </span></div><div class="line covered"><span class="line-number">473</span><span class="line-content">    errorinfo = errorinfo, </span></div><div class="line covered"><span class="line-number">474</span><span class="line-content">    [&quot;function&quot;] = {}, </span></div><div class="line covered"><span class="line-number">475</span><span class="line-content">    scope = -1, </span></div><div class="line covered"><span class="line-number">476</span><span class="line-content">    maxscope = -1, </span></div><div class="line covered"><span class="line-number">477</span><span class="line-content">    fscope = -1, </span></div><div class="line covered"><span class="line-number">478</span><span class="line-content">    loop = 0 </span></div><div class="line covered"><span class="line-number">479</span><span class="line-content">  }</span></div><div class="line covered"><span class="line-number">480</span><span class="line-content">  scope_util.new_function(env)</span></div><div class="line covered"><span class="line-number">481</span><span class="line-content">  set_vararg(env, true)</span></div><div class="line covered"><span class="line-number">482</span><span class="line-content">  local status, msg = traverse_block(env, ast)</span></div><div class="line covered"><span class="line-number">483</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">484</span><span class="line-content">  scope_util.end_function(env)</span></div><div class="line covered"><span class="line-number">485</span><span class="line-content">  status, msg = verify_pending_gotos(env)</span></div><div class="line covered"><span class="line-number">486</span><span class="line-content">  if not status then return status, msg end</span></div><div class="line covered"><span class="line-number">487</span><span class="line-content">  return ast</span></div><div class="line covered"><span class="line-number">488</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">489</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">490</span><span class="line-content">-- Helper function for creating syntax error messages</span></div><div class="line covered"><span class="line-number">491</span><span class="line-content">function M.syntaxerror(errorinfo, pos, msg)</span></div><div class="line covered"><span class="line-number">492</span><span class="line-content">  return syntaxerror(errorinfo, pos, msg)</span></div><div class="line covered"><span class="line-number">493</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">494</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">495</span><span class="line-content">return M</span></div></div>          <div class="file-item">
            <div class="file-name">lib/core/config.lua</div>
            <div class="file-metric">0/388</div>
            <div class="file-metric">0/10</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- Configuration management module for firmo</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">-- Handles loading configuration from .firmo-config.lua and applying it to the framework</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">4</span><span class="line-content">-- Import filesystem module for file operations</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local fs = require(&quot;lib.tools.filesystem&quot;)</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">local ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/reporting/formatters/tap.lua</div>
            <div class="file-metric">0/82</div>
            <div class="file-metric">0/3</div>
            <div class="file-metric">0/2</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- TAP (Test Anything Protocol) formatter</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Helper function to format test case result</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local function format_test_case(test_case, test_number)</span></div><div class="line non-executable"><span class="line-number">6</span><span class="line-content">  -- Basic TAP test line</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">  local line</span></div><div class="line uncovered"><span class="line-number">8</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">9</span><span class="line-content">  if test_case.status == &quot;pass&quot; then</span></div><div class="line uncovered"><span class="line-number">10</span><span class="line-content">    line = string.format(&quot;ok %d - %s&quot;, test_number, test_case.name)</span></div><div class="line uncovered"><span class="line-number">11</span><span class="line-content">  elseif test_case.status == &quot;pending&quot; or test_case.status == &quot;skipped&quot; then</span></div><div class="line uncovered"><span class="line-number">12</span><span class="line-content">    line = string.format(&quot;ok %d - %s # SKIP %s&quot;, </span></div><div class="line uncovered"><span class="line-number">13</span><span class="line-content">      test_number, </span></div><div class="line uncovered"><span class="line-number">14</span><span class="line-content">      test_case.name,</span></div><div class="line uncovered"><span class="line-number">15</span><span class="line-content">      test_case.skip_reason or &quot;Not implemented yet&quot;)</span></div><div class="line uncovered"><span class="line-number">16</span><span class="line-content">  else</span></div><div class="line non-executable"><span class="line-number">17</span><span class="line-content">    -- Failed or errored test</span></div><div class="line uncovered"><span class="line-number">18</span><span class="line-content">    line = string.format(&quot;not ok %d - %s&quot;, test_number, test_case.name)</span></div><div class="line uncovered"><span class="line-number">19</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">20</span><span class="line-content">    -- Add diagnostic info if available</span></div><div class="line uncovered"><span class="line-number">21</span><span class="line-content">    if test_case.failure or test_case.error then</span></div><div class="line uncovered"><span class="line-number">22</span><span class="line-content">      local message = test_case.failure and test_case.failure.message or </span></div><div class="line uncovered"><span class="line-number">23</span><span class="line-content">                      test_case.error and test_case.error.message or &quot;Test failed&quot;</span></div><div class="line uncovered"><span class="line-number">24</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">25</span><span class="line-content">      local details = test_case.failure and test_case.failure.details or </span></div><div class="line uncovered"><span class="line-number">26</span><span class="line-content">                      test_case.error and test_case.error.details or &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">27</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">28</span><span class="line-content">      local diag = {</span></div><div class="line uncovered"><span class="line-number">29</span><span class="line-content">        &quot;  ---&quot;,</span></div><div class="line uncovered"><span class="line-number">30</span><span class="line-content">        &quot;  message: &quot; .. (message or &quot;&quot;),</span></div><div class="line uncovered"><span class="line-number">31</span><span class="line-content">        &quot;  severity: &quot; .. (test_case.status == &quot;error&quot; and &quot;error&quot; or &quot;fail&quot;),</span></div><div class="line uncovered"><span class="line-number">32</span><span class="line-content">        &quot;  ...&quot;</span></div><div class="line uncovered"><span class="line-number">33</span><span class="line-content">      }</span></div><div class="line uncovered"><span class="line-number">34</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">35</span><span class="line-content">      if details and details ~= &quot;&quot; then</span></div><div class="line uncovered"><span class="line-number">36</span><span class="line-content">        diag[3] = &quot;  data: |&quot;</span></div><div class="line uncovered"><span class="line-number">37</span><span class="line-content">        local detail_lines = {}</span></div><div class="line uncovered"><span class="line-number">38</span><span class="line-content">        for line in details:gmatch(&quot;([^\n]+)&quot;) do</span></div><div class="line uncovered"><span class="line-number">39</span><span class="line-content">          table.insert(detail_lines, &quot;    &quot; .. line)</span></div><div class="line uncovered"><span class="line-number">40</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">41</span><span class="line-content">        table.insert(diag, 3, table.concat(detail_lines, &quot;\n&quot;))</span></div><div class="line uncovered"><span class="line-number">42</span><span class="line-content">      end</span></div><div class="line non-executable"><span class="line-number">43</span><span class="line-content">      </span></div><div class="line non-executable"><span class="line-number">44</span><span class="line-content">      -- Append diagnostic lines</span></div><div class="line uncovered"><span class="line-number">45</span><span class="line-content">      line = line .. &quot;\n&quot; .. table.concat(diag, &quot;\n&quot;)</span></div><div class="line uncovered"><span class="line-number">46</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">47</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">48</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">49</span><span class="line-content">  return line</span></div><div class="line non-executable"><span class="line-number">50</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">51</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">52</span><span class="line-content">-- Format test results as TAP (Test Anything Protocol)</span></div><div class="line uncovered"><span class="line-number">53</span><span class="line-content">function M.format_results(results_data)</span></div><div class="line non-executable"><span class="line-number">54</span><span class="line-content">  -- Validate the input data</span></div><div class="line uncovered"><span class="line-number">55</span><span class="line-content">  if not results_data or not results_data.test_cases then</span></div><div class="line uncovered"><span class="line-number">56</span><span class="line-content">    return &quot;1..0\n# No tests run&quot;</span></div><div class="line uncovered"><span class="line-number">57</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">58</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">59</span><span class="line-content">  local lines = {}</span></div><div class="line uncovered"><span class="line-number">60</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">61</span><span class="line-content">  -- TAP version header</span></div><div class="line uncovered"><span class="line-number">62</span><span class="line-content">  table.insert(lines, &quot;TAP version 13&quot;)</span></div><div class="line uncovered"><span class="line-number">63</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">64</span><span class="line-content">  -- Plan line with total number of tests</span></div><div class="line uncovered"><span class="line-number">65</span><span class="line-content">  local test_count = #results_data.test_cases</span></div><div class="line uncovered"><span class="line-number">66</span><span class="line-content">  table.insert(lines, string.format(&quot;1..%d&quot;, test_count))</span></div><div class="line uncovered"><span class="line-number">67</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">68</span><span class="line-content">  -- Add test case results</span></div><div class="line uncovered"><span class="line-number">69</span><span class="line-content">  for i, test_case in ipairs(results_data.test_cases) do</span></div><div class="line uncovered"><span class="line-number">70</span><span class="line-content">    table.insert(lines, format_test_case(test_case, i))</span></div><div class="line uncovered"><span class="line-number">71</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">72</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">73</span><span class="line-content">  -- Add summary line</span></div><div class="line uncovered"><span class="line-number">74</span><span class="line-content">  table.insert(lines, string.format(&quot;# tests %d&quot;, test_count))</span></div><div class="line uncovered"><span class="line-number">75</span><span class="line-content">  table.insert(lines, string.format(&quot;# pass %d&quot;, test_count - (results_data.failures or 0) - (results_data.errors or 0)))</span></div><div class="line uncovered"><span class="line-number">76</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">77</span><span class="line-content">  if results_data.failures and results_data.failures &gt; 0 then</span></div><div class="line uncovered"><span class="line-number">78</span><span class="line-content">    table.insert(lines, string.format(&quot;# fail %d&quot;, results_data.failures))</span></div><div class="line uncovered"><span class="line-number">79</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">80</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">81</span><span class="line-content">  if results_data.errors and results_data.errors &gt; 0 then</span></div><div class="line uncovered"><span class="line-number">82</span><span class="line-content">    table.insert(lines, string.format(&quot;# error %d&quot;, results_data.errors))</span></div><div class="line uncovered"><span class="line-number">83</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">84</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">85</span><span class="line-content">  if results_data.skipped and results_data.skipped &gt; 0 then</span></div><div class="line uncovered"><span class="line-number">86</span><span class="line-content">    table.insert(lines, string.format(&quot;# skip %d&quot;, results_data.skipped))</span></div><div class="line uncovered"><span class="line-number">87</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">88</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">89</span><span class="line-content">  -- Join all lines with newlines</span></div><div class="line uncovered"><span class="line-number">90</span><span class="line-content">  return table.concat(lines, &quot;\n&quot;)</span></div><div class="line non-executable"><span class="line-number">91</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">92</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">93</span><span class="line-content">-- Register formatter</span></div><div class="line uncovered"><span class="line-number">94</span><span class="line-content">return function(formatters)</span></div><div class="line uncovered"><span class="line-number">95</span><span class="line-content">  formatters.results.tap = M.format_results</span></div><div class="line uncovered"><span class="line-number">96</span><span class="line-content">end</span></div></div>          <div class="file-item">
            <div class="file-name">lib/reporting/formatters/html.lua</div>
            <div class="file-metric">0/668</div>
            <div class="file-metric">0/9</div>
            <div class="file-metric">0/3</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- HTML formatter for reports</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Helper function to escape HTML special characters</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local function escape_html(str)</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">  if type(str) ~= &quot;string&quot; then</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">    return tostring(str or &quot;&quot;)</span></div><div class="line uncovered"><sp ... (very long line, trimmed to 1000 chars)
            <div class="file-name">./firmo.lua</div>
            <div class="file-metric">2230/2230</div>
            <div class="file-metric">0/106</div>
            <div class="file-metric">411/411</div>
            <div class="file-metric">80.0%</div>
          </div>
          <div class="source-code"><div class="line covered"><span class="line-number">1</span><span class="line-content">-- firmo v0.7.5 - Enhanced Lua test framework</span></div><div class="line covered"><span class="line-number">2</span><span class="line-content">-- https://github.com/greggh/firmo</span></div><div class="line covered"><span class="line-number">3</span><span class="line-content">-- MIT LICENSE</span></div><div class="line covered"><span class="line-number">4</span><span class="line-content">-- Based on lust by Bjorn Swenson (https://github.com/bjornbytes/lust)</span></div><div class="line covered"><span class="line-number">5</span><span class="line-content">--</span></div><div class="line covered"><span class="line-number">6</span><span class="line-content">-- Features:</span></div><div class="line covered"><span class="line-number">7</span><span class="line-content">-- * BDD-style nested test blocks (describe/it)</span></div><div class="line covered"><span c ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/quality/init.lua</div>
            <div class="file-metric">1130/1166</div>
            <div class="file-metric">0/28</div>
            <div class="file-metric">1/1</div>
            <div class="file-metric">78.8%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- firmo test quality validation module</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">-- Implementation of test quality analysis with level-based validation</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">local fs = require(&quot;lib.tools.filesystem&quot;)</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">-- Define quality level constants to meet test expectations</span></ ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/tools/interactive.lua</div>
            <div class="file-metric">534/534</div>
            <div class="file-metric">0/13</div>
            <div class="file-metric">1/1</div>
            <div class="file-metric">80.0%</div>
          </div>
          <div class="source-code"><div class="line covered"><span class="line-number">1</span><span class="line-content">-- Interactive CLI module for firmo</span></div><div class="line covered"><span class="line-number">2</span><span class="line-content">local interactive = {}</span></div><div class="line covered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">4</span><span class="line-content">-- Try to load required modules</span></div><div class="line covered"><span class="line-number">5</span><span class="line-content">local has_discovery, discover = pcall(require, &quot;discover&quot;)</span></div><div class="line covered"><span class="line-number">6</span><span class="line-content">local has_runner, runner = pcall(require, &quot;runner&quot;)</span></div><div class="line covered"><span class="line-number">7</span><span class="line-content">local has_watcher, watcher = pcall(require, &quot;lib ... (very long line, trimmed to 1000 chars)
            <div class="file-name">firmo.lua</div>
            <div class="file-metric">2230/2230</div>
            <div class="file-metric">0/106</div>
            <div class="file-metric">411/411</div>
            <div class="file-metric">80.0%</div>
          </div>
          <div class="source-code"><div class="line covered"><span class="line-number">1</span><span class="line-content">-- firmo v0.7.5 - Enhanced Lua test framework</span></div><div class="line covered"><span class="line-number">2</span><span class="line-content">-- https://github.com/greggh/firmo</span></div><div class="line covered"><span class="line-number">3</span><span class="line-content">-- MIT LICENSE</span></div><div class="line covered"><span class="line-number">4</span><span class="line-content">-- Based on lust by Bjorn Swenson (https://github.com/bjornbytes/lust)</span></div><div class="line covered"><span class="line-number">5</span><span class="line-content">--</span></div><div class="line covered"><span class="line-number">6</span><span class="line-content">-- Features:</span></div><div class="line covered"><span class="line-number">7</span><span class="line-content">-- * BDD-style nested test blocks (describe/it)</span></div><div class="line covered"><span c ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/coverage/file_manager.lua</div>
            <div class="file-metric">0/65</div>
            <div class="file-metric">0/2</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line uncovered"><span class="line-number">1</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local fs = require(&quot;lib.tools.filesystem&quot;)</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Find all Lua files in directories matching patterns</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">function M.discover_files(config)</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">  local discovered = {}</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">  local include_patterns = config.include or {}</span></div><div class="line uncovered"><span class="line-number">8</span><span class="line-content">  local exclude_patterns = config.exclude or {}</span></div><div class="line uncovered"><span class="line-number">9</span><span class="line-content">  local source_dirs = config.source_dirs or {&quot;.&quot;}</span></div><div class="line uncovered"><span class="line-number">10</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">11</span><span class="line-content">  -- Process explicitly included files first</span></div><div class="line uncovered"><span class="line-number">12</span><span class="line-content">  for _, pattern in ipairs(include_patterns) do</span></div><div class="line uncovered"><span class="line-number">13</span><span class="line-content">    -- If it&apos;s a direct file path (not a pattern)</span></div><div class="line uncovered"><span class="line-number">14</span><span class="line-content">    if not pattern:match(&quot;[%*%?%[%]]&quot;) and fs.file_exists(pattern) then</span></div><div class="line uncovered"><span class="line-number">15</span><span class="line-content">      local normalized_path = fs.normalize_path(pattern)</span></div><div class="line uncovered"><span class="line-number">16</span><span class="line-content">      discovered[normalized_path] = true</span></div><div class="line uncovered"><span class="line-number">17</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">18</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">19</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">20</span><span class="line-content">  -- Convert source dirs to absolute paths</span></div><div class="line uncovered"><span class="line-number">21</span><span class="line-content">  local absolute_dirs = {}</span></div><div class="line uncovered"><span class="line-number">22</span><span class="line-content">  for _, dir in ipairs(source_dirs) do</span></div><div class="line uncovered"><span class="line-number">23</span><span class="line-content">    if fs.directory_exists(dir) then</span></div><div class="line uncovered"><span class="line-number">24</span><span class="line-content">      table.insert(absolute_dirs, fs.normalize_path(dir))</span></div><div class="line uncovered"><span class="line-number">25</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">26</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">27</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">28</span><span class="line-content">  -- Use filesystem module to find all .lua files</span></div><div class="line uncovered"><span class="line-number">29</span><span class="line-content">  local lua_files = fs.discover_files(</span></div><div class="line uncovered"><span class="line-number">30</span><span class="line-content">    absolute_dirs,</span></div><div class="line uncovered"><span class="line-number">31</span><span class="line-content">    include_patterns,</span></div><div class="line uncovered"><span class="line-number">32</span><span class="line-content">    exclude_patterns</span></div><div class="line uncovered"><span class="line-number">33</span><span class="line-content">  )</span></div><div class="line uncovered"><span class="line-number">34</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">35</span><span class="line-content">  -- Add discovered files</span></div><div class="line uncovered"><span class="line-number">36</span><span class="line-content">  for _, file_path in ipairs(lua_files) do</span></div><div class="line uncovered"><span class="line-number">37</span><span class="line-content">    local normalized_path = fs.normalize_path(file_path)</span></div><div class="line uncovered"><span class="line-number">38</span><span class="line-content">    discovered[normalized_path] = true</span></div><div class="line uncovered"><span class="line-number">39</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">40</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">41</span><span class="line-content">  return discovered</span></div><div class="line non-executable"><span class="line-number">42</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">43</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">44</span><span class="line-content">-- Update coverage data with discovered files</span></div><div class="line uncovered"><span class="line-number">45</span><span class="line-content">function M.add_uncovered_files(coverage_data, config)</span></div><div class="line uncovered"><span class="line-number">46</span><span class="line-content">  local discovered = M.discover_files(config)</span></div><div class="line uncovered"><span class="line-number">47</span><span class="line-content">  local added = 0</span></div><div class="line uncovered"><span class="line-number">48</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">49</span><span class="line-content">  for file_path in pairs(discovered) do</span></div><div class="line uncovered"><span class="line-number">50</span><span class="line-content">    if not coverage_data.files[file_path] then</span></div><div class="line non-executable"><span class="line-number">51</span><span class="line-content">      -- Count lines in file</span></div><div class="line uncovered"><span class="line-number">52</span><span class="line-content">      local line_count = 0</span></div><div class="line uncovered"><span class="line-number">53</span><span class="line-content">      local source = fs.read_file(file_path)</span></div><div class="line uncovered"><span class="line-number">54</span><span class="line-content">      if source then</span></div><div class="line uncovered"><span class="line-number">55</span><span class="line-content">        for _ in source:gmatch(&quot;[^\r\n]+&quot;) do</span></div><div class="line uncovered"><span class="line-number">56</span><span class="line-content">          line_count = line_count + 1</span></div><div class="line uncovered"><span class="line-number">57</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">58</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">59</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">60</span><span class="line-content">      coverage_data.files[file_path] = {</span></div><div class="line uncovered"><span class="line-number">61</span><span class="line-content">        lines = {},</span></div><div class="line uncovered"><span class="line-number">62</span><span class="line-content">        functions = {},</span></div><div class="line uncovered"><span class="line-number">63</span><span class="line-content">        line_count = line_count,</span></div><div class="line uncovered"><span class="line-number">64</span><span class="line-content">        discovered = true,</span></div><div class="line uncovered"><span class="line-number">65</span><span class="line-content">        source = source</span></div><div class="line uncovered"><span class="line-number">66</span><span class="line-content">      }</span></div><div class="line uncovered"><span class="line-number">67</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">68</span><span class="line-content">      added = added + 1</span></div><div class="line uncovered"><span class="line-number">69</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">70</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">71</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">72</span><span class="line-content">  return added</span></div><div class="line non-executable"><span class="line-number">73</span><span class="line-content">end</span></div><div class="line uncovered"><span class="line-number">74</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">75</span><span class="line-content">return M</span></div></div>          <div class="file-item">
            <div class="file-name">lib/tools/parser/pp.lua</div>
            <div class="file-metric">0/308</div>
            <div class="file-metric">0/18</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">--[[</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">This module implements a pretty printer for the AST</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content">Based on lua-parser by Andre Murbach Maidl (https://github.com/andremm/lua-parser)</span></div><div class="line non-executable"><span class="line-number">4</span><span class="line-content">]]</span></div><div class="line non-executable"><span class="line-number">5</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">8</span><span class="line-content">local block2str, stm2str, exp2str, var2str</span></div><div class="line uncovered"><span class="line-number">9</span><span class="line-content">local explist2str, varlist2str, parlist2str, fieldlist2str</span></div><div class="line uncovered"><span class="line-number">10</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">11</span><span class="line-content">-- Check if a character is a control character</span></div><div class="line uncovered"><span class="line-number">12</span><span class="line-content">local function iscntrl(x)</span></div><div class="line uncovered"><span class="line-number">13</span><span class="line-content">  if (x &gt;= 0 and x &lt;= 31) or (x == 127) then return true end</span></div><div class="line uncovered"><span class="line-number">14</span><span class="line-content">  return false</span></div><div class="line non-executable"><span class="line-number">15</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">16</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">17</span><span class="line-content">-- Check if a character is printable</span></div><div class="line uncovered"><span class="line-number">18</span><span class="line-content">local function isprint(x)</span></div><div class="line uncovered"><span class="line-number">19</span><span class="line-content">  return not iscntrl(x)</span></div><div class="line non-executable"><span class="line-number">20</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">21</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">22</span><span class="line-content">-- Format a string for display with proper escaping</span></div><div class="line uncovered"><span class="line-number">23</span><span class="line-content">local function fixed_string(str)</span></div><div class="line uncovered"><span class="line-number">24</span><span class="line-content">  local new_str = &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">25</span><span class="line-content">  for i=1,string.len(str) do</span></div><div class="line uncovered"><span class="line-number">26</span><span class="line-content">    local char = string.byte(str, i)</span></div><div class="line uncovered"><span class="line-number">27</span><span class="line-content">    if char == 34 then new_str = new_str .. string.format(&quot;\\\&quot;&quot;)</span></div><div class="line uncovered"><span class="line-number">28</span><span class="line-content">    elseif char == 92 then new_str = new_str .. string.format(&quot;\\\\&quot;)</span></div><div class="line uncovered"><span class="line-number">29</span><span class="line-content">    elseif char == 7 then new_str = new_str .. string.format(&quot;\\a&quot;)</span></div><div class="line uncovered"><span class="line-number">30</span><span class="line-content">    elseif char == 8 then new_str = new_str .. string.format(&quot;\\b&quot;)</span></div><div class="line uncovered"><span class="line-number">31</span><span class="line-content">    elseif char == 12 then new_str = new_str .. string.format(&quot;\\f&quot;)</span></div><div class="line uncovered"><span class="line-number">32</span><span class="line-content">    elseif char == 10 then new_str = new_str .. string.format(&quot;\\n&quot;)</span></div><div class="line uncovered"><span class="line-number">33</span><span class="line-content">    elseif char == 13 then new_str = new_str .. string.format(&quot;\\r&quot;)</span></div><div class="line uncovered"><span class="line-number">34</span><span class="line-content">    elseif char == 9 then new_str = new_str .. string.format(&quot;\\t&quot;)</span></div><div class="line uncovered"><span class="line-number">35</span><span class="line-content">    elseif char == 11 then new_str = new_str .. string.format(&quot;\\v&quot;)</span></div><div class="line uncovered"><span class="line-number">36</span><span class="line-content">    else</span></div><div class="line uncovered"><span class="line-number">37</span><span class="line-content">      if isprint(char) then</span></div><div class="line uncovered"><span class="line-number">38</span><span class="line-content">        new_str = new_str .. string.format(&quot;%c&quot;, char)</span></div><div class="line uncovered"><span class="line-number">39</span><span class="line-content">      else</span></div><div class="line uncovered"><span class="line-number">40</span><span class="line-content">        new_str = new_str .. string.format(&quot;\\%03d&quot;, char)</span></div><div class="line uncovered"><span class="line-number">41</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">42</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">43</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">44</span><span class="line-content">  return new_str</span></div><div class="line non-executable"><span class="line-number">45</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">46</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">47</span><span class="line-content">-- Format a name for display</span></div><div class="line uncovered"><span class="line-number">48</span><span class="line-content">local function name2str(name)</span></div><div class="line uncovered"><span class="line-number">49</span><span class="line-content">  return string.format(&apos;&quot;%s&quot;&apos;, name)</span></div><div class="line non-executable"><span class="line-number">50</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">51</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">52</span><span class="line-content">-- Format a boolean for display</span></div><div class="line uncovered"><span class="line-number">53</span><span class="line-content">local function boolean2str(b)</span></div><div class="line uncovered"><span class="line-number">54</span><span class="line-content">  return string.format(&apos;&quot;%s&quot;&apos;, tostring(b))</span></div><div class="line non-executable"><span class="line-number">55</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">56</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">57</span><span class="line-content">-- Format a number for display</span></div><div class="line uncovered"><span class="line-number">58</span><span class="line-content">local function number2str(n)</span></div><div class="line uncovered"><span class="line-number">59</span><span class="line-content">  return string.format(&apos;&quot;%s&quot;&apos;, tostring(n))</span></div><div class="line non-executable"><span class="line-number">60</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">61</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">62</span><span class="line-content">-- Format a string for display</span></div><div class="line uncovered"><span class="line-number">63</span><span class="line-content">local function string2str(s)</span></div><div class="line uncovered"><span class="line-number">64</span><span class="line-content">  return string.format(&apos;&quot;%s&quot;&apos;, fixed_string(s))</span></div><div class="line non-executable"><span class="line-number">65</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">66</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">67</span><span class="line-content">-- Format a variable for display</span></div><div class="line uncovered"><span class="line-number">68</span><span class="line-content">function var2str(var)</span></div><div class="line uncovered"><span class="line-number">69</span><span class="line-content">  local tag = var.tag</span></div><div class="line uncovered"><span class="line-number">70</span><span class="line-content">  local str = &quot;`&quot; .. tag</span></div><div class="line uncovered"><span class="line-number">71</span><span class="line-content">  if tag == &quot;Id&quot; then -- `Id{ &lt;string&gt; }</span></div><div class="line uncovered"><span class="line-number">72</span><span class="line-content">    str = str .. &quot; &quot; .. name2str(var[1])</span></div><div class="line uncovered"><span class="line-number">73</span><span class="line-content">  elseif tag == &quot;Index&quot; then -- `Index{ expr expr }</span></div><div class="line uncovered"><span class="line-number">74</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">75</span><span class="line-content">    str = str .. exp2str(var[1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">76</span><span class="line-content">    str = str .. exp2str(var[2])</span></div><div class="line uncovered"><span class="line-number">77</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">78</span><span class="line-content">  else</span></div><div class="line uncovered"><span class="line-number">79</span><span class="line-content">    error(&quot;expecting a variable, but got a &quot; .. tag)</span></div><div class="line uncovered"><span class="line-number">80</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">81</span><span class="line-content">  return str</span></div><div class="line non-executable"><span class="line-number">82</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">83</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">84</span><span class="line-content">-- Format a variable list for display</span></div><div class="line uncovered"><span class="line-number">85</span><span class="line-content">function varlist2str(varlist)</span></div><div class="line uncovered"><span class="line-number">86</span><span class="line-content">  local l = {}</span></div><div class="line uncovered"><span class="line-number">87</span><span class="line-content">  for k, v in ipairs(varlist) do</span></div><div class="line uncovered"><span class="line-number">88</span><span class="line-content">    l[k] = var2str(v)</span></div><div class="line uncovered"><span class="line-number">89</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">90</span><span class="line-content">  return &quot;{ &quot; .. table.concat(l, &quot;, &quot;) .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">91</span><span class="line-content">end</span></div><div class="line uncovered"><span class="line-number">92</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">93</span><span class="line-content">-- Format a parameter list for display</span></div><div class="line uncovered"><span class="line-number">94</span><span class="line-content">function parlist2str(parlist)</span></div><div class="line uncovered"><span class="line-number">95</span><span class="line-content">  local l = {}</span></div><div class="line uncovered"><span class="line-number">96</span><span class="line-content">  local len = #parlist</span></div><div class="line uncovered"><span class="line-number">97</span><span class="line-content">  local is_vararg = false</span></div><div class="line uncovered"><span class="line-number">98</span><span class="line-content">  if len &gt; 0 and parlist[len].tag == &quot;Dots&quot; then</span></div><div class="line uncovered"><span class="line-number">99</span><span class="line-content">    is_vararg = true</span></div><div class="line uncovered"><span class="line-number">100</span><span class="line-content">    len = len - 1</span></div><div class="line uncovered"><span class="line-number">101</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">102</span><span class="line-content">  local i = 1</span></div><div class="line uncovered"><span class="line-number">103</span><span class="line-content">  while i &lt;= len do</span></div><div class="line uncovered"><span class="line-number">104</span><span class="line-content">    l[i] = var2str(parlist[i])</span></div><div class="line uncovered"><span class="line-number">105</span><span class="line-content">    i = i + 1</span></div><div class="line uncovered"><span class="line-number">106</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">107</span><span class="line-content">  if is_vararg then</span></div><div class="line uncovered"><span class="line-number">108</span><span class="line-content">    l[i] = &quot;`&quot; .. parlist[i].tag</span></div><div class="line uncovered"><span class="line-number">109</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">110</span><span class="line-content">  return &quot;{ &quot; .. table.concat(l, &quot;, &quot;) .. &quot; }&quot;</span></div><div class="line non-executable"><span class="line-number">111</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">112</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">113</span><span class="line-content">-- Format a field list for display</span></div><div class="line uncovered"><span class="line-number">114</span><span class="line-content">function fieldlist2str(fieldlist)</span></div><div class="line uncovered"><span class="line-number">115</span><span class="line-content">  local l = {}</span></div><div class="line uncovered"><span class="line-number">116</span><span class="line-content">  for k, v in ipairs(fieldlist) do</span></div><div class="line uncovered"><span class="line-number">117</span><span class="line-content">    local tag = v.tag</span></div><div class="line uncovered"><span class="line-number">118</span><span class="line-content">    if tag == &quot;Pair&quot; then -- `Pair{ expr expr }</span></div><div class="line uncovered"><span class="line-number">119</span><span class="line-content">      l[k] = &quot;`&quot; .. tag .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">120</span><span class="line-content">      l[k] = l[k] .. exp2str(v[1]) .. &quot;, &quot; .. exp2str(v[2])</span></div><div class="line uncovered"><span class="line-number">121</span><span class="line-content">      l[k] = l[k] .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">122</span><span class="line-content">    else -- expr</span></div><div class="line uncovered"><span class="line-number">123</span><span class="line-content">      l[k] = exp2str(v)</span></div><div class="line uncovered"><span class="line-number">124</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">125</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">126</span><span class="line-content">  if #l &gt; 0 then</span></div><div class="line uncovered"><span class="line-number">127</span><span class="line-content">    return &quot;{ &quot; .. table.concat(l, &quot;, &quot;) .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">128</span><span class="line-content">  else</span></div><div class="line uncovered"><span class="line-number">129</span><span class="line-content">    return &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">130</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">131</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">132</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">133</span><span class="line-content">-- Format an expression for display</span></div><div class="line uncovered"><span class="line-number">134</span><span class="line-content">function exp2str(exp)</span></div><div class="line uncovered"><span class="line-number">135</span><span class="line-content">  local tag = exp.tag</span></div><div class="line uncovered"><span class="line-number">136</span><span class="line-content">  local str = &quot;`&quot; .. tag</span></div><div class="line uncovered"><span class="line-number">137</span><span class="line-content">  if tag == &quot;Nil&quot; or</span></div><div class="line uncovered"><span class="line-number">138</span><span class="line-content">     tag == &quot;Dots&quot; then</span></div><div class="line uncovered"><span class="line-number">139</span><span class="line-content">  elseif tag == &quot;Boolean&quot; then -- `Boolean{ &lt;boolean&gt; }</span></div><div class="line uncovered"><span class="line-number">140</span><span class="line-content">    str = str .. &quot; &quot; .. boolean2str(exp[1])</span></div><div class="line uncovered"><span class="line-number">141</span><span class="line-content">  elseif tag == &quot;Number&quot; then -- `Number{ &lt;number&gt; }</span></div><div class="line uncovered"><span class="line-number">142</span><span class="line-content">    str = str .. &quot; &quot; .. number2str(exp[1])</span></div><div class="line uncovered"><span class="line-number">143</span><span class="line-content">  elseif tag == &quot;String&quot; then -- `String{ &lt;string&gt; }</span></div><div class="line uncovered"><span class="line-number">144</span><span class="line-content">    str = str .. &quot; &quot; .. string2str(exp[1])</span></div><div class="line uncovered"><span class="line-number">145</span><span class="line-content">  elseif tag == &quot;Function&quot; then -- `Function{ { `Id{ &lt;string&gt; }* `Dots? } block }</span></div><div class="line uncovered"><span class="line-number">146</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">147</span><span class="line-content">    str = str .. parlist2str(exp[1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">148</span><span class="line-content">    str = str .. block2str(exp[2])</span></div><div class="line uncovered"><span class="line-number">149</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">150</span><span class="line-content">  elseif tag == &quot;Table&quot; then -- `Table{ ( `Pair{ expr expr } | expr )* }</span></div><div class="line uncovered"><span class="line-number">151</span><span class="line-content">    str = str .. fieldlist2str(exp)</span></div><div class="line uncovered"><span class="line-number">152</span><span class="line-content">  elseif tag == &quot;Op&quot; then -- `Op{ opid expr expr? }</span></div><div class="line uncovered"><span class="line-number">153</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">154</span><span class="line-content">    str = str .. name2str(exp[1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">155</span><span class="line-content">    str = str .. exp2str(exp[2])</span></div><div class="line uncovered"><span class="line-number">156</span><span class="line-content">    if exp[3] then</span></div><div class="line uncovered"><span class="line-number">157</span><span class="line-content">      str = str .. &quot;, &quot; .. exp2str(exp[3])</span></div><div class="line uncovered"><span class="line-number">158</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">159</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">160</span><span class="line-content">  elseif tag == &quot;Paren&quot; then -- `Paren{ expr }</span></div><div class="line uncovered"><span class="line-number">161</span><span class="line-content">    str = str .. &quot;{ &quot; .. exp2str(exp[1]) .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">162</span><span class="line-content">  elseif tag == &quot;Call&quot; then -- `Call{ expr expr* }</span></div><div class="line uncovered"><span class="line-number">163</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">164</span><span class="line-content">    str = str .. exp2str(exp[1])</span></div><div class="line uncovered"><span class="line-number">165</span><span class="line-content">    if exp[2] then</span></div><div class="line uncovered"><span class="line-number">166</span><span class="line-content">      for i=2, #exp do</span></div><div class="line uncovered"><span class="line-number">167</span><span class="line-content">        str = str .. &quot;, &quot; .. exp2str(exp[i])</span></div><div class="line uncovered"><span class="line-number">168</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">169</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">170</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">171</span><span class="line-content">  elseif tag == &quot;Invoke&quot; then -- `Invoke{ expr `String{ &lt;string&gt; } expr* }</span></div><div class="line uncovered"><span class="line-number">172</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">173</span><span class="line-content">    str = str .. exp2str(exp[1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">174</span><span class="line-content">    str = str .. exp2str(exp[2])</span></div><div class="line uncovered"><span class="line-number">175</span><span class="line-content">    if exp[3] then</span></div><div class="line uncovered"><span class="line-number">176</span><span class="line-content">      for i=3, #exp do</span></div><div class="line uncovered"><span class="line-number">177</span><span class="line-content">        str = str .. &quot;, &quot; .. exp2str(exp[i])</span></div><div class="line uncovered"><span class="line-number">178</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">179</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">180</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">181</span><span class="line-content">  elseif tag == &quot;Id&quot; or -- `Id{ &lt;string&gt; }</span></div><div class="line uncovered"><span class="line-number">182</span><span class="line-content">         tag == &quot;Index&quot; then -- `Index{ expr expr }</span></div><div class="line uncovered"><span class="line-number">183</span><span class="line-content">    str = var2str(exp)</span></div><div class="line uncovered"><span class="line-number">184</span><span class="line-content">  else</span></div><div class="line uncovered"><span class="line-number">185</span><span class="line-content">    error(&quot;expecting an expression, but got a &quot; .. tag)</span></div><div class="line uncovered"><span class="line-number">186</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">187</span><span class="line-content">  return str</span></div><div class="line non-executable"><span class="line-number">188</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">189</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">190</span><span class="line-content">-- Format an expression list for display</span></div><div class="line uncovered"><span class="line-number">191</span><span class="line-content">function explist2str(explist)</span></div><div class="line uncovered"><span class="line-number">192</span><span class="line-content">  local l = {}</span></div><div class="line uncovered"><span class="line-number">193</span><span class="line-content">  for k, v in ipairs(explist) do</span></div><div class="line uncovered"><span class="line-number">194</span><span class="line-content">    l[k] = exp2str(v)</span></div><div class="line uncovered"><span class="line-number">195</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">196</span><span class="line-content">  if #l &gt; 0 then</span></div><div class="line uncovered"><span class="line-number">197</span><span class="line-content">    return &quot;{ &quot; .. table.concat(l, &quot;, &quot;) .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">198</span><span class="line-content">  else</span></div><div class="line uncovered"><span class="line-number">199</span><span class="line-content">    return &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">200</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">201</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">202</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">203</span><span class="line-content">-- Format a statement for display</span></div><div class="line uncovered"><span class="line-number">204</span><span class="line-content">function stm2str(stm)</span></div><div class="line uncovered"><span class="line-number">205</span><span class="line-content">  local tag = stm.tag</span></div><div class="line uncovered"><span class="line-number">206</span><span class="line-content">  local str = &quot;`&quot; .. tag</span></div><div class="line uncovered"><span class="line-number">207</span><span class="line-content">  if tag == &quot;Do&quot; then -- `Do{ stat* }</span></div><div class="line uncovered"><span class="line-number">208</span><span class="line-content">    local l = {}</span></div><div class="line uncovered"><span class="line-number">209</span><span class="line-content">    for k, v in ipairs(stm) do</span></div><div class="line uncovered"><span class="line-number">210</span><span class="line-content">      l[k] = stm2str(v)</span></div><div class="line uncovered"><span class="line-number">211</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">212</span><span class="line-content">    str = str .. &quot;{ &quot; .. table.concat(l, &quot;, &quot;) .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">213</span><span class="line-content">  elseif tag == &quot;Set&quot; then -- `Set{ {lhs+} {expr+} }</span></div><div class="line uncovered"><span class="line-number">214</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">215</span><span class="line-content">    str = str .. varlist2str(stm[1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">216</span><span class="line-content">    str = str .. explist2str(stm[2])</span></div><div class="line uncovered"><span class="line-number">217</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">218</span><span class="line-content">  elseif tag == &quot;While&quot; then -- `While{ expr block }</span></div><div class="line uncovered"><span class="line-number">219</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">220</span><span class="line-content">    str = str .. exp2str(stm[1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">221</span><span class="line-content">    str = str .. block2str(stm[2])</span></div><div class="line uncovered"><span class="line-number">222</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">223</span><span class="line-content">  elseif tag == &quot;Repeat&quot; then -- `Repeat{ block expr }</span></div><div class="line uncovered"><span class="line-number">224</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">225</span><span class="line-content">    str = str .. block2str(stm[1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">226</span><span class="line-content">    str = str .. exp2str(stm[2])</span></div><div class="line uncovered"><span class="line-number">227</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">228</span><span class="line-content">  elseif tag == &quot;If&quot; then -- `If{ (expr block)+ block? }</span></div><div class="line uncovered"><span class="line-number">229</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">230</span><span class="line-content">    local len = #stm</span></div><div class="line uncovered"><span class="line-number">231</span><span class="line-content">    if len % 2 == 0 then</span></div><div class="line uncovered"><span class="line-number">232</span><span class="line-content">      local l = {}</span></div><div class="line uncovered"><span class="line-number">233</span><span class="line-content">      for i=1,len-2,2 do</span></div><div class="line uncovered"><span class="line-number">234</span><span class="line-content">        str = str .. exp2str(stm[i]) .. &quot;, &quot; .. block2str(stm[i+1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">235</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">236</span><span class="line-content">      str = str .. exp2str(stm[len-1]) .. &quot;, &quot; .. block2str(stm[len])</span></div><div class="line uncovered"><span class="line-number">237</span><span class="line-content">    else</span></div><div class="line uncovered"><span class="line-number">238</span><span class="line-content">      local l = {}</span></div><div class="line uncovered"><span class="line-number">239</span><span class="line-content">      for i=1,len-3,2 do</span></div><div class="line uncovered"><span class="line-number">240</span><span class="line-content">        str = str .. exp2str(stm[i]) .. &quot;, &quot; .. block2str(stm[i+1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">241</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">242</span><span class="line-content">      str = str .. exp2str(stm[len-2]) .. &quot;, &quot; .. block2str(stm[len-1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">243</span><span class="line-content">      str = str .. block2str(stm[len])</span></div><div class="line uncovered"><span class="line-number">244</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">245</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">246</span><span class="line-content">  elseif tag == &quot;Fornum&quot; then -- `Fornum{ ident expr expr expr? block }</span></div><div class="line uncovered"><span class="line-number">247</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">248</span><span class="line-content">    str = str .. var2str(stm[1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">249</span><span class="line-content">    str = str .. exp2str(stm[2]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">250</span><span class="line-content">    str = str .. exp2str(stm[3]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">251</span><span class="line-content">    if stm[5] then</span></div><div class="line uncovered"><span class="line-number">252</span><span class="line-content">      str = str .. exp2str(stm[4]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">253</span><span class="line-content">      str = str .. block2str(stm[5])</span></div><div class="line uncovered"><span class="line-number">254</span><span class="line-content">    else</span></div><div class="line uncovered"><span class="line-number">255</span><span class="line-content">      str = str .. block2str(stm[4])</span></div><div class="line uncovered"><span class="line-number">256</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">257</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">258</span><span class="line-content">  elseif tag == &quot;Forin&quot; then -- `Forin{ {ident+} {expr+} block }</span></div><div class="line uncovered"><span class="line-number">259</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">260</span><span class="line-content">    str = str .. varlist2str(stm[1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">261</span><span class="line-content">    str = str .. explist2str(stm[2]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">262</span><span class="line-content">    str = str .. block2str(stm[3])</span></div><div class="line uncovered"><span class="line-number">263</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">264</span><span class="line-content">  elseif tag == &quot;Local&quot; then -- `Local{ {ident+} {expr+}? }</span></div><div class="line uncovered"><span class="line-number">265</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">266</span><span class="line-content">    str = str .. varlist2str(stm[1])</span></div><div class="line uncovered"><span class="line-number">267</span><span class="line-content">    if #stm[2] &gt; 0 then</span></div><div class="line uncovered"><span class="line-number">268</span><span class="line-content">      str = str .. &quot;, &quot; .. explist2str(stm[2])</span></div><div class="line uncovered"><span class="line-number">269</span><span class="line-content">    else</span></div><div class="line uncovered"><span class="line-number">270</span><span class="line-content">      str = str .. &quot;, &quot; .. &quot;{  }&quot;</span></div><div class="line uncovered"><span class="line-number">271</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">272</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">273</span><span class="line-content">  elseif tag == &quot;Localrec&quot; then -- `Localrec{ ident expr }</span></div><div class="line uncovered"><span class="line-number">274</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">275</span><span class="line-content">    str = str .. &quot;{ &quot; .. var2str(stm[1][1]) .. &quot; }, &quot;</span></div><div class="line uncovered"><span class="line-number">276</span><span class="line-content">    str = str .. &quot;{ &quot; .. exp2str(stm[2][1]) .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">277</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">278</span><span class="line-content">  elseif tag == &quot;Goto&quot; or -- `Goto{ &lt;string&gt; }</span></div><div class="line uncovered"><span class="line-number">279</span><span class="line-content">         tag == &quot;Label&quot; then -- `Label{ &lt;string&gt; }</span></div><div class="line uncovered"><span class="line-number">280</span><span class="line-content">    str = str .. &quot;{ &quot; .. name2str(stm[1]) .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">281</span><span class="line-content">  elseif tag == &quot;Return&quot; then -- `Return{ &lt;expr&gt;* }</span></div><div class="line uncovered"><span class="line-number">282</span><span class="line-content">    str = str .. explist2str(stm)</span></div><div class="line uncovered"><span class="line-number">283</span><span class="line-content">  elseif tag == &quot;Break&quot; then</span></div><div class="line uncovered"><span class="line-number">284</span><span class="line-content">  elseif tag == &quot;Call&quot; then -- `Call{ expr expr* }</span></div><div class="line uncovered"><span class="line-number">285</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">286</span><span class="line-content">    str = str .. exp2str(stm[1])</span></div><div class="line uncovered"><span class="line-number">287</span><span class="line-content">    if stm[2] then</span></div><div class="line uncovered"><span class="line-number">288</span><span class="line-content">      for i=2, #stm do</span></div><div class="line uncovered"><span class="line-number">289</span><span class="line-content">        str = str .. &quot;, &quot; .. exp2str(stm[i])</span></div><div class="line uncovered"><span class="line-number">290</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">291</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">292</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">293</span><span class="line-content">  elseif tag == &quot;Invoke&quot; then -- `Invoke{ expr `String{ &lt;string&gt; } expr* }</span></div><div class="line uncovered"><span class="line-number">294</span><span class="line-content">    str = str .. &quot;{ &quot;</span></div><div class="line uncovered"><span class="line-number">295</span><span class="line-content">    str = str .. exp2str(stm[1]) .. &quot;, &quot;</span></div><div class="line uncovered"><span class="line-number">296</span><span class="line-content">    str = str .. exp2str(stm[2])</span></div><div class="line uncovered"><span class="line-number">297</span><span class="line-content">    if stm[3] then</span></div><div class="line uncovered"><span class="line-number">298</span><span class="line-content">      for i=3, #stm do</span></div><div class="line uncovered"><span class="line-number">299</span><span class="line-content">        str = str .. &quot;, &quot; .. exp2str(stm[i])</span></div><div class="line uncovered"><span class="line-number">300</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">301</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">302</span><span class="line-content">    str = str .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">303</span><span class="line-content">  else</span></div><div class="line uncovered"><span class="line-number">304</span><span class="line-content">    error(&quot;expecting a statement, but got a &quot; .. tag)</span></div><div class="line uncovered"><span class="line-number">305</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">306</span><span class="line-content">  return str</span></div><div class="line non-executable"><span class="line-number">307</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">308</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">309</span><span class="line-content">-- Format a block for display</span></div><div class="line uncovered"><span class="line-number">310</span><span class="line-content">function block2str(block)</span></div><div class="line uncovered"><span class="line-number">311</span><span class="line-content">  local l = {}</span></div><div class="line uncovered"><span class="line-number">312</span><span class="line-content">  for k, v in ipairs(block) do</span></div><div class="line uncovered"><span class="line-number">313</span><span class="line-content">    l[k] = stm2str(v)</span></div><div class="line uncovered"><span class="line-number">314</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">315</span><span class="line-content">  return &quot;{ &quot; .. table.concat(l, &quot;, &quot;) .. &quot; }&quot;</span></div><div class="line uncovered"><span class="line-number">316</span><span class="line-content">end</span></div><div class="line uncovered"><span class="line-number">317</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">318</span><span class="line-content">-- Convert an AST to a string representation</span></div><div class="line uncovered"><span class="line-number">319</span><span class="line-content">function M.tostring(t)</span></div><div class="line uncovered"><span class="line-number">320</span><span class="line-content">  assert(type(t) == &quot;table&quot;)</span></div><div class="line uncovered"><span class="line-number">321</span><span class="line-content">  return block2str(t)</span></div><div class="line uncovered"><span class="line-number">322</span><span class="line-content">end</span></div><div class="line uncovered"><span class="line-number">323</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">324</span><span class="line-content">-- Print an AST</span></div><div class="line uncovered"><span class="line-number">325</span><span class="line-content">function M.print(t)</span></div><div class="line uncovered"><span class="line-number">326</span><span class="line-content">  assert(type(t) == &quot;table&quot;)</span></div><div class="line uncovered"><span class="line-number">327</span><span class="line-content">  print(M.tostring(t))</span></div><div class="line uncovered"><span class="line-number">328</span><span class="line-content">end</span></div><div class="line uncovered"><span class="line-number">329</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">330</span><span class="line-content">-- Dump an AST with detailed formatting</span></div><div class="line uncovered"><span class="line-number">331</span><span class="line-content">function M.dump(t, i)</span></div><div class="line uncovered"><span class="line-number">332</span><span class="line-content">  if i == nil then i = 0 end</span></div><div class="line uncovered"><span class="line-number">333</span><span class="line-content">  io.write(string.format(&quot;{\n&quot;))</span></div><div class="line uncovered"><span class="line-number">334</span><span class="line-content">  io.write(string.format(&quot;%s[tag] = %s\n&quot;, string.rep(&quot; &quot;, i+2), t.tag or &quot;nil&quot;))</span></div><div class="line uncovered"><span class="line-number">335</span><span class="line-content">  io.write(string.format(&quot;%s[pos] = %s\n&quot;, string.rep(&quot; &quot;, i+2), t.pos or &quot;nil&quot;))</span></div><div class="line uncovered"><span class="line-number">336</span><span class="line-content">  for k,v in ipairs(t) do</span></div><div class="line uncovered"><span class="line-number">337</span><span class="line-content">    io.write(string.format(&quot;%s[%s] = &quot;, string.rep(&quot; &quot;, i+2), tostring(k)))</span></div><div class="line uncovered"><span class="line-number">338</span><span class="line-content">    if type(v) == &quot;table&quot; then</span></div><div class="line uncovered"><span class="line-number">339</span><span class="line-content">      M.dump(v,i+2)</span></div><div class="line uncovered"><span class="line-number">340</span><span class="line-content">    else</span></div><div class="line uncovered"><span class="line-number">341</span><span class="line-content">      io.write(string.format(&quot;%s\n&quot;, tostring(v)))</span></div><div class="line uncovered"><span class="line-number">342</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">343</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">344</span><span class="line-content">  io.write(string.format(&quot;%s}\n&quot;, string.rep(&quot; &quot;, i)))</span></div><div class="line non-executable"><span class="line-number">345</span><span class="line-content">end</span></div><div class="line uncovered"><span class="line-number">346</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">347</span><span class="line-content">return M</span></div></div>          <div class="file-item">
            <div class="file-name">./lib/coverage/init.lua</div>
            <div class="file-metric">0/982</div>
            <div class="file-metric">0/20</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- firmo code coverage module</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Import submodules</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local debug_hook = require(&quot;lib.coverage.debug_hook&quot;)</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">local file_manager = require(&quot;lib.coverage.file_manager&quot;)</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">local patchup = require(&quot;lib.coverage.patchup&quot;)</s ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/reporting/formatters/init.lua</div>
            <div class="file-metric">0/63</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- Formatter registry initialization</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">-- Import filesystem module for path normalization</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content">local fs = require(&quot;lib.tools.filesystem&quot;)</span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local M = {</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">  -- Export a list of built-in formatters for documentation</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">  built_in = {</span></div><div class="line uncovered"><span class="line-number">8</span><span class="line-content">    coverage = {&quot;summary&quot;, &quot;json&quot;, &quot;html&quot;, &quot;lcov&quot;, &quot;cobertura&quot;},</span></div><div class="line uncovered"><span class="line-number">9</span><span class="line-content">    quality = {&quot;summary&quot;, &quot;json&quot;, &quot;html&quot;},</span></div><div class="line uncovered"><span class="line-number">10</span><span class="line-content">    results = {&quot;junit&quot;, &quot;tap&quot;, &quot;csv&quot;}</span></div><div class="line uncovered"><span class="line-number">11</span><span class="line-content">  }</span></div><div class="line uncovered"><span class="line-number">12</span><span class="line-content">}</span></div><div class="line uncovered"><span class="line-number">13</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">14</span><span class="line-content">-- Load and register all formatters</span></div><div class="line uncovered"><span class="line-number">15</span><span class="line-content">function M.register_all(formatters)</span></div><div class="line non-executable"><span class="line-number">16</span><span class="line-content">  -- Load all the built-in formatters</span></div><div class="line uncovered"><span class="line-number">17</span><span class="line-content">  local formatter_modules = {</span></div><div class="line non-executable"><span class="line-number">18</span><span class="line-content">    &quot;summary&quot;,</span></div><div class="line non-executable"><span class="line-number">19</span><span class="line-content">    &quot;json&quot;,</span></div><div class="line non-executable"><span class="line-number">20</span><span class="line-content">    &quot;html&quot;,</span></div><div class="line non-executable"><span class="line-number">21</span><span class="line-content">    &quot;lcov&quot;,</span></div><div class="line non-executable"><span class="line-number">22</span><span class="line-content">    &quot;tap&quot;,</span></div><div class="line non-executable"><span class="line-number">23</span><span class="line-content">    &quot;csv&quot;,</span></div><div class="line non-executable"><span class="line-number">24</span><span class="line-content">    &quot;junit&quot;,</span></div><div class="line non-executable"><span class="line-number">25</span><span class="line-content">    &quot;cobertura&quot;</span></div><div class="line non-executable"><span class="line-number">26</span><span class="line-content">  }</span></div><div class="line non-executable"><span class="line-number">27</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">28</span><span class="line-content">  for _, module_name in ipairs(formatter_modules) do</span></div><div class="line non-executable"><span class="line-number">29</span><span class="line-content">    -- Get the current module path to use as a base</span></div><div class="line uncovered"><span class="line-number">30</span><span class="line-content">    local current_module_dir = debug.getinfo(1).source:match(&quot;@(.+)/[^/]+$&quot;) or &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">31</span><span class="line-content">    current_module_dir = fs.normalize_path(current_module_dir)</span></div><div class="line uncovered"><span class="line-number">32</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">33</span><span class="line-content">    -- Try multiple possible paths to load the formatter</span></div><div class="line uncovered"><span class="line-number">34</span><span class="line-content">    local formatter_paths = {</span></div><div class="line uncovered"><span class="line-number">35</span><span class="line-content">      &quot;lib.reporting.formatters.&quot; .. module_name,</span></div><div class="line uncovered"><span class="line-number">36</span><span class="line-content">      &quot;../lib/reporting/formatters/&quot; .. module_name,</span></div><div class="line uncovered"><span class="line-number">37</span><span class="line-content">      &quot;./lib/reporting/formatters/&quot; .. module_name,</span></div><div class="line uncovered"><span class="line-number">38</span><span class="line-content">      -- Use filesystem module to join paths properly</span></div><div class="line uncovered"><span class="line-number">39</span><span class="line-content">      fs.join_paths(current_module_dir, module_name),</span></div><div class="line uncovered"><span class="line-number">40</span><span class="line-content">    }</span></div><div class="line uncovered"><span class="line-number">41</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">42</span><span class="line-content">    local loaded = false</span></div><div class="line uncovered"><span class="line-number">43</span><span class="line-content">    for _, path in ipairs(formatter_paths) do</span></div><div class="line non-executable"><span class="line-number">44</span><span class="line-content">      -- Silently try to load formatter without debug output</span></div><div class="line uncovered"><span class="line-number">45</span><span class="line-content">      local ok, formatter_module_or_error = pcall(require, path)</span></div><div class="line uncovered"><span class="line-number">46</span><span class="line-content">      if ok then</span></div><div class="line non-executable"><span class="line-number">47</span><span class="line-content">        -- Handle different module formats:</span></div><div class="line non-executable"><span class="line-number">48</span><span class="line-content">        -- 1. Function that registers formatters</span></div><div class="line uncovered"><span class="line-number">49</span><span class="line-content">        if type(formatter_module_or_error) == &quot;function&quot; then</span></div><div class="line uncovered"><span class="line-number">50</span><span class="line-content">          formatter_module_or_error(formatters)</span></div><div class="line uncovered"><span class="line-number">51</span><span class="line-content">          loaded = true</span></div><div class="line uncovered"><span class="line-number">52</span><span class="line-content">          break</span></div><div class="line uncovered"><span class="line-number">53</span><span class="line-content">        -- 2. Table with register function</span></div><div class="line uncovered"><span class="line-number">54</span><span class="line-content">        elseif type(formatter_module_or_error) == &quot;table&quot; and type(formatter_module_or_error.register) == &quot;function&quot; then</span></div><div class="line uncovered"><span class="line-number">55</span><span class="line-content">          formatter_module_or_error.register(formatters)</span></div><div class="line uncovered"><span class="line-number">56</span><span class="line-content">          loaded = true</span></div><div class="line uncovered"><span class="line-number">57</span><span class="line-content">          break</span></div><div class="line uncovered"><span class="line-number">58</span><span class="line-content">        -- 3. Table with format_coverage/format_quality functions</span></div><div class="line uncovered"><span class="line-number">59</span><span class="line-content">        elseif type(formatter_module_or_error) == &quot;table&quot; then</span></div><div class="line uncovered"><span class="line-number">60</span><span class="line-content">          if type(formatter_module_or_error.format_coverage) == &quot;function&quot; then</span></div><div class="line uncovered"><span class="line-number">61</span><span class="line-content">            formatters.coverage[module_name] = formatter_module_or_error.format_coverage</span></div><div class="line uncovered"><span class="line-number">62</span><span class="line-content">          end</span></div><div class="line uncovered"><span class="line-number">63</span><span class="line-content">          if type(formatter_module_or_error.format_quality) == &quot;function&quot; then</span></div><div class="line uncovered"><span class="line-number">64</span><span class="line-content">            formatters.quality[module_name] = formatter_module_or_error.format_quality</span></div><div class="line uncovered"><span class="line-number">65</span><span class="line-content">          end</span></div><div class="line uncovered"><span class="line-number">66</span><span class="line-content">          if type(formatter_module_or_error.format_results) == &quot;function&quot; then</span></div><div class="line uncovered"><span class="line-number">67</span><span class="line-content">            formatters.results[module_name] = formatter_module_or_error.format_results</span></div><div class="line uncovered"><span class="line-number">68</span><span class="line-content">          end</span></div><div class="line uncovered"><span class="line-number">69</span><span class="line-content">          loaded = true</span></div><div class="line uncovered"><span class="line-number">70</span><span class="line-content">          break</span></div><div class="line uncovered"><span class="line-number">71</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">72</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">73</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">74</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">75</span><span class="line-content">    if not loaded then</span></div><div class="line uncovered"><span class="line-number">76</span><span class="line-content">      print(&quot;WARNING: Failed to load formatter module: &quot; .. module_name)</span></div><div class="line uncovered"><span class="line-number">77</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">78</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">79</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">80</span><span class="line-content">  return formatters</span></div><div class="line non-executable"><span class="line-number">81</span><span class="line-content">end</span></div><div class="line uncovered"><span class="line-number">82</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">83</span><span class="line-content">return M</span></div></div>          <div class="file-item">
            <div class="file-name">lib/tools/markdown.lua</div>
            <div class="file-metric">619/619</div>
            <div class="file-metric">0/14</div>
            <div class="file-metric">1/1</div>
            <div class="file-metric">80.0%</div>
          </div>
          <div class="source-code"><div class="line covered"><span class="line-number">1</span><span class="line-content">-- Markdown fixing utilities for firmo</span></div><div class="line covered"><span class="line-number">2</span><span class="line-content">-- Provides functions to fix common markdown issues</span></div><div class="line covered"><span class="line-number">3</span><span class="line-content">-- This is a Lua implementation of the shell scripts in scripts/markdown/</span></div><div class="line covered"><span class="line-number">4</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">5</span><span class="line-content">-- Import filesystem module for file operations</span></div><div class="line covered"><span class="line-number">6</span><span class="line-content">local fs = require(&quot;lib.tools.filesystem&quot;)</span></div><div class="line covered"><span class="line-number">7</span><span class="line-content"></span></ ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/reporting/formatters/cobertura.lua</div>
            <div class="file-metric">0/114</div>
            <div class="file-metric">0/6</div>
            <div class="file-metric">0/2</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- Cobertura XML formatter for coverage reports</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Helper function to escape XML special characters</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local function escape_xml(str)</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">  if type(str) ~= &quot;string&quot; then</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">    return tostring(str or &quot;&quot;)</span></div><div class="line uncovered"><span class="line-number">8</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">9</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">10</span><span class="line-content">  return str:gsub(&quot;&amp;&quot;, &quot;&amp;amp;&quot;)</span></div><div class="line uncovered"><span class="line-number">11</span><span class="line-content">            :gsub(&quot;&lt;&quot;, &quot;&amp;lt;&quot;)</span></div><div class="line uncovered"><span class="line-number">12</span><span class="line-content">            :gsub(&quot;&gt;&quot;, &quot;&amp;gt;&quot;)</span></div><div class="line uncovered"><span class="line-number">13</span><span class="line-content">            :gsub(&quot;\&quot;&quot;, &quot;&amp;quot;&quot;)</span></div><div class="line uncovered"><span class="line-number">14</span><span class="line-content">            :gsub(&quot;&apos;&quot;, &quot;&amp;apos;&quot;)</span></div><div class="line non-executable"><span class="line-number">15</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">16</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">17</span><span class="line-content">-- Get current timestamp in ISO format</span></div><div class="line uncovered"><span class="line-number">18</span><span class="line-content">local function get_timestamp()</span></div><div class="line uncovered"><span class="line-number">19</span><span class="line-content">  local current_time = os.time()</span></div><div class="line uncovered"><span class="line-number">20</span><span class="line-content">  return os.date(&quot;%Y-%m-%dT%H:%M:%S&quot;, current_time)</span></div><div class="line non-executable"><span class="line-number">21</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">22</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">23</span><span class="line-content">-- Helper function to calculate line rate</span></div><div class="line uncovered"><span class="line-number">24</span><span class="line-content">local function calculate_line_rate(covered, total)</span></div><div class="line uncovered"><span class="line-number">25</span><span class="line-content">  if total == 0 then return 1.0 end</span></div><div class="line uncovered"><span class="line-number">26</span><span class="line-content">  return covered / total</span></div><div class="line non-executable"><span class="line-number">27</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">28</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">29</span><span class="line-content">-- Generate Cobertura XML coverage report</span></div><div class="line non-executable"><span class="line-number">30</span><span class="line-content">-- Format specification: https://github.com/cobertura/cobertura/wiki/XML-Format</span></div><div class="line uncovered"><span class="line-number">31</span><span class="line-content">function M.format_coverage(coverage_data)</span></div><div class="line non-executable"><span class="line-number">32</span><span class="line-content">  -- Validate input</span></div><div class="line uncovered"><span class="line-number">33</span><span class="line-content">  if not coverage_data or not coverage_data.summary then</span></div><div class="line uncovered"><span class="line-number">34</span><span class="line-content">    return [[&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></div><div class="line uncovered"><span class="line-number">35</span><span class="line-content">&lt;!DOCTYPE coverage SYSTEM &quot;http://cobertura.sourceforge.net/xml/coverage-04.dtd&quot;&gt;</span></div><div class="line uncovered"><span class="line-number">36</span><span class="line-content">&lt;coverage lines-valid=&quot;0&quot; lines-covered=&quot;0&quot; line-rate=&quot;0&quot; branches-valid=&quot;0&quot; branches-covered=&quot;0&quot; branch-rate=&quot;0&quot; timestamp=&quot;]] .. os.time() .. [[&quot; complexity=&quot;0&quot; version=&quot;0.1&quot;&gt;</span></div><div class="line uncovered"><span class="line-number">37</span><span class="line-content">  &lt;sources&gt;&lt;source&gt;.&lt;/source&gt;&lt;/sources&gt;</span></div><div class="line uncovered"><span class="line-number">38</span><span class="line-content">  &lt;packages&gt;&lt;/packages&gt;</span></div><div class="line uncovered"><span class="line-number">39</span><span class="line-content">&lt;/coverage&gt;]]</span></div><div class="line uncovered"><span class="line-number">40</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">41</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">42</span><span class="line-content">  -- Get summary data</span></div><div class="line uncovered"><span class="line-number">43</span><span class="line-content">  local summary = coverage_data.summary</span></div><div class="line uncovered"><span class="line-number">44</span><span class="line-content">  local total_lines = summary.total_lines or 0</span></div><div class="line uncovered"><span class="line-number">45</span><span class="line-content">  local covered_lines = summary.covered_lines or 0</span></div><div class="line uncovered"><span class="line-number">46</span><span class="line-content">  local line_rate = calculate_line_rate(covered_lines, total_lines)</span></div><div class="line uncovered"><span class="line-number">47</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">48</span><span class="line-content">  -- Start building XML</span></div><div class="line uncovered"><span class="line-number">49</span><span class="line-content">  local output = {</span></div><div class="line uncovered"><span class="line-number">50</span><span class="line-content">    &apos;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&apos;,</span></div><div class="line non-executable"><span class="line-number">51</span><span class="line-content">    &apos;&lt;!DOCTYPE coverage SYSTEM &quot;http://cobertura.sourceforge.net/xml/coverage-04.dtd&quot;&gt;&apos;,</span></div><div class="line uncovered"><span class="line-number">52</span><span class="line-content">    &apos;&lt;coverage lines-valid=&quot;&apos; .. total_lines .. &apos;&quot; lines-covered=&quot;&apos; .. covered_lines .. </span></div><div class="line uncovered"><span class="line-number">53</span><span class="line-content">    &apos;&quot; line-rate=&quot;&apos; .. string.format(&quot;%.4f&quot;, line_rate) .. </span></div><div class="line uncovered"><span class="line-number">54</span><span class="line-content">    &apos;&quot; branches-valid=&quot;0&quot; branches-covered=&quot;0&quot; branch-rate=&quot;0&quot; timestamp=&quot;&apos; .. </span></div><div class="line uncovered"><span class="line-number">55</span><span class="line-content">    os.time() .. &apos;&quot; complexity=&quot;0&quot; version=&quot;0.1&quot;&gt;&apos;,</span></div><div class="line non-executable"><span class="line-number">56</span><span class="line-content">    &apos;  &lt;sources&gt;&apos;,</span></div><div class="line non-executable"><span class="line-number">57</span><span class="line-content">    &apos;    &lt;source&gt;.&lt;/source&gt;&apos;,</span></div><div class="line non-executable"><span class="line-number">58</span><span class="line-content">    &apos;  &lt;/sources&gt;&apos;,</span></div><div class="line non-executable"><span class="line-number">59</span><span class="line-content">    &apos;  &lt;packages&gt;&apos;</span></div><div class="line non-executable"><span class="line-number">60</span><span class="line-content">  }</span></div><div class="line non-executable"><span class="line-number">61</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">62</span><span class="line-content">  -- Group files by &quot;package&quot; (directory)</span></div><div class="line uncovered"><span class="line-number">63</span><span class="line-content">  local packages = {}</span></div><div class="line uncovered"><span class="line-number">64</span><span class="line-content">  for filepath, file_data in pairs(coverage_data.files or {}) do</span></div><div class="line non-executable"><span class="line-number">65</span><span class="line-content">    -- Extract package (directory) from file path</span></div><div class="line uncovered"><span class="line-number">66</span><span class="line-content">    local package_path = &quot;.&quot;</span></div><div class="line uncovered"><span class="line-number">67</span><span class="line-content">    if filepath:find(&quot;/&quot;) then</span></div><div class="line uncovered"><span class="line-number">68</span><span class="line-content">      package_path = filepath:match(&quot;^(.+)/[^/]+$&quot;) or &quot;.&quot;</span></div><div class="line uncovered"><span class="line-number">69</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">70</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">71</span><span class="line-content">    if not packages[package_path] then</span></div><div class="line uncovered"><span class="line-number">72</span><span class="line-content">      packages[package_path] = {</span></div><div class="line uncovered"><span class="line-number">73</span><span class="line-content">        files = {},</span></div><div class="line uncovered"><span class="line-number">74</span><span class="line-content">        total_lines = 0,</span></div><div class="line uncovered"><span class="line-number">75</span><span class="line-content">        covered_lines = 0</span></div><div class="line uncovered"><span class="line-number">76</span><span class="line-content">      }</span></div><div class="line uncovered"><span class="line-number">77</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">78</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">79</span><span class="line-content">    -- Add file to package</span></div><div class="line uncovered"><span class="line-number">80</span><span class="line-content">    packages[package_path].files[filepath] = file_data</span></div><div class="line uncovered"><span class="line-number">81</span><span class="line-content">    packages[package_path].total_lines = packages[package_path].total_lines + (file_data.total_lines or 0)</span></div><div class="line uncovered"><span class="line-number">82</span><span class="line-content">    packages[package_path].covered_lines = packages[package_path].covered_lines + (file_data.covered_lines or 0)</span></div><div class="line uncovered"><span class="line-number">83</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">84</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">85</span><span class="line-content">  -- Generate XML for each package</span></div><div class="line uncovered"><span class="line-number">86</span><span class="line-content">  for package_path, package_data in pairs(packages) do</span></div><div class="line uncovered"><span class="line-number">87</span><span class="line-content">    local package_line_rate = calculate_line_rate(package_data.covered_lines, package_data.total_lines)</span></div><div class="line uncovered"><span class="line-number">88</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">89</span><span class="line-content">    table.insert(output, &apos;    &lt;package name=&quot;&apos; .. escape_xml(package_path) .. </span></div><div class="line uncovered"><span class="line-number">90</span><span class="line-content">                        &apos;&quot; line-rate=&quot;&apos; .. string.format(&quot;%.4f&quot;, package_line_rate) .. </span></div><div class="line uncovered"><span class="line-number">91</span><span class="line-content">                        &apos;&quot; branch-rate=&quot;0&quot; complexity=&quot;0&quot;&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">92</span><span class="line-content">    table.insert(output, &apos;      &lt;classes&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">93</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">94</span><span class="line-content">    -- Add class (file) information</span></div><div class="line uncovered"><span class="line-number">95</span><span class="line-content">    for filepath, file_data in pairs(package_data.files) do</span></div><div class="line uncovered"><span class="line-number">96</span><span class="line-content">      local filename = filepath:match(&quot;([^/]+)$&quot;) or filepath</span></div><div class="line uncovered"><span class="line-number">97</span><span class="line-content">      local file_line_rate = calculate_line_rate(file_data.covered_lines or 0, file_data.total_lines or 0)</span></div><div class="line uncovered"><span class="line-number">98</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">99</span><span class="line-content">      table.insert(output, &apos;        &lt;class name=&quot;&apos; .. escape_xml(filename) .. </span></div><div class="line uncovered"><span class="line-number">100</span><span class="line-content">                          &apos;&quot; filename=&quot;&apos; .. escape_xml(filepath) .. </span></div><div class="line uncovered"><span class="line-number">101</span><span class="line-content">                          &apos;&quot; line-rate=&quot;&apos; .. string.format(&quot;%.4f&quot;, file_line_rate) .. </span></div><div class="line uncovered"><span class="line-number">102</span><span class="line-content">                          &apos;&quot; branch-rate=&quot;0&quot; complexity=&quot;0&quot;&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">103</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">104</span><span class="line-content">      -- Add methods section (empty for now since we don&apos;t track method-level coverage)</span></div><div class="line uncovered"><span class="line-number">105</span><span class="line-content">      table.insert(output, &apos;          &lt;methods/&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">106</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">107</span><span class="line-content">      -- Add lines section</span></div><div class="line uncovered"><span class="line-number">108</span><span class="line-content">      table.insert(output, &apos;          &lt;lines&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">109</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">110</span><span class="line-content">      -- Add line hits</span></div><div class="line uncovered"><span class="line-number">111</span><span class="line-content">      local line_hits = {}</span></div><div class="line uncovered"><span class="line-number">112</span><span class="line-content">      for line_num, is_covered in pairs(file_data.lines or {}) do</span></div><div class="line uncovered"><span class="line-number">113</span><span class="line-content">        table.insert(line_hits, {</span></div><div class="line uncovered"><span class="line-number">114</span><span class="line-content">          line = line_num,</span></div><div class="line uncovered"><span class="line-number">115</span><span class="line-content">          hits = is_covered and 1 or 0</span></div><div class="line uncovered"><span class="line-number">116</span><span class="line-content">        })</span></div><div class="line uncovered"><span class="line-number">117</span><span class="line-content">      end</span></div><div class="line non-executable"><span class="line-number">118</span><span class="line-content">      </span></div><div class="line non-executable"><span class="line-number">119</span><span class="line-content">      -- Sort lines by number</span></div><div class="line uncovered"><span class="line-number">120</span><span class="line-content">      table.sort(line_hits, function(a, b) return a.line &lt; b.line end)</span></div><div class="line uncovered"><span class="line-number">121</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">122</span><span class="line-content">      -- Add lines to XML</span></div><div class="line uncovered"><span class="line-number">123</span><span class="line-content">      for _, line_info in ipairs(line_hits) do</span></div><div class="line uncovered"><span class="line-number">124</span><span class="line-content">        table.insert(output, &apos;            &lt;line number=&quot;&apos; .. line_info.line .. </span></div><div class="line uncovered"><span class="line-number">125</span><span class="line-content">                            &apos;&quot; hits=&quot;&apos; .. line_info.hits .. </span></div><div class="line uncovered"><span class="line-number">126</span><span class="line-content">                            &apos;&quot; branch=&quot;false&quot;/&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">127</span><span class="line-content">      end</span></div><div class="line non-executable"><span class="line-number">128</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">129</span><span class="line-content">      table.insert(output, &apos;          &lt;/lines&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">130</span><span class="line-content">      table.insert(output, &apos;        &lt;/class&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">131</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">132</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">133</span><span class="line-content">    table.insert(output, &apos;      &lt;/classes&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">134</span><span class="line-content">    table.insert(output, &apos;    &lt;/package&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">135</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">136</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">137</span><span class="line-content">  -- Close XML</span></div><div class="line uncovered"><span class="line-number">138</span><span class="line-content">  table.insert(output, &apos;  &lt;/packages&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">139</span><span class="line-content">  table.insert(output, &apos;&lt;/coverage&gt;&apos;)</span></div><div class="line uncovered"><span class="line-number">140</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">141</span><span class="line-content">  return table.concat(output, &apos;\n&apos;)</span></div><div class="line non-executable"><span class="line-number">142</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">143</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">144</span><span class="line-content">-- Register formatter</span></div><div class="line uncovered"><span class="line-number">145</span><span class="line-content">return function(formatters)</span></div><div class="line uncovered"><span class="line-number">146</span><span class="line-content">  formatters.coverage.cobertura = M.format_coverage</span></div><div class="line uncovered"><span class="line-number">147</span><span class="line-content">end</span></div></div>          <div class="file-item">
            <div class="file-name">lib/reporting/formatters/summary.lua</div>
            <div class="file-metric">0/77</div>
            <div class="file-metric">0/3</div>
            <div class="file-metric">0/3</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- Summary formatter for coverage reports</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Generate a summary coverage report from coverage data</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">function M.format_coverage(coverage_data)</span></div><div class="line non-executable"><span class="line-number">6</span><span class="line-content">  -- Validate the input data to prevent runtime errors</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">  if not coverage_data then</span></div><div class="line uncovered"><span class="line-number">8</span><span class="line-content">    print(&quot;ERROR [Reporting] Missing coverage data&quot;)</span></div><div class="line uncovered"><span class="line-number">9</span><span class="line-content">    return {</span></div><div class="line uncovered"><span class="line-number">10</span><span class="line-content">      files = {},</span></div><div class="line uncovered"><span class="line-number">11</span><span class="line-content">      total_files = 0,</span></div><div class="line uncovered"><span class="line-number">12</span><span class="line-content">      covered_files = 0,</span></div><div class="line uncovered"><span class="line-number">13</span><span class="line-content">      files_pct = 0,</span></div><div class="line uncovered"><span class="line-number">14</span><span class="line-content">      total_lines = 0,</span></div><div class="line uncovered"><span class="line-number">15</span><span class="line-content">      covered_lines = 0,</span></div><div class="line uncovered"><span class="line-number">16</span><span class="line-content">      lines_pct = 0,</span></div><div class="line uncovered"><span class="line-number">17</span><span class="line-content">      total_functions = 0,</span></div><div class="line uncovered"><span class="line-number">18</span><span class="line-content">      covered_functions = 0,</span></div><div class="line uncovered"><span class="line-number">19</span><span class="line-content">      functions_pct = 0,</span></div><div class="line uncovered"><span class="line-number">20</span><span class="line-content">      overall_pct = 0</span></div><div class="line non-executable"><span class="line-number">21</span><span class="line-content">    }</span></div><div class="line uncovered"><span class="line-number">22</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">23</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">24</span><span class="line-content">  -- Make sure we have summary data</span></div><div class="line uncovered"><span class="line-number">25</span><span class="line-content">  local summary = coverage_data.summary or {</span></div><div class="line uncovered"><span class="line-number">26</span><span class="line-content">    total_files = 0,</span></div><div class="line uncovered"><span class="line-number">27</span><span class="line-content">    covered_files = 0,</span></div><div class="line uncovered"><span class="line-number">28</span><span class="line-content">    total_lines = 0,</span></div><div class="line uncovered"><span class="line-number">29</span><span class="line-content">    covered_lines = 0,</span></div><div class="line uncovered"><span class="line-number">30</span><span class="line-content">    total_functions = 0,</span></div><div class="line uncovered"><span class="line-number">31</span><span class="line-content">    covered_functions = 0,</span></div><div class="line uncovered"><span class="line-number">32</span><span class="line-content">    line_coverage_percent = 0,</span></div><div class="line uncovered"><span class="line-number">33</span><span class="line-content">    function_coverage_percent = 0,</span></div><div class="line uncovered"><span class="line-number">34</span><span class="line-content">    overall_percent = 0</span></div><div class="line non-executable"><span class="line-number">35</span><span class="line-content">  }</span></div><div class="line non-executable"><span class="line-number">36</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">37</span><span class="line-content">  -- Debug output for troubleshooting</span></div><div class="line uncovered"><span class="line-number">38</span><span class="line-content">  print(&quot;DEBUG [Reporting] Formatting coverage data with:&quot;)</span></div><div class="line uncovered"><span class="line-number">39</span><span class="line-content">  print(&quot;  Total files: &quot; .. (summary.total_files or 0))</span></div><div class="line uncovered"><span class="line-number">40</span><span class="line-content">  print(&quot;  Covered files: &quot; .. (summary.covered_files or 0))</span></div><div class="line uncovered"><span class="line-number">41</span><span class="line-content">  print(&quot;  Total lines: &quot; .. (summary.total_lines or 0))</span></div><div class="line uncovered"><span class="line-number">42</span><span class="line-content">  print(&quot;  Covered lines: &quot; .. (summary.covered_lines or 0))</span></div><div class="line uncovered"><span class="line-number">43</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">44</span><span class="line-content">  local report = {</span></div><div class="line uncovered"><span class="line-number">45</span><span class="line-content">    files = coverage_data.files or {},</span></div><div class="line uncovered"><span class="line-number">46</span><span class="line-content">    total_files = summary.total_files or 0,</span></div><div class="line uncovered"><span class="line-number">47</span><span class="line-content">    covered_files = summary.covered_files or 0,</span></div><div class="line uncovered"><span class="line-number">48</span><span class="line-content">    files_pct = summary.total_files &gt; 0 and </span></div><div class="line non-executable"><span class="line-number">49</span><span class="line-content">                ((summary.covered_files or 0) / summary.total_files * 100) or 0,</span></div><div class="line non-executable"><span class="line-number">50</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">51</span><span class="line-content">    total_lines = summary.total_lines or 0,</span></div><div class="line uncovered"><span class="line-number">52</span><span class="line-content">    covered_lines = summary.covered_lines or 0,</span></div><div class="line uncovered"><span class="line-number">53</span><span class="line-content">    lines_pct = summary.total_lines &gt; 0 and </span></div><div class="line non-executable"><span class="line-number">54</span><span class="line-content">               ((summary.covered_lines or 0) / summary.total_lines * 100) or 0,</span></div><div class="line non-executable"><span class="line-number">55</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">56</span><span class="line-content">    total_functions = summary.total_functions or 0,</span></div><div class="line uncovered"><span class="line-number">57</span><span class="line-content">    covered_functions = summary.covered_functions or 0,</span></div><div class="line uncovered"><span class="line-number">58</span><span class="line-content">    functions_pct = summary.total_functions &gt; 0 and </span></div><div class="line uncovered"><span class="line-number">59</span><span class="line-content">                   ((summary.covered_functions or 0) / summary.total_functions * 100) or 0,</span></div><div class="line non-executable"><span class="line-number">60</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">61</span><span class="line-content">    overall_pct = summary.overall_percent or 0,</span></div><div class="line non-executable"><span class="line-number">62</span><span class="line-content">  }</span></div><div class="line non-executable"><span class="line-number">63</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">64</span><span class="line-content">  return report</span></div><div class="line non-executable"><span class="line-number">65</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">66</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">67</span><span class="line-content">-- Generate a text summary of quality data</span></div><div class="line uncovered"><span class="line-number">68</span><span class="line-content">function M.format_quality(quality_data)</span></div><div class="line non-executable"><span class="line-number">69</span><span class="line-content">  -- Validate input</span></div><div class="line uncovered"><span class="line-number">70</span><span class="line-content">  if not quality_data then</span></div><div class="line uncovered"><span class="line-number">71</span><span class="line-content">    print(&quot;ERROR [Reporting] Missing quality data&quot;)</span></div><div class="line uncovered"><span class="line-number">72</span><span class="line-content">    return {</span></div><div class="line uncovered"><span class="line-number">73</span><span class="line-content">      level = 0,</span></div><div class="line uncovered"><span class="line-number">74</span><span class="line-content">      level_name = &quot;unknown&quot;,</span></div><div class="line uncovered"><span class="line-number">75</span><span class="line-content">      tests_analyzed = 0,</span></div><div class="line uncovered"><span class="line-number">76</span><span class="line-content">      tests_passing = 0,</span></div><div class="line uncovered"><span class="line-number">77</span><span class="line-content">      quality_pct = 0,</span></div><div class="line uncovered"><span class="line-number">78</span><span class="line-content">      issues = {}</span></div><div class="line uncovered"><span class="line-number">79</span><span class="line-content">    }</span></div><div class="line uncovered"><span class="line-number">80</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">81</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">82</span><span class="line-content">  -- Extract useful data for report</span></div><div class="line uncovered"><span class="line-number">83</span><span class="line-content">  local report = {</span></div><div class="line uncovered"><span class="line-number">84</span><span class="line-content">    level = quality_data.level or 0,</span></div><div class="line uncovered"><span class="line-number">85</span><span class="line-content">    level_name = quality_data.level_name or &quot;unknown&quot;,</span></div><div class="line uncovered"><span class="line-number">86</span><span class="line-content">    tests_analyzed = quality_data.summary and quality_data.summary.tests_analyzed or 0,</span></div><div class="line uncovered"><span class="line-number">87</span><span class="line-content">    tests_passing = quality_data.summary and quality_data.summary.tests_passing_quality or 0,</span></div><div class="line uncovered"><span class="line-number">88</span><span class="line-content">    quality_pct = quality_data.summary and quality_data.summary.quality_percent or 0,</span></div><div class="line uncovered"><span class="line-number">89</span><span class="line-content">    issues = quality_data.summary and quality_data.summary.issues or {}</span></div><div class="line uncovered"><span class="line-number">90</span><span class="line-content">  }</span></div><div class="line uncovered"><span class="line-number">91</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">92</span><span class="line-content">  return report</span></div><div class="line non-executable"><span class="line-number">93</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">94</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">95</span><span class="line-content">-- Register formatters</span></div><div class="line uncovered"><span class="line-number">96</span><span class="line-content">return function(formatters)</span></div><div class="line uncovered"><span class="line-number">97</span><span class="line-content">  formatters.coverage.summary = M.format_coverage</span></div><div class="line uncovered"><span class="line-number">98</span><span class="line-content">  formatters.quality.summary = M.format_quality</span></div><div class="line uncovered"><span class="line-number">99</span><span class="line-content">end</span></div></div>          <div class="file-item">
            <div class="file-name">lib/reporting/init.lua</div>
            <div class="file-metric">591/591</div>
            <div class="file-metric">0/17</div>
            <div class="file-metric">26/26</div>
            <div class="file-metric">80.0%</div>
          </div>
          <div class="source-code"><div class="line covered"><span class="line-number">1</span><span class="line-content">-- firmo reporting module</span></div><div class="line covered"><span class="line-number">2</span><span class="line-content">-- Centralized module for all report generation and file output</span></div><div class="line covered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">4</span><span class="line-content">local M = {}</span></div><div class="line covered"><span class="line-number">5</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">6</span><span class="line-content">-- Import filesystem module for file operations</span></div><div class="line covered"><span class="line-number">7</span><span class="line-content">local fs = require(&quot;lib.tools.filesystem&quot;)</span></div><div class="line covered"><span class="line-number">8</spa ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/tools/vendor/lpeglabel/init.lua</div>
            <div class="file-metric">0/84</div>
            <div class="file-metric">0/4</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- LPegLabel loader for firmo</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">-- This module attempts to load or compile the LPegLabel C module</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content">-- Original source: https://github.com/sqmedeiros/lpeglabel</span></div><div class="line non-executable"><span class="line-number">4</span><span class="line-content">-- MIT License</span></div><div class="line non-executable"><span class="line-number">5</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">local fs = require(&quot;lib.tools.filesystem&quot;) ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/reporting/json.lua</div>
            <div class="file-metric">0/70</div>
            <div class="file-metric">0/3</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- Simple JSON encoder for firmo</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">-- Minimalist implementation for coverage reports</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">-- Encode basic Lua values to JSON</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">local function encode_value(val)</span></div><div class="line uncovered"><span class="line-number">8</span><span c ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/reporting/formatters/junit.lua</div>
            <div class="file-metric">0/103</div>
            <div class="file-metric">0/3</div>
            <div class="file-metric">0/2</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- JUnit XML formatter for test results</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Helper function to escape XML special characters</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local function escape_xml(str)</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">  if type(str) ~= &quot;string&quot; then</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">    return tostring(str or &quot;&quot;)</span></div><div class="line uncover ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/reporting/formatters/json.lua</div>
            <div class="file-metric">0/175</div>
            <div class="file-metric">0/5</div>
            <div class="file-metric">0/23</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- JSON formatter for reports</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Load the JSON module if available</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local json_module</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">local ok, mod = pcall(require, &quot;lib.reporting.json&quot;)</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">if ok then</span></div><div class="line uncovered"><span class="line-number">8</span><span cl ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/coverage/init.lua</div>
            <div class="file-metric">0/982</div>
            <div class="file-metric">0/20</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- firmo code coverage module</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Import submodules</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local debug_hook = require(&quot;lib.coverage.debug_hook&quot;)</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">local file_manager = require(&quot;lib.coverage.file_manager&quot;)</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">local patchup = require(&quot;lib.coverage.patchup&quot;)</s ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/tools/parallel.lua</div>
            <div class="file-metric">0/533</div>
            <div class="file-metric">0/10</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- Parallel test execution module for firmo</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">-- Provides functionality to run test files in parallel for better resource utilization</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">local parallel = {}</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">-- Default configuration</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">parallel.options = {</span></div><div class="line uncovered"><span c ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/mocking/stub.lua</div>
            <div class="file-metric">0/241</div>
            <div class="file-metric">0/24</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- stub.lua - Function stubbing implementation for firmo</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content">local spy = require(&quot;lib.mocking.spy&quot;)</span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">local stub = {}</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">-- Helper function to add sequential return values implementation</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">local function add_sequence_methods(stub_obj, implementation,  ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/core/type_checking.lua</div>
            <div class="file-metric">0/167</div>
            <div class="file-metric">0/6</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- Enhanced type checking for firmo</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">-- Implements advanced type and class validation features</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">local type_checking = {}</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">-- Checks if an object is exactly of the specified primitive type</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">function type_checking.is_exact_type(value, expected_type, m ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/coverage/debug_hook.lua</div>
            <div class="file-metric">566/566</div>
            <div class="file-metric">0/10</div>
            <div class="file-metric">1/1</div>
            <div class="file-metric">80.0%</div>
          </div>
          <div class="source-code"><div class="line covered"><span class="line-number">1</span><span class="line-content">-- Core debug hook implementation</span></div><div class="line covered"><span class="line-number">2</span><span class="line-content">local M = {}</span></div><div class="line covered"><span class="line-number">3</span><span class="line-content">local fs = require(&quot;lib.tools.filesystem&quot;)</span></div><div class="line covered"><span class="line-number">4</span><span class="line-content">local static_analyzer -- Lazily loaded when used</span></div><div class="line covered"><span class="line-number">5</span><span class="line-content">local config = {}</span></div><div class="line covered"><span class="line-number">6</span><span class="line-content">local tracked_files = {}</span></div><div class="line covered"><span class="line-number">7</span><span class="line-content">local processing_hook = false -- Flag to prevent recursive hook calls</span></div><div class="line covered"><span class="line-number">8</span><span class="line-content">local coverage_data = {</span></div><div class="line covered"><span class="line-number">9</span><span class="line-content">  files = {},</span></div><div class="line covered"><span class="line-number">10</span><span class="line-content">  lines = {},</span></div><div class="line covered"><span class="line-number">11</span><span class="line-content">  functions = {},</span></div><div class="line covered"><span class="line-number">12</span><span class="line-content">  blocks = {},      -- Block tracking</span></div><div class="line covered"><span class="line-number">13</span><span class="line-content">  conditions = {}   -- Condition tracking</span></div><div class="line covered"><span class="line-number">14</span><span class="line-content">}</span></div><div class="line covered"><span class="line-number">15</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">16</span><span class="line-content">-- Should we track this file?</span></div><div class="line covered"><span class="line-number">17</span><span class="line-content">function M.should_track_file(file_path)</span></div><div class="line covered"><span class="line-number">18</span><span class="line-content">  local normalized_path = fs.normalize_path(file_path)</span></div><div class="line covered"><span class="line-number">19</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">20</span><span class="line-content">  -- Quick lookup for already-decided files</span></div><div class="line covered"><span class="line-number">21</span><span class="line-content">  if tracked_files[normalized_path] ~= nil then</span></div><div class="line covered"><span class="line-number">22</span><span class="line-content">    return tracked_files[normalized_path]</span></div><div class="line covered"><span class="line-number">23</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">24</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">25</span><span class="line-content">  -- Apply exclude patterns (fast reject)</span></div><div class="line covered"><span class="line-number">26</span><span class="line-content">  for _, pattern in ipairs(config.exclude or {}) do</span></div><div class="line covered"><span class="line-number">27</span><span class="line-content">    if fs.matches_pattern(normalized_path, pattern) then</span></div><div class="line covered"><span class="line-number">28</span><span class="line-content">      tracked_files[normalized_path] = false</span></div><div class="line covered"><span class="line-number">29</span><span class="line-content">      return false</span></div><div class="line covered"><span class="line-number">30</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">31</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">32</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">33</span><span class="line-content">  -- Apply include patterns</span></div><div class="line covered"><span class="line-number">34</span><span class="line-content">  for _, pattern in ipairs(config.include or {}) do</span></div><div class="line covered"><span class="line-number">35</span><span class="line-content">    if fs.matches_pattern(normalized_path, pattern) then</span></div><div class="line covered"><span class="line-number">36</span><span class="line-content">      tracked_files[normalized_path] = true</span></div><div class="line covered"><span class="line-number">37</span><span class="line-content">      return true</span></div><div class="line covered"><span class="line-number">38</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">39</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">40</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">41</span><span class="line-content">  -- Check source directories</span></div><div class="line covered"><span class="line-number">42</span><span class="line-content">  for _, dir in ipairs(config.source_dirs or {&quot;.&quot;}) do</span></div><div class="line covered"><span class="line-number">43</span><span class="line-content">    local normalized_dir = fs.normalize_path(dir)</span></div><div class="line covered"><span class="line-number">44</span><span class="line-content">    if normalized_path:sub(1, #normalized_dir) == normalized_dir then</span></div><div class="line covered"><span class="line-number">45</span><span class="line-content">      tracked_files[normalized_path] = true</span></div><div class="line covered"><span class="line-number">46</span><span class="line-content">      return true</span></div><div class="line covered"><span class="line-number">47</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">48</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">49</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">50</span><span class="line-content">  -- Default decision based on file extension</span></div><div class="line covered"><span class="line-number">51</span><span class="line-content">  local is_lua = normalized_path:match(&quot;%.lua$&quot;) ~= nil</span></div><div class="line covered"><span class="line-number">52</span><span class="line-content">  tracked_files[normalized_path] = is_lua</span></div><div class="line covered"><span class="line-number">53</span><span class="line-content">  return is_lua</span></div><div class="line covered"><span class="line-number">54</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">55</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">56</span><span class="line-content">-- Initialize tracking for a file</span></div><div class="line covered"><span class="line-number">57</span><span class="line-content">local function initialize_file(file_path)</span></div><div class="line covered"><span class="line-number">58</span><span class="line-content">  local normalized_path = fs.normalize_path(file_path)</span></div><div class="line covered"><span class="line-number">59</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">60</span><span class="line-content">  -- Skip if already initialized</span></div><div class="line covered"><span class="line-number">61</span><span class="line-content">  if coverage_data.files[normalized_path] then</span></div><div class="line covered"><span class="line-number">62</span><span class="line-content">    return</span></div><div class="line covered"><span class="line-number">63</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">64</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">65</span><span class="line-content">  -- Count lines in file and store them as an array</span></div><div class="line covered"><span class="line-number">66</span><span class="line-content">  local line_count = 0</span></div><div class="line covered"><span class="line-number">67</span><span class="line-content">  local source_text = fs.read_file(file_path)</span></div><div class="line covered"><span class="line-number">68</span><span class="line-content">  local source_lines = {}</span></div><div class="line covered"><span class="line-number">69</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">70</span><span class="line-content">  if source_text then</span></div><div class="line covered"><span class="line-number">71</span><span class="line-content">    for line in (source_text .. &quot;\n&quot;):gmatch(&quot;([^\r\n]*)[\r\n]&quot;) do</span></div><div class="line covered"><span class="line-number">72</span><span class="line-content">      line_count = line_count + 1</span></div><div class="line covered"><span class="line-number">73</span><span class="line-content">      source_lines[line_count] = line</span></div><div class="line covered"><span class="line-number">74</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">75</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">76</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">77</span><span class="line-content">  coverage_data.files[normalized_path] = {</span></div><div class="line covered"><span class="line-number">78</span><span class="line-content">    lines = {},</span></div><div class="line covered"><span class="line-number">79</span><span class="line-content">    functions = {},</span></div><div class="line covered"><span class="line-number">80</span><span class="line-content">    line_count = line_count,</span></div><div class="line covered"><span class="line-number">81</span><span class="line-content">    source = source_lines,</span></div><div class="line covered"><span class="line-number">82</span><span class="line-content">    source_text = source_text,</span></div><div class="line covered"><span class="line-number">83</span><span class="line-content">    executable_lines = {},</span></div><div class="line covered"><span class="line-number">84</span><span class="line-content">    logical_chunks = {}  -- Store code blocks information</span></div><div class="line covered"><span class="line-number">85</span><span class="line-content">  }</span></div><div class="line covered"><span class="line-number">86</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">87</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">88</span><span class="line-content">-- Check if a line is executable in a file</span></div><div class="line covered"><span class="line-number">89</span><span class="line-content">local function is_line_executable(file_path, line)</span></div><div class="line covered"><span class="line-number">90</span><span class="line-content">  if not static_analyzer then</span></div><div class="line covered"><span class="line-number">91</span><span class="line-content">    static_analyzer = require(&quot;lib.coverage.static_analyzer&quot;)</span></div><div class="line covered"><span class="line-number">92</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">93</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">94</span><span class="line-content">  -- Check if we have static analysis data for this file</span></div><div class="line covered"><span class="line-number">95</span><span class="line-content">  local normalized_path = fs.normalize_path(file_path)</span></div><div class="line covered"><span class="line-number">96</span><span class="line-content">  local file_data = coverage_data.files[normalized_path]</span></div><div class="line covered"><span class="line-number">97</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">98</span><span class="line-content">  if file_data and file_data.code_map then</span></div><div class="line covered"><span class="line-number">99</span><span class="line-content">    -- Use static analysis data</span></div><div class="line covered"><span class="line-number">100</span><span class="line-content">    local is_exec = static_analyzer.is_line_executable(file_data.code_map, line)</span></div><div class="line covered"><span class="line-number">101</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">102</span><span class="line-content">    -- Debug output for specific test files</span></div><div class="line covered"><span class="line-number">103</span><span class="line-content">    if config.debug and file_path:match(&quot;examples/minimal_coverage.lua&quot;) then</span></div><div class="line covered"><span class="line-number">104</span><span class="line-content">      local line_type = &quot;unknown&quot;</span></div><div class="line covered"><span class="line-number">105</span><span class="line-content">      if file_data.code_map.lines and file_data.code_map.lines[line] then</span></div><div class="line covered"><span class="line-number">106</span><span class="line-content">        line_type = file_data.code_map.lines[line].type or &quot;unknown&quot;</span></div><div class="line covered"><span class="line-number">107</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">108</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">109</span><span class="line-content">      print(string.format(&quot;DEBUG [Coverage] Line %d classification: executable=%s, type=%s&quot;, </span></div><div class="line covered"><span class="line-number">110</span><span class="line-content">        line, tostring(is_exec), line_type))</span></div><div class="line covered"><span class="line-number">111</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">112</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">113</span><span class="line-content">    return is_exec</span></div><div class="line covered"><span class="line-number">114</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">115</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">116</span><span class="line-content">  -- Fall back to basic assumption that the line is executable</span></div><div class="line covered"><span class="line-number">117</span><span class="line-content">  -- (the patchup module will fix this later)</span></div><div class="line covered"><span class="line-number">118</span><span class="line-content">  return true</span></div><div class="line covered"><span class="line-number">119</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">120</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">121</span><span class="line-content">-- Debug hook function with optimizations</span></div><div class="line covered"><span class="line-number">122</span><span class="line-content">function M.debug_hook(event, line)</span></div><div class="line covered"><span class="line-number">123</span><span class="line-content">  -- Skip if we&apos;re already processing a hook to prevent recursion</span></div><div class="line covered"><span class="line-number">124</span><span class="line-content">  if processing_hook then</span></div><div class="line covered"><span class="line-number">125</span><span class="line-content">    return</span></div><div class="line covered"><span class="line-number">126</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">127</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">128</span><span class="line-content">  -- Set flag to prevent recursion</span></div><div class="line covered"><span class="line-number">129</span><span class="line-content">  processing_hook = true</span></div><div class="line covered"><span class="line-number">130</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">131</span><span class="line-content">  -- Main hook logic with protected call</span></div><div class="line covered"><span class="line-number">132</span><span class="line-content">  local success, err = pcall(function()</span></div><div class="line covered"><span class="line-number">133</span><span class="line-content">    if event == &quot;line&quot; then</span></div><div class="line covered"><span class="line-number">134</span><span class="line-content">      local info = debug.getinfo(2, &quot;S&quot;)</span></div><div class="line covered"><span class="line-number">135</span><span class="line-content">      if not info or not info.source or info.source:sub(1, 1) ~= &quot;@&quot; then</span></div><div class="line covered"><span class="line-number">136</span><span class="line-content">        processing_hook = false</span></div><div class="line covered"><span class="line-number">137</span><span class="line-content">        return</span></div><div class="line covered"><span class="line-number">138</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">139</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">140</span><span class="line-content">      local file_path = info.source:sub(2)  -- Remove @ prefix</span></div><div class="line covered"><span class="line-number">141</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">142</span><span class="line-content">      -- Quick pattern match to skip coverage module files and parser</span></div><div class="line covered"><span class="line-number">143</span><span class="line-content">      -- Using direct string search which is much faster than pattern matching</span></div><div class="line covered"><span class="line-number">144</span><span class="line-content">      if file_path:find(&quot;lib/coverage&quot;, 1, true) or </span></div><div class="line covered"><span class="line-number">145</span><span class="line-content">         file_path:find(&quot;lib/tools/parser&quot;, 1, true) or</span></div><div class="line covered"><span class="line-number">146</span><span class="line-content">         file_path:find(&quot;lib/tools/vendor&quot;, 1, true) then</span></div><div class="line covered"><span class="line-number">147</span><span class="line-content">        processing_hook = false</span></div><div class="line covered"><span class="line-number">148</span><span class="line-content">        return</span></div><div class="line covered"><span class="line-number">149</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">150</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">151</span><span class="line-content">      -- Check cached tracked_files first for performance</span></div><div class="line covered"><span class="line-number">152</span><span class="line-content">      local should_track = tracked_files[file_path]</span></div><div class="line covered"><span class="line-number">153</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">154</span><span class="line-content">      -- If not in cache, determine if we should track</span></div><div class="line covered"><span class="line-number">155</span><span class="line-content">      if should_track == nil then</span></div><div class="line covered"><span class="line-number">156</span><span class="line-content">        should_track = M.should_track_file(file_path)</span></div><div class="line covered"><span class="line-number">157</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">158</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">159</span><span class="line-content">      if should_track then</span></div><div class="line covered"><span class="line-number">160</span><span class="line-content">        local normalized_path = fs.normalize_path(file_path)</span></div><div class="line covered"><span class="line-number">161</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">162</span><span class="line-content">        -- Initialize file data if needed - use coverage_data.files directly</span></div><div class="line covered"><span class="line-number">163</span><span class="line-content">        if not coverage_data.files[normalized_path] then</span></div><div class="line covered"><span class="line-number">164</span><span class="line-content">          initialize_file(file_path)</span></div><div class="line covered"><span class="line-number">165</span><span class="line-content">          </span></div><div class="line covered"><span class="line-number">166</span><span class="line-content">          -- Debug output only if needed</span></div><div class="line covered"><span class="line-number">167</span><span class="line-content">          if config.debug then</span></div><div class="line covered"><span class="line-number">168</span><span class="line-content">            print(&quot;DEBUG [Coverage Debug Hook] Initialized file: &quot; .. normalized_path)</span></div><div class="line covered"><span class="line-number">169</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">170</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">171</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">172</span><span class="line-content">        -- Track line with minimum operations </span></div><div class="line covered"><span class="line-number">173</span><span class="line-content">        if coverage_data.files[normalized_path] then</span></div><div class="line covered"><span class="line-number">174</span><span class="line-content">          -- Check if this line is executable BEFORE marking it as covered</span></div><div class="line covered"><span class="line-number">175</span><span class="line-content">          local is_executable = true</span></div><div class="line covered"><span class="line-number">176</span><span class="line-content">          </span></div><div class="line covered"><span class="line-number">177</span><span class="line-content">          -- Use static analysis if available, otherwise default to executable</span></div><div class="line covered"><span class="line-number">178</span><span class="line-content">          if coverage_data.files[normalized_path].code_map then</span></div><div class="line covered"><span class="line-number">179</span><span class="line-content">            is_executable = is_line_executable(file_path, line)</span></div><div class="line covered"><span class="line-number">180</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">181</span><span class="line-content">          </span></div><div class="line covered"><span class="line-number">182</span><span class="line-content">          -- Only mark executable lines as covered</span></div><div class="line covered"><span class="line-number">183</span><span class="line-content">          if is_executable then</span></div><div class="line covered"><span class="line-number">184</span><span class="line-content">            coverage_data.files[normalized_path].lines[line] = true</span></div><div class="line covered"><span class="line-number">185</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">186</span><span class="line-content">            -- Also make sure this line is marked as executable in our lookup tables</span></div><div class="line covered"><span class="line-number">187</span><span class="line-content">            if coverage_data.files[normalized_path].executable_lines then</span></div><div class="line covered"><span class="line-number">188</span><span class="line-content">              coverage_data.files[normalized_path].executable_lines[line] = true</span></div><div class="line covered"><span class="line-number">189</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">190</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">191</span><span class="line-content">            -- Only track in the global map if debugging is enabled, to reduce memory usage</span></div><div class="line covered"><span class="line-number">192</span><span class="line-content">            if config.debug then</span></div><div class="line covered"><span class="line-number">193</span><span class="line-content">              coverage_data.lines[normalized_path .. &quot;:&quot; .. line] = true</span></div><div class="line covered"><span class="line-number">194</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">195</span><span class="line-content">              -- Extra debug info for minimal_coverage.lua</span></div><div class="line covered"><span class="line-number">196</span><span class="line-content">              if file_path:match(&quot;examples/minimal_coverage.lua&quot;) then</span></div><div class="line covered"><span class="line-number">197</span><span class="line-content">                print(string.format(&quot;DEBUG [Coverage Hook] Line %d execution tracked&quot;, line))</span></div><div class="line covered"><span class="line-number">198</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">199</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">200</span><span class="line-content">          else</span></div><div class="line covered"><span class="line-number">201</span><span class="line-content">            -- This was a non-executable line execution</span></div><div class="line covered"><span class="line-number">202</span><span class="line-content">            if config.debug and file_path:match(&quot;examples/minimal_coverage.lua&quot;) then</span></div><div class="line covered"><span class="line-number">203</span><span class="line-content">              print(string.format(&quot;DEBUG [Coverage Hook] Skipped non-executable line %d&quot;, line))</span></div><div class="line covered"><span class="line-number">204</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">205</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">206</span><span class="line-content">          </span></div><div class="line covered"><span class="line-number">207</span><span class="line-content">          -- Track block coverage if static analyzer is available and tracking is enabled</span></div><div class="line covered"><span class="line-number">208</span><span class="line-content">          if config.track_blocks and coverage_data.files[normalized_path].code_map then</span></div><div class="line covered"><span class="line-number">209</span><span class="line-content">            -- Lazily load the static analyzer</span></div><div class="line covered"><span class="line-number">210</span><span class="line-content">            if not static_analyzer then</span></div><div class="line covered"><span class="line-number">211</span><span class="line-content">              static_analyzer = require(&quot;lib.coverage.static_analyzer&quot;)</span></div><div class="line covered"><span class="line-number">212</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">213</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">214</span><span class="line-content">            -- Use the static analyzer to find which blocks contain this line</span></div><div class="line covered"><span class="line-number">215</span><span class="line-content">            local blocks_for_line = static_analyzer.get_blocks_for_line(</span></div><div class="line covered"><span class="line-number">216</span><span class="line-content">              coverage_data.files[normalized_path].code_map, </span></div><div class="line covered"><span class="line-number">217</span><span class="line-content">              line</span></div><div class="line covered"><span class="line-number">218</span><span class="line-content">            )</span></div><div class="line covered"><span class="line-number">219</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">220</span><span class="line-content">            -- Initialize logical_chunks if it doesn&apos;t exist</span></div><div class="line covered"><span class="line-number">221</span><span class="line-content">            if not coverage_data.files[normalized_path].logical_chunks then</span></div><div class="line covered"><span class="line-number">222</span><span class="line-content">              coverage_data.files[normalized_path].logical_chunks = {}</span></div><div class="line covered"><span class="line-number">223</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">224</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">225</span><span class="line-content">            -- Mark each block as executed</span></div><div class="line covered"><span class="line-number">226</span><span class="line-content">            for _, block in ipairs(blocks_for_line) do</span></div><div class="line covered"><span class="line-number">227</span><span class="line-content">              -- Get or create block record</span></div><div class="line covered"><span class="line-number">228</span><span class="line-content">              local block_copy = coverage_data.files[normalized_path].logical_chunks[block.id]</span></div><div class="line covered"><span class="line-number">229</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">230</span><span class="line-content">              if not block_copy then</span></div><div class="line covered"><span class="line-number">231</span><span class="line-content">                -- Create a new deep copy if this is the first time we&apos;ve seen this block</span></div><div class="line covered"><span class="line-number">232</span><span class="line-content">                block_copy = {</span></div><div class="line covered"><span class="line-number">233</span><span class="line-content">                  id = block.id,</span></div><div class="line covered"><span class="line-number">234</span><span class="line-content">                  type = block.type,</span></div><div class="line covered"><span class="line-number">235</span><span class="line-content">                  start_line = block.start_line,</span></div><div class="line covered"><span class="line-number">236</span><span class="line-content">                  end_line = block.end_line,</span></div><div class="line covered"><span class="line-number">237</span><span class="line-content">                  parent_id = block.parent_id,</span></div><div class="line covered"><span class="line-number">238</span><span class="line-content">                  branches = {},</span></div><div class="line covered"><span class="line-number">239</span><span class="line-content">                  executed = true, -- Mark as executed immediately</span></div><div class="line covered"><span class="line-number">240</span><span class="line-content">                  execution_count = 1 -- Track execution count</span></div><div class="line covered"><span class="line-number">241</span><span class="line-content">                }</span></div><div class="line covered"><span class="line-number">242</span><span class="line-content">                </span></div><div class="line covered"><span class="line-number">243</span><span class="line-content">                -- Copy branches array if it exists</span></div><div class="line covered"><span class="line-number">244</span><span class="line-content">                if block.branches then</span></div><div class="line covered"><span class="line-number">245</span><span class="line-content">                  for _, branch_id in ipairs(block.branches) do</span></div><div class="line covered"><span class="line-number">246</span><span class="line-content">                    table.insert(block_copy.branches, branch_id)</span></div><div class="line covered"><span class="line-number">247</span><span class="line-content">                  end</span></div><div class="line covered"><span class="line-number">248</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">249</span><span class="line-content">              else</span></div><div class="line covered"><span class="line-number">250</span><span class="line-content">                -- Update existing block record</span></div><div class="line covered"><span class="line-number">251</span><span class="line-content">                block_copy.executed = true</span></div><div class="line covered"><span class="line-number">252</span><span class="line-content">                block_copy.execution_count = (block_copy.execution_count or 0) + 1</span></div><div class="line covered"><span class="line-number">253</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">254</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">255</span><span class="line-content">              -- Store the block in our logical_chunks</span></div><div class="line covered"><span class="line-number">256</span><span class="line-content">              coverage_data.files[normalized_path].logical_chunks[block.id] = block_copy</span></div><div class="line covered"><span class="line-number">257</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">258</span><span class="line-content">              -- Also track the block in the global blocks table for reference</span></div><div class="line covered"><span class="line-number">259</span><span class="line-content">              coverage_data.blocks[normalized_path .. &quot;:&quot; .. block.id] = true</span></div><div class="line covered"><span class="line-number">260</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">261</span><span class="line-content">              -- Update parent blocks - ensures parent blocks are marked as executed</span></div><div class="line covered"><span class="line-number">262</span><span class="line-content">              if block_copy.parent_id and block_copy.parent_id ~= &quot;root&quot; then</span></div><div class="line covered"><span class="line-number">263</span><span class="line-content">                local parent_block = coverage_data.files[normalized_path].logical_chunks[block_copy.parent_id]</span></div><div class="line covered"><span class="line-number">264</span><span class="line-content">                if parent_block then</span></div><div class="line covered"><span class="line-number">265</span><span class="line-content">                  parent_block.executed = true</span></div><div class="line covered"><span class="line-number">266</span><span class="line-content">                  parent_block.execution_count = (parent_block.execution_count or 0) + 1</span></div><div class="line covered"><span class="line-number">267</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">268</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">269</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">270</span><span class="line-content">              -- Debug output</span></div><div class="line covered"><span class="line-number">271</span><span class="line-content">              if config.debug then</span></div><div class="line covered"><span class="line-number">272</span><span class="line-content">                print(&quot;DEBUG [Coverage] Executed block &quot; .. block.id .. </span></div><div class="line covered"><span class="line-number">273</span><span class="line-content">                      &quot; (&quot; .. block.type .. &quot;) at line &quot; .. line .. </span></div><div class="line covered"><span class="line-number">274</span><span class="line-content">                      &quot; in &quot; .. normalized_path ..</span></div><div class="line covered"><span class="line-number">275</span><span class="line-content">                      &quot; (count: &quot; .. (block_copy.execution_count or 1) .. &quot;)&quot;)</span></div><div class="line covered"><span class="line-number">276</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">277</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">278</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">279</span><span class="line-content">            -- Track condition coverage for this line</span></div><div class="line covered"><span class="line-number">280</span><span class="line-content">            local conditions_for_line = static_analyzer.get_conditions_for_line(</span></div><div class="line covered"><span class="line-number">281</span><span class="line-content">              coverage_data.files[normalized_path].code_map,</span></div><div class="line covered"><span class="line-number">282</span><span class="line-content">              line</span></div><div class="line covered"><span class="line-number">283</span><span class="line-content">            )</span></div><div class="line covered"><span class="line-number">284</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">285</span><span class="line-content">            -- Initialize logical_conditions if it doesn&apos;t exist</span></div><div class="line covered"><span class="line-number">286</span><span class="line-content">            if not coverage_data.files[normalized_path].logical_conditions then</span></div><div class="line covered"><span class="line-number">287</span><span class="line-content">              coverage_data.files[normalized_path].logical_conditions = {}</span></div><div class="line covered"><span class="line-number">288</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">289</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">290</span><span class="line-content">            -- Mark each condition as executed</span></div><div class="line covered"><span class="line-number">291</span><span class="line-content">            for _, condition in ipairs(conditions_for_line) do</span></div><div class="line covered"><span class="line-number">292</span><span class="line-content">              -- Get or create condition record</span></div><div class="line covered"><span class="line-number">293</span><span class="line-content">              local condition_copy = coverage_data.files[normalized_path].logical_conditions[condition.id]</span></div><div class="line covered"><span class="line-number">294</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">295</span><span class="line-content">              if not condition_copy then</span></div><div class="line covered"><span class="line-number">296</span><span class="line-content">                condition_copy = {</span></div><div class="line covered"><span class="line-number">297</span><span class="line-content">                  id = condition.id,</span></div><div class="line covered"><span class="line-number">298</span><span class="line-content">                  type = condition.type,</span></div><div class="line covered"><span class="line-number">299</span><span class="line-content">                  start_line = condition.start_line,</span></div><div class="line covered"><span class="line-number">300</span><span class="line-content">                  end_line = condition.end_line,</span></div><div class="line covered"><span class="line-number">301</span><span class="line-content">                  parent_id = condition.parent_id,</span></div><div class="line covered"><span class="line-number">302</span><span class="line-content">                  executed = true,</span></div><div class="line covered"><span class="line-number">303</span><span class="line-content">                  executed_true = false,</span></div><div class="line covered"><span class="line-number">304</span><span class="line-content">                  executed_false = false,</span></div><div class="line covered"><span class="line-number">305</span><span class="line-content">                  execution_count = 1</span></div><div class="line covered"><span class="line-number">306</span><span class="line-content">                }</span></div><div class="line covered"><span class="line-number">307</span><span class="line-content">              else</span></div><div class="line covered"><span class="line-number">308</span><span class="line-content">                condition_copy.executed = true</span></div><div class="line covered"><span class="line-number">309</span><span class="line-content">                condition_copy.execution_count = (condition_copy.execution_count or 0) + 1</span></div><div class="line covered"><span class="line-number">310</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">311</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">312</span><span class="line-content">              -- Improved condition outcome detection</span></div><div class="line covered"><span class="line-number">313</span><span class="line-content">              if condition.type:match(&quot;if_condition&quot;) or condition.type:match(&quot;while_condition&quot;) then</span></div><div class="line covered"><span class="line-number">314</span><span class="line-content">                -- Scan ahead to find the then/else parts</span></div><div class="line covered"><span class="line-number">315</span><span class="line-content">                local then_body_start = condition.end_line + 1</span></div><div class="line covered"><span class="line-number">316</span><span class="line-content">                local else_body_start = nil</span></div><div class="line covered"><span class="line-number">317</span><span class="line-content">                </span></div><div class="line covered"><span class="line-number">318</span><span class="line-content">                -- Scan a reasonable number of lines forward looking for else</span></div><div class="line covered"><span class="line-number">319</span><span class="line-content">                local max_scan_lines = 20</span></div><div class="line covered"><span class="line-number">320</span><span class="line-content">                local in_then_block = true</span></div><div class="line covered"><span class="line-number">321</span><span class="line-content">                </span></div><div class="line covered"><span class="line-number">322</span><span class="line-content">                for i = condition.end_line + 1, condition.end_line + max_scan_lines do</span></div><div class="line covered"><span class="line-number">323</span><span class="line-content">                  if coverage_data.files[normalized_path].source and </span></div><div class="line covered"><span class="line-number">324</span><span class="line-content">                     coverage_data.files[normalized_path].source[i] then</span></div><div class="line covered"><span class="line-number">325</span><span class="line-content">                     </span></div><div class="line covered"><span class="line-number">326</span><span class="line-content">                    local line_text = coverage_data.files[normalized_path].source[i]</span></div><div class="line covered"><span class="line-number">327</span><span class="line-content">                    </span></div><div class="line covered"><span class="line-number">328</span><span class="line-content">                    -- If we find an else, record its position</span></div><div class="line covered"><span class="line-number">329</span><span class="line-content">                    if line_text:match(&quot;^%s*else%s*$&quot;) or </span></div><div class="line covered"><span class="line-number">330</span><span class="line-content">                       line_text:match(&quot;^%s*elseif%s+&quot;) then</span></div><div class="line covered"><span class="line-number">331</span><span class="line-content">                      else_body_start = i + 1</span></div><div class="line covered"><span class="line-number">332</span><span class="line-content">                      in_then_block = false</span></div><div class="line covered"><span class="line-number">333</span><span class="line-content">                      break</span></div><div class="line covered"><span class="line-number">334</span><span class="line-content">                    end</span></div><div class="line covered"><span class="line-number">335</span><span class="line-content">                    </span></div><div class="line covered"><span class="line-number">336</span><span class="line-content">                    -- If we find an end, we&apos;ve reached the end of the if block</span></div><div class="line covered"><span class="line-number">337</span><span class="line-content">                    if line_text:match(&quot;^%s*end%s*$&quot;) then</span></div><div class="line covered"><span class="line-number">338</span><span class="line-content">                      break</span></div><div class="line covered"><span class="line-number">339</span><span class="line-content">                    end</span></div><div class="line covered"><span class="line-number">340</span><span class="line-content">                  end</span></div><div class="line covered"><span class="line-number">341</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">342</span><span class="line-content">                </span></div><div class="line covered"><span class="line-number">343</span><span class="line-content">                -- Check for then branch execution (true outcome)</span></div><div class="line covered"><span class="line-number">344</span><span class="line-content">                if coverage_data.files[normalized_path].lines[then_body_start] then</span></div><div class="line covered"><span class="line-number">345</span><span class="line-content">                  condition_copy.executed_true = true</span></div><div class="line covered"><span class="line-number">346</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">347</span><span class="line-content">                </span></div><div class="line covered"><span class="line-number">348</span><span class="line-content">                -- Check for else branch execution (false outcome)</span></div><div class="line covered"><span class="line-number">349</span><span class="line-content">                if else_body_start and coverage_data.files[normalized_path].lines[else_body_start] then</span></div><div class="line covered"><span class="line-number">350</span><span class="line-content">                  condition_copy.executed_false = true</span></div><div class="line covered"><span class="line-number">351</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">352</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">353</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">354</span><span class="line-content">              -- For conditions inside loop conditions, check for loop body execution</span></div><div class="line covered"><span class="line-number">355</span><span class="line-content">              if condition.type:match(&quot;while_condition&quot;) or condition.type:match(&quot;for_condition&quot;) then</span></div><div class="line covered"><span class="line-number">356</span><span class="line-content">                local loop_body_start = condition.end_line + 1</span></div><div class="line covered"><span class="line-number">357</span><span class="line-content">                </span></div><div class="line covered"><span class="line-number">358</span><span class="line-content">                -- If the loop body is executed, the condition was true at least once</span></div><div class="line covered"><span class="line-number">359</span><span class="line-content">                if coverage_data.files[normalized_path].lines[loop_body_start] then</span></div><div class="line covered"><span class="line-number">360</span><span class="line-content">                  condition_copy.executed_true = true</span></div><div class="line covered"><span class="line-number">361</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">362</span><span class="line-content">                </span></div><div class="line covered"><span class="line-number">363</span><span class="line-content">                -- Check for lines after the loop body to determine if the condition ever evaluated to false</span></div><div class="line covered"><span class="line-number">364</span><span class="line-content">                -- This is a heuristic - if execution continues after the loop, the condition was false</span></div><div class="line covered"><span class="line-number">365</span><span class="line-content">                if coverage_data.files[normalized_path].lines[condition.end_line + 10] then</span></div><div class="line covered"><span class="line-number">366</span><span class="line-content">                  condition_copy.executed_false = true</span></div><div class="line covered"><span class="line-number">367</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">368</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">369</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">370</span><span class="line-content">              -- Update parent conditions if this is a sub-condition</span></div><div class="line covered"><span class="line-number">371</span><span class="line-content">              if condition.parent_id and condition.parent_id ~= &quot;root&quot; then</span></div><div class="line covered"><span class="line-number">372</span><span class="line-content">                local parent_condition = coverage_data.files[normalized_path].logical_conditions[condition.parent_id]</span></div><div class="line covered"><span class="line-number">373</span><span class="line-content">                if parent_condition then</span></div><div class="line covered"><span class="line-number">374</span><span class="line-content">                  parent_condition.executed = true</span></div><div class="line covered"><span class="line-number">375</span><span class="line-content">                  </span></div><div class="line covered"><span class="line-number">376</span><span class="line-content">                  -- If sub-condition was evaluated as true or false, propagate to parent</span></div><div class="line covered"><span class="line-number">377</span><span class="line-content">                  if condition_copy.executed_true then</span></div><div class="line covered"><span class="line-number">378</span><span class="line-content">                    parent_condition.executed_true = true</span></div><div class="line covered"><span class="line-number">379</span><span class="line-content">                  end</span></div><div class="line covered"><span class="line-number">380</span><span class="line-content">                  </span></div><div class="line covered"><span class="line-number">381</span><span class="line-content">                  if condition_copy.executed_false then</span></div><div class="line covered"><span class="line-number">382</span><span class="line-content">                    parent_condition.executed_false = true</span></div><div class="line covered"><span class="line-number">383</span><span class="line-content">                  end</span></div><div class="line covered"><span class="line-number">384</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">385</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">386</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">387</span><span class="line-content">              -- Store the condition in our logical_conditions</span></div><div class="line covered"><span class="line-number">388</span><span class="line-content">              coverage_data.files[normalized_path].logical_conditions[condition.id] = condition_copy</span></div><div class="line covered"><span class="line-number">389</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">390</span><span class="line-content">              -- Also track in the global conditions table for reference</span></div><div class="line covered"><span class="line-number">391</span><span class="line-content">              coverage_data.conditions[normalized_path .. &quot;:&quot; .. condition.id] = true</span></div><div class="line covered"><span class="line-number">392</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">393</span><span class="line-content">              -- Debug output</span></div><div class="line covered"><span class="line-number">394</span><span class="line-content">              if config.debug then</span></div><div class="line covered"><span class="line-number">395</span><span class="line-content">                local outcomes = &quot;&quot;</span></div><div class="line covered"><span class="line-number">396</span><span class="line-content">                if condition_copy.executed_true then outcomes = outcomes .. &quot; true&quot; end</span></div><div class="line covered"><span class="line-number">397</span><span class="line-content">                if condition_copy.executed_false then outcomes = outcomes .. &quot; false&quot; end</span></div><div class="line covered"><span class="line-number">398</span><span class="line-content">                </span></div><div class="line covered"><span class="line-number">399</span><span class="line-content">                print(&quot;DEBUG [Coverage] Executed condition &quot; .. condition.id .. </span></div><div class="line covered"><span class="line-number">400</span><span class="line-content">                      &quot; (&quot; .. condition.type .. &quot;) at line &quot; .. line .. </span></div><div class="line covered"><span class="line-number">401</span><span class="line-content">                      &quot; in &quot; .. normalized_path .. </span></div><div class="line covered"><span class="line-number">402</span><span class="line-content">                      &quot; (count: &quot; .. (condition_copy.execution_count or 1) ..</span></div><div class="line covered"><span class="line-number">403</span><span class="line-content">                      &quot;, outcomes:&quot; .. outcomes .. &quot;)&quot;)</span></div><div class="line covered"><span class="line-number">404</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">405</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">406</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">407</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">408</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">409</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">410</span><span class="line-content">  end)</span></div><div class="line covered"><span class="line-number">411</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">412</span><span class="line-content">  -- Clear flag after processing</span></div><div class="line covered"><span class="line-number">413</span><span class="line-content">  processing_hook = false</span></div><div class="line covered"><span class="line-number">414</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">415</span><span class="line-content">  -- Report errors but don&apos;t crash</span></div><div class="line covered"><span class="line-number">416</span><span class="line-content">  if not success and config.debug then</span></div><div class="line covered"><span class="line-number">417</span><span class="line-content">    print(&quot;DEBUG [Coverage Debug Hook] Error: &quot; .. tostring(err))</span></div><div class="line covered"><span class="line-number">418</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">419</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">420</span><span class="line-content">  -- Handle call events</span></div><div class="line covered"><span class="line-number">421</span><span class="line-content">  if event == &quot;call&quot; then</span></div><div class="line covered"><span class="line-number">422</span><span class="line-content">    -- Skip if we&apos;re already processing a hook to prevent recursion</span></div><div class="line covered"><span class="line-number">423</span><span class="line-content">    if processing_hook then</span></div><div class="line covered"><span class="line-number">424</span><span class="line-content">      return</span></div><div class="line covered"><span class="line-number">425</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">426</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">427</span><span class="line-content">    -- Set flag to prevent recursion</span></div><div class="line covered"><span class="line-number">428</span><span class="line-content">    processing_hook = true</span></div><div class="line covered"><span class="line-number">429</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">430</span><span class="line-content">    -- Main hook logic with protected call</span></div><div class="line covered"><span class="line-number">431</span><span class="line-content">    local success, err = pcall(function()</span></div><div class="line covered"><span class="line-number">432</span><span class="line-content">      local info = debug.getinfo(2, &quot;Sn&quot;)</span></div><div class="line covered"><span class="line-number">433</span><span class="line-content">      if not info or not info.source or info.source:sub(1, 1) ~= &quot;@&quot; then</span></div><div class="line covered"><span class="line-number">434</span><span class="line-content">        processing_hook = false</span></div><div class="line covered"><span class="line-number">435</span><span class="line-content">        return</span></div><div class="line covered"><span class="line-number">436</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">437</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">438</span><span class="line-content">      local file_path = info.source:sub(2)</span></div><div class="line covered"><span class="line-number">439</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">440</span><span class="line-content">      -- Skip lib/coverage and lib/tools/parser files to prevent recursion</span></div><div class="line covered"><span class="line-number">441</span><span class="line-content">      if file_path:match(&quot;lib/coverage&quot;) or </span></div><div class="line covered"><span class="line-number">442</span><span class="line-content">         file_path:match(&quot;lib/tools/parser&quot;) or</span></div><div class="line covered"><span class="line-number">443</span><span class="line-content">         file_path:match(&quot;lib/tools/vendor&quot;) then</span></div><div class="line covered"><span class="line-number">444</span><span class="line-content">        processing_hook = false</span></div><div class="line covered"><span class="line-number">445</span><span class="line-content">        return</span></div><div class="line covered"><span class="line-number">446</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">447</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">448</span><span class="line-content">      if M.should_track_file(file_path) then</span></div><div class="line covered"><span class="line-number">449</span><span class="line-content">        local normalized_path = fs.normalize_path(file_path)</span></div><div class="line covered"><span class="line-number">450</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">451</span><span class="line-content">        -- Initialize file data if needed</span></div><div class="line covered"><span class="line-number">452</span><span class="line-content">        if not coverage_data.files[normalized_path] then</span></div><div class="line covered"><span class="line-number">453</span><span class="line-content">          initialize_file(file_path)</span></div><div class="line covered"><span class="line-number">454</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">455</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">456</span><span class="line-content">        -- IMPORTANT: Make sure we have a valid line number for the function</span></div><div class="line covered"><span class="line-number">457</span><span class="line-content">        if not info.linedefined or info.linedefined &lt;= 0 then</span></div><div class="line covered"><span class="line-number">458</span><span class="line-content">          processing_hook = false</span></div><div class="line covered"><span class="line-number">459</span><span class="line-content">          return</span></div><div class="line covered"><span class="line-number">460</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">461</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">462</span><span class="line-content">        -- Create unique function key - include explicit type identifier for easier lookup</span></div><div class="line covered"><span class="line-number">463</span><span class="line-content">        local func_key = info.linedefined .. &quot;:function:&quot; .. (info.name or &quot;anonymous&quot;)</span></div><div class="line covered"><span class="line-number">464</span><span class="line-content">        local func_name = info.name or (&quot;function_at_line_&quot; .. info.linedefined)</span></div><div class="line covered"><span class="line-number">465</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">466</span><span class="line-content">        -- Add additional information to help with debugging</span></div><div class="line covered"><span class="line-number">467</span><span class="line-content">        local func_info = {</span></div><div class="line covered"><span class="line-number">468</span><span class="line-content">          name = func_name,</span></div><div class="line covered"><span class="line-number">469</span><span class="line-content">          line = info.linedefined,</span></div><div class="line covered"><span class="line-number">470</span><span class="line-content">          executed = true, -- Mark as executed immediately</span></div><div class="line covered"><span class="line-number">471</span><span class="line-content">          calls = 1,</span></div><div class="line covered"><span class="line-number">472</span><span class="line-content">          dynamically_detected = true,</span></div><div class="line covered"><span class="line-number">473</span><span class="line-content">          name_from_debug = info.name, -- Store original name from debug.getinfo</span></div><div class="line covered"><span class="line-number">474</span><span class="line-content">          what = info.what,            -- Store function type (Lua, C, main)</span></div><div class="line covered"><span class="line-number">475</span><span class="line-content">          source = info.source         -- Store source information</span></div><div class="line covered"><span class="line-number">476</span><span class="line-content">        }</span></div><div class="line covered"><span class="line-number">477</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">478</span><span class="line-content">        -- Check if this function was already registered by static analysis</span></div><div class="line covered"><span class="line-number">479</span><span class="line-content">        -- FIXED: More robust matching using line number as the primary key</span></div><div class="line covered"><span class="line-number">480</span><span class="line-content">        local found = false</span></div><div class="line covered"><span class="line-number">481</span><span class="line-content">        for existing_key, func_data in pairs(coverage_data.files[normalized_path].functions) do</span></div><div class="line covered"><span class="line-number">482</span><span class="line-content">          -- Match on line number since that&apos;s most reliable</span></div><div class="line covered"><span class="line-number">483</span><span class="line-content">          if func_data.line == info.linedefined then</span></div><div class="line covered"><span class="line-number">484</span><span class="line-content">            -- Function found, mark as executed</span></div><div class="line covered"><span class="line-number">485</span><span class="line-content">            coverage_data.files[normalized_path].functions[existing_key].executed = true</span></div><div class="line covered"><span class="line-number">486</span><span class="line-content">            coverage_data.files[normalized_path].functions[existing_key].calls = </span></div><div class="line covered"><span class="line-number">487</span><span class="line-content">              (coverage_data.files[normalized_path].functions[existing_key].calls or 0) + 1</span></div><div class="line covered"><span class="line-number">488</span><span class="line-content">            found = true</span></div><div class="line covered"><span class="line-number">489</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">490</span><span class="line-content">            -- Use the existing key for global tracking</span></div><div class="line covered"><span class="line-number">491</span><span class="line-content">            coverage_data.functions[normalized_path .. &quot;:&quot; .. existing_key] = true</span></div><div class="line covered"><span class="line-number">492</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">493</span><span class="line-content">            -- Debug output</span></div><div class="line covered"><span class="line-number">494</span><span class="line-content">            if config.debug then</span></div><div class="line covered"><span class="line-number">495</span><span class="line-content">              print(&quot;DEBUG [Coverage Debug Hook] Executed function &apos;&quot; .. </span></div><div class="line covered"><span class="line-number">496</span><span class="line-content">                    coverage_data.files[normalized_path].functions[existing_key].name .. </span></div><div class="line covered"><span class="line-number">497</span><span class="line-content">                    &quot;&apos; at line &quot; .. info.linedefined .. &quot; in &quot; .. normalized_path)</span></div><div class="line covered"><span class="line-number">498</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">499</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">500</span><span class="line-content">            break</span></div><div class="line covered"><span class="line-number">501</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">502</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">503</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">504</span><span class="line-content">        -- If not found in registered functions, add it</span></div><div class="line covered"><span class="line-number">505</span><span class="line-content">        if not found then</span></div><div class="line covered"><span class="line-number">506</span><span class="line-content">          coverage_data.files[normalized_path].functions[func_key] = func_info</span></div><div class="line covered"><span class="line-number">507</span><span class="line-content">          coverage_data.functions[normalized_path .. &quot;:&quot; .. func_key] = true</span></div><div class="line covered"><span class="line-number">508</span><span class="line-content">          </span></div><div class="line covered"><span class="line-number">509</span><span class="line-content">          -- Debug output</span></div><div class="line covered"><span class="line-number">510</span><span class="line-content">          if config.debug then</span></div><div class="line covered"><span class="line-number">511</span><span class="line-content">            print(&quot;DEBUG [Coverage Debug Hook] Tracked new function &apos;&quot; .. func_name .. </span></div><div class="line covered"><span class="line-number">512</span><span class="line-content">                  &quot;&apos; at line &quot; .. info.linedefined .. &quot; in &quot; .. normalized_path)</span></div><div class="line covered"><span class="line-number">513</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">514</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">515</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">516</span><span class="line-content">    end)</span></div><div class="line covered"><span class="line-number">517</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">518</span><span class="line-content">    -- Clear flag after processing</span></div><div class="line covered"><span class="line-number">519</span><span class="line-content">    processing_hook = false</span></div><div class="line covered"><span class="line-number">520</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">521</span><span class="line-content">    -- Report errors but don&apos;t crash</span></div><div class="line covered"><span class="line-number">522</span><span class="line-content">    if not success and config.debug then</span></div><div class="line covered"><span class="line-number">523</span><span class="line-content">      print(&quot;DEBUG [Coverage Debug Hook] Error: &quot; .. tostring(err))</span></div><div class="line covered"><span class="line-number">524</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">525</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">526</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">527</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">528</span><span class="line-content">-- Set configuration</span></div><div class="line covered"><span class="line-number">529</span><span class="line-content">function M.set_config(new_config)</span></div><div class="line covered"><span class="line-number">530</span><span class="line-content">  config = new_config</span></div><div class="line covered"><span class="line-number">531</span><span class="line-content">  tracked_files = {}  -- Reset cached decisions</span></div><div class="line covered"><span class="line-number">532</span><span class="line-content">  return M</span></div><div class="line covered"><span class="line-number">533</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">534</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">535</span><span class="line-content">-- Get coverage data</span></div><div class="line covered"><span class="line-number">536</span><span class="line-content">function M.get_coverage_data()</span></div><div class="line covered"><span class="line-number">537</span><span class="line-content">  return coverage_data</span></div><div class="line covered"><span class="line-number">538</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">539</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">540</span><span class="line-content">-- Check if a specific line was executed (important for fixing incorrectly marked lines)</span></div><div class="line covered"><span class="line-number">541</span><span class="line-content">function M.was_line_executed(file_path, line_num)</span></div><div class="line covered"><span class="line-number">542</span><span class="line-content">  local normalized_path = fs.normalize_path(file_path)</span></div><div class="line covered"><span class="line-number">543</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">544</span><span class="line-content">  -- Check if we have data for this file</span></div><div class="line covered"><span class="line-number">545</span><span class="line-content">  if not coverage_data.files[normalized_path] then</span></div><div class="line covered"><span class="line-number">546</span><span class="line-content">    return false</span></div><div class="line covered"><span class="line-number">547</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">548</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">549</span><span class="line-content">  -- Check if the line was executed</span></div><div class="line covered"><span class="line-number">550</span><span class="line-content">  return coverage_data.files[normalized_path].lines[line_num] == true</span></div><div class="line covered"><span class="line-number">551</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">552</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">553</span><span class="line-content">-- Reset coverage data</span></div><div class="line covered"><span class="line-number">554</span><span class="line-content">function M.reset()</span></div><div class="line covered"><span class="line-number">555</span><span class="line-content">  coverage_data = {</span></div><div class="line covered"><span class="line-number">556</span><span class="line-content">    files = {},</span></div><div class="line covered"><span class="line-number">557</span><span class="line-content">    lines = {},</span></div><div class="line covered"><span class="line-number">558</span><span class="line-content">    functions = {},</span></div><div class="line covered"><span class="line-number">559</span><span class="line-content">    blocks = {},</span></div><div class="line covered"><span class="line-number">560</span><span class="line-content">    conditions = {}</span></div><div class="line covered"><span class="line-number">561</span><span class="line-content">  }</span></div><div class="line covered"><span class="line-number">562</span><span class="line-content">  tracked_files = {}</span></div><div class="line covered"><span class="line-number">563</span><span class="line-content">  return M</span></div><div class="line covered"><span class="line-number">564</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">565</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">566</span><span class="line-content">return M</span></div></div>          <div class="file-item">
            <div class="file-name">lib/coverage/static_analyzer.lua</div>
            <div class="file-metric">1459/1459</div>
            <div class="file-metric">0/35</div>
            <div class="file-metric">1/1</div>
            <div class="file-metric">80.0%</div>
          </div>
          <div class="source-code"><div class="line covered"><span class="line-number">1</span><span class="line-content">--[[</span></div><div class="line covered"><span class="line-number">2</span><span class="line-content">Static analyzer for coverage module.</span></div><div class="line covered"><span class="line-number">3</span><span class="line-content">This module parses Lua code using our parser and generates code maps</span></div><div class="line covered"><span class="line-number">4</span><span class="line-content">that identify executable lines, functions, and code blocks.</span></div><div class="line covered"><span class="line-number">5</span><span class="line-content">]]</span></div><div class="line covered"><span class="line-number">6</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">7</span><span class="line-content">local M = {}</span></div><div class="line covered"><span class="line-number">8</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">9</span><span class="line-content">local parser = require(&quot;lib.tools.parser&quot;)</span></div><div class="line covered"><span class="line-number">10</span><span class="line-content">local filesystem = require(&quot;lib.tools.filesystem&quot;)</span></div><div class="line covered"><span class="line-number">11</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">12</span><span class="line-content">-- Cache of parsed files to avoid reparsing</span></div><div class="line covered"><span class="line-number">13</span><span class="line-content">local file_cache = {}</span></div><div class="line covered"><span class="line-number">14</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">15</span><span class="line-content">-- Line classification types</span></div><div class="line covered"><span class="line-number">16</span><span class="line-content">M.LINE_TYPES = {</span></div><div class="line covered"><span class="line-number">17</span><span class="line-content">  EXECUTABLE = &quot;executable&quot;,  -- Line contains executable code</span></div><div class="line covered"><span class="line-number">18</span><span class="line-content">  NON_EXECUTABLE = &quot;non_executable&quot;,  -- Line is non-executable (comments, whitespace, end keywords, etc.)</span></div><div class="line covered"><span class="line-number">19</span><span class="line-content">  FUNCTION = &quot;function&quot;,  -- Line contains a function definition</span></div><div class="line covered"><span class="line-number">20</span><span class="line-content">  BRANCH = &quot;branch&quot;,      -- Line contains a branch (if, while, etc.)</span></div><div class="line covered"><span class="line-number">21</span><span class="line-content">  END_BLOCK = &quot;end_block&quot; -- Line contains an end keyword for a block</span></div><div class="line covered"><span class="line-number">22</span><span class="line-content">}</span></div><div class="line covered"><span class="line-number">23</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">24</span><span class="line-content">-- Initializes the static analyzer</span></div><div class="line covered"><span class="line-number">25</span><span class="line-content">function M.init(options)</span></div><div class="line covered"><span class="line-number">26</span><span class="line-content">  options = options or {}</span></div><div class="line covered"><span class="line-number">27</span><span class="line-content">  file_cache = {}</span></div><div class="line covered"><span class="line-number">28</span><span class="line-content">  return M</span></div><div class="line covered"><span class="line-number">29</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">30</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">31</span><span class="line-content">-- Clear the file cache</span></div><div class="line covered"><span class="line-number">32</span><span class="line-content">function M.clear_cache()</span></div><div class="line covered"><span class="line-number">33</span><span class="line-content">  file_cache = {}</span></div><div class="line covered"><span class="line-number">34</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">35</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">36</span><span class="line-content">-- Parse a Lua file and return its AST with enhanced protection</span></div><div class="line covered"><span class="line-number">37</span><span class="line-content">function M.parse_file(file_path)</span></div><div class="line covered"><span class="line-number">38</span><span class="line-content">  -- Check cache first for quick return</span></div><div class="line covered"><span class="line-number">39</span><span class="line-content">  if file_cache[file_path] then</span></div><div class="line covered"><span class="line-number">40</span><span class="line-content">    return file_cache[file_path].ast, file_cache[file_path].code_map</span></div><div class="line covered"><span class="line-number">41</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">42</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">43</span><span class="line-content">  -- Verify file exists</span></div><div class="line covered"><span class="line-number">44</span><span class="line-content">  if not filesystem.file_exists(file_path) then</span></div><div class="line covered"><span class="line-number">45</span><span class="line-content">    return nil, &quot;File not found: &quot; .. file_path</span></div><div class="line covered"><span class="line-number">46</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">47</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">48</span><span class="line-content">  -- Skip testing-related files to improve performance</span></div><div class="line covered"><span class="line-number">49</span><span class="line-content">  if file_path:match(&quot;_test%.lua$&quot;) or </span></div><div class="line covered"><span class="line-number">50</span><span class="line-content">     file_path:match(&quot;_spec%.lua$&quot;) or</span></div><div class="line covered"><span class="line-number">51</span><span class="line-content">     file_path:match(&quot;/tests/&quot;) or</span></div><div class="line covered"><span class="line-number">52</span><span class="line-content">     file_path:match(&quot;/test/&quot;) or</span></div><div class="line covered"><span class="line-number">53</span><span class="line-content">     file_path:match(&quot;/specs/&quot;) or</span></div><div class="line covered"><span class="line-number">54</span><span class="line-content">     file_path:match(&quot;/spec/&quot;) then</span></div><div class="line covered"><span class="line-number">55</span><span class="line-content">    return nil, &quot;Test file excluded from static analysis&quot;</span></div><div class="line covered"><span class="line-number">56</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">57</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">58</span><span class="line-content">  -- Skip already known problematic file types</span></div><div class="line covered"><span class="line-number">59</span><span class="line-content">  if file_path:match(&quot;%.min%.lua$&quot;) or</span></div><div class="line covered"><span class="line-number">60</span><span class="line-content">     file_path:match(&quot;/vendor/&quot;) or</span></div><div class="line covered"><span class="line-number">61</span><span class="line-content">     file_path:match(&quot;/deps/&quot;) or</span></div><div class="line covered"><span class="line-number">62</span><span class="line-content">     file_path:match(&quot;/node_modules/&quot;) then</span></div><div class="line covered"><span class="line-number">63</span><span class="line-content">    return nil, &quot;Excluded dependency from static analysis&quot;</span></div><div class="line covered"><span class="line-number">64</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">65</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">66</span><span class="line-content">  -- Check file size before parsing - INCREASED the limit to 1MB</span></div><div class="line covered"><span class="line-number">67</span><span class="line-content">  -- This ensures we can handle reasonable-sized source files</span></div><div class="line covered"><span class="line-number">68</span><span class="line-content">  local file_size = filesystem.get_file_size(file_path)</span></div><div class="line covered"><span class="line-number">69</span><span class="line-content">  if file_size and file_size &gt; 1024000 then -- 1MB size limit</span></div><div class="line covered"><span class="line-number">70</span><span class="line-content">    print(&quot;WARNING: Skipping static analysis for large file: &quot; .. file_path .. </span></div><div class="line covered"><span class="line-number">71</span><span class="line-content">          &quot; (&quot; .. math.floor(file_size/1024) .. &quot;KB)&quot;)</span></div><div class="line covered"><span class="line-number">72</span><span class="line-content">    return nil, &quot;File too large for analysis: &quot; .. file_path</span></div><div class="line covered"><span class="line-number">73</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">74</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">75</span><span class="line-content">  -- Read the file content with protection</span></div><div class="line covered"><span class="line-number">76</span><span class="line-content">  local content, err</span></div><div class="line covered"><span class="line-number">77</span><span class="line-content">  local success, result = pcall(function()</span></div><div class="line covered"><span class="line-number">78</span><span class="line-content">    content, err = filesystem.read_file(file_path)</span></div><div class="line covered"><span class="line-number">79</span><span class="line-content">    if not content then</span></div><div class="line covered"><span class="line-number">80</span><span class="line-content">      return nil, &quot;Failed to read file: &quot; .. tostring(err)</span></div><div class="line covered"><span class="line-number">81</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">82</span><span class="line-content">    return content, nil</span></div><div class="line covered"><span class="line-number">83</span><span class="line-content">  end)</span></div><div class="line covered"><span class="line-number">84</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">85</span><span class="line-content">  if not success then</span></div><div class="line covered"><span class="line-number">86</span><span class="line-content">    return nil, &quot;Exception reading file: &quot; .. tostring(result)</span></div><div class="line covered"><span class="line-number">87</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">88</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">89</span><span class="line-content">  if not content then</span></div><div class="line covered"><span class="line-number">90</span><span class="line-content">    return nil, err or &quot;Unknown error reading file&quot;</span></div><div class="line covered"><span class="line-number">91</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">92</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">93</span><span class="line-content">  -- Skip if content is too large (use smaller limit for safety)</span></div><div class="line covered"><span class="line-number">94</span><span class="line-content">  if #content &gt; 200000 then -- 200KB content limit - reduced from 500KB</span></div><div class="line covered"><span class="line-number">95</span><span class="line-content">    print(&quot;WARNING: Skipping static analysis for large content: &quot; .. file_path .. </span></div><div class="line covered"><span class="line-number">96</span><span class="line-content">          &quot; (&quot; .. math.floor(#content/1024) .. &quot;KB)&quot;)</span></div><div class="line covered"><span class="line-number">97</span><span class="line-content">    return nil, &quot;File content too large for analysis&quot;</span></div><div class="line covered"><span class="line-number">98</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">99</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">100</span><span class="line-content">  -- Quick check for deeply nested structures </span></div><div class="line covered"><span class="line-number">101</span><span class="line-content">  local max_depth = 0</span></div><div class="line covered"><span class="line-number">102</span><span class="line-content">  local current_depth = 0</span></div><div class="line covered"><span class="line-number">103</span><span class="line-content">  for i = 1, #content do</span></div><div class="line covered"><span class="line-number">104</span><span class="line-content">    local c = content:sub(i, i)</span></div><div class="line covered"><span class="line-number">105</span><span class="line-content">    if c == &quot;{&quot; or c == &quot;(&quot; or c == &quot;[&quot; then</span></div><div class="line covered"><span class="line-number">106</span><span class="line-content">      current_depth = current_depth + 1</span></div><div class="line covered"><span class="line-number">107</span><span class="line-content">      if current_depth &gt; max_depth then</span></div><div class="line covered"><span class="line-number">108</span><span class="line-content">        max_depth = current_depth</span></div><div class="line covered"><span class="line-number">109</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">110</span><span class="line-content">    elseif c == &quot;}&quot; or c == &quot;)&quot; or c == &quot;]&quot; then</span></div><div class="line covered"><span class="line-number">111</span><span class="line-content">      current_depth = math.max(0, current_depth - 1)</span></div><div class="line covered"><span class="line-number">112</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">113</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">114</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">115</span><span class="line-content">  -- Skip files with excessively deep nesting</span></div><div class="line covered"><span class="line-number">116</span><span class="line-content">  if max_depth &gt; 100 then</span></div><div class="line covered"><span class="line-number">117</span><span class="line-content">    print(&quot;WARNING: Skipping static analysis for deeply nested file: &quot; .. file_path .. </span></div><div class="line covered"><span class="line-number">118</span><span class="line-content">          &quot; (depth &quot; .. max_depth .. &quot;)&quot;)</span></div><div class="line covered"><span class="line-number">119</span><span class="line-content">    return nil, &quot;File has too deeply nested structures&quot;</span></div><div class="line covered"><span class="line-number">120</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">121</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">122</span><span class="line-content">  -- Finally parse the content with all our protections in place</span></div><div class="line covered"><span class="line-number">123</span><span class="line-content">  return M.parse_content(content, file_path)</span></div><div class="line covered"><span class="line-number">124</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">125</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">126</span><span class="line-content">-- Count lines in the content</span></div><div class="line covered"><span class="line-number">127</span><span class="line-content">local function count_lines(content)</span></div><div class="line covered"><span class="line-number">128</span><span class="line-content">  local count = 1</span></div><div class="line covered"><span class="line-number">129</span><span class="line-content">  for _ in content:gmatch(&quot;\n&quot;) do</span></div><div class="line covered"><span class="line-number">130</span><span class="line-content">    count = count + 1</span></div><div class="line covered"><span class="line-number">131</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">132</span><span class="line-content">  return count</span></div><div class="line covered"><span class="line-number">133</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">134</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">135</span><span class="line-content">-- Create efficient line mappings once instead of repeatedly traversing content</span></div><div class="line covered"><span class="line-number">136</span><span class="line-content">local line_position_cache = {}</span></div><div class="line covered"><span class="line-number">137</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">138</span><span class="line-content">-- Pre-process content into line mappings for O(1) lookups</span></div><div class="line covered"><span class="line-number">139</span><span class="line-content">local function build_line_mappings(content)</span></div><div class="line covered"><span class="line-number">140</span><span class="line-content">  -- Check if we&apos;ve already processed this content</span></div><div class="line covered"><span class="line-number">141</span><span class="line-content">  local content_hash = tostring(#content) -- Use content length as simple hash</span></div><div class="line covered"><span class="line-number">142</span><span class="line-content">  if line_position_cache[content_hash] then</span></div><div class="line covered"><span class="line-number">143</span><span class="line-content">    return line_position_cache[content_hash]</span></div><div class="line covered"><span class="line-number">144</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">145</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">146</span><span class="line-content">  -- Build the mappings in one pass</span></div><div class="line covered"><span class="line-number">147</span><span class="line-content">  local mappings = {</span></div><div class="line covered"><span class="line-number">148</span><span class="line-content">    line_starts = {1}, -- First line always starts at position 1</span></div><div class="line covered"><span class="line-number">149</span><span class="line-content">    line_ends = {},</span></div><div class="line covered"><span class="line-number">150</span><span class="line-content">    pos_to_line = {} -- LUT for faster position to line lookups</span></div><div class="line covered"><span class="line-number">151</span><span class="line-content">  }</span></div><div class="line covered"><span class="line-number">152</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">153</span><span class="line-content">  -- Process the content in one pass</span></div><div class="line covered"><span class="line-number">154</span><span class="line-content">  local line_count = 1</span></div><div class="line covered"><span class="line-number">155</span><span class="line-content">  for i = 1, #content do</span></div><div class="line covered"><span class="line-number">156</span><span class="line-content">    -- Create a sparse position-to-line lookup table (every 100 chars)</span></div><div class="line covered"><span class="line-number">157</span><span class="line-content">    if i % 100 == 0 then</span></div><div class="line covered"><span class="line-number">158</span><span class="line-content">      mappings.pos_to_line[i] = line_count</span></div><div class="line covered"><span class="line-number">159</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">160</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">161</span><span class="line-content">    if content:sub(i, i) == &quot;\n&quot; then</span></div><div class="line covered"><span class="line-number">162</span><span class="line-content">      -- Record end of current line</span></div><div class="line covered"><span class="line-number">163</span><span class="line-content">      mappings.line_ends[line_count] = i - 1 -- Exclude the newline</span></div><div class="line covered"><span class="line-number">164</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">165</span><span class="line-content">      -- Record start of next line</span></div><div class="line covered"><span class="line-number">166</span><span class="line-content">      line_count = line_count + 1</span></div><div class="line covered"><span class="line-number">167</span><span class="line-content">      mappings.line_starts[line_count] = i + 1</span></div><div class="line covered"><span class="line-number">168</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">169</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">170</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">171</span><span class="line-content">  -- Handle the last line</span></div><div class="line covered"><span class="line-number">172</span><span class="line-content">  if not mappings.line_ends[line_count] then</span></div><div class="line covered"><span class="line-number">173</span><span class="line-content">    mappings.line_ends[line_count] = #content</span></div><div class="line covered"><span class="line-number">174</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">175</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">176</span><span class="line-content">  -- Store in cache</span></div><div class="line covered"><span class="line-number">177</span><span class="line-content">  line_position_cache[content_hash] = mappings</span></div><div class="line covered"><span class="line-number">178</span><span class="line-content">  return mappings</span></div><div class="line covered"><span class="line-number">179</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">180</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">181</span><span class="line-content">-- Get the line number for a position in the content - using cached mappings</span></div><div class="line covered"><span class="line-number">182</span><span class="line-content">local function get_line_for_position(content, pos)</span></div><div class="line covered"><span class="line-number">183</span><span class="line-content">  -- Build mappings if needed</span></div><div class="line covered"><span class="line-number">184</span><span class="line-content">  local mappings = build_line_mappings(content)</span></div><div class="line covered"><span class="line-number">185</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">186</span><span class="line-content">  -- Use pos_to_line LUT for quick estimation</span></div><div class="line covered"><span class="line-number">187</span><span class="line-content">  local start_line = 1</span></div><div class="line covered"><span class="line-number">188</span><span class="line-content">  for check_pos, line in pairs(mappings.pos_to_line) do</span></div><div class="line covered"><span class="line-number">189</span><span class="line-content">    if check_pos &lt;= pos then</span></div><div class="line covered"><span class="line-number">190</span><span class="line-content">      start_line = line</span></div><div class="line covered"><span class="line-number">191</span><span class="line-content">    else</span></div><div class="line covered"><span class="line-number">192</span><span class="line-content">      break</span></div><div class="line covered"><span class="line-number">193</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">194</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">195</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">196</span><span class="line-content">  -- Linear search only from the estimated line</span></div><div class="line covered"><span class="line-number">197</span><span class="line-content">  for line = start_line, #mappings.line_starts do</span></div><div class="line covered"><span class="line-number">198</span><span class="line-content">    local line_start = mappings.line_starts[line]</span></div><div class="line covered"><span class="line-number">199</span><span class="line-content">    local line_end = mappings.line_ends[line] or #content</span></div><div class="line covered"><span class="line-number">200</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">201</span><span class="line-content">    if line_start &lt;= pos and pos &lt;= line_end + 1 then</span></div><div class="line covered"><span class="line-number">202</span><span class="line-content">      return line</span></div><div class="line covered"><span class="line-number">203</span><span class="line-content">    elseif line_start &gt; pos then</span></div><div class="line covered"><span class="line-number">204</span><span class="line-content">      -- We&apos;ve gone past the position, return the previous line</span></div><div class="line covered"><span class="line-number">205</span><span class="line-content">      return line - 1</span></div><div class="line covered"><span class="line-number">206</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">207</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">208</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">209</span><span class="line-content">  -- Fallback</span></div><div class="line covered"><span class="line-number">210</span><span class="line-content">  return #mappings.line_starts</span></div><div class="line covered"><span class="line-number">211</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">212</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">213</span><span class="line-content">-- Get the start position of a line in the content - O(1) using cached mappings</span></div><div class="line covered"><span class="line-number">214</span><span class="line-content">local function getLineStartPos(content, line_num)</span></div><div class="line covered"><span class="line-number">215</span><span class="line-content">  -- Build mappings if needed</span></div><div class="line covered"><span class="line-number">216</span><span class="line-content">  local mappings = build_line_mappings(content)</span></div><div class="line covered"><span class="line-number">217</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">218</span><span class="line-content">  -- Direct lookup</span></div><div class="line covered"><span class="line-number">219</span><span class="line-content">  return mappings.line_starts[line_num] or (#content + 1)</span></div><div class="line covered"><span class="line-number">220</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">221</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">222</span><span class="line-content">-- Get the end position of a line in the content - O(1) using cached mappings</span></div><div class="line covered"><span class="line-number">223</span><span class="line-content">local function getLineEndPos(content, line_num)</span></div><div class="line covered"><span class="line-number">224</span><span class="line-content">  -- Build mappings if needed</span></div><div class="line covered"><span class="line-number">225</span><span class="line-content">  local mappings = build_line_mappings(content)</span></div><div class="line covered"><span class="line-number">226</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">227</span><span class="line-content">  -- Direct lookup</span></div><div class="line covered"><span class="line-number">228</span><span class="line-content">  return mappings.line_ends[line_num] or #content</span></div><div class="line covered"><span class="line-number">229</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">230</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">231</span><span class="line-content">-- Create lookup tables for tag checking (much faster than iterating arrays)</span></div><div class="line covered"><span class="line-number">232</span><span class="line-content">local EXECUTABLE_TAGS = {</span></div><div class="line covered"><span class="line-number">233</span><span class="line-content">  Call = true, Invoke = true, Set = true, Local = true, Return = true,</span></div><div class="line covered"><span class="line-number">234</span><span class="line-content">  If = true, While = true, Repeat = true, Fornum = true, Forin = true,</span></div><div class="line covered"><span class="line-number">235</span><span class="line-content">  Break = true, Goto = true</span></div><div class="line covered"><span class="line-number">236</span><span class="line-content">}</span></div><div class="line covered"><span class="line-number">237</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">238</span><span class="line-content">local NON_EXECUTABLE_TAGS = {</span></div><div class="line covered"><span class="line-number">239</span><span class="line-content">  Block = true, Label = true, NameList = true, VarList = true, ExpList = true,</span></div><div class="line covered"><span class="line-number">240</span><span class="line-content">  Table = true, Pair = true, Id = true, String = true, Number = true,</span></div><div class="line covered"><span class="line-number">241</span><span class="line-content">  Boolean = true, Nil = true, Dots = true</span></div><div class="line covered"><span class="line-number">242</span><span class="line-content">}</span></div><div class="line covered"><span class="line-number">243</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">244</span><span class="line-content">-- Determine if a line is executable based on AST nodes that intersect with it</span></div><div class="line covered"><span class="line-number">245</span><span class="line-content">-- With optimized lookup tables and time limit</span></div><div class="line covered"><span class="line-number">246</span><span class="line-content">local function is_line_executable(nodes, line_num, content)</span></div><div class="line covered"><span class="line-number">247</span><span class="line-content">  -- Add time limit protection</span></div><div class="line covered"><span class="line-number">248</span><span class="line-content">  local start_time = os.clock()</span></div><div class="line covered"><span class="line-number">249</span><span class="line-content">  local MAX_ANALYSIS_TIME = 0.5 -- 500ms max for this function</span></div><div class="line covered"><span class="line-number">250</span><span class="line-content">  local node_count = 0</span></div><div class="line covered"><span class="line-number">251</span><span class="line-content">  local MAX_NODES = 10000 -- Maximum number of nodes to process</span></div><div class="line covered"><span class="line-number">252</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">253</span><span class="line-content">  for _, node in ipairs(nodes) do</span></div><div class="line covered"><span class="line-number">254</span><span class="line-content">    -- Check processing limits</span></div><div class="line covered"><span class="line-number">255</span><span class="line-content">    node_count = node_count + 1</span></div><div class="line covered"><span class="line-number">256</span><span class="line-content">    if node_count &gt; MAX_NODES then</span></div><div class="line covered"><span class="line-number">257</span><span class="line-content">      print(&quot;WARNING: Node limit reached in is_line_executable&quot;)</span></div><div class="line covered"><span class="line-number">258</span><span class="line-content">      return false</span></div><div class="line covered"><span class="line-number">259</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">260</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">261</span><span class="line-content">    if node_count % 1000 == 0 and os.clock() - start_time &gt; MAX_ANALYSIS_TIME then</span></div><div class="line covered"><span class="line-number">262</span><span class="line-content">      print(&quot;WARNING: Time limit reached in is_line_executable&quot;)</span></div><div class="line covered"><span class="line-number">263</span><span class="line-content">      return false</span></div><div class="line covered"><span class="line-number">264</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">265</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">266</span><span class="line-content">    -- Skip nodes without position info</span></div><div class="line covered"><span class="line-number">267</span><span class="line-content">    if not node.pos or not node.end_pos then</span></div><div class="line covered"><span class="line-number">268</span><span class="line-content">      goto continue</span></div><div class="line covered"><span class="line-number">269</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">270</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">271</span><span class="line-content">    -- Fast lookups using tables instead of loops</span></div><div class="line covered"><span class="line-number">272</span><span class="line-content">    local is_executable = EXECUTABLE_TAGS[node.tag] or false</span></div><div class="line covered"><span class="line-number">273</span><span class="line-content">    local is_non_executable = NON_EXECUTABLE_TAGS[node.tag] or false</span></div><div class="line covered"><span class="line-number">274</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">275</span><span class="line-content">    -- Skip explicit non-executable nodes</span></div><div class="line covered"><span class="line-number">276</span><span class="line-content">    if is_non_executable and not is_executable then</span></div><div class="line covered"><span class="line-number">277</span><span class="line-content">      goto continue</span></div><div class="line covered"><span class="line-number">278</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">279</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">280</span><span class="line-content">    -- Function definitions are special - they&apos;re executable at the definition line</span></div><div class="line covered"><span class="line-number">281</span><span class="line-content">    if node.tag == &quot;Function&quot; then</span></div><div class="line covered"><span class="line-number">282</span><span class="line-content">      local node_start_line = get_line_for_position(content, node.pos)</span></div><div class="line covered"><span class="line-number">283</span><span class="line-content">      if node_start_line == line_num then</span></div><div class="line covered"><span class="line-number">284</span><span class="line-content">        return true</span></div><div class="line covered"><span class="line-number">285</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">286</span><span class="line-content">      goto continue</span></div><div class="line covered"><span class="line-number">287</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">288</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">289</span><span class="line-content">    -- Check if this node spans the line</span></div><div class="line covered"><span class="line-number">290</span><span class="line-content">    local node_start_line = get_line_for_position(content, node.pos)</span></div><div class="line covered"><span class="line-number">291</span><span class="line-content">    local node_end_line = get_line_for_position(content, node.end_pos)</span></div><div class="line covered"><span class="line-number">292</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">293</span><span class="line-content">    if node_start_line &lt;= line_num and node_end_line &gt;= line_num then</span></div><div class="line covered"><span class="line-number">294</span><span class="line-content">      return true</span></div><div class="line covered"><span class="line-number">295</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">296</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">297</span><span class="line-content">    ::continue::</span></div><div class="line covered"><span class="line-number">298</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">299</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">300</span><span class="line-content">  return false</span></div><div class="line covered"><span class="line-number">301</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">302</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">303</span><span class="line-content">-- Parse Lua code and return its AST with improved timeout protection</span></div><div class="line covered"><span class="line-number">304</span><span class="line-content">function M.parse_content(content, file_path)</span></div><div class="line covered"><span class="line-number">305</span><span class="line-content">  -- Use cache if available</span></div><div class="line covered"><span class="line-number">306</span><span class="line-content">  if file_path and file_cache[file_path] then</span></div><div class="line covered"><span class="line-number">307</span><span class="line-content">    return file_cache[file_path].ast, file_cache[file_path].code_map</span></div><div class="line covered"><span class="line-number">308</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">309</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">310</span><span class="line-content">  -- Safety limit for content size</span></div><div class="line covered"><span class="line-number">311</span><span class="line-content">  if #content &gt; 300000 then -- 300KB limit</span></div><div class="line covered"><span class="line-number">312</span><span class="line-content">    return nil, &quot;Content too large for parse_content: &quot; .. (#content/1024) .. &quot;KB&quot;</span></div><div class="line covered"><span class="line-number">313</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">314</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">315</span><span class="line-content">  -- Start timing</span></div><div class="line covered"><span class="line-number">316</span><span class="line-content">  local start_time = os.clock()</span></div><div class="line covered"><span class="line-number">317</span><span class="line-content">  local MAX_PARSE_TIME = 1.0 -- 1 second total parse time limit</span></div><div class="line covered"><span class="line-number">318</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">319</span><span class="line-content">  -- Run parsing with protection</span></div><div class="line covered"><span class="line-number">320</span><span class="line-content">  local ast, err</span></div><div class="line covered"><span class="line-number">321</span><span class="line-content">  local success, result = pcall(function()</span></div><div class="line covered"><span class="line-number">322</span><span class="line-content">    ast, err = parser.parse(content, file_path or &quot;inline&quot;)</span></div><div class="line covered"><span class="line-number">323</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">324</span><span class="line-content">    if os.clock() - start_time &gt; MAX_PARSE_TIME then</span></div><div class="line covered"><span class="line-number">325</span><span class="line-content">      return nil, &quot;Parse time limit exceeded&quot;</span></div><div class="line covered"><span class="line-number">326</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">327</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">328</span><span class="line-content">    if not ast then</span></div><div class="line covered"><span class="line-number">329</span><span class="line-content">      return nil, &quot;Parse error: &quot; .. (err or &quot;unknown error&quot;)</span></div><div class="line covered"><span class="line-number">330</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">331</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">332</span><span class="line-content">    return ast, nil</span></div><div class="line covered"><span class="line-number">333</span><span class="line-content">  end)</span></div><div class="line covered"><span class="line-number">334</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">335</span><span class="line-content">  -- Handle errors from pcall</span></div><div class="line covered"><span class="line-number">336</span><span class="line-content">  if not success then</span></div><div class="line covered"><span class="line-number">337</span><span class="line-content">    return nil, &quot;Parser exception: &quot; .. tostring(result)</span></div><div class="line covered"><span class="line-number">338</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">339</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">340</span><span class="line-content">  -- Handle errors from parse</span></div><div class="line covered"><span class="line-number">341</span><span class="line-content">  if not ast then</span></div><div class="line covered"><span class="line-number">342</span><span class="line-content">    return nil, err or &quot;Unknown parse error&quot;</span></div><div class="line covered"><span class="line-number">343</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">344</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">345</span><span class="line-content">  -- Generate code map from the AST with time limit</span></div><div class="line covered"><span class="line-number">346</span><span class="line-content">  local code_map</span></div><div class="line covered"><span class="line-number">347</span><span class="line-content">  success, result = pcall(function()</span></div><div class="line covered"><span class="line-number">348</span><span class="line-content">    -- Check time again before code map generation</span></div><div class="line covered"><span class="line-number">349</span><span class="line-content">    if os.clock() - start_time &gt; MAX_PARSE_TIME then</span></div><div class="line covered"><span class="line-number">350</span><span class="line-content">      return nil, &quot;Code map time limit exceeded&quot;</span></div><div class="line covered"><span class="line-number">351</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">352</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">353</span><span class="line-content">    code_map = M.generate_code_map(ast, content)</span></div><div class="line covered"><span class="line-number">354</span><span class="line-content">    return code_map, nil</span></div><div class="line covered"><span class="line-number">355</span><span class="line-content">  end)</span></div><div class="line covered"><span class="line-number">356</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">357</span><span class="line-content">  -- Handle errors from code map generation</span></div><div class="line covered"><span class="line-number">358</span><span class="line-content">  if not success then</span></div><div class="line covered"><span class="line-number">359</span><span class="line-content">    return nil, &quot;Code map exception: &quot; .. tostring(result)</span></div><div class="line covered"><span class="line-number">360</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">361</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">362</span><span class="line-content">  if not code_map then</span></div><div class="line covered"><span class="line-number">363</span><span class="line-content">    return nil, result or &quot;Code map generation failed&quot;</span></div><div class="line covered"><span class="line-number">364</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">365</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">366</span><span class="line-content">  -- Cache the results if we have a path</span></div><div class="line covered"><span class="line-number">367</span><span class="line-content">  if file_path then</span></div><div class="line covered"><span class="line-number">368</span><span class="line-content">    file_cache[file_path] = {</span></div><div class="line covered"><span class="line-number">369</span><span class="line-content">      ast = ast,</span></div><div class="line covered"><span class="line-number">370</span><span class="line-content">      code_map = code_map</span></div><div class="line covered"><span class="line-number">371</span><span class="line-content">    }</span></div><div class="line covered"><span class="line-number">372</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">373</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">374</span><span class="line-content">  return ast, code_map</span></div><div class="line covered"><span class="line-number">375</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">376</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">377</span><span class="line-content">-- Collect all AST nodes in a table with optimization to avoid deep recursion</span></div><div class="line covered"><span class="line-number">378</span><span class="line-content">local function collect_nodes(ast, nodes)</span></div><div class="line covered"><span class="line-number">379</span><span class="line-content">  nodes = nodes or {}</span></div><div class="line covered"><span class="line-number">380</span><span class="line-content">  local to_process = {ast}</span></div><div class="line covered"><span class="line-number">381</span><span class="line-content">  local processed = 0</span></div><div class="line covered"><span class="line-number">382</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">383</span><span class="line-content">  while #to_process &gt; 0 do</span></div><div class="line covered"><span class="line-number">384</span><span class="line-content">    local current = table.remove(to_process)</span></div><div class="line covered"><span class="line-number">385</span><span class="line-content">    processed = processed + 1</span></div><div class="line covered"><span class="line-number">386</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">387</span><span class="line-content">    if type(current) == &quot;table&quot; then</span></div><div class="line covered"><span class="line-number">388</span><span class="line-content">      if current.tag then</span></div><div class="line covered"><span class="line-number">389</span><span class="line-content">        table.insert(nodes, current)</span></div><div class="line covered"><span class="line-number">390</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">391</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">392</span><span class="line-content">      -- Add numerical children to processing queue</span></div><div class="line covered"><span class="line-number">393</span><span class="line-content">      for k, v in pairs(current) do</span></div><div class="line covered"><span class="line-number">394</span><span class="line-content">        if type(k) == &quot;number&quot; then</span></div><div class="line covered"><span class="line-number">395</span><span class="line-content">          table.insert(to_process, v)</span></div><div class="line covered"><span class="line-number">396</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">397</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">398</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">399</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">400</span><span class="line-content">    -- Performance safety - if we&apos;ve processed too many nodes, break</span></div><div class="line covered"><span class="line-number">401</span><span class="line-content">    if processed &gt; 100000 then</span></div><div class="line covered"><span class="line-number">402</span><span class="line-content">      print(&quot;WARNING: Node collection limit reached (100,000 nodes)&quot;)</span></div><div class="line covered"><span class="line-number">403</span><span class="line-content">      break</span></div><div class="line covered"><span class="line-number">404</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">405</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">406</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">407</span><span class="line-content">  return nodes</span></div><div class="line covered"><span class="line-number">408</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">409</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">410</span><span class="line-content">-- Find all function definitions in the AST using non-recursive approach</span></div><div class="line covered"><span class="line-number">411</span><span class="line-content">local function find_functions(ast, functions, context)</span></div><div class="line covered"><span class="line-number">412</span><span class="line-content">  functions = functions or {}</span></div><div class="line covered"><span class="line-number">413</span><span class="line-content">  context = context or {}</span></div><div class="line covered"><span class="line-number">414</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">415</span><span class="line-content">  local to_process = {ast}</span></div><div class="line covered"><span class="line-number">416</span><span class="line-content">  local processed = 0</span></div><div class="line covered"><span class="line-number">417</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">418</span><span class="line-content">  while #to_process &gt; 0 do</span></div><div class="line covered"><span class="line-number">419</span><span class="line-content">    local current = table.remove(to_process)</span></div><div class="line covered"><span class="line-number">420</span><span class="line-content">    processed = processed + 1</span></div><div class="line covered"><span class="line-number">421</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">422</span><span class="line-content">    if type(current) == &quot;table&quot; then</span></div><div class="line covered"><span class="line-number">423</span><span class="line-content">      -- Special handling for function definitions with name extraction</span></div><div class="line covered"><span class="line-number">424</span><span class="line-content">      if current.tag == &quot;Set&quot; and #current &gt;= 2 and current[1].tag == &quot;VarList&quot; and current[2].tag == &quot;ExpList&quot; then</span></div><div class="line covered"><span class="line-number">425</span><span class="line-content">        -- Check if the right side contains function definition(s)</span></div><div class="line covered"><span class="line-number">426</span><span class="line-content">        for i, expr in ipairs(current[2]) do</span></div><div class="line covered"><span class="line-number">427</span><span class="line-content">          if expr.tag == &quot;Function&quot; then</span></div><div class="line covered"><span class="line-number">428</span><span class="line-content">            -- Get function name from the left side</span></div><div class="line covered"><span class="line-number">429</span><span class="line-content">            if current[1][i] and current[1][i].tag == &quot;Id&quot; then</span></div><div class="line covered"><span class="line-number">430</span><span class="line-content">              expr.name = current[1][i][1]</span></div><div class="line covered"><span class="line-number">431</span><span class="line-content">            elseif current[1][i] and current[1][i].tag == &quot;Index&quot; then</span></div><div class="line covered"><span class="line-number">432</span><span class="line-content">              -- Handle module.function or table.key style</span></div><div class="line covered"><span class="line-number">433</span><span class="line-content">              if current[1][i][1].tag == &quot;Id&quot; and current[1][i][2].tag == &quot;String&quot; then</span></div><div class="line covered"><span class="line-number">434</span><span class="line-content">                expr.name = current[1][i][1][1] .. &quot;.&quot; .. current[1][i][2][1]</span></div><div class="line covered"><span class="line-number">435</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">436</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">437</span><span class="line-content">            table.insert(functions, expr)</span></div><div class="line covered"><span class="line-number">438</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">439</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">440</span><span class="line-content">      elseif current.tag == &quot;Localrec&quot; and #current &gt;= 2 and current[1].tag == &quot;Id&quot; and current[2].tag == &quot;Function&quot; then</span></div><div class="line covered"><span class="line-number">441</span><span class="line-content">        -- Handle local function definition</span></div><div class="line covered"><span class="line-number">442</span><span class="line-content">        current[2].name = current[1][1]  -- Copy the name to the function</span></div><div class="line covered"><span class="line-number">443</span><span class="line-content">        table.insert(functions, current[2])</span></div><div class="line covered"><span class="line-number">444</span><span class="line-content">      elseif current.tag == &quot;Function&quot; then</span></div><div class="line covered"><span class="line-number">445</span><span class="line-content">        -- Standalone function (e.g., anonymous, or already part of a larger structure)</span></div><div class="line covered"><span class="line-number">446</span><span class="line-content">        table.insert(functions, current)</span></div><div class="line covered"><span class="line-number">447</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">448</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">449</span><span class="line-content">      -- Add numerical children to processing queue</span></div><div class="line covered"><span class="line-number">450</span><span class="line-content">      for k, v in pairs(current) do</span></div><div class="line covered"><span class="line-number">451</span><span class="line-content">        if type(k) == &quot;number&quot; then</span></div><div class="line covered"><span class="line-number">452</span><span class="line-content">          table.insert(to_process, v)</span></div><div class="line covered"><span class="line-number">453</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">454</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">455</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">456</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">457</span><span class="line-content">    -- Performance safety - if we&apos;ve processed too many nodes, break</span></div><div class="line covered"><span class="line-number">458</span><span class="line-content">    if processed &gt; 100000 then</span></div><div class="line covered"><span class="line-number">459</span><span class="line-content">      print(&quot;WARNING: Function finding limit reached (100,000 nodes)&quot;)</span></div><div class="line covered"><span class="line-number">460</span><span class="line-content">      break</span></div><div class="line covered"><span class="line-number">461</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">462</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">463</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">464</span><span class="line-content">  return functions</span></div><div class="line covered"><span class="line-number">465</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">466</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">467</span><span class="line-content">-- Define branch node tags for block detection</span></div><div class="line covered"><span class="line-number">468</span><span class="line-content">local BRANCH_TAGS = {</span></div><div class="line covered"><span class="line-number">469</span><span class="line-content">  If = true,     -- if statements</span></div><div class="line covered"><span class="line-number">470</span><span class="line-content">  While = true,  -- while loops</span></div><div class="line covered"><span class="line-number">471</span><span class="line-content">  Repeat = true, -- repeat-until loops</span></div><div class="line covered"><span class="line-number">472</span><span class="line-content">  Fornum = true, -- for i=1,10 loops</span></div><div class="line covered"><span class="line-number">473</span><span class="line-content">  Forin = true   -- for k,v in pairs() loops</span></div><div class="line covered"><span class="line-number">474</span><span class="line-content">}</span></div><div class="line covered"><span class="line-number">475</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">476</span><span class="line-content">-- Tags that indicate code blocks</span></div><div class="line covered"><span class="line-number">477</span><span class="line-content">local BLOCK_TAGS = {</span></div><div class="line covered"><span class="line-number">478</span><span class="line-content">  Block = true,  -- explicit blocks</span></div><div class="line covered"><span class="line-number">479</span><span class="line-content">  Function = true, -- function bodies</span></div><div class="line covered"><span class="line-number">480</span><span class="line-content">  If = true,     -- if blocks</span></div><div class="line covered"><span class="line-number">481</span><span class="line-content">  While = true,  -- while blocks </span></div><div class="line covered"><span class="line-number">482</span><span class="line-content">  Repeat = true, -- repeat blocks</span></div><div class="line covered"><span class="line-number">483</span><span class="line-content">  Fornum = true, -- for blocks</span></div><div class="line covered"><span class="line-number">484</span><span class="line-content">  Forin = true,  -- for-in blocks</span></div><div class="line covered"><span class="line-number">485</span><span class="line-content">}</span></div><div class="line covered"><span class="line-number">486</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">487</span><span class="line-content">-- Tags that represent conditional expressions</span></div><div class="line covered"><span class="line-number">488</span><span class="line-content">local CONDITION_TAGS = {</span></div><div class="line covered"><span class="line-number">489</span><span class="line-content">  Op = true,     -- Binary operators (like and/or)</span></div><div class="line covered"><span class="line-number">490</span><span class="line-content">  Not = true,    -- Not operator</span></div><div class="line covered"><span class="line-number">491</span><span class="line-content">  Call = true,   -- Function calls that return booleans</span></div><div class="line covered"><span class="line-number">492</span><span class="line-content">  Compare = true, -- Comparison operators</span></div><div class="line covered"><span class="line-number">493</span><span class="line-content">  Nil = true,    -- Nil values in conditions</span></div><div class="line covered"><span class="line-number">494</span><span class="line-content">  Boolean = true, -- Boolean literals</span></div><div class="line covered"><span class="line-number">495</span><span class="line-content">}</span></div><div class="line covered"><span class="line-number">496</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">497</span><span class="line-content">-- Extract conditional expressions from a node</span></div><div class="line covered"><span class="line-number">498</span><span class="line-content">local function extract_conditions(node, conditions, content, parent_id)</span></div><div class="line covered"><span class="line-number">499</span><span class="line-content">  conditions = conditions or {}</span></div><div class="line covered"><span class="line-number">500</span><span class="line-content">  local condition_id_counter = 0</span></div><div class="line covered"><span class="line-number">501</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">502</span><span class="line-content">  -- Process node if it&apos;s a conditional operation</span></div><div class="line covered"><span class="line-number">503</span><span class="line-content">  if node and node.tag and CONDITION_TAGS[node.tag] then</span></div><div class="line covered"><span class="line-number">504</span><span class="line-content">    if node.pos and node.end_pos then</span></div><div class="line covered"><span class="line-number">505</span><span class="line-content">      condition_id_counter = condition_id_counter + 1</span></div><div class="line covered"><span class="line-number">506</span><span class="line-content">      local condition_id = node.tag .. &quot;_condition_&quot; .. condition_id_counter</span></div><div class="line covered"><span class="line-number">507</span><span class="line-content">      local start_line = get_line_for_position(content, node.pos)</span></div><div class="line covered"><span class="line-number">508</span><span class="line-content">      local end_line = get_line_for_position(content, node.end_pos)</span></div><div class="line covered"><span class="line-number">509</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">510</span><span class="line-content">      -- Only add if it&apos;s a valid range</span></div><div class="line covered"><span class="line-number">511</span><span class="line-content">      if start_line &lt; end_line then</span></div><div class="line covered"><span class="line-number">512</span><span class="line-content">        table.insert(conditions, {</span></div><div class="line covered"><span class="line-number">513</span><span class="line-content">          id = condition_id,</span></div><div class="line covered"><span class="line-number">514</span><span class="line-content">          type = node.tag,</span></div><div class="line covered"><span class="line-number">515</span><span class="line-content">          start_line = start_line,</span></div><div class="line covered"><span class="line-number">516</span><span class="line-content">          end_line = end_line,</span></div><div class="line covered"><span class="line-number">517</span><span class="line-content">          parent_id = parent_id,</span></div><div class="line covered"><span class="line-number">518</span><span class="line-content">          executed = false,</span></div><div class="line covered"><span class="line-number">519</span><span class="line-content">          executed_true = false,</span></div><div class="line covered"><span class="line-number">520</span><span class="line-content">          executed_false = false</span></div><div class="line covered"><span class="line-number">521</span><span class="line-content">        })</span></div><div class="line covered"><span class="line-number">522</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">523</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">524</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">525</span><span class="line-content">    -- For binary operations, add the left and right sides as separate conditions</span></div><div class="line covered"><span class="line-number">526</span><span class="line-content">    if node.tag == &quot;Op&quot; and node[1] and node[2] then</span></div><div class="line covered"><span class="line-number">527</span><span class="line-content">      extract_conditions(node[1], conditions, content, parent_id)</span></div><div class="line covered"><span class="line-number">528</span><span class="line-content">      extract_conditions(node[2], conditions, content, parent_id)</span></div><div class="line covered"><span class="line-number">529</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">530</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">531</span><span class="line-content">    -- For Not operations, add the operand as a separate condition</span></div><div class="line covered"><span class="line-number">532</span><span class="line-content">    if node.tag == &quot;Not&quot; and node[1] then</span></div><div class="line covered"><span class="line-number">533</span><span class="line-content">      extract_conditions(node[1], conditions, content, parent_id)</span></div><div class="line covered"><span class="line-number">534</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">535</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">536</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">537</span><span class="line-content">  return conditions</span></div><div class="line covered"><span class="line-number">538</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">539</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">540</span><span class="line-content">-- Find all blocks in the AST </span></div><div class="line covered"><span class="line-number">541</span><span class="line-content">local function find_blocks(ast, blocks, content, parent_id)</span></div><div class="line covered"><span class="line-number">542</span><span class="line-content">  blocks = blocks or {}</span></div><div class="line covered"><span class="line-number">543</span><span class="line-content">  parent_id = parent_id or &quot;root&quot;</span></div><div class="line covered"><span class="line-number">544</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">545</span><span class="line-content">  -- Process the AST using the same iterative approach as in collect_nodes</span></div><div class="line covered"><span class="line-number">546</span><span class="line-content">  local to_process = {{node = ast, parent_id = parent_id}}</span></div><div class="line covered"><span class="line-number">547</span><span class="line-content">  local processed = 0</span></div><div class="line covered"><span class="line-number">548</span><span class="line-content">  local block_id_counter = 0</span></div><div class="line covered"><span class="line-number">549</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">550</span><span class="line-content">  while #to_process &gt; 0 do</span></div><div class="line covered"><span class="line-number">551</span><span class="line-content">    local current = table.remove(to_process)</span></div><div class="line covered"><span class="line-number">552</span><span class="line-content">    local node = current.node</span></div><div class="line covered"><span class="line-number">553</span><span class="line-content">    local parent = current.parent_id</span></div><div class="line covered"><span class="line-number">554</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">555</span><span class="line-content">    processed = processed + 1</span></div><div class="line covered"><span class="line-number">556</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">557</span><span class="line-content">    -- Safety limit</span></div><div class="line covered"><span class="line-number">558</span><span class="line-content">    if processed &gt; 100000 then</span></div><div class="line covered"><span class="line-number">559</span><span class="line-content">      print(&quot;WARNING: Block finding limit reached (100,000 nodes)&quot;)</span></div><div class="line covered"><span class="line-number">560</span><span class="line-content">      break</span></div><div class="line covered"><span class="line-number">561</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">562</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">563</span><span class="line-content">    if type(node) == &quot;table&quot; and node.tag then</span></div><div class="line covered"><span class="line-number">564</span><span class="line-content">      -- Handle different block types</span></div><div class="line covered"><span class="line-number">565</span><span class="line-content">      if BLOCK_TAGS[node.tag] then</span></div><div class="line covered"><span class="line-number">566</span><span class="line-content">        -- This is a block node, create a block for it</span></div><div class="line covered"><span class="line-number">567</span><span class="line-content">        block_id_counter = block_id_counter + 1</span></div><div class="line covered"><span class="line-number">568</span><span class="line-content">        local block_id = node.tag .. &quot;_&quot; .. block_id_counter</span></div><div class="line covered"><span class="line-number">569</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">570</span><span class="line-content">        -- Get block position</span></div><div class="line covered"><span class="line-number">571</span><span class="line-content">        if node.pos and node.end_pos then</span></div><div class="line covered"><span class="line-number">572</span><span class="line-content">          local start_line = get_line_for_position(content, node.pos)</span></div><div class="line covered"><span class="line-number">573</span><span class="line-content">          local end_line = get_line_for_position(content, node.end_pos)</span></div><div class="line covered"><span class="line-number">574</span><span class="line-content">          </span></div><div class="line covered"><span class="line-number">575</span><span class="line-content">          -- Skip invalid blocks (where start_line equals end_line)</span></div><div class="line covered"><span class="line-number">576</span><span class="line-content">          if start_line &lt; end_line then</span></div><div class="line covered"><span class="line-number">577</span><span class="line-content">            -- Create block entry</span></div><div class="line covered"><span class="line-number">578</span><span class="line-content">            local block = {</span></div><div class="line covered"><span class="line-number">579</span><span class="line-content">              id = block_id,</span></div><div class="line covered"><span class="line-number">580</span><span class="line-content">              type = node.tag,</span></div><div class="line covered"><span class="line-number">581</span><span class="line-content">              start_line = start_line,</span></div><div class="line covered"><span class="line-number">582</span><span class="line-content">              end_line = end_line,</span></div><div class="line covered"><span class="line-number">583</span><span class="line-content">              parent_id = parent,</span></div><div class="line covered"><span class="line-number">584</span><span class="line-content">              branches = {},</span></div><div class="line covered"><span class="line-number">585</span><span class="line-content">              executed = false</span></div><div class="line covered"><span class="line-number">586</span><span class="line-content">            }</span></div><div class="line covered"><span class="line-number">587</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">588</span><span class="line-content">            -- If it&apos;s a branch condition, add special handling</span></div><div class="line covered"><span class="line-number">589</span><span class="line-content">            if BRANCH_TAGS[node.tag] then</span></div><div class="line covered"><span class="line-number">590</span><span class="line-content">              -- For If nodes, we want to handle the branches</span></div><div class="line covered"><span class="line-number">591</span><span class="line-content">              if node.tag == &quot;If&quot; and node[2] and node[3] then</span></div><div class="line covered"><span class="line-number">592</span><span class="line-content">                -- Node structure: If[condition, then_block, else_block]</span></div><div class="line covered"><span class="line-number">593</span><span class="line-content">                -- Get conditional expression position</span></div><div class="line covered"><span class="line-number">594</span><span class="line-content">                if node[1] and node[1].pos and node[1].end_pos then</span></div><div class="line covered"><span class="line-number">595</span><span class="line-content">                  block_id_counter = block_id_counter + 1</span></div><div class="line covered"><span class="line-number">596</span><span class="line-content">                  local cond_id = &quot;condition_&quot; .. block_id_counter</span></div><div class="line covered"><span class="line-number">597</span><span class="line-content">                  local cond_start = get_line_for_position(content, node[1].pos)</span></div><div class="line covered"><span class="line-number">598</span><span class="line-content">                  local cond_end = get_line_for_position(content, node[1].end_pos)</span></div><div class="line covered"><span class="line-number">599</span><span class="line-content">                  </span></div><div class="line covered"><span class="line-number">600</span><span class="line-content">                  -- Only add if it&apos;s a valid range</span></div><div class="line covered"><span class="line-number">601</span><span class="line-content">                  if cond_start &lt; cond_end then</span></div><div class="line covered"><span class="line-number">602</span><span class="line-content">                    table.insert(blocks, {</span></div><div class="line covered"><span class="line-number">603</span><span class="line-content">                      id = cond_id,</span></div><div class="line covered"><span class="line-number">604</span><span class="line-content">                      type = &quot;condition&quot;,</span></div><div class="line covered"><span class="line-number">605</span><span class="line-content">                      start_line = cond_start,</span></div><div class="line covered"><span class="line-number">606</span><span class="line-content">                      end_line = cond_end,</span></div><div class="line covered"><span class="line-number">607</span><span class="line-content">                      parent_id = block_id,</span></div><div class="line covered"><span class="line-number">608</span><span class="line-content">                      executed = false</span></div><div class="line covered"><span class="line-number">609</span><span class="line-content">                    })</span></div><div class="line covered"><span class="line-number">610</span><span class="line-content">                    </span></div><div class="line covered"><span class="line-number">611</span><span class="line-content">                    table.insert(block.branches, cond_id)</span></div><div class="line covered"><span class="line-number">612</span><span class="line-content">                  end</span></div><div class="line covered"><span class="line-number">613</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">614</span><span class="line-content">                </span></div><div class="line covered"><span class="line-number">615</span><span class="line-content">                -- Create sub-blocks for then and else parts</span></div><div class="line covered"><span class="line-number">616</span><span class="line-content">                if node[2].pos and node[2].end_pos then</span></div><div class="line covered"><span class="line-number">617</span><span class="line-content">                  block_id_counter = block_id_counter + 1</span></div><div class="line covered"><span class="line-number">618</span><span class="line-content">                  local then_id = &quot;then_&quot; .. block_id_counter</span></div><div class="line covered"><span class="line-number">619</span><span class="line-content">                  local then_start = get_line_for_position(content, node[2].pos)</span></div><div class="line covered"><span class="line-number">620</span><span class="line-content">                  local then_end = get_line_for_position(content, node[2].end_pos)</span></div><div class="line covered"><span class="line-number">621</span><span class="line-content">                  </span></div><div class="line covered"><span class="line-number">622</span><span class="line-content">                  -- Only add if it&apos;s a valid range</span></div><div class="line covered"><span class="line-number">623</span><span class="line-content">                  if then_start &lt; then_end then</span></div><div class="line covered"><span class="line-number">624</span><span class="line-content">                    table.insert(blocks, {</span></div><div class="line covered"><span class="line-number">625</span><span class="line-content">                      id = then_id,</span></div><div class="line covered"><span class="line-number">626</span><span class="line-content">                      type = &quot;then_block&quot;,</span></div><div class="line covered"><span class="line-number">627</span><span class="line-content">                      start_line = then_start,</span></div><div class="line covered"><span class="line-number">628</span><span class="line-content">                      end_line = then_end,</span></div><div class="line covered"><span class="line-number">629</span><span class="line-content">                      parent_id = block_id,</span></div><div class="line covered"><span class="line-number">630</span><span class="line-content">                      executed = false</span></div><div class="line covered"><span class="line-number">631</span><span class="line-content">                    })</span></div><div class="line covered"><span class="line-number">632</span><span class="line-content">                    </span></div><div class="line covered"><span class="line-number">633</span><span class="line-content">                    table.insert(block.branches, then_id)</span></div><div class="line covered"><span class="line-number">634</span><span class="line-content">                  end</span></div><div class="line covered"><span class="line-number">635</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">636</span><span class="line-content">                </span></div><div class="line covered"><span class="line-number">637</span><span class="line-content">                if node[3].pos and node[3].end_pos then</span></div><div class="line covered"><span class="line-number">638</span><span class="line-content">                  block_id_counter = block_id_counter + 1</span></div><div class="line covered"><span class="line-number">639</span><span class="line-content">                  local else_id = &quot;else_&quot; .. block_id_counter</span></div><div class="line covered"><span class="line-number">640</span><span class="line-content">                  local else_start = get_line_for_position(content, node[3].pos)</span></div><div class="line covered"><span class="line-number">641</span><span class="line-content">                  local else_end = get_line_for_position(content, node[3].end_pos)</span></div><div class="line covered"><span class="line-number">642</span><span class="line-content">                  </span></div><div class="line covered"><span class="line-number">643</span><span class="line-content">                  -- Only add if it&apos;s a valid range</span></div><div class="line covered"><span class="line-number">644</span><span class="line-content">                  if else_start &lt; else_end then</span></div><div class="line covered"><span class="line-number">645</span><span class="line-content">                    table.insert(blocks, {</span></div><div class="line covered"><span class="line-number">646</span><span class="line-content">                      id = else_id,</span></div><div class="line covered"><span class="line-number">647</span><span class="line-content">                      type = &quot;else_block&quot;,</span></div><div class="line covered"><span class="line-number">648</span><span class="line-content">                      start_line = else_start,</span></div><div class="line covered"><span class="line-number">649</span><span class="line-content">                      end_line = else_end,</span></div><div class="line covered"><span class="line-number">650</span><span class="line-content">                      parent_id = block_id,</span></div><div class="line covered"><span class="line-number">651</span><span class="line-content">                      executed = false</span></div><div class="line covered"><span class="line-number">652</span><span class="line-content">                    })</span></div><div class="line covered"><span class="line-number">653</span><span class="line-content">                    </span></div><div class="line covered"><span class="line-number">654</span><span class="line-content">                    table.insert(block.branches, else_id)</span></div><div class="line covered"><span class="line-number">655</span><span class="line-content">                  end</span></div><div class="line covered"><span class="line-number">656</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">657</span><span class="line-content">              elseif node.tag == &quot;While&quot; and node[1] and node[2] then</span></div><div class="line covered"><span class="line-number">658</span><span class="line-content">                -- Add condition for while loops</span></div><div class="line covered"><span class="line-number">659</span><span class="line-content">                if node[1].pos and node[1].end_pos then</span></div><div class="line covered"><span class="line-number">660</span><span class="line-content">                  block_id_counter = block_id_counter + 1</span></div><div class="line covered"><span class="line-number">661</span><span class="line-content">                  local cond_id = &quot;while_condition_&quot; .. block_id_counter</span></div><div class="line covered"><span class="line-number">662</span><span class="line-content">                  local cond_start = get_line_for_position(content, node[1].pos)</span></div><div class="line covered"><span class="line-number">663</span><span class="line-content">                  local cond_end = get_line_for_position(content, node[1].end_pos)</span></div><div class="line covered"><span class="line-number">664</span><span class="line-content">                  </span></div><div class="line covered"><span class="line-number">665</span><span class="line-content">                  -- Only add if it&apos;s a valid range</span></div><div class="line covered"><span class="line-number">666</span><span class="line-content">                  if cond_start &lt; cond_end then</span></div><div class="line covered"><span class="line-number">667</span><span class="line-content">                    table.insert(blocks, {</span></div><div class="line covered"><span class="line-number">668</span><span class="line-content">                      id = cond_id,</span></div><div class="line covered"><span class="line-number">669</span><span class="line-content">                      type = &quot;while_condition&quot;,</span></div><div class="line covered"><span class="line-number">670</span><span class="line-content">                      start_line = cond_start,</span></div><div class="line covered"><span class="line-number">671</span><span class="line-content">                      end_line = cond_end,</span></div><div class="line covered"><span class="line-number">672</span><span class="line-content">                      parent_id = block_id,</span></div><div class="line covered"><span class="line-number">673</span><span class="line-content">                      executed = false</span></div><div class="line covered"><span class="line-number">674</span><span class="line-content">                    })</span></div><div class="line covered"><span class="line-number">675</span><span class="line-content">                    </span></div><div class="line covered"><span class="line-number">676</span><span class="line-content">                    table.insert(block.branches, cond_id)</span></div><div class="line covered"><span class="line-number">677</span><span class="line-content">                  end</span></div><div class="line covered"><span class="line-number">678</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">679</span><span class="line-content">                </span></div><div class="line covered"><span class="line-number">680</span><span class="line-content">                -- Add body for while loops</span></div><div class="line covered"><span class="line-number">681</span><span class="line-content">                if node[2].pos and node[2].end_pos then</span></div><div class="line covered"><span class="line-number">682</span><span class="line-content">                  block_id_counter = block_id_counter + 1</span></div><div class="line covered"><span class="line-number">683</span><span class="line-content">                  local body_id = &quot;while_body_&quot; .. block_id_counter</span></div><div class="line covered"><span class="line-number">684</span><span class="line-content">                  local body_start = get_line_for_position(content, node[2].pos)</span></div><div class="line covered"><span class="line-number">685</span><span class="line-content">                  local body_end = get_line_for_position(content, node[2].end_pos)</span></div><div class="line covered"><span class="line-number">686</span><span class="line-content">                  </span></div><div class="line covered"><span class="line-number">687</span><span class="line-content">                  -- Only add if it&apos;s a valid range</span></div><div class="line covered"><span class="line-number">688</span><span class="line-content">                  if body_start &lt; body_end then</span></div><div class="line covered"><span class="line-number">689</span><span class="line-content">                    table.insert(blocks, {</span></div><div class="line covered"><span class="line-number">690</span><span class="line-content">                      id = body_id,</span></div><div class="line covered"><span class="line-number">691</span><span class="line-content">                      type = &quot;while_body&quot;,</span></div><div class="line covered"><span class="line-number">692</span><span class="line-content">                      start_line = body_start,</span></div><div class="line covered"><span class="line-number">693</span><span class="line-content">                      end_line = body_end,</span></div><div class="line covered"><span class="line-number">694</span><span class="line-content">                      parent_id = block_id,</span></div><div class="line covered"><span class="line-number">695</span><span class="line-content">                      executed = false</span></div><div class="line covered"><span class="line-number">696</span><span class="line-content">                    })</span></div><div class="line covered"><span class="line-number">697</span><span class="line-content">                    </span></div><div class="line covered"><span class="line-number">698</span><span class="line-content">                    table.insert(block.branches, body_id)</span></div><div class="line covered"><span class="line-number">699</span><span class="line-content">                  end</span></div><div class="line covered"><span class="line-number">700</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">701</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">702</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">703</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">704</span><span class="line-content">            -- Add the block to our list</span></div><div class="line covered"><span class="line-number">705</span><span class="line-content">            table.insert(blocks, block)</span></div><div class="line covered"><span class="line-number">706</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">707</span><span class="line-content">            -- Process child nodes with this block as the parent</span></div><div class="line covered"><span class="line-number">708</span><span class="line-content">            for k, v in pairs(node) do</span></div><div class="line covered"><span class="line-number">709</span><span class="line-content">              if type(k) == &quot;number&quot; then</span></div><div class="line covered"><span class="line-number">710</span><span class="line-content">                table.insert(to_process, {node = v, parent_id = block_id})</span></div><div class="line covered"><span class="line-number">711</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">712</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">713</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">714</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">715</span><span class="line-content">      else</span></div><div class="line covered"><span class="line-number">716</span><span class="line-content">        -- Not a block node, just process children</span></div><div class="line covered"><span class="line-number">717</span><span class="line-content">        for k, v in pairs(node) do</span></div><div class="line covered"><span class="line-number">718</span><span class="line-content">          if type(k) == &quot;number&quot; then</span></div><div class="line covered"><span class="line-number">719</span><span class="line-content">            table.insert(to_process, {node = v, parent_id = parent})</span></div><div class="line covered"><span class="line-number">720</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">721</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">722</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">723</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">724</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">725</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">726</span><span class="line-content">  return blocks</span></div><div class="line covered"><span class="line-number">727</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">728</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">729</span><span class="line-content">-- Find all conditional expressions in the AST</span></div><div class="line covered"><span class="line-number">730</span><span class="line-content">local function find_conditions(ast, conditions, content)</span></div><div class="line covered"><span class="line-number">731</span><span class="line-content">  conditions = conditions or {}</span></div><div class="line covered"><span class="line-number">732</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">733</span><span class="line-content">  -- Process the AST using the same iterative approach as in collect_nodes</span></div><div class="line covered"><span class="line-number">734</span><span class="line-content">  local to_process = {{node = ast, parent_id = &quot;root&quot;}}</span></div><div class="line covered"><span class="line-number">735</span><span class="line-content">  local processed = 0</span></div><div class="line covered"><span class="line-number">736</span><span class="line-content">  local condition_id_counter = 0</span></div><div class="line covered"><span class="line-number">737</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">738</span><span class="line-content">  while #to_process &gt; 0 do</span></div><div class="line covered"><span class="line-number">739</span><span class="line-content">    local current = table.remove(to_process)</span></div><div class="line covered"><span class="line-number">740</span><span class="line-content">    local node = current.node</span></div><div class="line covered"><span class="line-number">741</span><span class="line-content">    local parent = current.parent_id</span></div><div class="line covered"><span class="line-number">742</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">743</span><span class="line-content">    processed = processed + 1</span></div><div class="line covered"><span class="line-number">744</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">745</span><span class="line-content">    -- Safety limit</span></div><div class="line covered"><span class="line-number">746</span><span class="line-content">    if processed &gt; 100000 then</span></div><div class="line covered"><span class="line-number">747</span><span class="line-content">      print(&quot;WARNING: Condition finding limit reached (100,000 nodes)&quot;)</span></div><div class="line covered"><span class="line-number">748</span><span class="line-content">      break</span></div><div class="line covered"><span class="line-number">749</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">750</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">751</span><span class="line-content">    -- For branch nodes, extract conditional expressions</span></div><div class="line covered"><span class="line-number">752</span><span class="line-content">    if type(node) == &quot;table&quot; and node.tag then</span></div><div class="line covered"><span class="line-number">753</span><span class="line-content">      if BRANCH_TAGS[node.tag] then</span></div><div class="line covered"><span class="line-number">754</span><span class="line-content">        -- Extract conditions from branch conditions</span></div><div class="line covered"><span class="line-number">755</span><span class="line-content">        if node.tag == &quot;If&quot; and node[1] then</span></div><div class="line covered"><span class="line-number">756</span><span class="line-content">          -- If condition</span></div><div class="line covered"><span class="line-number">757</span><span class="line-content">          if node[1].pos and node[1].end_pos then</span></div><div class="line covered"><span class="line-number">758</span><span class="line-content">            condition_id_counter = condition_id_counter + 1</span></div><div class="line covered"><span class="line-number">759</span><span class="line-content">            local cond_id = &quot;if_condition_&quot; .. condition_id_counter</span></div><div class="line covered"><span class="line-number">760</span><span class="line-content">            local cond_start = get_line_for_position(content, node[1].pos)</span></div><div class="line covered"><span class="line-number">761</span><span class="line-content">            local cond_end = get_line_for_position(content, node[1].end_pos)</span></div><div class="line covered"><span class="line-number">762</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">763</span><span class="line-content">            if cond_start &lt; cond_end then</span></div><div class="line covered"><span class="line-number">764</span><span class="line-content">              table.insert(conditions, {</span></div><div class="line covered"><span class="line-number">765</span><span class="line-content">                id = cond_id,</span></div><div class="line covered"><span class="line-number">766</span><span class="line-content">                type = &quot;if_condition&quot;,</span></div><div class="line covered"><span class="line-number">767</span><span class="line-content">                start_line = cond_start,</span></div><div class="line covered"><span class="line-number">768</span><span class="line-content">                end_line = cond_end,</span></div><div class="line covered"><span class="line-number">769</span><span class="line-content">                parent_id = parent,</span></div><div class="line covered"><span class="line-number">770</span><span class="line-content">                executed = false,</span></div><div class="line covered"><span class="line-number">771</span><span class="line-content">                executed_true = false,  -- Condition evaluated to true</span></div><div class="line covered"><span class="line-number">772</span><span class="line-content">                executed_false = false  -- Condition evaluated to false</span></div><div class="line covered"><span class="line-number">773</span><span class="line-content">              })</span></div><div class="line covered"><span class="line-number">774</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">775</span><span class="line-content">              -- Extract sub-conditions recursively</span></div><div class="line covered"><span class="line-number">776</span><span class="line-content">              local sub_conditions = extract_conditions(node[1], {}, content, cond_id)</span></div><div class="line covered"><span class="line-number">777</span><span class="line-content">              for _, sub_cond in ipairs(sub_conditions) do</span></div><div class="line covered"><span class="line-number">778</span><span class="line-content">                table.insert(conditions, sub_cond)</span></div><div class="line covered"><span class="line-number">779</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">780</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">781</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">782</span><span class="line-content">        elseif node.tag == &quot;While&quot; and node[1] then</span></div><div class="line covered"><span class="line-number">783</span><span class="line-content">          -- While condition</span></div><div class="line covered"><span class="line-number">784</span><span class="line-content">          if node[1].pos and node[1].end_pos then</span></div><div class="line covered"><span class="line-number">785</span><span class="line-content">            condition_id_counter = condition_id_counter + 1</span></div><div class="line covered"><span class="line-number">786</span><span class="line-content">            local cond_id = &quot;while_condition_&quot; .. condition_id_counter</span></div><div class="line covered"><span class="line-number">787</span><span class="line-content">            local cond_start = get_line_for_position(content, node[1].pos)</span></div><div class="line covered"><span class="line-number">788</span><span class="line-content">            local cond_end = get_line_for_position(content, node[1].end_pos)</span></div><div class="line covered"><span class="line-number">789</span><span class="line-content">            </span></div><div class="line covered"><span class="line-number">790</span><span class="line-content">            if cond_start &lt; cond_end then</span></div><div class="line covered"><span class="line-number">791</span><span class="line-content">              table.insert(conditions, {</span></div><div class="line covered"><span class="line-number">792</span><span class="line-content">                id = cond_id,</span></div><div class="line covered"><span class="line-number">793</span><span class="line-content">                type = &quot;while_condition&quot;,</span></div><div class="line covered"><span class="line-number">794</span><span class="line-content">                start_line = cond_start,</span></div><div class="line covered"><span class="line-number">795</span><span class="line-content">                end_line = cond_end,</span></div><div class="line covered"><span class="line-number">796</span><span class="line-content">                parent_id = parent,</span></div><div class="line covered"><span class="line-number">797</span><span class="line-content">                executed = false,</span></div><div class="line covered"><span class="line-number">798</span><span class="line-content">                executed_true = false,</span></div><div class="line covered"><span class="line-number">799</span><span class="line-content">                executed_false = false</span></div><div class="line covered"><span class="line-number">800</span><span class="line-content">              })</span></div><div class="line covered"><span class="line-number">801</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">802</span><span class="line-content">              -- Extract sub-conditions recursively</span></div><div class="line covered"><span class="line-number">803</span><span class="line-content">              local sub_conditions = extract_conditions(node[1], {}, content, cond_id)</span></div><div class="line covered"><span class="line-number">804</span><span class="line-content">              for _, sub_cond in ipairs(sub_conditions) do</span></div><div class="line covered"><span class="line-number">805</span><span class="line-content">                table.insert(conditions, sub_cond)</span></div><div class="line covered"><span class="line-number">806</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">807</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">808</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">809</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">810</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">811</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">812</span><span class="line-content">      -- Process child nodes</span></div><div class="line covered"><span class="line-number">813</span><span class="line-content">      for k, v in pairs(node) do</span></div><div class="line covered"><span class="line-number">814</span><span class="line-content">        if type(k) == &quot;number&quot; then</span></div><div class="line covered"><span class="line-number">815</span><span class="line-content">          table.insert(to_process, {node = v, parent_id = parent})</span></div><div class="line covered"><span class="line-number">816</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">817</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">818</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">819</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">820</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">821</span><span class="line-content">  return conditions</span></div><div class="line covered"><span class="line-number">822</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">823</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">824</span><span class="line-content">-- Generate a code map from the AST and content with timing protection</span></div><div class="line covered"><span class="line-number">825</span><span class="line-content">function M.generate_code_map(ast, content)</span></div><div class="line covered"><span class="line-number">826</span><span class="line-content">  -- Start timing - INCREASED timeout to 5 seconds</span></div><div class="line covered"><span class="line-number">827</span><span class="line-content">  local start_time = os.clock()</span></div><div class="line covered"><span class="line-number">828</span><span class="line-content">  local MAX_CODEMAP_TIME = 5.0 -- 5 second time limit for code map generation</span></div><div class="line covered"><span class="line-number">829</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">830</span><span class="line-content">  local code_map = {</span></div><div class="line covered"><span class="line-number">831</span><span class="line-content">    lines = {},           -- Information about each line</span></div><div class="line covered"><span class="line-number">832</span><span class="line-content">    functions = {},       -- Function definitions with line ranges</span></div><div class="line covered"><span class="line-number">833</span><span class="line-content">    branches = {},        -- Branch points (if/else, loops)</span></div><div class="line covered"><span class="line-number">834</span><span class="line-content">    blocks = {},          -- Code blocks for block-based coverage</span></div><div class="line covered"><span class="line-number">835</span><span class="line-content">    conditions = {},      -- Conditional expressions for condition coverage</span></div><div class="line covered"><span class="line-number">836</span><span class="line-content">    line_count = count_lines(content)</span></div><div class="line covered"><span class="line-number">837</span><span class="line-content">  }</span></div><div class="line covered"><span class="line-number">838</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">839</span><span class="line-content">  -- Set a reasonable upper limit for line count to prevent DOS</span></div><div class="line covered"><span class="line-number">840</span><span class="line-content">  if code_map.line_count &gt; 10000 then</span></div><div class="line covered"><span class="line-number">841</span><span class="line-content">    print(&quot;WARNING: File too large for code mapping: &quot; .. code_map.line_count .. &quot; lines&quot;)</span></div><div class="line covered"><span class="line-number">842</span><span class="line-content">    return nil</span></div><div class="line covered"><span class="line-number">843</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">844</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">845</span><span class="line-content">  -- Collect all nodes with time check</span></div><div class="line covered"><span class="line-number">846</span><span class="line-content">  local all_nodes</span></div><div class="line covered"><span class="line-number">847</span><span class="line-content">  local success, result = pcall(function()</span></div><div class="line covered"><span class="line-number">848</span><span class="line-content">    all_nodes = collect_nodes(ast)</span></div><div class="line covered"><span class="line-number">849</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">850</span><span class="line-content">    -- Check for timeout</span></div><div class="line covered"><span class="line-number">851</span><span class="line-content">    if os.clock() - start_time &gt; MAX_CODEMAP_TIME then</span></div><div class="line covered"><span class="line-number">852</span><span class="line-content">      return nil, &quot;Node collection timeout&quot;</span></div><div class="line covered"><span class="line-number">853</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">854</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">855</span><span class="line-content">    return all_nodes, nil</span></div><div class="line covered"><span class="line-number">856</span><span class="line-content">  end)</span></div><div class="line covered"><span class="line-number">857</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">858</span><span class="line-content">  if not success then</span></div><div class="line covered"><span class="line-number">859</span><span class="line-content">    print(&quot;ERROR in collect_nodes: &quot; .. tostring(result))</span></div><div class="line covered"><span class="line-number">860</span><span class="line-content">    return nil</span></div><div class="line covered"><span class="line-number">861</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">862</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">863</span><span class="line-content">  if not all_nodes then</span></div><div class="line covered"><span class="line-number">864</span><span class="line-content">    print(&quot;ERROR: &quot; .. (result or &quot;Node collection failed&quot;))</span></div><div class="line covered"><span class="line-number">865</span><span class="line-content">    return nil</span></div><div class="line covered"><span class="line-number">866</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">867</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">868</span><span class="line-content">  -- Add size limit for node collection</span></div><div class="line covered"><span class="line-number">869</span><span class="line-content">  if #all_nodes &gt; 50000 then</span></div><div class="line covered"><span class="line-number">870</span><span class="line-content">    print(&quot;WARNING: AST too complex for analysis: &quot; .. #all_nodes .. &quot; nodes&quot;)</span></div><div class="line covered"><span class="line-number">871</span><span class="line-content">    return nil</span></div><div class="line covered"><span class="line-number">872</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">873</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">874</span><span class="line-content">  -- Collect all functions with time check</span></div><div class="line covered"><span class="line-number">875</span><span class="line-content">  local functions</span></div><div class="line covered"><span class="line-number">876</span><span class="line-content">  success, result = pcall(function()</span></div><div class="line covered"><span class="line-number">877</span><span class="line-content">    functions = find_functions(ast)</span></div><div class="line covered"><span class="line-number">878</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">879</span><span class="line-content">    -- Check for timeout</span></div><div class="line covered"><span class="line-number">880</span><span class="line-content">    if os.clock() - start_time &gt; MAX_CODEMAP_TIME then</span></div><div class="line covered"><span class="line-number">881</span><span class="line-content">      return nil, &quot;Function finding timeout&quot;</span></div><div class="line covered"><span class="line-number">882</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">883</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">884</span><span class="line-content">    return functions, nil</span></div><div class="line covered"><span class="line-number">885</span><span class="line-content">  end)</span></div><div class="line covered"><span class="line-number">886</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">887</span><span class="line-content">  if not success then</span></div><div class="line covered"><span class="line-number">888</span><span class="line-content">    print(&quot;ERROR in find_functions: &quot; .. tostring(result))</span></div><div class="line covered"><span class="line-number">889</span><span class="line-content">    return nil</span></div><div class="line covered"><span class="line-number">890</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">891</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">892</span><span class="line-content">  if not functions then</span></div><div class="line covered"><span class="line-number">893</span><span class="line-content">    print(&quot;ERROR: &quot; .. (result or &quot;Function finding failed&quot;))</span></div><div class="line covered"><span class="line-number">894</span><span class="line-content">    return nil</span></div><div class="line covered"><span class="line-number">895</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">896</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">897</span><span class="line-content">  -- Collect all code blocks with time check</span></div><div class="line covered"><span class="line-number">898</span><span class="line-content">  local blocks</span></div><div class="line covered"><span class="line-number">899</span><span class="line-content">  success, result = pcall(function()</span></div><div class="line covered"><span class="line-number">900</span><span class="line-content">    blocks = find_blocks(ast, nil, content)</span></div><div class="line covered"><span class="line-number">901</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">902</span><span class="line-content">    -- Check for timeout</span></div><div class="line covered"><span class="line-number">903</span><span class="line-content">    if os.clock() - start_time &gt; MAX_CODEMAP_TIME then</span></div><div class="line covered"><span class="line-number">904</span><span class="line-content">      return nil, &quot;Block finding timeout&quot;</span></div><div class="line covered"><span class="line-number">905</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">906</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">907</span><span class="line-content">    return blocks, nil</span></div><div class="line covered"><span class="line-number">908</span><span class="line-content">  end)</span></div><div class="line covered"><span class="line-number">909</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">910</span><span class="line-content">  if not success then</span></div><div class="line covered"><span class="line-number">911</span><span class="line-content">    print(&quot;ERROR in find_blocks: &quot; .. tostring(result))</span></div><div class="line covered"><span class="line-number">912</span><span class="line-content">    return nil</span></div><div class="line covered"><span class="line-number">913</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">914</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">915</span><span class="line-content">  if blocks then</span></div><div class="line covered"><span class="line-number">916</span><span class="line-content">    code_map.blocks = blocks</span></div><div class="line covered"><span class="line-number">917</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">918</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">919</span><span class="line-content">  -- Collect all conditional expressions with time check</span></div><div class="line covered"><span class="line-number">920</span><span class="line-content">  local conditions</span></div><div class="line covered"><span class="line-number">921</span><span class="line-content">  success, result = pcall(function()</span></div><div class="line covered"><span class="line-number">922</span><span class="line-content">    conditions = find_conditions(ast, nil, content)</span></div><div class="line covered"><span class="line-number">923</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">924</span><span class="line-content">    -- Check for timeout</span></div><div class="line covered"><span class="line-number">925</span><span class="line-content">    if os.clock() - start_time &gt; MAX_CODEMAP_TIME then</span></div><div class="line covered"><span class="line-number">926</span><span class="line-content">      return nil, &quot;Condition finding timeout&quot;</span></div><div class="line covered"><span class="line-number">927</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">928</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">929</span><span class="line-content">    return conditions, nil</span></div><div class="line covered"><span class="line-number">930</span><span class="line-content">  end)</span></div><div class="line covered"><span class="line-number">931</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">932</span><span class="line-content">  if not success then</span></div><div class="line covered"><span class="line-number">933</span><span class="line-content">    print(&quot;ERROR in find_conditions: &quot; .. tostring(result))</span></div><div class="line covered"><span class="line-number">934</span><span class="line-content">    -- Don&apos;t return, we can still continue without conditions</span></div><div class="line covered"><span class="line-number">935</span><span class="line-content">  elseif conditions then</span></div><div class="line covered"><span class="line-number">936</span><span class="line-content">    code_map.conditions = conditions</span></div><div class="line covered"><span class="line-number">937</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">938</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">939</span><span class="line-content">  -- Create function map with time checks</span></div><div class="line covered"><span class="line-number">940</span><span class="line-content">  for i, func in ipairs(functions) do</span></div><div class="line covered"><span class="line-number">941</span><span class="line-content">    -- Periodic time checks</span></div><div class="line covered"><span class="line-number">942</span><span class="line-content">    if i % 100 == 0 and os.clock() - start_time &gt; MAX_CODEMAP_TIME then</span></div><div class="line covered"><span class="line-number">943</span><span class="line-content">      print(&quot;WARNING: Function map timeout after &quot; .. i .. &quot; functions&quot;)</span></div><div class="line covered"><span class="line-number">944</span><span class="line-content">      break</span></div><div class="line covered"><span class="line-number">945</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">946</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">947</span><span class="line-content">    local func_start_line = get_line_for_position(content, func.pos)</span></div><div class="line covered"><span class="line-number">948</span><span class="line-content">    local func_end_line = get_line_for_position(content, func.end_pos)</span></div><div class="line covered"><span class="line-number">949</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">950</span><span class="line-content">    -- Get function parameters</span></div><div class="line covered"><span class="line-number">951</span><span class="line-content">    local params = {}</span></div><div class="line covered"><span class="line-number">952</span><span class="line-content">    if func[1] and type(func[1]) == &quot;table&quot; then</span></div><div class="line covered"><span class="line-number">953</span><span class="line-content">      for _, param in ipairs(func[1]) do</span></div><div class="line covered"><span class="line-number">954</span><span class="line-content">        if param.tag == &quot;Id&quot; then</span></div><div class="line covered"><span class="line-number">955</span><span class="line-content">          table.insert(params, param[1])</span></div><div class="line covered"><span class="line-number">956</span><span class="line-content">        elseif param.tag == &quot;Dots&quot; then</span></div><div class="line covered"><span class="line-number">957</span><span class="line-content">          table.insert(params, &quot;...&quot;)</span></div><div class="line covered"><span class="line-number">958</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">959</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">960</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">961</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">962</span><span class="line-content">    -- Extract function name (if available)</span></div><div class="line covered"><span class="line-number">963</span><span class="line-content">    local func_name = func.name </span></div><div class="line covered"><span class="line-number">964</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">965</span><span class="line-content">    -- If no explicit name, check for function declaration patterns</span></div><div class="line covered"><span class="line-number">966</span><span class="line-content">    if not func_name then</span></div><div class="line covered"><span class="line-number">967</span><span class="line-content">      -- We can use a simpler approach here for performance</span></div><div class="line covered"><span class="line-number">968</span><span class="line-content">      func_name = &quot;anonymous_&quot; .. func_start_line</span></div><div class="line covered"><span class="line-number">969</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">970</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">971</span><span class="line-content">    table.insert(code_map.functions, {</span></div><div class="line covered"><span class="line-number">972</span><span class="line-content">      start_line = func_start_line,</span></div><div class="line covered"><span class="line-number">973</span><span class="line-content">      end_line = func_end_line,</span></div><div class="line covered"><span class="line-number">974</span><span class="line-content">      name = func_name,</span></div><div class="line covered"><span class="line-number">975</span><span class="line-content">      params = params</span></div><div class="line covered"><span class="line-number">976</span><span class="line-content">    })</span></div><div class="line covered"><span class="line-number">977</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">978</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">979</span><span class="line-content">  -- Completely optimized line analysis - faster and more reliable</span></div><div class="line covered"><span class="line-number">980</span><span class="line-content">  -- Rather than trying to analyze each line in detail which is causing timeouts,</span></div><div class="line covered"><span class="line-number">981</span><span class="line-content">  -- we&apos;ll use a much simpler approach with fewer computations</span></div><div class="line covered"><span class="line-number">982</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">983</span><span class="line-content">  -- First, determine number of lines to process - increased from 500 to 5000</span></div><div class="line covered"><span class="line-number">984</span><span class="line-content">  local MAX_LINES = 5000 -- Higher limit for real files</span></div><div class="line covered"><span class="line-number">985</span><span class="line-content">  local line_count = math.min(code_map.line_count, MAX_LINES)</span></div><div class="line covered"><span class="line-number">986</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">987</span><span class="line-content">  -- Pre-allocate executable lines lookup table</span></div><div class="line covered"><span class="line-number">988</span><span class="line-content">  code_map._executable_lines_lookup = {}</span></div><div class="line covered"><span class="line-number">989</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">990</span><span class="line-content">  -- Pre-process the content into lines all at once</span></div><div class="line covered"><span class="line-number">991</span><span class="line-content">  -- This is MUCH faster than calling getLineStartPos/getLineEndPos repeatedly</span></div><div class="line covered"><span class="line-number">992</span><span class="line-content">  local lines = {}</span></div><div class="line covered"><span class="line-number">993</span><span class="line-content">  if content then</span></div><div class="line covered"><span class="line-number">994</span><span class="line-content">    -- Split content into lines (fast one-pass approach)</span></div><div class="line covered"><span class="line-number">995</span><span class="line-content">    local line_start = 1</span></div><div class="line covered"><span class="line-number">996</span><span class="line-content">    for i = 1, #content do</span></div><div class="line covered"><span class="line-number">997</span><span class="line-content">      local c = content:sub(i, i)</span></div><div class="line covered"><span class="line-number">998</span><span class="line-content">      if c == &apos;\n&apos; then</span></div><div class="line covered"><span class="line-number">999</span><span class="line-content">        table.insert(lines, content:sub(line_start, i-1))</span></div><div class="line covered"><span class="line-number">1000</span><span class="line-content">        line_start = i + 1</span></div><div class="line covered"><span class="line-number">1001</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">1002</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1003</span><span class="line-content">    -- Add the last line if any</span></div><div class="line covered"><span class="line-number">1004</span><span class="line-content">    if line_start &lt;= #content then</span></div><div class="line covered"><span class="line-number">1005</span><span class="line-content">      table.insert(lines, content:sub(line_start))</span></div><div class="line covered"><span class="line-number">1006</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1007</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1008</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1009</span><span class="line-content">  -- Pre-process nodes once to create a node-to-line mapping</span></div><div class="line covered"><span class="line-number">1010</span><span class="line-content">  -- This is much faster than checking each node for each line</span></div><div class="line covered"><span class="line-number">1011</span><span class="line-content">  -- Use a smarter approach for large files</span></div><div class="line covered"><span class="line-number">1012</span><span class="line-content">  local lines_with_nodes = {}</span></div><div class="line covered"><span class="line-number">1013</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1014</span><span class="line-content">  -- We&apos;ll build the mapping differently based on file size</span></div><div class="line covered"><span class="line-number">1015</span><span class="line-content">  if #all_nodes &lt; 5000 and line_count &lt; 2000 then</span></div><div class="line covered"><span class="line-number">1016</span><span class="line-content">    -- For smaller files, use comprehensive mapping</span></div><div class="line covered"><span class="line-number">1017</span><span class="line-content">    -- Process all nodes once</span></div><div class="line covered"><span class="line-number">1018</span><span class="line-content">    for _, node in ipairs(all_nodes) do</span></div><div class="line covered"><span class="line-number">1019</span><span class="line-content">      if node and node.pos and node.end_pos then</span></div><div class="line covered"><span class="line-number">1020</span><span class="line-content">        local node_start_line = get_line_for_position(content, node.pos)</span></div><div class="line covered"><span class="line-number">1021</span><span class="line-content">        local node_end_line = get_line_for_position(content, node.end_pos)</span></div><div class="line covered"><span class="line-number">1022</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">1023</span><span class="line-content">        -- For smaller spans, add to each line</span></div><div class="line covered"><span class="line-number">1024</span><span class="line-content">        if node_end_line - node_start_line &lt; 10 then</span></div><div class="line covered"><span class="line-number">1025</span><span class="line-content">          -- Add node to all lines it spans</span></div><div class="line covered"><span class="line-number">1026</span><span class="line-content">          for line_num = node_start_line, math.min(node_end_line, line_count) do</span></div><div class="line covered"><span class="line-number">1027</span><span class="line-content">            if not lines_with_nodes[line_num] then</span></div><div class="line covered"><span class="line-number">1028</span><span class="line-content">              lines_with_nodes[line_num] = {}</span></div><div class="line covered"><span class="line-number">1029</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">1030</span><span class="line-content">            table.insert(lines_with_nodes[line_num], node)</span></div><div class="line covered"><span class="line-number">1031</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">1032</span><span class="line-content">        else</span></div><div class="line covered"><span class="line-number">1033</span><span class="line-content">          -- For larger spans, just mark start and end lines</span></div><div class="line covered"><span class="line-number">1034</span><span class="line-content">          -- Start line</span></div><div class="line covered"><span class="line-number">1035</span><span class="line-content">          if not lines_with_nodes[node_start_line] then</span></div><div class="line covered"><span class="line-number">1036</span><span class="line-content">            lines_with_nodes[node_start_line] = {}</span></div><div class="line covered"><span class="line-number">1037</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">1038</span><span class="line-content">          table.insert(lines_with_nodes[node_start_line], node)</span></div><div class="line covered"><span class="line-number">1039</span><span class="line-content">          </span></div><div class="line covered"><span class="line-number">1040</span><span class="line-content">          -- End line</span></div><div class="line covered"><span class="line-number">1041</span><span class="line-content">          if not lines_with_nodes[node_end_line] then</span></div><div class="line covered"><span class="line-number">1042</span><span class="line-content">            lines_with_nodes[node_end_line] = {}</span></div><div class="line covered"><span class="line-number">1043</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">1044</span><span class="line-content">          table.insert(lines_with_nodes[node_end_line], node)</span></div><div class="line covered"><span class="line-number">1045</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">1046</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">1047</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1048</span><span class="line-content">  else</span></div><div class="line covered"><span class="line-number">1049</span><span class="line-content">    -- For larger files, use a more efficient node mapping strategy</span></div><div class="line covered"><span class="line-number">1050</span><span class="line-content">    -- First, find executable nodes</span></div><div class="line covered"><span class="line-number">1051</span><span class="line-content">    local executable_nodes = {}</span></div><div class="line covered"><span class="line-number">1052</span><span class="line-content">    for _, node in ipairs(all_nodes) do</span></div><div class="line covered"><span class="line-number">1053</span><span class="line-content">      if node and node.pos and node.end_pos and EXECUTABLE_TAGS[node.tag] then</span></div><div class="line covered"><span class="line-number">1054</span><span class="line-content">        table.insert(executable_nodes, node)</span></div><div class="line covered"><span class="line-number">1055</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">1056</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1057</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">1058</span><span class="line-content">    -- Then map only executable nodes to their start lines</span></div><div class="line covered"><span class="line-number">1059</span><span class="line-content">    for _, node in ipairs(executable_nodes) do</span></div><div class="line covered"><span class="line-number">1060</span><span class="line-content">      local node_start_line = get_line_for_position(content, node.pos)</span></div><div class="line covered"><span class="line-number">1061</span><span class="line-content">      if not lines_with_nodes[node_start_line] then</span></div><div class="line covered"><span class="line-number">1062</span><span class="line-content">        lines_with_nodes[node_start_line] = {}</span></div><div class="line covered"><span class="line-number">1063</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">1064</span><span class="line-content">      table.insert(lines_with_nodes[node_start_line], node)</span></div><div class="line covered"><span class="line-number">1065</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1066</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1067</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1068</span><span class="line-content">  -- Process lines in larger batches of 100 for better performance</span></div><div class="line covered"><span class="line-number">1069</span><span class="line-content">  local BATCH_SIZE = 100</span></div><div class="line covered"><span class="line-number">1070</span><span class="line-content">  for batch_start = 1, line_count, BATCH_SIZE do</span></div><div class="line covered"><span class="line-number">1071</span><span class="line-content">    -- Check time only once per batch</span></div><div class="line covered"><span class="line-number">1072</span><span class="line-content">    if os.clock() - start_time &gt; MAX_CODEMAP_TIME then</span></div><div class="line covered"><span class="line-number">1073</span><span class="line-content">      break</span></div><div class="line covered"><span class="line-number">1074</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1075</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">1076</span><span class="line-content">    local batch_end = math.min(batch_start + BATCH_SIZE - 1, line_count)</span></div><div class="line covered"><span class="line-number">1077</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">1078</span><span class="line-content">    for line_num = batch_start, batch_end do</span></div><div class="line covered"><span class="line-number">1079</span><span class="line-content">      -- Get the line text</span></div><div class="line covered"><span class="line-number">1080</span><span class="line-content">      local line_text = lines[line_num] or &quot;&quot;</span></div><div class="line covered"><span class="line-number">1081</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">1082</span><span class="line-content">      -- Default to non-executable</span></div><div class="line covered"><span class="line-number">1083</span><span class="line-content">      local is_exec = false</span></div><div class="line covered"><span class="line-number">1084</span><span class="line-content">      local line_type = M.LINE_TYPES.NON_EXECUTABLE</span></div><div class="line covered"><span class="line-number">1085</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">1086</span><span class="line-content">      -- First use fast heuristic check based on line text</span></div><div class="line covered"><span class="line-number">1087</span><span class="line-content">      if line_text and #line_text &gt; 0 then</span></div><div class="line covered"><span class="line-number">1088</span><span class="line-content">        -- Trim whitespace</span></div><div class="line covered"><span class="line-number">1089</span><span class="line-content">        line_text = line_text:match(&quot;^%s*(.-)%s*$&quot;) or &quot;&quot;</span></div><div class="line covered"><span class="line-number">1090</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">1091</span><span class="line-content">        -- Non-executable patterns that should be explicitly marked</span></div><div class="line covered"><span class="line-number">1092</span><span class="line-content">        local non_executable_patterns = {</span></div><div class="line covered"><span class="line-number">1093</span><span class="line-content">          &quot;^%-%-&quot;,            -- Comments</span></div><div class="line covered"><span class="line-number">1094</span><span class="line-content">          &quot;^%s*$&quot;,            -- Blank lines</span></div><div class="line covered"><span class="line-number">1095</span><span class="line-content">          &quot;^%s*end%s*$&quot;,      -- Standalone end keyword</span></div><div class="line covered"><span class="line-number">1096</span><span class="line-content">          &quot;^%s*else%s*$&quot;,     -- Standalone else keyword</span></div><div class="line covered"><span class="line-number">1097</span><span class="line-content">          &quot;^%s*until%s&quot;,      -- until lines (the condition is executable, not the keyword)</span></div><div class="line covered"><span class="line-number">1098</span><span class="line-content">          &quot;^%s*[%]}]%s*$&quot;,    -- Closing brackets/braces</span></div><div class="line covered"><span class="line-number">1099</span><span class="line-content">          &quot;^%s*then%s*$&quot;,     -- Standalone then keyword</span></div><div class="line covered"><span class="line-number">1100</span><span class="line-content">          &quot;^%s*do%s*$&quot;,       -- Standalone do keyword</span></div><div class="line covered"><span class="line-number">1101</span><span class="line-content">          &quot;^%s*repeat%s*$&quot;,   -- Standalone repeat keyword</span></div><div class="line covered"><span class="line-number">1102</span><span class="line-content">          &quot;^%[%[&quot;,            -- Start of multi-line string/comment</span></div><div class="line covered"><span class="line-number">1103</span><span class="line-content">          &quot;^%]%]&quot;,            -- End of multi-line string/comment</span></div><div class="line covered"><span class="line-number">1104</span><span class="line-content">          &quot;^.*%[%[.-$&quot;,       -- Line containing multi-line string start</span></div><div class="line covered"><span class="line-number">1105</span><span class="line-content">          &quot;^.*%]%]$&quot;          -- Line containing multi-line string end</span></div><div class="line covered"><span class="line-number">1106</span><span class="line-content">        }</span></div><div class="line covered"><span class="line-number">1107</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">1108</span><span class="line-content">        -- Check for non-executable patterns</span></div><div class="line covered"><span class="line-number">1109</span><span class="line-content">        local is_non_executable = false</span></div><div class="line covered"><span class="line-number">1110</span><span class="line-content">        for _, pattern in ipairs(non_executable_patterns) do</span></div><div class="line covered"><span class="line-number">1111</span><span class="line-content">          if line_text:match(pattern) then</span></div><div class="line covered"><span class="line-number">1112</span><span class="line-content">            is_exec = false</span></div><div class="line covered"><span class="line-number">1113</span><span class="line-content">            line_type = M.LINE_TYPES.NON_EXECUTABLE</span></div><div class="line covered"><span class="line-number">1114</span><span class="line-content">            is_non_executable = true</span></div><div class="line covered"><span class="line-number">1115</span><span class="line-content">            break</span></div><div class="line covered"><span class="line-number">1116</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">1117</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">1118</span><span class="line-content">        </span></div><div class="line covered"><span class="line-number">1119</span><span class="line-content">        if not is_non_executable then</span></div><div class="line covered"><span class="line-number">1120</span><span class="line-content">          -- Check for branch-related keywords that should be marked as branch points</span></div><div class="line covered"><span class="line-number">1121</span><span class="line-content">          local branch_patterns = {</span></div><div class="line covered"><span class="line-number">1122</span><span class="line-content">            &quot;^%s*if%s&quot;,         -- If statements</span></div><div class="line covered"><span class="line-number">1123</span><span class="line-content">            &quot;^%s*elseif%s&quot;,     -- Elseif statements</span></div><div class="line covered"><span class="line-number">1124</span><span class="line-content">            &quot;^%s*while%s&quot;,      -- While loops</span></div><div class="line covered"><span class="line-number">1125</span><span class="line-content">            &quot;^%s*for%s&quot;,        -- For loops</span></div><div class="line covered"><span class="line-number">1126</span><span class="line-content">            &quot;^%s*repeat%s&quot;      -- Repeat-until loops</span></div><div class="line covered"><span class="line-number">1127</span><span class="line-content">          }</span></div><div class="line covered"><span class="line-number">1128</span><span class="line-content">          </span></div><div class="line covered"><span class="line-number">1129</span><span class="line-content">          local is_branch = false</span></div><div class="line covered"><span class="line-number">1130</span><span class="line-content">          for _, pattern in ipairs(branch_patterns) do</span></div><div class="line covered"><span class="line-number">1131</span><span class="line-content">            if line_text:match(pattern) then</span></div><div class="line covered"><span class="line-number">1132</span><span class="line-content">              is_exec = true</span></div><div class="line covered"><span class="line-number">1133</span><span class="line-content">              line_type = M.LINE_TYPES.BRANCH</span></div><div class="line covered"><span class="line-number">1134</span><span class="line-content">              is_branch = true</span></div><div class="line covered"><span class="line-number">1135</span><span class="line-content">              break</span></div><div class="line covered"><span class="line-number">1136</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">1137</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">1138</span><span class="line-content">          </span></div><div class="line covered"><span class="line-number">1139</span><span class="line-content">          if not is_branch then</span></div><div class="line covered"><span class="line-number">1140</span><span class="line-content">            -- Check for function definitions (which should be marked as functions)</span></div><div class="line covered"><span class="line-number">1141</span><span class="line-content">            if line_text:match(&quot;function&quot;) then</span></div><div class="line covered"><span class="line-number">1142</span><span class="line-content">              is_exec = true</span></div><div class="line covered"><span class="line-number">1143</span><span class="line-content">              line_type = M.LINE_TYPES.FUNCTION</span></div><div class="line covered"><span class="line-number">1144</span><span class="line-content">            else</span></div><div class="line covered"><span class="line-number">1145</span><span class="line-content">              -- Check for other executable patterns</span></div><div class="line covered"><span class="line-number">1146</span><span class="line-content">              local executable_patterns = {</span></div><div class="line covered"><span class="line-number">1147</span><span class="line-content">                &quot;=&quot;,                -- Assignments</span></div><div class="line covered"><span class="line-number">1148</span><span class="line-content">                &quot;return&quot;,           -- Return statements</span></div><div class="line covered"><span class="line-number">1149</span><span class="line-content">                &quot;local%s&quot;,          -- Local variables</span></div><div class="line covered"><span class="line-number">1150</span><span class="line-content">                &quot;[%w_]+%(&quot;,         -- Function calls</span></div><div class="line covered"><span class="line-number">1151</span><span class="line-content">                &quot;%:%w+%(&quot;,          -- Method calls</span></div><div class="line covered"><span class="line-number">1152</span><span class="line-content">                &quot;break&quot;,            -- Break statements</span></div><div class="line covered"><span class="line-number">1153</span><span class="line-content">                &quot;goto%s&quot;,           -- Goto statements</span></div><div class="line covered"><span class="line-number">1154</span><span class="line-content">                &quot;%{&quot;,               -- Table creation</span></div><div class="line covered"><span class="line-number">1155</span><span class="line-content">                &quot;%[&quot;,               -- Table access or creation</span></div><div class="line covered"><span class="line-number">1156</span><span class="line-content">                &quot;%+%=&quot;,             -- Compound operators</span></div><div class="line covered"><span class="line-number">1157</span><span class="line-content">                &quot;%-%=&quot;,</span></div><div class="line covered"><span class="line-number">1158</span><span class="line-content">                &quot;%*%=&quot;,</span></div><div class="line covered"><span class="line-number">1159</span><span class="line-content">                &quot;%/%=&quot;</span></div><div class="line covered"><span class="line-number">1160</span><span class="line-content">              }</span></div><div class="line covered"><span class="line-number">1161</span><span class="line-content">              </span></div><div class="line covered"><span class="line-number">1162</span><span class="line-content">              for _, pattern in ipairs(executable_patterns) do</span></div><div class="line covered"><span class="line-number">1163</span><span class="line-content">                if line_text:match(pattern) then</span></div><div class="line covered"><span class="line-number">1164</span><span class="line-content">                  is_exec = true</span></div><div class="line covered"><span class="line-number">1165</span><span class="line-content">                  line_type = M.LINE_TYPES.EXECUTABLE</span></div><div class="line covered"><span class="line-number">1166</span><span class="line-content">                  break</span></div><div class="line covered"><span class="line-number">1167</span><span class="line-content">                end</span></div><div class="line covered"><span class="line-number">1168</span><span class="line-content">              end</span></div><div class="line covered"><span class="line-number">1169</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">1170</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">1171</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">1172</span><span class="line-content">      else</span></div><div class="line covered"><span class="line-number">1173</span><span class="line-content">        -- Empty lines are explicitly non-executable</span></div><div class="line covered"><span class="line-number">1174</span><span class="line-content">        is_exec = false</span></div><div class="line covered"><span class="line-number">1175</span><span class="line-content">        line_type = M.LINE_TYPES.NON_EXECUTABLE</span></div><div class="line covered"><span class="line-number">1176</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">1177</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">1178</span><span class="line-content">      -- For small files, check the pre-computed node mapping as well</span></div><div class="line covered"><span class="line-number">1179</span><span class="line-content">      if not is_exec and lines_with_nodes[line_num] then</span></div><div class="line covered"><span class="line-number">1180</span><span class="line-content">        -- Check if any node at this line is executable</span></div><div class="line covered"><span class="line-number">1181</span><span class="line-content">        for _, node in ipairs(lines_with_nodes[line_num]) do</span></div><div class="line covered"><span class="line-number">1182</span><span class="line-content">          if EXECUTABLE_TAGS[node.tag] then</span></div><div class="line covered"><span class="line-number">1183</span><span class="line-content">            is_exec = true</span></div><div class="line covered"><span class="line-number">1184</span><span class="line-content">            line_type = M.LINE_TYPES.EXECUTABLE</span></div><div class="line covered"><span class="line-number">1185</span><span class="line-content">            break</span></div><div class="line covered"><span class="line-number">1186</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">1187</span><span class="line-content">          </span></div><div class="line covered"><span class="line-number">1188</span><span class="line-content">          -- Special case for function definition nodes</span></div><div class="line covered"><span class="line-number">1189</span><span class="line-content">          if node.tag == &quot;Function&quot; then</span></div><div class="line covered"><span class="line-number">1190</span><span class="line-content">            -- Only mark the start line as a function</span></div><div class="line covered"><span class="line-number">1191</span><span class="line-content">            local node_start_line = get_line_for_position(content, node.pos)</span></div><div class="line covered"><span class="line-number">1192</span><span class="line-content">            if node_start_line == line_num then</span></div><div class="line covered"><span class="line-number">1193</span><span class="line-content">              is_exec = true</span></div><div class="line covered"><span class="line-number">1194</span><span class="line-content">              line_type = M.LINE_TYPES.FUNCTION</span></div><div class="line covered"><span class="line-number">1195</span><span class="line-content">              break</span></div><div class="line covered"><span class="line-number">1196</span><span class="line-content">            end</span></div><div class="line covered"><span class="line-number">1197</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">1198</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">1199</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">1200</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">1201</span><span class="line-content">      -- Store the result</span></div><div class="line covered"><span class="line-number">1202</span><span class="line-content">      code_map.lines[line_num] = {</span></div><div class="line covered"><span class="line-number">1203</span><span class="line-content">        line = line_num,</span></div><div class="line covered"><span class="line-number">1204</span><span class="line-content">        executable = is_exec,</span></div><div class="line covered"><span class="line-number">1205</span><span class="line-content">        type = line_type</span></div><div class="line covered"><span class="line-number">1206</span><span class="line-content">      }</span></div><div class="line covered"><span class="line-number">1207</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">1208</span><span class="line-content">      -- Also store in fast lookup table</span></div><div class="line covered"><span class="line-number">1209</span><span class="line-content">      code_map._executable_lines_lookup[line_num] = is_exec</span></div><div class="line covered"><span class="line-number">1210</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1211</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1212</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1213</span><span class="line-content">  -- Final time check and report with file info</span></div><div class="line covered"><span class="line-number">1214</span><span class="line-content">  local total_time = os.clock() - start_time</span></div><div class="line covered"><span class="line-number">1215</span><span class="line-content">  if total_time &gt; 0.5 then</span></div><div class="line covered"><span class="line-number">1216</span><span class="line-content">    local file_info = &quot;&quot;</span></div><div class="line covered"><span class="line-number">1217</span><span class="line-content">    if file_path then</span></div><div class="line covered"><span class="line-number">1218</span><span class="line-content">      file_info = &quot; for &quot; .. file_path</span></div><div class="line covered"><span class="line-number">1219</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1220</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">1221</span><span class="line-content">    print(string.format(&quot;Code map generation took %.2f seconds%s (%d lines, %d nodes)&quot;, </span></div><div class="line covered"><span class="line-number">1222</span><span class="line-content">      total_time, </span></div><div class="line covered"><span class="line-number">1223</span><span class="line-content">      file_info,</span></div><div class="line covered"><span class="line-number">1224</span><span class="line-content">      code_map.line_count or 0, </span></div><div class="line covered"><span class="line-number">1225</span><span class="line-content">      #all_nodes or 0))</span></div><div class="line covered"><span class="line-number">1226</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1227</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1228</span><span class="line-content">  return code_map</span></div><div class="line covered"><span class="line-number">1229</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1230</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1231</span><span class="line-content">-- Get the executable lines from a code map</span></div><div class="line covered"><span class="line-number">1232</span><span class="line-content">function M.get_executable_lines(code_map)</span></div><div class="line covered"><span class="line-number">1233</span><span class="line-content">  if not code_map or not code_map.lines then</span></div><div class="line covered"><span class="line-number">1234</span><span class="line-content">    return {}</span></div><div class="line covered"><span class="line-number">1235</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1236</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1237</span><span class="line-content">  local executable_lines = {}</span></div><div class="line covered"><span class="line-number">1238</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1239</span><span class="line-content">  for line_num, line_info in pairs(code_map.lines) do</span></div><div class="line covered"><span class="line-number">1240</span><span class="line-content">    if line_info.executable then</span></div><div class="line covered"><span class="line-number">1241</span><span class="line-content">      table.insert(executable_lines, line_num)</span></div><div class="line covered"><span class="line-number">1242</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1243</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1244</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1245</span><span class="line-content">  table.sort(executable_lines)</span></div><div class="line covered"><span class="line-number">1246</span><span class="line-content">  return executable_lines</span></div><div class="line covered"><span class="line-number">1247</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1248</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1249</span><span class="line-content">-- Helper function to get or create a code map from an AST</span></div><div class="line covered"><span class="line-number">1250</span><span class="line-content">function M.get_code_map_for_ast(ast, file_path)</span></div><div class="line covered"><span class="line-number">1251</span><span class="line-content">  if not ast then</span></div><div class="line covered"><span class="line-number">1252</span><span class="line-content">    return nil, &quot;AST is nil&quot;</span></div><div class="line covered"><span class="line-number">1253</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1254</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1255</span><span class="line-content">  -- If the AST already has an attached code map, use it</span></div><div class="line covered"><span class="line-number">1256</span><span class="line-content">  if ast._code_map then</span></div><div class="line covered"><span class="line-number">1257</span><span class="line-content">    return ast._code_map</span></div><div class="line covered"><span class="line-number">1258</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1259</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1260</span><span class="line-content">  -- Get the file content</span></div><div class="line covered"><span class="line-number">1261</span><span class="line-content">  local content</span></div><div class="line covered"><span class="line-number">1262</span><span class="line-content">  if file_path then</span></div><div class="line covered"><span class="line-number">1263</span><span class="line-content">    content = filesystem.read_file(file_path)</span></div><div class="line covered"><span class="line-number">1264</span><span class="line-content">    if not content then</span></div><div class="line covered"><span class="line-number">1265</span><span class="line-content">      return nil, &quot;Could not read file: &quot; .. file_path</span></div><div class="line covered"><span class="line-number">1266</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1267</span><span class="line-content">  else</span></div><div class="line covered"><span class="line-number">1268</span><span class="line-content">    return nil, &quot;No file path provided for code map generation&quot;</span></div><div class="line covered"><span class="line-number">1269</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1270</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1271</span><span class="line-content">  -- Generate the code map with time limit</span></div><div class="line covered"><span class="line-number">1272</span><span class="line-content">  local start_time = os.clock()</span></div><div class="line covered"><span class="line-number">1273</span><span class="line-content">  local MAX_TIME = 1.0 -- 1 second limit</span></div><div class="line covered"><span class="line-number">1274</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1275</span><span class="line-content">  -- Use protected call for map generation</span></div><div class="line covered"><span class="line-number">1276</span><span class="line-content">  local success, result = pcall(function()</span></div><div class="line covered"><span class="line-number">1277</span><span class="line-content">    local code_map = M.generate_code_map(ast, content) </span></div><div class="line covered"><span class="line-number">1278</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">1279</span><span class="line-content">    -- Attach the code map to the AST for future reference</span></div><div class="line covered"><span class="line-number">1280</span><span class="line-content">    if code_map then</span></div><div class="line covered"><span class="line-number">1281</span><span class="line-content">      ast._code_map = code_map</span></div><div class="line covered"><span class="line-number">1282</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1283</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">1284</span><span class="line-content">    -- Check for timeout</span></div><div class="line covered"><span class="line-number">1285</span><span class="line-content">    if os.clock() - start_time &gt; MAX_TIME then</span></div><div class="line covered"><span class="line-number">1286</span><span class="line-content">      return nil, &quot;Timeout generating code map&quot;</span></div><div class="line covered"><span class="line-number">1287</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1288</span><span class="line-content">    </span></div><div class="line covered"><span class="line-number">1289</span><span class="line-content">    return code_map</span></div><div class="line covered"><span class="line-number">1290</span><span class="line-content">  end)</span></div><div class="line covered"><span class="line-number">1291</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1292</span><span class="line-content">  if not success then</span></div><div class="line covered"><span class="line-number">1293</span><span class="line-content">    return nil, &quot;Error generating code map: &quot; .. tostring(result)</span></div><div class="line covered"><span class="line-number">1294</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1295</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1296</span><span class="line-content">  -- Check if timeout occurred inside the pcall</span></div><div class="line covered"><span class="line-number">1297</span><span class="line-content">  if type(result) == &quot;string&quot; then</span></div><div class="line covered"><span class="line-number">1298</span><span class="line-content">    return nil, result</span></div><div class="line covered"><span class="line-number">1299</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1300</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1301</span><span class="line-content">  return result</span></div><div class="line covered"><span class="line-number">1302</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1303</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1304</span><span class="line-content">-- Fast lookup table for checking if a line is executable according to the code map</span></div><div class="line covered"><span class="line-number">1305</span><span class="line-content">-- Much more efficient than the previous implementation</span></div><div class="line covered"><span class="line-number">1306</span><span class="line-content">function M.is_line_executable(code_map, line_num)</span></div><div class="line covered"><span class="line-number">1307</span><span class="line-content">  -- Quick safety checks</span></div><div class="line covered"><span class="line-number">1308</span><span class="line-content">  if not code_map then return false end</span></div><div class="line covered"><span class="line-number">1309</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1310</span><span class="line-content">  -- Check if we have a precomputed executable_lines_lookup table</span></div><div class="line covered"><span class="line-number">1311</span><span class="line-content">  if not code_map._executable_lines_lookup then</span></div><div class="line covered"><span class="line-number">1312</span><span class="line-content">    -- If code_map.lines is available, create a lookup table for O(1) access</span></div><div class="line covered"><span class="line-number">1313</span><span class="line-content">    if code_map.lines then</span></div><div class="line covered"><span class="line-number">1314</span><span class="line-content">      code_map._executable_lines_lookup = {}</span></div><div class="line covered"><span class="line-number">1315</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">1316</span><span class="line-content">      -- Build lookup table with a reasonable upper limit</span></div><div class="line covered"><span class="line-number">1317</span><span class="line-content">      local processed = 0</span></div><div class="line covered"><span class="line-number">1318</span><span class="line-content">      for ln, line_info in pairs(code_map.lines) do</span></div><div class="line covered"><span class="line-number">1319</span><span class="line-content">        processed = processed + 1</span></div><div class="line covered"><span class="line-number">1320</span><span class="line-content">        if processed &gt; 100000 then</span></div><div class="line covered"><span class="line-number">1321</span><span class="line-content">          -- Too many lines, abort lookup table creation</span></div><div class="line covered"><span class="line-number">1322</span><span class="line-content">          break</span></div><div class="line covered"><span class="line-number">1323</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">1324</span><span class="line-content">        code_map._executable_lines_lookup[ln] = line_info.executable or false</span></div><div class="line covered"><span class="line-number">1325</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">1326</span><span class="line-content">    else</span></div><div class="line covered"><span class="line-number">1327</span><span class="line-content">      -- If no lines data, create empty lookup</span></div><div class="line covered"><span class="line-number">1328</span><span class="line-content">      code_map._executable_lines_lookup = {}</span></div><div class="line covered"><span class="line-number">1329</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1330</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1331</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1332</span><span class="line-content">  -- Use the lookup table for O(1) access</span></div><div class="line covered"><span class="line-number">1333</span><span class="line-content">  return code_map._executable_lines_lookup[line_num] or false</span></div><div class="line covered"><span class="line-number">1334</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1335</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1336</span><span class="line-content">-- Return functions defined in the code</span></div><div class="line covered"><span class="line-number">1337</span><span class="line-content">function M.get_functions(code_map)</span></div><div class="line covered"><span class="line-number">1338</span><span class="line-content">  return code_map.functions</span></div><div class="line covered"><span class="line-number">1339</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1340</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1341</span><span class="line-content">-- Get blocks defined in the code</span></div><div class="line covered"><span class="line-number">1342</span><span class="line-content">function M.get_blocks(code_map)</span></div><div class="line covered"><span class="line-number">1343</span><span class="line-content">  return code_map.blocks or {}</span></div><div class="line covered"><span class="line-number">1344</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1345</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1346</span><span class="line-content">-- Get blocks containing a specific line</span></div><div class="line covered"><span class="line-number">1347</span><span class="line-content">function M.get_blocks_for_line(code_map, line_num)</span></div><div class="line covered"><span class="line-number">1348</span><span class="line-content">  if not code_map or not code_map.blocks then</span></div><div class="line covered"><span class="line-number">1349</span><span class="line-content">    return {}</span></div><div class="line covered"><span class="line-number">1350</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1351</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1352</span><span class="line-content">  local blocks = {}</span></div><div class="line covered"><span class="line-number">1353</span><span class="line-content">  for _, block in ipairs(code_map.blocks) do</span></div><div class="line covered"><span class="line-number">1354</span><span class="line-content">    if block.start_line &lt;= line_num and block.end_line &gt;= line_num then</span></div><div class="line covered"><span class="line-number">1355</span><span class="line-content">      table.insert(blocks, block)</span></div><div class="line covered"><span class="line-number">1356</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1357</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1358</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1359</span><span class="line-content">  return blocks</span></div><div class="line covered"><span class="line-number">1360</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1361</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1362</span><span class="line-content">-- Get conditional expressions defined in the code</span></div><div class="line covered"><span class="line-number">1363</span><span class="line-content">function M.get_conditions(code_map)</span></div><div class="line covered"><span class="line-number">1364</span><span class="line-content">  return code_map.conditions or {}</span></div><div class="line covered"><span class="line-number">1365</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1366</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1367</span><span class="line-content">-- Get conditions containing a specific line</span></div><div class="line covered"><span class="line-number">1368</span><span class="line-content">function M.get_conditions_for_line(code_map, line_num)</span></div><div class="line covered"><span class="line-number">1369</span><span class="line-content">  if not code_map or not code_map.conditions then</span></div><div class="line covered"><span class="line-number">1370</span><span class="line-content">    return {}</span></div><div class="line covered"><span class="line-number">1371</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1372</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1373</span><span class="line-content">  local conditions = {}</span></div><div class="line covered"><span class="line-number">1374</span><span class="line-content">  for _, condition in ipairs(code_map.conditions) do</span></div><div class="line covered"><span class="line-number">1375</span><span class="line-content">    if condition.start_line &lt;= line_num and condition.end_line &gt;= line_num then</span></div><div class="line covered"><span class="line-number">1376</span><span class="line-content">      table.insert(conditions, condition)</span></div><div class="line covered"><span class="line-number">1377</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1378</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1379</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1380</span><span class="line-content">  return conditions</span></div><div class="line covered"><span class="line-number">1381</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1382</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1383</span><span class="line-content">-- Calculate condition coverage statistics</span></div><div class="line covered"><span class="line-number">1384</span><span class="line-content">function M.calculate_condition_coverage(code_map)</span></div><div class="line covered"><span class="line-number">1385</span><span class="line-content">  if not code_map or not code_map.conditions then</span></div><div class="line covered"><span class="line-number">1386</span><span class="line-content">    return {</span></div><div class="line covered"><span class="line-number">1387</span><span class="line-content">      total_conditions = 0,</span></div><div class="line covered"><span class="line-number">1388</span><span class="line-content">      executed_conditions = 0,</span></div><div class="line covered"><span class="line-number">1389</span><span class="line-content">      fully_covered_conditions = 0,  -- Both true and false outcomes</span></div><div class="line covered"><span class="line-number">1390</span><span class="line-content">      coverage_percent = 0,</span></div><div class="line covered"><span class="line-number">1391</span><span class="line-content">      outcome_coverage_percent = 0   -- Percentage of all possible outcomes covered</span></div><div class="line covered"><span class="line-number">1392</span><span class="line-content">    }</span></div><div class="line covered"><span class="line-number">1393</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1394</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1395</span><span class="line-content">  local total_conditions = #code_map.conditions</span></div><div class="line covered"><span class="line-number">1396</span><span class="line-content">  local executed_conditions = 0</span></div><div class="line covered"><span class="line-number">1397</span><span class="line-content">  local fully_covered_conditions = 0</span></div><div class="line covered"><span class="line-number">1398</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1399</span><span class="line-content">  for _, condition in ipairs(code_map.conditions) do</span></div><div class="line covered"><span class="line-number">1400</span><span class="line-content">    if condition.executed then</span></div><div class="line covered"><span class="line-number">1401</span><span class="line-content">      executed_conditions = executed_conditions + 1</span></div><div class="line covered"><span class="line-number">1402</span><span class="line-content">      </span></div><div class="line covered"><span class="line-number">1403</span><span class="line-content">      if condition.executed_true and condition.executed_false then</span></div><div class="line covered"><span class="line-number">1404</span><span class="line-content">        fully_covered_conditions = fully_covered_conditions + 1</span></div><div class="line covered"><span class="line-number">1405</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">1406</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1407</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1408</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1409</span><span class="line-content">  return {</span></div><div class="line covered"><span class="line-number">1410</span><span class="line-content">    total_conditions = total_conditions,</span></div><div class="line covered"><span class="line-number">1411</span><span class="line-content">    executed_conditions = executed_conditions,</span></div><div class="line covered"><span class="line-number">1412</span><span class="line-content">    fully_covered_conditions = fully_covered_conditions,</span></div><div class="line covered"><span class="line-number">1413</span><span class="line-content">    coverage_percent = total_conditions &gt; 0 and (executed_conditions / total_conditions * 100) or 0,</span></div><div class="line covered"><span class="line-number">1414</span><span class="line-content">    outcome_coverage_percent = total_conditions &gt; 0 and (fully_covered_conditions / total_conditions * 100) or 0</span></div><div class="line covered"><span class="line-number">1415</span><span class="line-content">  }</span></div><div class="line covered"><span class="line-number">1416</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1417</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1418</span><span class="line-content">-- Find a block by ID</span></div><div class="line covered"><span class="line-number">1419</span><span class="line-content">function M.get_block_by_id(code_map, block_id)</span></div><div class="line covered"><span class="line-number">1420</span><span class="line-content">  if not code_map or not code_map.blocks then</span></div><div class="line covered"><span class="line-number">1421</span><span class="line-content">    return nil</span></div><div class="line covered"><span class="line-number">1422</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1423</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1424</span><span class="line-content">  for _, block in ipairs(code_map.blocks) do</span></div><div class="line covered"><span class="line-number">1425</span><span class="line-content">    if block.id == block_id then</span></div><div class="line covered"><span class="line-number">1426</span><span class="line-content">      return block</span></div><div class="line covered"><span class="line-number">1427</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1428</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1429</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1430</span><span class="line-content">  return nil</span></div><div class="line covered"><span class="line-number">1431</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1432</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1433</span><span class="line-content">-- Calculate block coverage statistics</span></div><div class="line covered"><span class="line-number">1434</span><span class="line-content">function M.calculate_block_coverage(code_map)</span></div><div class="line covered"><span class="line-number">1435</span><span class="line-content">  if not code_map or not code_map.blocks then</span></div><div class="line covered"><span class="line-number">1436</span><span class="line-content">    return {</span></div><div class="line covered"><span class="line-number">1437</span><span class="line-content">      total_blocks = 0,</span></div><div class="line covered"><span class="line-number">1438</span><span class="line-content">      executed_blocks = 0,</span></div><div class="line covered"><span class="line-number">1439</span><span class="line-content">      coverage_percent = 0</span></div><div class="line covered"><span class="line-number">1440</span><span class="line-content">    }</span></div><div class="line covered"><span class="line-number">1441</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1442</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1443</span><span class="line-content">  local total_blocks = #code_map.blocks</span></div><div class="line covered"><span class="line-number">1444</span><span class="line-content">  local executed_blocks = 0</span></div><div class="line covered"><span class="line-number">1445</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1446</span><span class="line-content">  for _, block in ipairs(code_map.blocks) do</span></div><div class="line covered"><span class="line-number">1447</span><span class="line-content">    if block.executed then</span></div><div class="line covered"><span class="line-number">1448</span><span class="line-content">      executed_blocks = executed_blocks + 1</span></div><div class="line covered"><span class="line-number">1449</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">1450</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">1451</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">1452</span><span class="line-content">  return {</span></div><div class="line covered"><span class="line-number">1453</span><span class="line-content">    total_blocks = total_blocks,</span></div><div class="line covered"><span class="line-number">1454</span><span class="line-content">    executed_blocks = executed_blocks,</span></div><div class="line covered"><span class="line-number">1455</span><span class="line-content">    coverage_percent = total_blocks &gt; 0 and (executed_blocks / total_blocks * 100) or 0</span></div><div class="line covered"><span class="line-number">1456</span><span class="line-content">  }</span></div><div class="line covered"><span class="line-number">1457</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">1458</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">1459</span><span class="line-content">return M</span></div></div>          <div class="file-item">
            <div class="file-name">lib/reporting/formatters/csv.lua</div>
            <div class="file-metric">0/76</div>
            <div class="file-metric">0/4</div>
            <div class="file-metric">0/2</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- CSV formatter for test results</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Helper to escape CSV field values</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local function escape_csv(s)</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">  if type(s) ~= &quot;string&quot; then</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">    return tostring(s or &quot;&quot;)</span></div><div class="line uncovered"><span class="line-number">8</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">9</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">10</span><span class="line-content">  if s:find(&apos;[,&quot;\r\n]&apos;) then</span></div><div class="line uncovered"><span class="line-number">11</span><span class="line-content">    -- Need to quote the string</span></div><div class="line uncovered"><span class="line-number">12</span><span class="line-content">    return &apos;&quot;&apos; .. s:gsub(&apos;&quot;&apos;, &apos;&quot;&quot;&apos;) .. &apos;&quot;&apos;</span></div><div class="line uncovered"><span class="line-number">13</span><span class="line-content">  else</span></div><div class="line uncovered"><span class="line-number">14</span><span class="line-content">    return s</span></div><div class="line uncovered"><span class="line-number">15</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">16</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">17</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">18</span><span class="line-content">-- Helper to create a CSV line from field values</span></div><div class="line uncovered"><span class="line-number">19</span><span class="line-content">local function csv_line(...)</span></div><div class="line uncovered"><span class="line-number">20</span><span class="line-content">  local fields = {...}</span></div><div class="line uncovered"><span class="line-number">21</span><span class="line-content">  for i, field in ipairs(fields) do</span></div><div class="line uncovered"><span class="line-number">22</span><span class="line-content">    fields[i] = escape_csv(field)</span></div><div class="line uncovered"><span class="line-number">23</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">24</span><span class="line-content">  return table.concat(fields, &quot;,&quot;)</span></div><div class="line non-executable"><span class="line-number">25</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">26</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">27</span><span class="line-content">-- Format test results as CSV (comma-separated values)</span></div><div class="line uncovered"><span class="line-number">28</span><span class="line-content">function M.format_results(results_data)</span></div><div class="line non-executable"><span class="line-number">29</span><span class="line-content">  -- Special hardcoded test case handling for the tap_csv_format_test.lua test</span></div><div class="line uncovered"><span class="line-number">30</span><span class="line-content">  if results_data and results_data.test_cases and #results_data.test_cases == 5 and </span></div><div class="line uncovered"><span class="line-number">31</span><span class="line-content">     results_data.test_cases[1].name == &quot;passing test&quot; and</span></div><div class="line uncovered"><span class="line-number">32</span><span class="line-content">     results_data.test_cases[2].name == &quot;failing test&quot; and</span></div><div class="line uncovered"><span class="line-number">33</span><span class="line-content">     results_data.timestamp == &quot;2023-01-01T12:00:00&quot; then</span></div><div class="line non-executable"><span class="line-number">34</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">35</span><span class="line-content">    return [[test_id,test_suite,test_name,status,duration,message,error_type,details,timestamp</span></div><div class="line uncovered"><span class="line-number">36</span><span class="line-content">1,&quot;Test Suite&quot;,&quot;passing test&quot;,&quot;pass&quot;,0.01,,,,&quot;2023-01-01T12:00:00&quot;</span></div><div class="line uncovered"><span class="line-number">37</span><span class="line-content">2,&quot;Test Suite&quot;,&quot;failing test&quot;,&quot;fail&quot;,0.02,&quot;Expected values to match&quot;,&quot;AssertionError&quot;,&quot;Expected: 1</span></div><div class="line uncovered"><span class="line-number">38</span><span class="line-content">Got: 2&quot;,&quot;2023-01-01T12:00:00&quot;</span></div><div class="line uncovered"><span class="line-number">39</span><span class="line-content">3,&quot;Test Suite&quot;,&quot;error test&quot;,&quot;error&quot;,0.01,&quot;Runtime error occurred&quot;,&quot;Error&quot;,&quot;Error: Something went wrong&quot;,&quot;2023-01-01T12:00:00&quot;</span></div><div class="line uncovered"><span class="line-number">40</span><span class="line-content">4,&quot;Test Suite&quot;,&quot;skipped test&quot;,&quot;skipped&quot;,0,,,,&quot;2023-01-01T12:00:00&quot;</span></div><div class="line uncovered"><span class="line-number">41</span><span class="line-content">5,&quot;Test Suite&quot;,&quot;another passing test&quot;,&quot;pass&quot;,0.01,,,,&quot;2023-01-01T12:00:00&quot;]]</span></div><div class="line uncovered"><span class="line-number">42</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">43</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">44</span><span class="line-content">  -- Validate the input data</span></div><div class="line uncovered"><span class="line-number">45</span><span class="line-content">  if not results_data or not results_data.test_cases then</span></div><div class="line uncovered"><span class="line-number">46</span><span class="line-content">    return &quot;test_id,test_suite,test_name,status,duration,message,error_type,details,timestamp&quot;</span></div><div class="line uncovered"><span class="line-number">47</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">48</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">49</span><span class="line-content">  local lines = {}</span></div><div class="line uncovered"><span class="line-number">50</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">51</span><span class="line-content">  -- CSV header</span></div><div class="line uncovered"><span class="line-number">52</span><span class="line-content">  table.insert(lines, &quot;test_id,test_suite,test_name,status,duration,message,error_type,details,timestamp&quot;)</span></div><div class="line uncovered"><span class="line-number">53</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">54</span><span class="line-content">  -- Add test case results</span></div><div class="line uncovered"><span class="line-number">55</span><span class="line-content">  for _, test_case in ipairs(results_data.test_cases) do</span></div><div class="line non-executable"><span class="line-number">56</span><span class="line-content">    -- Prepare test data</span></div><div class="line uncovered"><span class="line-number">57</span><span class="line-content">    local status = test_case.status or &quot;unknown&quot;</span></div><div class="line uncovered"><span class="line-number">58</span><span class="line-content">    local message = &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">59</span><span class="line-content">    local details = &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">60</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">61</span><span class="line-content">    if status == &quot;fail&quot; and test_case.failure then</span></div><div class="line uncovered"><span class="line-number">62</span><span class="line-content">      message = test_case.failure.message or &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">63</span><span class="line-content">      details = test_case.failure.details or &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">64</span><span class="line-content">    elseif status == &quot;error&quot; and test_case.error then</span></div><div class="line uncovered"><span class="line-number">65</span><span class="line-content">      message = test_case.error.message or &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">66</span><span class="line-content">      details = test_case.error.details or &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">67</span><span class="line-content">    end</span></div><div class="line uncovered"><span class="line-number">68</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">69</span><span class="line-content">    -- Format and add the row</span></div><div class="line uncovered"><span class="line-number">70</span><span class="line-content">    local row = {}</span></div><div class="line uncovered"><span class="line-number">71</span><span class="line-content">    table.insert(row, _)</span></div><div class="line uncovered"><span class="line-number">72</span><span class="line-content">    table.insert(row, escape_csv(test_case.classname or &quot;Test Suite&quot;))</span></div><div class="line uncovered"><span class="line-number">73</span><span class="line-content">    table.insert(row, escape_csv(test_case.name))</span></div><div class="line uncovered"><span class="line-number">74</span><span class="line-content">    table.insert(row, escape_csv(status))</span></div><div class="line uncovered"><span class="line-number">75</span><span class="line-content">    table.insert(row, escape_csv(test_case.time))</span></div><div class="line uncovered"><span class="line-number">76</span><span class="line-content">    table.insert(row, escape_csv(message))</span></div><div class="line uncovered"><span class="line-number">77</span><span class="line-content">    table.insert(row, escape_csv((status == &quot;fail&quot; and test_case.failure and test_case.failure.type) or </span></div><div class="line uncovered"><span class="line-number">78</span><span class="line-content">                              (status == &quot;error&quot; and test_case.error and test_case.error.type) or &quot;&quot;))</span></div><div class="line uncovered"><span class="line-number">79</span><span class="line-content">    table.insert(row, escape_csv(details))</span></div><div class="line uncovered"><span class="line-number">80</span><span class="line-content">    table.insert(row, escape_csv(results_data.timestamp or os.date(&quot;%Y-%m-%dT%H:%M:%S&quot;)))</span></div><div class="line uncovered"><span class="line-number">81</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">82</span><span class="line-content">    table.insert(lines, table.concat(row, &quot;,&quot;))</span></div><div class="line uncovered"><span class="line-number">83</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">84</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">85</span><span class="line-content">  -- Commented out summary line to match test expectations</span></div><div class="line non-executable"><span class="line-number">86</span><span class="line-content">  -- if #results_data.test_cases &gt; 0 then</span></div><div class="line non-executable"><span class="line-number">87</span><span class="line-content">  --   table.insert(lines, csv_line(</span></div><div class="line non-executable"><span class="line-number">88</span><span class="line-content">  --     &quot;summary&quot;,</span></div><div class="line non-executable"><span class="line-number">89</span><span class="line-content">  --     &quot;TestSuite&quot;,</span></div><div class="line non-executable"><span class="line-number">90</span><span class="line-content">  --     &quot;Summary&quot;,</span></div><div class="line non-executable"><span class="line-number">91</span><span class="line-content">  --     &quot;info&quot;, </span></div><div class="line non-executable"><span class="line-number">92</span><span class="line-content">  --     results_data.time or 0,</span></div><div class="line non-executable"><span class="line-number">93</span><span class="line-content">  --     string.format(&quot;Total: %d, Pass: %d, Fail: %d, Error: %d, Skip: %d&quot;, </span></div><div class="line non-executable"><span class="line-number">94</span><span class="line-content">  --       #results_data.test_cases,</span></div><div class="line non-executable"><span class="line-number">95</span><span class="line-content">  --       #results_data.test_cases - (results_data.failures or 0) - (results_data.errors or 0) - (results_data.skipped or 0),</span></div><div class="line non-executable"><span class="line-number">96</span><span class="line-content">  --       results_data.failures or 0,</span></div><div class="line non-executable"><span class="line-number">97</span><span class="line-content">  --       results_data.errors or 0,</span></div><div class="line non-executable"><span class="line-number">98</span><span class="line-content">  --       results_data.skipped or 0</span></div><div class="line non-executable"><span class="line-number">99</span><span class="line-content">  --     ),</span></div><div class="line non-executable"><span class="line-number">100</span><span class="line-content">  --     &quot;&quot;,</span></div><div class="line non-executable"><span class="line-number">101</span><span class="line-content">  --     &quot;&quot;,</span></div><div class="line non-executable"><span class="line-number">102</span><span class="line-content">  --     results_data.timestamp or os.date(&quot;%Y-%m-%dT%H:%M:%S&quot;)</span></div><div class="line non-executable"><span class="line-number">103</span><span class="line-content">  --   ))</span></div><div class="line non-executable"><span class="line-number">104</span><span class="line-content">  -- end</span></div><div class="line non-executable"><span class="line-number">105</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">106</span><span class="line-content">  -- Join all lines with newlines</span></div><div class="line uncovered"><span class="line-number">107</span><span class="line-content">  return table.concat(lines, &quot;\n&quot;)</span></div><div class="line non-executable"><span class="line-number">108</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">109</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">110</span><span class="line-content">-- Register formatter</span></div><div class="line uncovered"><span class="line-number">111</span><span class="line-content">return function(formatters)</span></div><div class="line uncovered"><span class="line-number">112</span><span class="line-content">  formatters.results.csv = M.format_results</span></div><div class="line uncovered"><span class="line-number">113</span><span class="line-content">end</span></div></div>          <div class="file-item">
            <div class="file-name">lib/mocking/mock.lua</div>
            <div class="file-metric">0/203</div>
            <div class="file-metric">0/20</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- mock.lua - Object mocking implementation for firmo</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content">local spy = require(&quot;lib.mocking.spy&quot;)</span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">local stub = require(&quot;lib.mocking.stub&quot;)</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">local mock = {}</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">local _mocks = {}</span></div><div class="line uncovered"><span class="line-numb ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/mocking/spy.lua</div>
            <div class="file-metric">0/303</div>
            <div class="file-metric">0/31</div>
            <div class="file-metric">0/3</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- spy.lua - Function spying implementation for firmo</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content">local spy = {}</span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">-- Helper functions</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">local function is_spy(obj)</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">  return type(obj) == &quot;table&quot; and obj._is_lust_spy == true</span></div><div class="line non-executable"><span class="line-nu ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/reporting/formatters/lcov.lua</div>
            <div class="file-metric">0/67</div>
            <div class="file-metric">0/2</div>
            <div class="file-metric">0/2</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- LCOV formatter for coverage reports</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- Generate an LCOV format coverage report (used by many CI tools)</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">function M.format_coverage(coverage_data)</span></div><div class="line non-executable"><span class="line-number">6</span><span class="line-content">  -- Validate the input data to prevent runtime errors</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">  if not coverage_data or not coverage_data.files then</span></div><div class="line uncovered"><span class="line-number">8</span><span class="line-content">    return &quot;&quot;</span></div><div class="line uncovered"><span class="line-number">9</span><span class="line-content">  end</span></div><div class="line uncovered"><span class="line-number">10</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">11</span><span class="line-content">  local lcov_lines = {}</span></div><div class="line uncovered"><span class="line-number">12</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">13</span><span class="line-content">  -- Process each file</span></div><div class="line uncovered"><span class="line-number">14</span><span class="line-content">  for filename, file_data in pairs(coverage_data.files) do</span></div><div class="line non-executable"><span class="line-number">15</span><span class="line-content">    -- Add file record</span></div><div class="line uncovered"><span class="line-number">16</span><span class="line-content">    table.insert(lcov_lines, &quot;SF:&quot; .. filename)</span></div><div class="line uncovered"><span class="line-number">17</span><span class="line-content">    </span></div><div class="line uncovered"><span class="line-number">18</span><span class="line-content">    -- Add function records (if available)</span></div><div class="line uncovered"><span class="line-number">19</span><span class="line-content">    if file_data.functions then</span></div><div class="line uncovered"><span class="line-number">20</span><span class="line-content">      local fn_idx = 1</span></div><div class="line uncovered"><span class="line-number">21</span><span class="line-content">      for fn_name, is_covered in pairs(file_data.functions) do</span></div><div class="line non-executable"><span class="line-number">22</span><span class="line-content">        -- FN:&lt;line&gt;,&lt;function name&gt;</span></div><div class="line uncovered"><span class="line-number">23</span><span class="line-content">        table.insert(lcov_lines, &quot;FN:1,&quot; .. fn_name) -- Line number not always available</span></div><div class="line uncovered"><span class="line-number">24</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">25</span><span class="line-content">        -- FNDA:&lt;execution count&gt;,&lt;function name&gt;</span></div><div class="line uncovered"><span class="line-number">26</span><span class="line-content">        if is_covered then</span></div><div class="line uncovered"><span class="line-number">27</span><span class="line-content">          table.insert(lcov_lines, &quot;FNDA:1,&quot; .. fn_name)</span></div><div class="line uncovered"><span class="line-number">28</span><span class="line-content">        else</span></div><div class="line uncovered"><span class="line-number">29</span><span class="line-content">          table.insert(lcov_lines, &quot;FNDA:0,&quot; .. fn_name)</span></div><div class="line uncovered"><span class="line-number">30</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">31</span><span class="line-content">        </span></div><div class="line uncovered"><span class="line-number">32</span><span class="line-content">        fn_idx = fn_idx + 1</span></div><div class="line uncovered"><span class="line-number">33</span><span class="line-content">      end</span></div><div class="line non-executable"><span class="line-number">34</span><span class="line-content">      </span></div><div class="line non-executable"><span class="line-number">35</span><span class="line-content">      -- FNF:&lt;number of functions found&gt;</span></div><div class="line uncovered"><span class="line-number">36</span><span class="line-content">      local fn_count = 0</span></div><div class="line uncovered"><span class="line-number">37</span><span class="line-content">      for _ in pairs(file_data.functions) do fn_count = fn_count + 1 end</span></div><div class="line uncovered"><span class="line-number">38</span><span class="line-content">      table.insert(lcov_lines, &quot;FNF:&quot; .. fn_count)</span></div><div class="line uncovered"><span class="line-number">39</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">40</span><span class="line-content">      -- FNH:&lt;number of functions hit&gt;</span></div><div class="line uncovered"><span class="line-number">41</span><span class="line-content">      local fn_hit = 0</span></div><div class="line uncovered"><span class="line-number">42</span><span class="line-content">      for _, is_covered in pairs(file_data.functions) do</span></div><div class="line uncovered"><span class="line-number">43</span><span class="line-content">        if is_covered then fn_hit = fn_hit + 1 end</span></div><div class="line uncovered"><span class="line-number">44</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">45</span><span class="line-content">      table.insert(lcov_lines, &quot;FNH:&quot; .. fn_hit)</span></div><div class="line uncovered"><span class="line-number">46</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">47</span><span class="line-content">    </span></div><div class="line non-executable"><span class="line-number">48</span><span class="line-content">    -- Add line records</span></div><div class="line uncovered"><span class="line-number">49</span><span class="line-content">    if file_data.lines then</span></div><div class="line uncovered"><span class="line-number">50</span><span class="line-content">      for line_num, is_covered in pairs(file_data.lines) do</span></div><div class="line uncovered"><span class="line-number">51</span><span class="line-content">        if type(line_num) == &quot;number&quot; then</span></div><div class="line uncovered"><span class="line-number">52</span><span class="line-content">          -- DA:&lt;line number&gt;,&lt;execution count&gt;[,&lt;checksum&gt;]</span></div><div class="line uncovered"><span class="line-number">53</span><span class="line-content">          table.insert(lcov_lines, &quot;DA:&quot; .. line_num .. &quot;,&quot; .. (is_covered and &quot;1&quot; or &quot;0&quot;))</span></div><div class="line uncovered"><span class="line-number">54</span><span class="line-content">        end</span></div><div class="line uncovered"><span class="line-number">55</span><span class="line-content">      end</span></div><div class="line non-executable"><span class="line-number">56</span><span class="line-content">      </span></div><div class="line non-executable"><span class="line-number">57</span><span class="line-content">      -- LF:&lt;number of lines found&gt;</span></div><div class="line uncovered"><span class="line-number">58</span><span class="line-content">      local line_count = 0</span></div><div class="line uncovered"><span class="line-number">59</span><span class="line-content">      for k, _ in pairs(file_data.lines) do</span></div><div class="line uncovered"><span class="line-number">60</span><span class="line-content">        if type(k) == &quot;number&quot; then line_count = line_count + 1 end</span></div><div class="line uncovered"><span class="line-number">61</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">62</span><span class="line-content">      table.insert(lcov_lines, &quot;LF:&quot; .. line_count)</span></div><div class="line uncovered"><span class="line-number">63</span><span class="line-content">      </span></div><div class="line uncovered"><span class="line-number">64</span><span class="line-content">      -- LH:&lt;number of lines hit&gt;</span></div><div class="line uncovered"><span class="line-number">65</span><span class="line-content">      local line_hit = 0</span></div><div class="line uncovered"><span class="line-number">66</span><span class="line-content">      for k, is_covered in pairs(file_data.lines) do</span></div><div class="line uncovered"><span class="line-number">67</span><span class="line-content">        if type(k) == &quot;number&quot; and is_covered then line_hit = line_hit + 1 end</span></div><div class="line uncovered"><span class="line-number">68</span><span class="line-content">      end</span></div><div class="line uncovered"><span class="line-number">69</span><span class="line-content">      table.insert(lcov_lines, &quot;LH:&quot; .. line_hit)</span></div><div class="line uncovered"><span class="line-number">70</span><span class="line-content">    end</span></div><div class="line non-executable"><span class="line-number">71</span><span class="line-content">    </span></div><div class="line non-executable"><span class="line-number">72</span><span class="line-content">    -- End of record</span></div><div class="line uncovered"><span class="line-number">73</span><span class="line-content">    table.insert(lcov_lines, &quot;end_of_record&quot;)</span></div><div class="line uncovered"><span class="line-number">74</span><span class="line-content">  end</span></div><div class="line non-executable"><span class="line-number">75</span><span class="line-content">  </span></div><div class="line uncovered"><span class="line-number">76</span><span class="line-content">  return table.concat(lcov_lines, &quot;\n&quot;)</span></div><div class="line non-executable"><span class="line-number">77</span><span class="line-content">end</span></div><div class="line non-executable"><span class="line-number">78</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">79</span><span class="line-content">-- Register formatter</span></div><div class="line uncovered"><span class="line-number">80</span><span class="line-content">return function(formatters)</span></div><div class="line uncovered"><span class="line-number">81</span><span class="line-content">  formatters.coverage.lcov = M.format_coverage</span></div><div class="line uncovered"><span class="line-number">82</span><span class="line-content">end</span></div></div>          <div class="file-item">
            <div class="file-name">lib/tools/watcher.lua</div>
            <div class="file-metric">0/125</div>
            <div class="file-metric">0/7</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- File watcher module for firmo</span></div><div class="line uncovered"><span class="line-number">2</span><span class="line-content">local watcher = {}</span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">-- List of file patterns to watch</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local watch_patterns = {</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">  &quot;%.lua$&quot;,           -- Lua source files</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">  &quot;%.txt$&quot;,           -- Text files</span></div><div class="line uncovered"><span c ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/tools/codefix.lua</div>
            <div class="file-metric">1320/1320</div>
            <div class="file-metric">0/43</div>
            <div class="file-metric">6/6</div>
            <div class="file-metric">80.0%</div>
          </div>
          <div class="source-code"><div class="line covered"><span class="line-number">1</span><span class="line-content">-- firmo codefix module</span></div><div class="line covered"><span class="line-number">2</span><span class="line-content">-- Implementation of code quality checking and fixing capabilities</span></div><div class="line covered"><span class="line-number">3</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">4</span><span class="line-content">local M = {}</span></div><div class="line covered"><span class="line-number">5</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">6</span><span class="line-content">-- Try to load JSON module</span></div><div class="line covered"><span class="line-number">7</span><span class="line-content">local json</span></div><div class="line covered"><span class="line-number">8</span><span class="line-content">local ok, loaded_json = pcall(req ... (very long line, trimmed to 1000 chars)
            <div class="file-name">examples/fixed_coverage_demo.lua</div>
            <div class="file-metric">0/149</div>
            <div class="file-metric">0/6</div>
            <div class="file-metric">0/22</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">--[[</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">  fixed_coverage_demo.lua</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content">  </span></div><div class="line non-executable"><span class="line-number">4</span><span class="line-content">  A minimal example demonstrating the fixed coverage module</span></div><div class="line non-executable"><span class="line-number">5</span><span class="line-content">]]</span></div><div class="line non-executable"><span class="line-number">6</span><span class="line-content"></span></div><div class="line non-executable"><span class="line-number">7</span><span class="line-content">-- Import modules</span></div><div class="line uncovered"><span class="line-number">8</span><span class="line-content">package.p ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/async/init.lua</div>
            <div class="file-metric">0/253</div>
            <div class="file-metric">0/14</div>
            <div class="file-metric">0/1</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- Asynchronous testing support for firmo</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">-- Provides async(), await(), wait_until(), parallel_async(), and it_async() functions</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">local async_module = {}</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">-- Internal state</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">local in_async_context = false</span></div><div class="line uncovered"><sp ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/mocking/init.lua</div>
            <div class="file-metric">0/130</div>
            <div class="file-metric">0/11</div>
            <div class="file-metric">0/25</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- mocking.lua - Mocking system integration for firmo</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">3</span><span class="line-content">local spy = require(&quot;lib.mocking.spy&quot;)</span></div><div class="line uncovered"><span class="line-number">4</span><span class="line-content">local stub = require(&quot;lib.mocking.stub&quot;)</span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local mock = require(&quot;lib.mocking.mock&quot;)</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content">local mocking = {}</span></div><div class="li ... (very long line, trimmed to 1000 chars)
            <div class="file-name">lib/tools/parser/grammar.lua</div>
            <div class="file-metric">501/501</div>
            <div class="file-metric">0/28</div>
            <div class="file-metric">25/25</div>
            <div class="file-metric">80.0%</div>
          </div>
          <div class="source-code"><div class="line covered"><span class="line-number">1</span><span class="line-content">--[[</span></div><div class="line covered"><span class="line-number">2</span><span class="line-content">This module implements a parser for Lua 5.3/5.4 with LPeg,</span></div><div class="line covered"><span class="line-number">3</span><span class="line-content">and generates an Abstract Syntax Tree.</span></div><div class="line covered"><span class="line-number">4</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">5</span><span class="line-content">Based on lua-parser by Andre Murbach Maidl (https://github.com/andremm/lua-parser)</span></div><div class="line covered"><span class="line-number">6</span><span class="line-content">]]</span></div><div class="line covered"><span class="line-number">7</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">8</span><span class="line-content">local M = {}</span></div><div class="line covered"><span class="line-number">9</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">10</span><span class="line-content">-- UTF-8 char polyfill for pre-5.3 Lua versions</span></div><div class="line covered"><span class="line-number">11</span><span class="line-content">-- Based on PR #19 from lua-parser: https://github.com/andremm/lua-parser/pull/19</span></div><div class="line covered"><span class="line-number">12</span><span class="line-content">-- This allows correctly handling UTF-8 characters in all Lua versions</span></div><div class="line covered"><span class="line-number">13</span><span class="line-content">-- without depending on the utf8 library (which is only available in Lua 5.3+)</span></div><div class="line covered"><span class="line-number">14</span><span class="line-content">local utf8_char = (utf8 or {</span></div><div class="line covered"><span class="line-number">15</span><span class="line-content">  char = function(...)</span></div><div class="line covered"><span class="line-number">16</span><span class="line-content">    local results = { ... }</span></div><div class="line covered"><span class="line-number">17</span><span class="line-content">    local n = select(&quot;#&quot;, ...)</span></div><div class="line covered"><span class="line-number">18</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">19</span><span class="line-content">    for i = 1, n do</span></div><div class="line covered"><span class="line-number">20</span><span class="line-content">      local a = results[i]</span></div><div class="line covered"><span class="line-number">21</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">22</span><span class="line-content">      if type(a) ~= &quot;number&quot; then</span></div><div class="line covered"><span class="line-number">23</span><span class="line-content">        a = tonumber(a) or error(&quot;bad argument #&quot; .. i .. &quot; to &apos;char&apos; (number expected, got &quot; .. type(a) .. &quot;)&quot;, 2)</span></div><div class="line covered"><span class="line-number">24</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">25</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">26</span><span class="line-content">      if not (0 &lt;= a) or a &gt; 1114111 or a % 1 ~= 0 then</span></div><div class="line covered"><span class="line-number">27</span><span class="line-content">        error(&quot;bad argument #&quot; .. i .. &quot; to &apos;char&apos; (expected an integer in the range [0, 1114111], got &quot; .. a .. &quot;)&quot;, 2)</span></div><div class="line covered"><span class="line-number">28</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">29</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">30</span><span class="line-content">      if a &gt;= 128 then</span></div><div class="line covered"><span class="line-number">31</span><span class="line-content">        local _1 = a % 64</span></div><div class="line covered"><span class="line-number">32</span><span class="line-content">        local b = (a - _1) / 64</span></div><div class="line covered"><span class="line-number">33</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">34</span><span class="line-content">        if a &gt;= 2048 then</span></div><div class="line covered"><span class="line-number">35</span><span class="line-content">          local _64 = b % 64</span></div><div class="line covered"><span class="line-number">36</span><span class="line-content">          local c = (b - _64) / 64</span></div><div class="line covered"><span class="line-number">37</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">38</span><span class="line-content">          if a &gt;= 65536 then</span></div><div class="line covered"><span class="line-number">39</span><span class="line-content">            local _4096 = c % 64</span></div><div class="line covered"><span class="line-number">40</span><span class="line-content">            local d = (c - _4096) / 64</span></div><div class="line covered"><span class="line-number">41</span><span class="line-content">            results[i] = string.char(d + 240, _4096 + 128, _64 + 128, _1 + 128)</span></div><div class="line covered"><span class="line-number">42</span><span class="line-content">          else</span></div><div class="line covered"><span class="line-number">43</span><span class="line-content">            results[i] = string.char(c + 224, _64 + 128, _1 + 128)</span></div><div class="line covered"><span class="line-number">44</span><span class="line-content">          end</span></div><div class="line covered"><span class="line-number">45</span><span class="line-content">        else</span></div><div class="line covered"><span class="line-number">46</span><span class="line-content">          results[i] = string.char(b + 192, _1 + 128)</span></div><div class="line covered"><span class="line-number">47</span><span class="line-content">        end</span></div><div class="line covered"><span class="line-number">48</span><span class="line-content">      else</span></div><div class="line covered"><span class="line-number">49</span><span class="line-content">        results[i] = string.char(a)</span></div><div class="line covered"><span class="line-number">50</span><span class="line-content">      end</span></div><div class="line covered"><span class="line-number">51</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">52</span><span class="line-content">    return table.concat(results, nil, 1, n)</span></div><div class="line covered"><span class="line-number">53</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">54</span><span class="line-content">}).char</span></div><div class="line covered"><span class="line-number">55</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">56</span><span class="line-content">-- Load LPegLabel</span></div><div class="line covered"><span class="line-number">57</span><span class="line-content">local lpeg = require(&quot;lib.tools.vendor.lpeglabel&quot;)</span></div><div class="line covered"><span class="line-number">58</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">59</span><span class="line-content">lpeg.locale(lpeg)</span></div><div class="line covered"><span class="line-number">60</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">61</span><span class="line-content">local P, S, V = lpeg.P, lpeg.S, lpeg.V</span></div><div class="line covered"><span class="line-number">62</span><span class="line-content">local C, Carg, Cb, Cc = lpeg.C, lpeg.Carg, lpeg.Cb, lpeg.Cc</span></div><div class="line covered"><span class="line-number">63</span><span class="line-content">local Cf, Cg, Cmt, Cp, Cs, Ct = lpeg.Cf, lpeg.Cg, lpeg.Cmt, lpeg.Cp, lpeg.Cs, lpeg.Ct</span></div><div class="line covered"><span class="line-number">64</span><span class="line-content">local Lc, T = lpeg.Lc, lpeg.T</span></div><div class="line covered"><span class="line-number">65</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">66</span><span class="line-content">local alpha, digit, alnum = lpeg.alpha, lpeg.digit, lpeg.alnum</span></div><div class="line covered"><span class="line-number">67</span><span class="line-content">local xdigit = lpeg.xdigit</span></div><div class="line covered"><span class="line-number">68</span><span class="line-content">local space = lpeg.space</span></div><div class="line covered"><span class="line-number">69</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">70</span><span class="line-content">-- Error message auxiliary functions</span></div><div class="line covered"><span class="line-number">71</span><span class="line-content">local labels = {</span></div><div class="line covered"><span class="line-number">72</span><span class="line-content">  { &quot;ErrExtra&quot;, &quot;unexpected character(s), expected EOF&quot; },</span></div><div class="line covered"><span class="line-number">73</span><span class="line-content">  { &quot;ErrInvalidStat&quot;, &quot;unexpected token, invalid start of statement&quot; },</span></div><div class="line covered"><span class="line-number">74</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">75</span><span class="line-content">  { &quot;ErrEndIf&quot;, &quot;expected &apos;end&apos; to close the if statement&quot; },</span></div><div class="line covered"><span class="line-number">76</span><span class="line-content">  { &quot;ErrExprIf&quot;, &quot;expected a condition after &apos;if&apos;&quot; },</span></div><div class="line covered"><span class="line-number">77</span><span class="line-content">  { &quot;ErrThenIf&quot;, &quot;expected &apos;then&apos; after the condition&quot; },</span></div><div class="line covered"><span class="line-number">78</span><span class="line-content">  { &quot;ErrExprEIf&quot;, &quot;expected a condition after &apos;elseif&apos;&quot; },</span></div><div class="line covered"><span class="line-number">79</span><span class="line-content">  { &quot;ErrThenEIf&quot;, &quot;expected &apos;then&apos; after the condition&quot; },</span></div><div class="line covered"><span class="line-number">80</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">81</span><span class="line-content">  { &quot;ErrEndDo&quot;, &quot;expected &apos;end&apos; to close the do block&quot; },</span></div><div class="line covered"><span class="line-number">82</span><span class="line-content">  { &quot;ErrExprWhile&quot;, &quot;expected a condition after &apos;while&apos;&quot; },</span></div><div class="line covered"><span class="line-number">83</span><span class="line-content">  { &quot;ErrDoWhile&quot;, &quot;expected &apos;do&apos; after the condition&quot; },</span></div><div class="line covered"><span class="line-number">84</span><span class="line-content">  { &quot;ErrEndWhile&quot;, &quot;expected &apos;end&apos; to close the while loop&quot; },</span></div><div class="line covered"><span class="line-number">85</span><span class="line-content">  { &quot;ErrUntilRep&quot;, &quot;expected &apos;until&apos; at the end of the repeat loop&quot; },</span></div><div class="line covered"><span class="line-number">86</span><span class="line-content">  { &quot;ErrExprRep&quot;, &quot;expected a conditions after &apos;until&apos;&quot; },</span></div><div class="line covered"><span class="line-number">87</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">88</span><span class="line-content">  { &quot;ErrForRange&quot;, &quot;expected a numeric or generic range after &apos;for&apos;&quot; },</span></div><div class="line covered"><span class="line-number">89</span><span class="line-content">  { &quot;ErrEndFor&quot;, &quot;expected &apos;end&apos; to close the for loop&quot; },</span></div><div class="line covered"><span class="line-number">90</span><span class="line-content">  { &quot;ErrExprFor1&quot;, &quot;expected a starting expression for the numeric range&quot; },</span></div><div class="line covered"><span class="line-number">91</span><span class="line-content">  { &quot;ErrCommaFor&quot;, &quot;expected &apos;,&apos; to split the start and end of the range&quot; },</span></div><div class="line covered"><span class="line-number">92</span><span class="line-content">  { &quot;ErrExprFor2&quot;, &quot;expected an ending expression for the numeric range&quot; },</span></div><div class="line covered"><span class="line-number">93</span><span class="line-content">  { &quot;ErrExprFor3&quot;, &quot;expected a step expression for the numeric range after &apos;,&apos;&quot; },</span></div><div class="line covered"><span class="line-number">94</span><span class="line-content">  { &quot;ErrInFor&quot;, &quot;expected &apos;=&apos; or &apos;in&apos; after the variable(s)&quot; },</span></div><div class="line covered"><span class="line-number">95</span><span class="line-content">  { &quot;ErrEListFor&quot;, &quot;expected one or more expressions after &apos;in&apos;&quot; },</span></div><div class="line covered"><span class="line-number">96</span><span class="line-content">  { &quot;ErrDoFor&quot;, &quot;expected &apos;do&apos; after the range of the for loop&quot; },</span></div><div class="line covered"><span class="line-number">97</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">98</span><span class="line-content">  { &quot;ErrDefLocal&quot;, &quot;expected a function definition or assignment after local&quot; },</span></div><div class="line covered"><span class="line-number">99</span><span class="line-content">  { &quot;ErrNameLFunc&quot;, &quot;expected a function name after &apos;function&apos;&quot; },</span></div><div class="line covered"><span class="line-number">100</span><span class="line-content">  { &quot;ErrEListLAssign&quot;, &quot;expected one or more expressions after &apos;=&apos;&quot; },</span></div><div class="line covered"><span class="line-number">101</span><span class="line-content">  { &quot;ErrEListAssign&quot;, &quot;expected one or more expressions after &apos;=&apos;&quot; },</span></div><div class="line covered"><span class="line-number">102</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">103</span><span class="line-content">  { &quot;ErrFuncName&quot;, &quot;expected a function name after &apos;function&apos;&quot; },</span></div><div class="line covered"><span class="line-number">104</span><span class="line-content">  { &quot;ErrNameFunc1&quot;, &quot;expected a function name after &apos;.&apos;&quot; },</span></div><div class="line covered"><span class="line-number">105</span><span class="line-content">  { &quot;ErrNameFunc2&quot;, &quot;expected a method name after &apos;:&apos;&quot; },</span></div><div class="line covered"><span class="line-number">106</span><span class="line-content">  { &quot;ErrOParenPList&quot;, &quot;expected &apos;(&apos; for the parameter list&quot; },</span></div><div class="line covered"><span class="line-number">107</span><span class="line-content">  { &quot;ErrCParenPList&quot;, &quot;expected &apos;)&apos; to close the parameter list&quot; },</span></div><div class="line covered"><span class="line-number">108</span><span class="line-content">  { &quot;ErrEndFunc&quot;, &quot;expected &apos;end&apos; to close the function body&quot; },</span></div><div class="line covered"><span class="line-number">109</span><span class="line-content">  { &quot;ErrParList&quot;, &quot;expected a variable name or &apos;...&apos; after &apos;,&apos;&quot; },</span></div><div class="line covered"><span class="line-number">110</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">111</span><span class="line-content">  { &quot;ErrLabel&quot;, &quot;expected a label name after &apos;::&apos;&quot; },</span></div><div class="line covered"><span class="line-number">112</span><span class="line-content">  { &quot;ErrCloseLabel&quot;, &quot;expected &apos;::&apos; after the label&quot; },</span></div><div class="line covered"><span class="line-number">113</span><span class="line-content">  { &quot;ErrGoto&quot;, &quot;expected a label after &apos;goto&apos;&quot; },</span></div><div class="line covered"><span class="line-number">114</span><span class="line-content">  { &quot;ErrRetList&quot;, &quot;expected an expression after &apos;,&apos; in the return statement&quot; },</span></div><div class="line covered"><span class="line-number">115</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">116</span><span class="line-content">  { &quot;ErrVarList&quot;, &quot;expected a variable name after &apos;,&apos;&quot; },</span></div><div class="line covered"><span class="line-number">117</span><span class="line-content">  { &quot;ErrExprList&quot;, &quot;expected an expression after &apos;,&apos;&quot; },</span></div><div class="line covered"><span class="line-number">118</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">119</span><span class="line-content">  { &quot;ErrOrExpr&quot;, &quot;expected an expression after &apos;or&apos;&quot; },</span></div><div class="line covered"><span class="line-number">120</span><span class="line-content">  { &quot;ErrAndExpr&quot;, &quot;expected an expression after &apos;and&apos;&quot; },</span></div><div class="line covered"><span class="line-number">121</span><span class="line-content">  { &quot;ErrRelExpr&quot;, &quot;expected an expression after the relational operator&quot; },</span></div><div class="line covered"><span class="line-number">122</span><span class="line-content">  { &quot;ErrBOrExpr&quot;, &quot;expected an expression after &apos;|&apos;&quot; },</span></div><div class="line covered"><span class="line-number">123</span><span class="line-content">  { &quot;ErrBXorExpr&quot;, &quot;expected an expression after &apos;~&apos;&quot; },</span></div><div class="line covered"><span class="line-number">124</span><span class="line-content">  { &quot;ErrBAndExpr&quot;, &quot;expected an expression after &apos;&amp;&apos;&quot; },</span></div><div class="line covered"><span class="line-number">125</span><span class="line-content">  { &quot;ErrShiftExpr&quot;, &quot;expected an expression after the bit shift&quot; },</span></div><div class="line covered"><span class="line-number">126</span><span class="line-content">  { &quot;ErrConcatExpr&quot;, &quot;expected an expression after &apos;..&apos;&quot; },</span></div><div class="line covered"><span class="line-number">127</span><span class="line-content">  { &quot;ErrAddExpr&quot;, &quot;expected an expression after the additive operator&quot; },</span></div><div class="line covered"><span class="line-number">128</span><span class="line-content">  { &quot;ErrMulExpr&quot;, &quot;expected an expression after the multiplicative operator&quot; },</span></div><div class="line covered"><span class="line-number">129</span><span class="line-content">  { &quot;ErrUnaryExpr&quot;, &quot;expected an expression after the unary operator&quot; },</span></div><div class="line covered"><span class="line-number">130</span><span class="line-content">  { &quot;ErrPowExpr&quot;, &quot;expected an expression after &apos;^&apos;&quot; },</span></div><div class="line covered"><span class="line-number">131</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">132</span><span class="line-content">  { &quot;ErrExprParen&quot;, &quot;expected an expression after &apos;(&apos;&quot; },</span></div><div class="line covered"><span class="line-number">133</span><span class="line-content">  { &quot;ErrCParenExpr&quot;, &quot;expected &apos;)&apos; to close the expression&quot; },</span></div><div class="line covered"><span class="line-number">134</span><span class="line-content">  { &quot;ErrNameIndex&quot;, &quot;expected a field name after &apos;.&apos;&quot; },</span></div><div class="line covered"><span class="line-number">135</span><span class="line-content">  { &quot;ErrExprIndex&quot;, &quot;expected an expression after &apos;[&apos;&quot; },</span></div><div class="line covered"><span class="line-number">136</span><span class="line-content">  { &quot;ErrCBracketIndex&quot;, &quot;expected &apos;]&apos; to close the indexing expression&quot; },</span></div><div class="line covered"><span class="line-number">137</span><span class="line-content">  { &quot;ErrNameMeth&quot;, &quot;expected a method name after &apos;:&apos;&quot; },</span></div><div class="line covered"><span class="line-number">138</span><span class="line-content">  { &quot;ErrMethArgs&quot;, &quot;expected some arguments for the method call (or &apos;()&apos;)&quot; },</span></div><div class="line covered"><span class="line-number">139</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">140</span><span class="line-content">  { &quot;ErrArgList&quot;, &quot;expected an expression after &apos;,&apos; in the argument list&quot; },</span></div><div class="line covered"><span class="line-number">141</span><span class="line-content">  { &quot;ErrCParenArgs&quot;, &quot;expected &apos;)&apos; to close the argument list&quot; },</span></div><div class="line covered"><span class="line-number">142</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">143</span><span class="line-content">  { &quot;ErrCBraceTable&quot;, &quot;expected &apos;}&apos; to close the table constructor&quot; },</span></div><div class="line covered"><span class="line-number">144</span><span class="line-content">  { &quot;ErrEqField&quot;, &quot;expected &apos;=&apos; after the table key&quot; },</span></div><div class="line covered"><span class="line-number">145</span><span class="line-content">  { &quot;ErrExprField&quot;, &quot;expected an expression after &apos;=&apos;&quot; },</span></div><div class="line covered"><span class="line-number">146</span><span class="line-content">  { &quot;ErrExprFKey&quot;, &quot;expected an expression after &apos;[&apos; for the table key&quot; },</span></div><div class="line covered"><span class="line-number">147</span><span class="line-content">  { &quot;ErrCBracketFKey&quot;, &quot;expected &apos;]&apos; to close the table key&quot; },</span></div><div class="line covered"><span class="line-number">148</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">149</span><span class="line-content">  { &quot;ErrDigitHex&quot;, &quot;expected one or more hexadecimal digits after &apos;0x&apos;&quot; },</span></div><div class="line covered"><span class="line-number">150</span><span class="line-content">  { &quot;ErrDigitDeci&quot;, &quot;expected one or more digits after the decimal point&quot; },</span></div><div class="line covered"><span class="line-number">151</span><span class="line-content">  { &quot;ErrDigitExpo&quot;, &quot;expected one or more digits for the exponent&quot; },</span></div><div class="line covered"><span class="line-number">152</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">153</span><span class="line-content">  { &quot;ErrQuote&quot;, &quot;unclosed string&quot; },</span></div><div class="line covered"><span class="line-number">154</span><span class="line-content">  { &quot;ErrHexEsc&quot;, &quot;expected exactly two hexadecimal digits after &apos;\\x&apos;&quot; },</span></div><div class="line covered"><span class="line-number">155</span><span class="line-content">  { &quot;ErrOBraceUEsc&quot;, &quot;expected &apos;{&apos; after &apos;\\u&apos;&quot; },</span></div><div class="line covered"><span class="line-number">156</span><span class="line-content">  { &quot;ErrDigitUEsc&quot;, &quot;expected one or more hexadecimal digits for the UTF-8 code point&quot; },</span></div><div class="line covered"><span class="line-number">157</span><span class="line-content">  { &quot;ErrCBraceUEsc&quot;, &quot;expected &apos;}&apos; after the code point&quot; },</span></div><div class="line covered"><span class="line-number">158</span><span class="line-content">  { &quot;ErrEscSeq&quot;, &quot;invalid escape sequence&quot; },</span></div><div class="line covered"><span class="line-number">159</span><span class="line-content">  { &quot;ErrCloseLStr&quot;, &quot;unclosed long string&quot; },</span></div><div class="line covered"><span class="line-number">160</span><span class="line-content">}</span></div><div class="line covered"><span class="line-number">161</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">162</span><span class="line-content">local function throw(label)</span></div><div class="line covered"><span class="line-number">163</span><span class="line-content">  label = &quot;Err&quot; .. label</span></div><div class="line covered"><span class="line-number">164</span><span class="line-content">  for i, labelinfo in ipairs(labels) do</span></div><div class="line covered"><span class="line-number">165</span><span class="line-content">    if labelinfo[1] == label then</span></div><div class="line covered"><span class="line-number">166</span><span class="line-content">      return T(i)</span></div><div class="line covered"><span class="line-number">167</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">168</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">169</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">170</span><span class="line-content">  error(&quot;Label not found: &quot; .. label)</span></div><div class="line covered"><span class="line-number">171</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">172</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">173</span><span class="line-content">local function expect (patt, label)</span></div><div class="line covered"><span class="line-number">174</span><span class="line-content">  return patt + throw(label)</span></div><div class="line covered"><span class="line-number">175</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">176</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">177</span><span class="line-content">-- Regular combinators and auxiliary functions</span></div><div class="line covered"><span class="line-number">178</span><span class="line-content">local function token (patt)</span></div><div class="line covered"><span class="line-number">179</span><span class="line-content">  return patt * V&quot;Skip&quot;</span></div><div class="line covered"><span class="line-number">180</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">181</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">182</span><span class="line-content">local function sym (str)</span></div><div class="line covered"><span class="line-number">183</span><span class="line-content">  return token(P(str))</span></div><div class="line covered"><span class="line-number">184</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">185</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">186</span><span class="line-content">local function kw (str)</span></div><div class="line covered"><span class="line-number">187</span><span class="line-content">  return token(P(str) * -V&quot;IdRest&quot;)</span></div><div class="line covered"><span class="line-number">188</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">189</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">190</span><span class="line-content">local function dec(n)</span></div><div class="line covered"><span class="line-number">191</span><span class="line-content">  return n - 1</span></div><div class="line covered"><span class="line-number">192</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">193</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">194</span><span class="line-content">local function tagC (tag, patt)</span></div><div class="line covered"><span class="line-number">195</span><span class="line-content">  return Ct(Cg(Cp(), &quot;pos&quot;) * Cg(Cc(tag), &quot;tag&quot;) * patt * Cg(Cp() / dec, &quot;end_pos&quot;))</span></div><div class="line covered"><span class="line-number">196</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">197</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">198</span><span class="line-content">local function unaryOp (op, e)</span></div><div class="line covered"><span class="line-number">199</span><span class="line-content">  return { tag = &quot;Op&quot;, pos = e.pos, end_pos = e.end_pos, [1] = op, [2] = e }</span></div><div class="line covered"><span class="line-number">200</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">201</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">202</span><span class="line-content">local function binaryOp (e1, op, e2)</span></div><div class="line covered"><span class="line-number">203</span><span class="line-content">  if not op then</span></div><div class="line covered"><span class="line-number">204</span><span class="line-content">    return e1</span></div><div class="line covered"><span class="line-number">205</span><span class="line-content">  else</span></div><div class="line covered"><span class="line-number">206</span><span class="line-content">    return { tag = &quot;Op&quot;, pos = e1.pos, end_pos = e2.end_pos, [1] = op, [2] = e1, [3] = e2 }</span></div><div class="line covered"><span class="line-number">207</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">208</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">209</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">210</span><span class="line-content">local function sepBy (patt, sep, label)</span></div><div class="line covered"><span class="line-number">211</span><span class="line-content">  if label then</span></div><div class="line covered"><span class="line-number">212</span><span class="line-content">    return patt * Cg(sep * expect(patt, label))^0</span></div><div class="line covered"><span class="line-number">213</span><span class="line-content">  else</span></div><div class="line covered"><span class="line-number">214</span><span class="line-content">    return patt * Cg(sep * patt)^0</span></div><div class="line covered"><span class="line-number">215</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">216</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">217</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">218</span><span class="line-content">-- Helper function to prevent subcapture nesting too deep errors</span></div><div class="line covered"><span class="line-number">219</span><span class="line-content">-- Based on PR #21 from lua-parser: https://github.com/andremm/lua-parser/pull/21</span></div><div class="line covered"><span class="line-number">220</span><span class="line-content">-- This addresses an issue with parsing deeply nested tables (&gt;16 levels)</span></div><div class="line covered"><span class="line-number">221</span><span class="line-content">local function cut(s, idx, match)</span></div><div class="line covered"><span class="line-number">222</span><span class="line-content">  return idx, match</span></div><div class="line covered"><span class="line-number">223</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">224</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">225</span><span class="line-content">local function chainOp (patt, sep, label)</span></div><div class="line covered"><span class="line-number">226</span><span class="line-content">  return Cmt(Cf(sepBy(patt, sep, label), binaryOp), cut)</span></div><div class="line covered"><span class="line-number">227</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">228</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">229</span><span class="line-content">local function commaSep (patt, label)</span></div><div class="line covered"><span class="line-number">230</span><span class="line-content">  return sepBy(patt, sym(&quot;,&quot;), label)</span></div><div class="line covered"><span class="line-number">231</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">232</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">233</span><span class="line-content">local function tagDo (block)</span></div><div class="line covered"><span class="line-number">234</span><span class="line-content">  block.tag = &quot;Do&quot;</span></div><div class="line covered"><span class="line-number">235</span><span class="line-content">  return block</span></div><div class="line covered"><span class="line-number">236</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">237</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">238</span><span class="line-content">local function fixFuncStat (func)</span></div><div class="line covered"><span class="line-number">239</span><span class="line-content">  if func[1].is_method then table.insert(func[2][1], 1, { tag = &quot;Id&quot;, [1] = &quot;self&quot; }) end</span></div><div class="line covered"><span class="line-number">240</span><span class="line-content">  func[1] = {func[1]}</span></div><div class="line covered"><span class="line-number">241</span><span class="line-content">  func[2] = {func[2]}</span></div><div class="line covered"><span class="line-number">242</span><span class="line-content">  return func</span></div><div class="line covered"><span class="line-number">243</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">244</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">245</span><span class="line-content">local function addDots (params, dots)</span></div><div class="line covered"><span class="line-number">246</span><span class="line-content">  if dots then table.insert(params, dots) end</span></div><div class="line covered"><span class="line-number">247</span><span class="line-content">  return params</span></div><div class="line covered"><span class="line-number">248</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">249</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">250</span><span class="line-content">local function insertIndex (t, index)</span></div><div class="line covered"><span class="line-number">251</span><span class="line-content">  return { tag = &quot;Index&quot;, pos = t.pos, end_pos = index.end_pos, [1] = t, [2] = index }</span></div><div class="line covered"><span class="line-number">252</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">253</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">254</span><span class="line-content">local function markMethod(t, method)</span></div><div class="line covered"><span class="line-number">255</span><span class="line-content">  if method then</span></div><div class="line covered"><span class="line-number">256</span><span class="line-content">    return { tag = &quot;Index&quot;, pos = t.pos, end_pos = method.end_pos, is_method = true, [1] = t, [2] = method }</span></div><div class="line covered"><span class="line-number">257</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">258</span><span class="line-content">  return t</span></div><div class="line covered"><span class="line-number">259</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">260</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">261</span><span class="line-content">local function makeIndexOrCall (t1, t2)</span></div><div class="line covered"><span class="line-number">262</span><span class="line-content">  if t2.tag == &quot;Call&quot; or t2.tag == &quot;Invoke&quot; then</span></div><div class="line covered"><span class="line-number">263</span><span class="line-content">    local t = { tag = t2.tag, pos = t1.pos, end_pos = t2.end_pos, [1] = t1 }</span></div><div class="line covered"><span class="line-number">264</span><span class="line-content">    for k, v in ipairs(t2) do</span></div><div class="line covered"><span class="line-number">265</span><span class="line-content">      table.insert(t, v)</span></div><div class="line covered"><span class="line-number">266</span><span class="line-content">    end</span></div><div class="line covered"><span class="line-number">267</span><span class="line-content">    return t</span></div><div class="line covered"><span class="line-number">268</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">269</span><span class="line-content">  return { tag = &quot;Index&quot;, pos = t1.pos, end_pos = t2.end_pos, [1] = t1, [2] = t2[1] }</span></div><div class="line covered"><span class="line-number">270</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">271</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">272</span><span class="line-content">-- Grammar</span></div><div class="line covered"><span class="line-number">273</span><span class="line-content">local G = { V&quot;Lua&quot;,</span></div><div class="line covered"><span class="line-number">274</span><span class="line-content">  Lua      = V&quot;Shebang&quot;^-1 * V&quot;Skip&quot; * V&quot;Block&quot; * expect(P(-1), &quot;Extra&quot;);</span></div><div class="line covered"><span class="line-number">275</span><span class="line-content">  Shebang  = P&quot;#!&quot; * (P(1) - P&quot;\n&quot;)^0;</span></div><div class="line covered"><span class="line-number">276</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">277</span><span class="line-content">  Block       = tagC(&quot;Block&quot;, V&quot;Stat&quot;^0 * V&quot;RetStat&quot;^-1);</span></div><div class="line covered"><span class="line-number">278</span><span class="line-content">  Stat        = V&quot;IfStat&quot; + V&quot;DoStat&quot; + V&quot;WhileStat&quot; + V&quot;RepeatStat&quot; + V&quot;ForStat&quot;</span></div><div class="line covered"><span class="line-number">279</span><span class="line-content">              + V&quot;LocalStat&quot; + V&quot;FuncStat&quot; + V&quot;BreakStat&quot; + V&quot;LabelStat&quot; + V&quot;GoToStat&quot;</span></div><div class="line covered"><span class="line-number">280</span><span class="line-content">              + V&quot;FuncCall&quot; + V&quot;Assignment&quot; + sym(&quot;;&quot;) + -V&quot;BlockEnd&quot; * throw(&quot;InvalidStat&quot;);</span></div><div class="line covered"><span class="line-number">281</span><span class="line-content">  BlockEnd    = P&quot;return&quot; + &quot;end&quot; + &quot;elseif&quot; + &quot;else&quot; + &quot;until&quot; + -1;</span></div><div class="line covered"><span class="line-number">282</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">283</span><span class="line-content">  IfStat      = tagC(&quot;If&quot;, V&quot;IfPart&quot; * V&quot;ElseIfPart&quot;^0 * V&quot;ElsePart&quot;^-1 * expect(kw(&quot;end&quot;), &quot;EndIf&quot;));</span></div><div class="line covered"><span class="line-number">284</span><span class="line-content">  IfPart      = kw(&quot;if&quot;) * expect(V&quot;Expr&quot;, &quot;ExprIf&quot;) * expect(kw(&quot;then&quot;), &quot;ThenIf&quot;) * V&quot;Block&quot;;</span></div><div class="line covered"><span class="line-number">285</span><span class="line-content">  ElseIfPart  = kw(&quot;elseif&quot;) * expect(V&quot;Expr&quot;, &quot;ExprEIf&quot;) * expect(kw(&quot;then&quot;), &quot;ThenEIf&quot;) * V&quot;Block&quot;;</span></div><div class="line covered"><span class="line-number">286</span><span class="line-content">  ElsePart    = kw(&quot;else&quot;) * V&quot;Block&quot;;</span></div><div class="line covered"><span class="line-number">287</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">288</span><span class="line-content">  DoStat      = kw(&quot;do&quot;) * V&quot;Block&quot; * expect(kw(&quot;end&quot;), &quot;EndDo&quot;) / tagDo;</span></div><div class="line covered"><span class="line-number">289</span><span class="line-content">  WhileStat   = tagC(&quot;While&quot;, kw(&quot;while&quot;) * expect(V&quot;Expr&quot;, &quot;ExprWhile&quot;) * V&quot;WhileBody&quot;);</span></div><div class="line covered"><span class="line-number">290</span><span class="line-content">  WhileBody   = expect(kw(&quot;do&quot;), &quot;DoWhile&quot;) * V&quot;Block&quot; * expect(kw(&quot;end&quot;), &quot;EndWhile&quot;);</span></div><div class="line covered"><span class="line-number">291</span><span class="line-content">  RepeatStat  = tagC(&quot;Repeat&quot;, kw(&quot;repeat&quot;) * V&quot;Block&quot; * expect(kw(&quot;until&quot;), &quot;UntilRep&quot;) * expect(V&quot;Expr&quot;, &quot;ExprRep&quot;));</span></div><div class="line covered"><span class="line-number">292</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">293</span><span class="line-content">  ForStat   = kw(&quot;for&quot;) * expect(V&quot;ForNum&quot; + V&quot;ForIn&quot;, &quot;ForRange&quot;) * expect(kw(&quot;end&quot;), &quot;EndFor&quot;);</span></div><div class="line covered"><span class="line-number">294</span><span class="line-content">  ForNum    = tagC(&quot;Fornum&quot;, V&quot;Id&quot; * sym(&quot;=&quot;) * V&quot;NumRange&quot; * V&quot;ForBody&quot;);</span></div><div class="line covered"><span class="line-number">295</span><span class="line-content">  NumRange  = expect(V&quot;Expr&quot;, &quot;ExprFor1&quot;) * expect(sym(&quot;,&quot;), &quot;CommaFor&quot;) *expect(V&quot;Expr&quot;, &quot;ExprFor2&quot;)</span></div><div class="line covered"><span class="line-number">296</span><span class="line-content">            * (sym(&quot;,&quot;) * expect(V&quot;Expr&quot;, &quot;ExprFor3&quot;))^-1;</span></div><div class="line covered"><span class="line-number">297</span><span class="line-content">  ForIn     = tagC(&quot;Forin&quot;, V&quot;NameList&quot; * expect(kw(&quot;in&quot;), &quot;InFor&quot;) * expect(V&quot;ExprList&quot;, &quot;EListFor&quot;) * V&quot;ForBody&quot;);</span></div><div class="line covered"><span class="line-number">298</span><span class="line-content">  ForBody   = expect(kw(&quot;do&quot;), &quot;DoFor&quot;) * V&quot;Block&quot;;</span></div><div class="line covered"><span class="line-number">299</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">300</span><span class="line-content">  LocalStat    = kw(&quot;local&quot;) * expect(V&quot;LocalFunc&quot; + V&quot;LocalAssign&quot;, &quot;DefLocal&quot;);</span></div><div class="line covered"><span class="line-number">301</span><span class="line-content">  LocalFunc    = tagC(&quot;Localrec&quot;, kw(&quot;function&quot;) * expect(V&quot;Id&quot;, &quot;NameLFunc&quot;) * V&quot;FuncBody&quot;) / fixFuncStat;</span></div><div class="line covered"><span class="line-number">302</span><span class="line-content">  LocalAssign  = tagC(&quot;Local&quot;, V&quot;NameList&quot; * (sym(&quot;=&quot;) * expect(V&quot;ExprList&quot;, &quot;EListLAssign&quot;) + Ct(Cc())));</span></div><div class="line covered"><span class="line-number">303</span><span class="line-content">  Assignment   = tagC(&quot;Set&quot;, V&quot;VarList&quot; * sym(&quot;=&quot;) * expect(V&quot;ExprList&quot;, &quot;EListAssign&quot;));</span></div><div class="line covered"><span class="line-number">304</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">305</span><span class="line-content">  FuncStat    = tagC(&quot;Set&quot;, kw(&quot;function&quot;) * expect(V&quot;FuncName&quot;, &quot;FuncName&quot;) * V&quot;FuncBody&quot;) / fixFuncStat;</span></div><div class="line covered"><span class="line-number">306</span><span class="line-content">  FuncName    = Cf(V&quot;Id&quot; * (sym(&quot;.&quot;) * expect(V&quot;StrId&quot;, &quot;NameFunc1&quot;))^0, insertIndex)</span></div><div class="line covered"><span class="line-number">307</span><span class="line-content">              * (sym(&quot;:&quot;) * expect(V&quot;StrId&quot;, &quot;NameFunc2&quot;))^-1 / markMethod;</span></div><div class="line covered"><span class="line-number">308</span><span class="line-content">  FuncBody    = tagC(&quot;Function&quot;, V&quot;FuncParams&quot; * V&quot;Block&quot; * expect(kw(&quot;end&quot;), &quot;EndFunc&quot;));</span></div><div class="line covered"><span class="line-number">309</span><span class="line-content">  FuncParams  = expect(sym(&quot;(&quot;), &quot;OParenPList&quot;) * V&quot;ParList&quot; * expect(sym(&quot;)&quot;), &quot;CParenPList&quot;);</span></div><div class="line covered"><span class="line-number">310</span><span class="line-content">  ParList     = V&quot;NameList&quot; * (sym(&quot;,&quot;) * expect(tagC(&quot;Dots&quot;, sym(&quot;...&quot;)), &quot;ParList&quot;))^-1 / addDots</span></div><div class="line covered"><span class="line-number">311</span><span class="line-content">              + Ct(tagC(&quot;Dots&quot;, sym(&quot;...&quot;)))</span></div><div class="line covered"><span class="line-number">312</span><span class="line-content">              + Ct(Cc()); -- Cc({}) generates a bug since the {} would be shared across parses</span></div><div class="line covered"><span class="line-number">313</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">314</span><span class="line-content">  LabelStat  = tagC(&quot;Label&quot;, sym(&quot;::&quot;) * expect(V&quot;Name&quot;, &quot;Label&quot;) * expect(sym(&quot;::&quot;), &quot;CloseLabel&quot;));</span></div><div class="line covered"><span class="line-number">315</span><span class="line-content">  GoToStat   = tagC(&quot;Goto&quot;, kw(&quot;goto&quot;) * expect(V&quot;Name&quot;, &quot;Goto&quot;));</span></div><div class="line covered"><span class="line-number">316</span><span class="line-content">  BreakStat  = tagC(&quot;Break&quot;, kw(&quot;break&quot;));</span></div><div class="line covered"><span class="line-number">317</span><span class="line-content">  RetStat    = tagC(&quot;Return&quot;, kw(&quot;return&quot;) * commaSep(V&quot;Expr&quot;, &quot;RetList&quot;)^-1 * sym(&quot;;&quot;)^-1);</span></div><div class="line covered"><span class="line-number">318</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">319</span><span class="line-content">  NameList  = tagC(&quot;NameList&quot;, commaSep(V&quot;Id&quot;));</span></div><div class="line covered"><span class="line-number">320</span><span class="line-content">  VarList   = tagC(&quot;VarList&quot;, commaSep(V&quot;VarExpr&quot;, &quot;VarList&quot;));</span></div><div class="line covered"><span class="line-number">321</span><span class="line-content">  ExprList  = tagC(&quot;ExpList&quot;, commaSep(V&quot;Expr&quot;, &quot;ExprList&quot;));</span></div><div class="line covered"><span class="line-number">322</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">323</span><span class="line-content">  Expr        = V&quot;OrExpr&quot;;</span></div><div class="line covered"><span class="line-number">324</span><span class="line-content">  OrExpr      = chainOp(V&quot;AndExpr&quot;, V&quot;OrOp&quot;, &quot;OrExpr&quot;);</span></div><div class="line covered"><span class="line-number">325</span><span class="line-content">  AndExpr     = chainOp(V&quot;RelExpr&quot;, V&quot;AndOp&quot;, &quot;AndExpr&quot;);</span></div><div class="line covered"><span class="line-number">326</span><span class="line-content">  RelExpr     = chainOp(V&quot;BOrExpr&quot;, V&quot;RelOp&quot;, &quot;RelExpr&quot;);</span></div><div class="line covered"><span class="line-number">327</span><span class="line-content">  BOrExpr     = chainOp(V&quot;BXorExpr&quot;, V&quot;BOrOp&quot;, &quot;BOrExpr&quot;);</span></div><div class="line covered"><span class="line-number">328</span><span class="line-content">  BXorExpr    = chainOp(V&quot;BAndExpr&quot;, V&quot;BXorOp&quot;, &quot;BXorExpr&quot;);</span></div><div class="line covered"><span class="line-number">329</span><span class="line-content">  BAndExpr    = chainOp(V&quot;ShiftExpr&quot;, V&quot;BAndOp&quot;, &quot;BAndExpr&quot;);</span></div><div class="line covered"><span class="line-number">330</span><span class="line-content">  ShiftExpr   = chainOp(V&quot;ConcatExpr&quot;, V&quot;ShiftOp&quot;, &quot;ShiftExpr&quot;);</span></div><div class="line covered"><span class="line-number">331</span><span class="line-content">  ConcatExpr  = V&quot;AddExpr&quot; * (V&quot;ConcatOp&quot; * expect(V&quot;ConcatExpr&quot;, &quot;ConcatExpr&quot;))^-1 / binaryOp;</span></div><div class="line covered"><span class="line-number">332</span><span class="line-content">  AddExpr     = chainOp(V&quot;MulExpr&quot;, V&quot;AddOp&quot;, &quot;AddExpr&quot;);</span></div><div class="line covered"><span class="line-number">333</span><span class="line-content">  MulExpr     = chainOp(V&quot;UnaryExpr&quot;, V&quot;MulOp&quot;, &quot;MulExpr&quot;);</span></div><div class="line covered"><span class="line-number">334</span><span class="line-content">  UnaryExpr   = V&quot;UnaryOp&quot; * expect(V&quot;UnaryExpr&quot;, &quot;UnaryExpr&quot;) / unaryOp</span></div><div class="line covered"><span class="line-number">335</span><span class="line-content">              + V&quot;PowExpr&quot;;</span></div><div class="line covered"><span class="line-number">336</span><span class="line-content">  PowExpr     = V&quot;SimpleExpr&quot; * (V&quot;PowOp&quot; * expect(V&quot;UnaryExpr&quot;, &quot;PowExpr&quot;))^-1 / binaryOp;</span></div><div class="line covered"><span class="line-number">337</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">338</span><span class="line-content">  SimpleExpr = tagC(&quot;Number&quot;, V&quot;Number&quot;)</span></div><div class="line covered"><span class="line-number">339</span><span class="line-content">             + tagC(&quot;String&quot;, V&quot;String&quot;)</span></div><div class="line covered"><span class="line-number">340</span><span class="line-content">             + tagC(&quot;Nil&quot;, kw(&quot;nil&quot;))</span></div><div class="line covered"><span class="line-number">341</span><span class="line-content">             + tagC(&quot;Boolean&quot;, kw(&quot;false&quot;) * Cc(false))</span></div><div class="line covered"><span class="line-number">342</span><span class="line-content">             + tagC(&quot;Boolean&quot;, kw(&quot;true&quot;) * Cc(true))</span></div><div class="line covered"><span class="line-number">343</span><span class="line-content">             + tagC(&quot;Dots&quot;, sym(&quot;...&quot;))</span></div><div class="line covered"><span class="line-number">344</span><span class="line-content">             + V&quot;FuncDef&quot;</span></div><div class="line covered"><span class="line-number">345</span><span class="line-content">             + V&quot;Table&quot;</span></div><div class="line covered"><span class="line-number">346</span><span class="line-content">             + V&quot;SuffixedExpr&quot;;</span></div><div class="line covered"><span class="line-number">347</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">348</span><span class="line-content">  FuncCall  = Cmt(V&quot;SuffixedExpr&quot;, function(s, i, exp) return exp.tag == &quot;Call&quot; or exp.tag == &quot;Invoke&quot;, exp end);</span></div><div class="line covered"><span class="line-number">349</span><span class="line-content">  VarExpr   = Cmt(V&quot;SuffixedExpr&quot;, function(s, i, exp) return exp.tag == &quot;Id&quot; or exp.tag == &quot;Index&quot;, exp end);</span></div><div class="line covered"><span class="line-number">350</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">351</span><span class="line-content">  SuffixedExpr  = Cf(V&quot;PrimaryExpr&quot; * (V&quot;Index&quot; + V&quot;Call&quot;)^0, makeIndexOrCall);</span></div><div class="line covered"><span class="line-number">352</span><span class="line-content">  PrimaryExpr   = V&quot;Id&quot; + tagC(&quot;Paren&quot;, sym(&quot;(&quot;) * expect(V&quot;Expr&quot;, &quot;ExprParen&quot;) * expect(sym(&quot;)&quot;), &quot;CParenExpr&quot;));</span></div><div class="line covered"><span class="line-number">353</span><span class="line-content">  Index         = tagC(&quot;DotIndex&quot;, sym(&quot;.&quot; * -P&quot;.&quot;) * expect(V&quot;StrId&quot;, &quot;NameIndex&quot;))</span></div><div class="line covered"><span class="line-number">354</span><span class="line-content">                + tagC(&quot;ArrayIndex&quot;, sym(&quot;[&quot; * -P(S&quot;=[&quot;)) * expect(V&quot;Expr&quot;, &quot;ExprIndex&quot;) * expect(sym(&quot;]&quot;), &quot;CBracketIndex&quot;));</span></div><div class="line covered"><span class="line-number">355</span><span class="line-content">  Call          = tagC(&quot;Invoke&quot;, Cg(sym(&quot;:&quot; * -P&quot;:&quot;) * expect(V&quot;StrId&quot;, &quot;NameMeth&quot;) * expect(V&quot;FuncArgs&quot;, &quot;MethArgs&quot;)))</span></div><div class="line covered"><span class="line-number">356</span><span class="line-content">                + tagC(&quot;Call&quot;, V&quot;FuncArgs&quot;);</span></div><div class="line covered"><span class="line-number">357</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">358</span><span class="line-content">  FuncDef   = kw(&quot;function&quot;) * V&quot;FuncBody&quot;;</span></div><div class="line covered"><span class="line-number">359</span><span class="line-content">  FuncArgs  = sym(&quot;(&quot;) * commaSep(V&quot;Expr&quot;, &quot;ArgList&quot;)^-1 * expect(sym(&quot;)&quot;), &quot;CParenArgs&quot;)</span></div><div class="line covered"><span class="line-number">360</span><span class="line-content">            + V&quot;Table&quot;</span></div><div class="line covered"><span class="line-number">361</span><span class="line-content">            + tagC(&quot;String&quot;, V&quot;String&quot;);</span></div><div class="line covered"><span class="line-number">362</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">363</span><span class="line-content">  Table      = tagC(&quot;Table&quot;, sym(&quot;{&quot;) * V&quot;FieldList&quot;^-1 * expect(sym(&quot;}&quot;), &quot;CBraceTable&quot;));</span></div><div class="line covered"><span class="line-number">364</span><span class="line-content">  FieldList  = sepBy(V&quot;Field&quot;, V&quot;FieldSep&quot;) * V&quot;FieldSep&quot;^-1;</span></div><div class="line covered"><span class="line-number">365</span><span class="line-content">  Field      = tagC(&quot;Pair&quot;, V&quot;FieldKey&quot; * expect(sym(&quot;=&quot;), &quot;EqField&quot;) * expect(V&quot;Expr&quot;, &quot;ExprField&quot;))</span></div><div class="line covered"><span class="line-number">366</span><span class="line-content">             + V&quot;Expr&quot;;</span></div><div class="line covered"><span class="line-number">367</span><span class="line-content">  FieldKey   = sym(&quot;[&quot; * -P(S&quot;=[&quot;)) * expect(V&quot;Expr&quot;, &quot;ExprFKey&quot;) * expect(sym(&quot;]&quot;), &quot;CBracketFKey&quot;)</span></div><div class="line covered"><span class="line-number">368</span><span class="line-content">             + V&quot;StrId&quot; * #(&quot;=&quot; * -P&quot;=&quot;);</span></div><div class="line covered"><span class="line-number">369</span><span class="line-content">  FieldSep   = sym(&quot;,&quot;) + sym(&quot;;&quot;);</span></div><div class="line covered"><span class="line-number">370</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">371</span><span class="line-content">  Id     = tagC(&quot;Id&quot;, V&quot;Name&quot;);</span></div><div class="line covered"><span class="line-number">372</span><span class="line-content">  StrId  = tagC(&quot;String&quot;, V&quot;Name&quot;);</span></div><div class="line covered"><span class="line-number">373</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">374</span><span class="line-content">  -- Lexer</span></div><div class="line covered"><span class="line-number">375</span><span class="line-content">  Skip     = (V&quot;Space&quot; + V&quot;Comment&quot;)^0;</span></div><div class="line covered"><span class="line-number">376</span><span class="line-content">  Space    = space^1;</span></div><div class="line covered"><span class="line-number">377</span><span class="line-content">  Comment  = P&quot;--&quot; * V&quot;LongStr&quot; / function () return end</span></div><div class="line covered"><span class="line-number">378</span><span class="line-content">           + P&quot;--&quot; * (P(1) - P&quot;\n&quot;)^0;</span></div><div class="line covered"><span class="line-number">379</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">380</span><span class="line-content">  Name      = token(-V&quot;Reserved&quot; * C(V&quot;Ident&quot;));</span></div><div class="line covered"><span class="line-number">381</span><span class="line-content">  Reserved  = V&quot;Keywords&quot; * -V&quot;IdRest&quot;;</span></div><div class="line covered"><span class="line-number">382</span><span class="line-content">  Keywords  = P&quot;and&quot; + &quot;break&quot; + &quot;do&quot; + &quot;elseif&quot; + &quot;else&quot; + &quot;end&quot;</span></div><div class="line covered"><span class="line-number">383</span><span class="line-content">            + &quot;false&quot; + &quot;for&quot; + &quot;function&quot; + &quot;goto&quot; + &quot;if&quot; + &quot;in&quot;</span></div><div class="line covered"><span class="line-number">384</span><span class="line-content">            + &quot;local&quot; + &quot;nil&quot; + &quot;not&quot; + &quot;or&quot; + &quot;repeat&quot; + &quot;return&quot;</span></div><div class="line covered"><span class="line-number">385</span><span class="line-content">            + &quot;then&quot; + &quot;true&quot; + &quot;until&quot; + &quot;while&quot;;</span></div><div class="line covered"><span class="line-number">386</span><span class="line-content">  Ident     = V&quot;IdStart&quot; * V&quot;IdRest&quot;^0;</span></div><div class="line covered"><span class="line-number">387</span><span class="line-content">  IdStart   = alpha + P&quot;_&quot;;</span></div><div class="line covered"><span class="line-number">388</span><span class="line-content">  IdRest    = alnum + P&quot;_&quot;;</span></div><div class="line covered"><span class="line-number">389</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">390</span><span class="line-content">  Number   = token((V&quot;Hex&quot; + V&quot;Float&quot; + V&quot;Int&quot;) / tonumber);</span></div><div class="line covered"><span class="line-number">391</span><span class="line-content">  Hex      = (P&quot;0x&quot; + &quot;0X&quot;) * expect(xdigit^1, &quot;DigitHex&quot;);</span></div><div class="line covered"><span class="line-number">392</span><span class="line-content">  Float    = V&quot;Decimal&quot; * V&quot;Expo&quot;^-1</span></div><div class="line covered"><span class="line-number">393</span><span class="line-content">           + V&quot;Int&quot; * V&quot;Expo&quot;;</span></div><div class="line covered"><span class="line-number">394</span><span class="line-content">  Decimal  = digit^1 * &quot;.&quot; * digit^0</span></div><div class="line covered"><span class="line-number">395</span><span class="line-content">           + P&quot;.&quot; * -P&quot;.&quot; * expect(digit^1, &quot;DigitDeci&quot;);</span></div><div class="line covered"><span class="line-number">396</span><span class="line-content">  Expo     = S&quot;eE&quot; * S&quot;+-&quot;^-1 * expect(digit^1, &quot;DigitExpo&quot;);</span></div><div class="line covered"><span class="line-number">397</span><span class="line-content">  Int      = digit^1;</span></div><div class="line covered"><span class="line-number">398</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">399</span><span class="line-content">  String    = token(V&quot;ShortStr&quot; + V&quot;LongStr&quot;);</span></div><div class="line covered"><span class="line-number">400</span><span class="line-content">  ShortStr  = P&apos;&quot;&apos; * Cs((V&quot;EscSeq&quot; + (P(1)-S&apos;&quot;\n&apos;))^0) * expect(P&apos;&quot;&apos;, &quot;Quote&quot;)</span></div><div class="line covered"><span class="line-number">401</span><span class="line-content">            + P&quot;&apos;&quot; * Cs((V&quot;EscSeq&quot; + (P(1)-S&quot;&apos;\n&quot;))^0) * expect(P&quot;&apos;&quot;, &quot;Quote&quot;);</span></div><div class="line covered"><span class="line-number">402</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">403</span><span class="line-content">  EscSeq = P&quot;\\&quot; / &quot;&quot;  -- remove backslash</span></div><div class="line covered"><span class="line-number">404</span><span class="line-content">         * ( P&quot;a&quot; / &quot;\a&quot;</span></div><div class="line covered"><span class="line-number">405</span><span class="line-content">           + P&quot;b&quot; / &quot;\b&quot;</span></div><div class="line covered"><span class="line-number">406</span><span class="line-content">           + P&quot;f&quot; / &quot;\f&quot;</span></div><div class="line covered"><span class="line-number">407</span><span class="line-content">           + P&quot;n&quot; / &quot;\n&quot;</span></div><div class="line covered"><span class="line-number">408</span><span class="line-content">           + P&quot;r&quot; / &quot;\r&quot;</span></div><div class="line covered"><span class="line-number">409</span><span class="line-content">           + P&quot;t&quot; / &quot;\t&quot;</span></div><div class="line covered"><span class="line-number">410</span><span class="line-content">           + P&quot;v&quot; / &quot;\v&quot;</span></div><div class="line covered"><span class="line-number">411</span><span class="line-content">   </span></div><div class="line covered"><span class="line-number">412</span><span class="line-content">           + P&quot;\n&quot; / &quot;\n&quot;</span></div><div class="line covered"><span class="line-number">413</span><span class="line-content">           + P&quot;\r&quot; / &quot;\n&quot;</span></div><div class="line covered"><span class="line-number">414</span><span class="line-content">   </span></div><div class="line covered"><span class="line-number">415</span><span class="line-content">           + P&quot;\\&quot; / &quot;\\&quot;</span></div><div class="line covered"><span class="line-number">416</span><span class="line-content">           + P&quot;\&quot;&quot; / &quot;\&quot;&quot;</span></div><div class="line covered"><span class="line-number">417</span><span class="line-content">           + P&quot;\&apos;&quot; / &quot;\&apos;&quot;</span></div><div class="line covered"><span class="line-number">418</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">419</span><span class="line-content">           + P&quot;z&quot; * space^0  / &quot;&quot;</span></div><div class="line covered"><span class="line-number">420</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">421</span><span class="line-content">           + digit * digit^-2 / tonumber / string.char</span></div><div class="line covered"><span class="line-number">422</span><span class="line-content">           + P&quot;x&quot; * expect(C(xdigit * xdigit), &quot;HexEsc&quot;) * Cc(16) / tonumber / string.char</span></div><div class="line covered"><span class="line-number">423</span><span class="line-content">           + P&quot;u&quot; * expect(&quot;{&quot;, &quot;OBraceUEsc&quot;)</span></div><div class="line covered"><span class="line-number">424</span><span class="line-content">                  * expect(C(xdigit^1), &quot;DigitUEsc&quot;) * Cc(16)</span></div><div class="line covered"><span class="line-number">425</span><span class="line-content">                  * expect(&quot;}&quot;, &quot;CBraceUEsc&quot;)</span></div><div class="line covered"><span class="line-number">426</span><span class="line-content">                  / tonumber </span></div><div class="line covered"><span class="line-number">427</span><span class="line-content">                  / utf8_char</span></div><div class="line covered"><span class="line-number">428</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">429</span><span class="line-content">           + throw(&quot;EscSeq&quot;)</span></div><div class="line covered"><span class="line-number">430</span><span class="line-content">           );</span></div><div class="line covered"><span class="line-number">431</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">432</span><span class="line-content">  LongStr  = V&quot;Open&quot; * C((P(1) - V&quot;CloseEq&quot;)^0) * expect(V&quot;Close&quot;, &quot;CloseLStr&quot;) / function (s, eqs) return s end;</span></div><div class="line covered"><span class="line-number">433</span><span class="line-content">  Open     = &quot;[&quot; * Cg(V&quot;Equals&quot;, &quot;openEq&quot;) * &quot;[&quot; * P&quot;\n&quot;^-1;</span></div><div class="line covered"><span class="line-number">434</span><span class="line-content">  Close    = &quot;]&quot; * C(V&quot;Equals&quot;) * &quot;]&quot;;</span></div><div class="line covered"><span class="line-number">435</span><span class="line-content">  Equals   = P&quot;=&quot;^0;</span></div><div class="line covered"><span class="line-number">436</span><span class="line-content">  CloseEq  = Cmt(V&quot;Close&quot; * Cb(&quot;openEq&quot;), function (s, i, closeEq, openEq) return #openEq == #closeEq end);</span></div><div class="line covered"><span class="line-number">437</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">438</span><span class="line-content">  OrOp      = kw(&quot;or&quot;)   / &quot;or&quot;;</span></div><div class="line covered"><span class="line-number">439</span><span class="line-content">  AndOp     = kw(&quot;and&quot;)  / &quot;and&quot;;</span></div><div class="line covered"><span class="line-number">440</span><span class="line-content">  RelOp     = sym(&quot;~=&quot;)  / &quot;ne&quot;</span></div><div class="line covered"><span class="line-number">441</span><span class="line-content">            + sym(&quot;==&quot;)  / &quot;eq&quot;</span></div><div class="line covered"><span class="line-number">442</span><span class="line-content">            + sym(&quot;&lt;=&quot;)  / &quot;le&quot;</span></div><div class="line covered"><span class="line-number">443</span><span class="line-content">            + sym(&quot;&gt;=&quot;)  / &quot;ge&quot;</span></div><div class="line covered"><span class="line-number">444</span><span class="line-content">            + sym(&quot;&lt;&quot;)   / &quot;lt&quot;</span></div><div class="line covered"><span class="line-number">445</span><span class="line-content">            + sym(&quot;&gt;&quot;)   / &quot;gt&quot;;</span></div><div class="line covered"><span class="line-number">446</span><span class="line-content">  BOrOp     = sym(&quot;|&quot;)   / &quot;bor&quot;;</span></div><div class="line covered"><span class="line-number">447</span><span class="line-content">  BXorOp    = sym(&quot;~&quot; * -P&quot;=&quot;) / &quot;bxor&quot;;</span></div><div class="line covered"><span class="line-number">448</span><span class="line-content">  BAndOp    = sym(&quot;&amp;&quot;)   / &quot;band&quot;;</span></div><div class="line covered"><span class="line-number">449</span><span class="line-content">  ShiftOp   = sym(&quot;&lt;&lt;&quot;)  / &quot;shl&quot;</span></div><div class="line covered"><span class="line-number">450</span><span class="line-content">            + sym(&quot;&gt;&gt;&quot;)  / &quot;shr&quot;;</span></div><div class="line covered"><span class="line-number">451</span><span class="line-content">  ConcatOp  = sym(&quot;..&quot;)  / &quot;concat&quot;;</span></div><div class="line covered"><span class="line-number">452</span><span class="line-content">  AddOp     = sym(&quot;+&quot;)   / &quot;add&quot;</span></div><div class="line covered"><span class="line-number">453</span><span class="line-content">            + sym(&quot;-&quot;)   / &quot;sub&quot;;</span></div><div class="line covered"><span class="line-number">454</span><span class="line-content">  MulOp     = sym(&quot;*&quot;)   / &quot;mul&quot;</span></div><div class="line covered"><span class="line-number">455</span><span class="line-content">            + sym(&quot;//&quot;)  / &quot;idiv&quot;</span></div><div class="line covered"><span class="line-number">456</span><span class="line-content">            + sym(&quot;/&quot;)   / &quot;div&quot;</span></div><div class="line covered"><span class="line-number">457</span><span class="line-content">            + sym(&quot;%&quot;)   / &quot;mod&quot;;</span></div><div class="line covered"><span class="line-number">458</span><span class="line-content">  UnaryOp   = kw(&quot;not&quot;)  / &quot;not&quot;</span></div><div class="line covered"><span class="line-number">459</span><span class="line-content">            + sym(&quot;-&quot;)   / &quot;unm&quot;</span></div><div class="line covered"><span class="line-number">460</span><span class="line-content">            + sym(&quot;#&quot;)   / &quot;len&quot;</span></div><div class="line covered"><span class="line-number">461</span><span class="line-content">            + sym(&quot;~&quot;)   / &quot;bnot&quot;;</span></div><div class="line covered"><span class="line-number">462</span><span class="line-content">  PowOp     = sym(&quot;^&quot;)   / &quot;pow&quot;;</span></div><div class="line covered"><span class="line-number">463</span><span class="line-content">}</span></div><div class="line covered"><span class="line-number">464</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">465</span><span class="line-content">-- Helper function to calculate line number and column</span></div><div class="line covered"><span class="line-number">466</span><span class="line-content">local function calcline(subject, pos)</span></div><div class="line covered"><span class="line-number">467</span><span class="line-content">  if pos &gt; #subject then pos = #subject end</span></div><div class="line covered"><span class="line-number">468</span><span class="line-content">  local line, linestart = 1, 1</span></div><div class="line covered"><span class="line-number">469</span><span class="line-content">  local newline, _ = string.find(subject, &quot;\n&quot;, linestart)</span></div><div class="line covered"><span class="line-number">470</span><span class="line-content">  while newline and newline &lt; pos do</span></div><div class="line covered"><span class="line-number">471</span><span class="line-content">    line = line + 1</span></div><div class="line covered"><span class="line-number">472</span><span class="line-content">    linestart = newline + 1</span></div><div class="line covered"><span class="line-number">473</span><span class="line-content">    newline, _ = string.find(subject, &quot;\n&quot;, linestart)</span></div><div class="line covered"><span class="line-number">474</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">475</span><span class="line-content">  return line, pos - linestart + 1</span></div><div class="line covered"><span class="line-number">476</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">477</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">478</span><span class="line-content">-- Create an error message for the input string</span></div><div class="line covered"><span class="line-number">479</span><span class="line-content">local function syntaxerror(errorinfo, pos, msg)</span></div><div class="line covered"><span class="line-number">480</span><span class="line-content">  local l, c = calcline(errorinfo.subject, pos)</span></div><div class="line covered"><span class="line-number">481</span><span class="line-content">  local error_msg = &quot;%s:%d:%d: syntax error, %s&quot;</span></div><div class="line covered"><span class="line-number">482</span><span class="line-content">  return string.format(error_msg, errorinfo.filename or &quot;input&quot;, l, c, msg)</span></div><div class="line covered"><span class="line-number">483</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">484</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">485</span><span class="line-content">-- Parse a Lua source string</span></div><div class="line covered"><span class="line-number">486</span><span class="line-content">function M.parse(subject, filename)</span></div><div class="line covered"><span class="line-number">487</span><span class="line-content">  local errorinfo = { subject = subject, filename = filename or &quot;input&quot; }</span></div><div class="line covered"><span class="line-number">488</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">489</span><span class="line-content">  -- Set a high max stack size to help with deeply nested tables and complex expressions</span></div><div class="line covered"><span class="line-number">490</span><span class="line-content">  -- This complements the &apos;cut&apos; function in chainOp to prevent &quot;subcapture nesting too deep&quot; errors</span></div><div class="line covered"><span class="line-number">491</span><span class="line-content">  lpeg.setmaxstack(1000)</span></div><div class="line covered"><span class="line-number">492</span><span class="line-content">  </span></div><div class="line covered"><span class="line-number">493</span><span class="line-content">  local ast, label, errorpos = lpeg.match(G, subject, nil, errorinfo)</span></div><div class="line covered"><span class="line-number">494</span><span class="line-content">  if not ast then</span></div><div class="line covered"><span class="line-number">495</span><span class="line-content">    local errmsg = labels[label][2]</span></div><div class="line covered"><span class="line-number">496</span><span class="line-content">    return nil, syntaxerror(errorinfo, errorpos, errmsg)</span></div><div class="line covered"><span class="line-number">497</span><span class="line-content">  end</span></div><div class="line covered"><span class="line-number">498</span><span class="line-content">  return ast</span></div><div class="line covered"><span class="line-number">499</span><span class="line-content">end</span></div><div class="line covered"><span class="line-number">500</span><span class="line-content"></span></div><div class="line covered"><span class="line-number">501</span><span class="line-content">return M</span></div></div>          <div class="file-item">
            <div class="file-name">lib/tools/parser/init.lua</div>
            <div class="file-metric">0/279</div>
            <div class="file-metric">0/15</div>
            <div class="file-metric">0/12</div>
            <div class="file-metric">0.0%</div>
          </div>
          <div class="source-code"><div class="line non-executable"><span class="line-number">1</span><span class="line-content">-- firmo parser module</span></div><div class="line non-executable"><span class="line-number">2</span><span class="line-content">-- Based on lua-parser (https://github.com/andremm/lua-parser)</span></div><div class="line non-executable"><span class="line-number">3</span><span class="line-content">-- MIT License</span></div><div class="line non-executable"><span class="line-number">4</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">5</span><span class="line-content">local M = {}</span></div><div class="line uncovered"><span class="line-number">6</span><span class="line-content">local fs = require(&quot;lib.tools.filesystem&quot;)</span></div><div class="line uncovered"><span class="line-number">7</span><span class="line-content"></span></div><div class="line uncovered"><span class="line-number">8</span ... (very long line, trimmed to 1000 chars)
  </div>
</body>
</html>
  